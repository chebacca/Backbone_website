const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-Ighhwe4d.js","assets/index-CtftzVC1.js","assets/mui-D8UjIA2s.js","assets/vendor-CjD1bmmO.js","assets/stripe-CUttI3Gx.js","assets/index-CBai7h7s.css","assets/index.esm-COtph9ny.js","assets/index.esm-CZcVTLdu.js","assets/index.esm-Bm1DnCIa.js"])))=>i.map(i=>d[i]);
var O=Object.defineProperty;var q=(l,e,t)=>e in l?O(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var m=(l,e,t)=>q(l,typeof e!="symbol"?e+"":e,t);import{_ as D}from"./index-CtftzVC1.js";import"./mui-D8UjIA2s.js";import"./vendor-CjD1bmmO.js";import"./stripe-CUttI3Gx.js";const g=class g{constructor(){m(this,"db");m(this,"auth")}static getInstance(){return g.instance||(g.instance=new g),g.instance}async initialize(){const e=await D(()=>import("./firebase-Ighhwe4d.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));this.db=e.db,this.auth=e.auth}getCurrentUser(){var e;return(e=this.auth)==null?void 0:e.currentUser}async getDocumentById(e,t){try{const{doc:r,getDoc:a}=await D(async()=>{const{doc:o,getDoc:n}=await import("./index.esm-CZcVTLdu.js");return{doc:o,getDoc:n}},__vite__mapDeps([7,6])),i=r(this.db,e,t),s=await a(i);if(s.exists()){const o=s.data();return{id:s.id,...this.convertFirestoreDates(o)}}return null}catch(r){return console.error(`‚ùå [FirestoreAdapter] Error getting document ${t} from ${e}:`,r),null}}async queryDocuments(e,t=[]){try{const{collection:r,query:a,where:i,getDocs:s}=await D(async()=>{const{collection:d,query:h,where:$,getDocs:z}=await import("./index.esm-CZcVTLdu.js");return{collection:d,query:h,where:$,getDocs:z}},__vite__mapDeps([7,6])),o=r(this.db,e);let n;if(t.length>0){let d=[];for(const h of t)d.push(i(h.field,h.operator,h.value));n=a(o,...d)}else n=a(o);const c=await s(n),u=[];return c.forEach(d=>{const h=d.data();u.push({id:d.id,...this.convertFirestoreDates(h)})}),u}catch(r){return console.error(`‚ùå [FirestoreAdapter] Error querying ${e}:`,r),[]}}async createDocument(e,t){try{const{collection:r,addDoc:a}=await D(async()=>{const{collection:o,addDoc:n}=await import("./index.esm-CZcVTLdu.js");return{collection:o,addDoc:n}},__vite__mapDeps([7,6])),i=this.cleanDocumentData({...t,createdAt:new Date,updatedAt:new Date});return{id:(await a(r(this.db,e),i)).id,...i}}catch(r){return console.error(`‚ùå [FirestoreAdapter] Error creating document in ${e}:`,r),null}}async updateDocument(e,t,r){try{const{doc:a,updateDoc:i}=await D(async()=>{const{doc:o,updateDoc:n}=await import("./index.esm-CZcVTLdu.js");return{doc:o,updateDoc:n}},__vite__mapDeps([7,6])),s=this.cleanDocumentData({...r,updatedAt:new Date});return await i(a(this.db,e,t),s),!0}catch(a){return console.error(`‚ùå [FirestoreAdapter] Error updating document ${t} in ${e}:`,a),!1}}async deleteDocument(e,t){try{const{doc:r,deleteDoc:a}=await D(async()=>{const{doc:i,deleteDoc:s}=await import("./index.esm-CZcVTLdu.js");return{doc:i,deleteDoc:s}},__vite__mapDeps([7,6]));return await a(r(this.db,e,t)),!0}catch(r){return console.error(`‚ùå [FirestoreAdapter] Error deleting document ${t} from ${e}:`,r),!1}}cleanDocumentData(e){const t={};for(const[r,a]of Object.entries(e))if(a!==void 0){if(a===null){t[r]=null;continue}if(typeof a=="object"&&!Array.isArray(a)&&!(a instanceof Date)){t[r]=this.cleanDocumentData(a);continue}t[r]=a}return t}convertFirestoreDates(e){const t={};for(const[r,a]of Object.entries(e))a&&typeof a=="object"&&a.toDate&&typeof a.toDate=="function"?t[r]=a.toDate().toISOString():a&&typeof a=="object"&&!Array.isArray(a)?t[r]=this.convertFirestoreDates(a):t[r]=a;return t}};m(g,"instance");let T=g;class E{constructor(e){m(this,"config");m(this,"firestoreAdapter");this.config=e,this.firestoreAdapter=T.getInstance()}isWebOnlyMode(){return this.config.isWebOnlyMode}getConfig(){return this.config}async apiRequest(e,t="GET",r,a){try{const s=`${this.config.apiBaseUrl||"/api"}/${e.startsWith("/")?e.substring(1):e}`,o={"Content-Type":"application/json",...a},n={method:t,headers:o,credentials:"include"};r&&(t==="POST"||t==="PATCH")&&(n.body=JSON.stringify(r));const c=await fetch(s,n);if(!c.ok)throw new Error(`API request failed: ${c.status} ${c.statusText}`);const u=c.headers.get("content-type");return u&&u.includes("application/json")?await c.json():await c.text()}catch(i){throw console.error(`‚ùå [BaseService] API request failed for ${e}:`,i),i}}handleError(e,t){console.error(`‚ùå [${this.constructor.name}] Error in ${t}:`,e)}}var f=(l=>(l.ADMIN="ADMIN",l.MEMBER="MEMBER",l.VIEWER="VIEWER",l.OWNER="OWNER",l.DO_ER="DO_ER",l))(f||{}),P=(l=>(l.ACTIVE="active",l.ARCHIVED="archived",l.DELETED="deleted",l.DRAFT="draft",l))(P||{});const w=class w extends E{constructor(e){super(e)}static getInstance(e){return w.instance||(w.instance=new w(e)),w.instance}async getProjects(){try{if(console.log("üöÄ [ProjectService] Getting all projects"),this.isWebOnlyMode())return await this.getProjectsFromFirestore();try{return await this.apiRequest("projects")}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.getProjectsFromFirestore()}}catch(e){return this.handleError(e,"getProjects"),[]}}async getProject(e){try{if(console.log(`üöÄ [ProjectService] Getting project: ${e}`),this.isWebOnlyMode())return await this.getProjectFromFirestore(e);try{return await this.apiRequest(`projects/${e}`)}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.getProjectFromFirestore(e)}}catch(t){return this.handleError(t,`getProject(${e})`),null}}async createProject(e){try{if(console.log("üöÄ [ProjectService] Creating new project"),this.isWebOnlyMode())return await this.createProjectInFirestore(e);try{return await this.apiRequest("projects","POST",e)}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.createProjectInFirestore(e)}}catch(t){return this.handleError(t,"createProject"),null}}async updateProject(e,t){try{if(console.log(`üöÄ [ProjectService] Updating project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}`,"PATCH",t)}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`updateProject(${e})`),null}}async archiveProject(e){try{if(console.log(`üöÄ [ProjectService] Archiving project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,{status:P.ARCHIVED})!==null;try{return await this.apiRequest(`projects/${e}/archive`,"POST"),!0}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,{status:P.ARCHIVED})!==null}}catch(t){return this.handleError(t,`archiveProject(${e})`),!1}}async restoreProject(e){try{if(console.log(`üöÄ [ProjectService] Restoring project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,{status:P.ACTIVE})!==null;try{return await this.apiRequest(`projects/${e}/restore`,"POST"),!0}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,{status:P.ACTIVE})!==null}}catch(t){return this.handleError(t,`restoreProject(${e})`),!1}}async getProjectsFromFirestore(){var e;try{console.log("üîç [ProjectService] Getting projects from Firestore"),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();let r=this.config.organizationId;if(t)r=((e=(await this.firestoreAdapter.queryDocuments("users",[{field:"uid",operator:"==",value:t.uid}]))[0])==null?void 0:e.organizationId)||r;else{console.warn("‚ö†Ô∏è [ProjectService] No authenticated Firebase user, trying fallback methods");try{const i=localStorage.getItem("auth_user");i&&(r=JSON.parse(i).organizationId||r,console.log("‚úÖ [ProjectService] Using organization ID from localStorage:",r))}catch{console.warn("‚ö†Ô∏è [ProjectService] Failed to parse auth user from localStorage")}r||(r="24H6zaiCUycuT8ukx9Jz",console.log("‚úÖ [ProjectService] Using fallback enterprise organization ID:",r))}return r?(await this.firestoreAdapter.queryDocuments("projects",[{field:"organizationId",operator:"==",value:r}])).sort((i,s)=>{const o=i.lastAccessedAt?new Date(i.lastAccessedAt).getTime():0;return(s.lastAccessedAt?new Date(s.lastAccessedAt).getTime():0)-o}):(console.warn("‚ö†Ô∏è [ProjectService] No organization ID found for current user"),[])}catch(t){return this.handleError(t,"getProjectsFromFirestore"),[]}}async getProjectFromFirestore(e){try{return console.log(`üîç [ProjectService] Getting project from Firestore: ${e}`),await this.firestoreAdapter.initialize(),await this.firestoreAdapter.getDocumentById("projects",e)}catch(t){return this.handleError(t,`getProjectFromFirestore(${e})`),null}}async createProjectInFirestore(e){try{console.log("üîç [ProjectService] Creating project in Firestore"),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();if(!t)return console.warn("‚ö†Ô∏è [ProjectService] No authenticated user for project creation"),null;const r={...e,ownerId:e.ownerId||t.uid,status:e.status||P.ACTIVE,teamMembers:e.teamMembers||[]};return await this.firestoreAdapter.createDocument("projects",r)}catch(t){return this.handleError(t,"createProjectInFirestore"),null}}async updateProjectInFirestore(e,t){try{console.log(`üîç [ProjectService] Updating project in Firestore: ${e}`),await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.getDocumentById("projects",e);return r?await this.firestoreAdapter.updateDocument("projects",e,t)?{...r,...t,id:e}:null:(console.warn(`‚ö†Ô∏è [ProjectService] Project not found: ${e}`),null)}catch(r){return this.handleError(r,`updateProjectInFirestore(${e})`),null}}};m(w,"instance");let S=w;const y=class y extends E{constructor(e){super(e)}static getInstance(e){return y.instance||(y.instance=new y(e)),y.instance}async listDatasets(e){try{if(console.log("üöÄ [DatasetService] Listing datasets with params:",e),this.isWebOnlyMode())return await this.listDatasetsFromFirestore(e);const t=new URLSearchParams;e!=null&&e.organizationId&&t.append("organizationId",e.organizationId),e!=null&&e.visibility&&t.append("visibility",e.visibility),e!=null&&e.backend&&e.backend!=="all"&&t.append("backend",e.backend),e!=null&&e.query&&t.append("query",e.query);try{return await this.apiRequest(`datasets${t.toString()?`?${t}`:""}`)}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.listDatasetsFromFirestore(e)}}catch(t){return this.handleError(t,"listDatasets"),[]}}async createDataset(e){try{if(console.log("üöÄ [DatasetService] Creating dataset"),this.isWebOnlyMode())return await this.createDatasetInFirestore(e);const t={...e};try{return await this.apiRequest("datasets","POST",t)}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.createDatasetInFirestore(e)}}catch(t){return this.handleError(t,"createDataset"),null}}async getProjectDatasets(e){try{if(console.log(`üöÄ [DatasetService] Getting datasets for project: ${e}`),this.isWebOnlyMode())return await this.getProjectDatasetsFromFirestore(e);try{return await this.apiRequest(`datasets/project/${e}`,"GET")}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.getProjectDatasetsFromFirestore(e)}}catch(t){return this.handleError(t,`getProjectDatasets(${e})`),[]}}async assignDatasetToProject(e,t){try{if(console.log(`üöÄ [DatasetService] Assigning dataset ${t} to project ${e}`),this.isWebOnlyMode())return await this.assignDatasetToProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}/datasets/${t}`,"POST"),!0}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.assignDatasetToProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`assignDatasetToProject(${e}, ${t})`),!1}}async unassignDatasetFromProject(e,t){try{if(console.log(`üöÄ [DatasetService] Unassigning dataset ${t} from project ${e}`),this.isWebOnlyMode())return await this.unassignDatasetFromProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}/datasets/${t}`,"DELETE"),!0}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.unassignDatasetFromProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`unassignDatasetFromProject(${e}, ${t})`),!1}}async listDatasetsFromFirestore(e){var t;try{console.log("üîç [DatasetService] Fetching datasets from Firestore with params:",e),await this.firestoreAdapter.initialize();const r=this.firestoreAdapter.getCurrentUser();let a=this.config.organizationId;if(r)a=((t=(await this.firestoreAdapter.queryDocuments("users",[{field:"uid",operator:"==",value:r.uid}]))[0])==null?void 0:t.organizationId)||a;else{console.warn("‚ö†Ô∏è [DatasetService] No authenticated Firebase user, trying fallback methods");try{const n=localStorage.getItem("auth_user");n&&(a=JSON.parse(n).organizationId||a,console.log("‚úÖ [DatasetService] Using organization ID from localStorage:",a))}catch{console.warn("‚ö†Ô∏è [DatasetService] Failed to parse auth user from localStorage")}a||(a="24H6zaiCUycuT8ukx9Jz",console.log("‚úÖ [DatasetService] Using fallback enterprise organization ID:",a))}if(!a)return console.warn("‚ö†Ô∏è [DatasetService] No organization ID found for current user"),[];console.log("üè¢ [DatasetService] Fetching datasets for organization:",a);const i=[];i.push({field:"organizationId",operator:"==",value:(e==null?void 0:e.organizationId)||a});let o=await this.firestoreAdapter.queryDocuments("datasets",i);if(e!=null&&e.backend&&e.backend!=="all"&&(o=o.filter(n=>{var u;return(((u=n.storage)==null?void 0:u.backend)||"firestore")===e.backend})),e!=null&&e.query){const n=e.query.toLowerCase();o=o.filter(c=>{const u=(c.name||"").toLowerCase(),d=(c.description||"").toLowerCase();return u.includes(n)||d.includes(n)})}return e!=null&&e.visibility&&(o=o.filter(n=>(n.visibility||"private")===e.visibility)),o.sort((n,c)=>{const u=new Date(n.createdAt||"").getTime();return new Date(c.createdAt||"").getTime()-u}),console.log(`‚úÖ [DatasetService] Found ${o.length} datasets from Firestore`),o}catch(r){return this.handleError(r,"listDatasetsFromFirestore"),[]}}async createDatasetInFirestore(e){var t,r;try{console.log("üîç [DatasetService] Creating dataset in Firestore"),await this.firestoreAdapter.initialize();const a=this.firestoreAdapter.getCurrentUser();let i=e.organizationId;if(!i)if(a)i=((t=(await this.firestoreAdapter.queryDocuments("users",[{field:"uid",operator:"==",value:a.uid}]))[0])==null?void 0:t.organizationId)||this.config.organizationId;else{console.warn("‚ö†Ô∏è [DatasetService] No authenticated Firebase user, trying fallback methods");try{const o=localStorage.getItem("auth_user");o&&(i=JSON.parse(o).organizationId||this.config.organizationId,console.log("‚úÖ [DatasetService] Using organization ID from localStorage:",i))}catch{console.warn("‚ö†Ô∏è [DatasetService] Failed to parse auth user from localStorage")}i||(i="24H6zaiCUycuT8ukx9Jz",console.log("‚úÖ [DatasetService] Using fallback enterprise organization ID:",i))}if(i||(i=((r=(await this.firestoreAdapter.queryDocuments("users",[{field:"uid",operator:"==",value:a.uid}]))[0])==null?void 0:r.organizationId)||this.config.organizationId),!i)return console.warn("‚ö†Ô∏è [DatasetService] No organization ID found for dataset creation"),null;const s={...e,ownerId:a.uid,organizationId:i,visibility:e.visibility||"private",storage:e.storage||{backend:"firestore"},status:e.status||"active"};return await this.firestoreAdapter.createDocument("datasets",s)}catch(a){return this.handleError(a,"createDatasetInFirestore"),null}}async getProjectDatasetsFromFirestore(e){try{console.log(`üîç [DatasetService] Fetching datasets from Firestore for project: ${e}`),await this.firestoreAdapter.initialize();const t=await this.firestoreAdapter.queryDocuments("datasets",[{field:"projectId",operator:"==",value:e}]);return t.sort((r,a)=>{const i=new Date(r.createdAt||"").getTime();return new Date(a.createdAt||"").getTime()-i}),console.log(`‚úÖ [DatasetService] Found ${t.length} datasets for project ${e}`),t}catch(t){return this.handleError(t,`getProjectDatasetsFromFirestore(${e})`),[]}}async assignDatasetToProjectInFirestore(e,t){try{if(console.log(`üîç [DatasetService] Assigning dataset to project in Firestore: ${e}, ${t}`),await this.firestoreAdapter.initialize(),!await this.firestoreAdapter.getDocumentById("datasets",t))return console.warn(`‚ö†Ô∏è [DatasetService] Dataset not found: ${t}`),!1;const a=await this.firestoreAdapter.updateDocument("datasets",t,{projectId:e});return console.log(`‚úÖ [DatasetService] Dataset ${a?"assigned":"failed to assign"} to project in Firestore`),a}catch(r){return this.handleError(r,`assignDatasetToProjectInFirestore(${e}, ${t})`),!1}}async unassignDatasetFromProjectInFirestore(e,t){try{console.log(`üîç [DatasetService] Unassigning dataset from project in Firestore: ${e}, ${t}`),await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.getDocumentById("datasets",t);if(!r)return console.warn(`‚ö†Ô∏è [DatasetService] Dataset not found: ${t}`),!1;if(r.projectId!==e)return console.warn(`‚ö†Ô∏è [DatasetService] Dataset is not assigned to this project: ${t}, ${e}`),!1;const a=await this.firestoreAdapter.updateDocument("datasets",t,{projectId:null});return console.log(`‚úÖ [DatasetService] Dataset ${a?"unassigned":"failed to unassign"} from project in Firestore`),a}catch(r){return this.handleError(r,`unassignDatasetFromProjectInFirestore(${e}, ${t})`),!1}}};m(y,"instance");let j=y;const b=class b extends E{constructor(e){super(e)}static getInstance(e){return b.instance||(b.instance=new b(e)),b.instance}async getLicensedTeamMembers(e){try{if(console.log("üöÄ [TeamMemberService] Getting licensed team members with options:",e),this.isWebOnlyMode())return await this.getLicensedTeamMembersFromFirestore(e);const t=new URLSearchParams;e!=null&&e.search&&t.append("search",e.search),e!=null&&e.excludeProjectId&&t.append("excludeProjectId",e.excludeProjectId);const r=`team-members/licensed${t.toString()?`?${t.toString()}`:""}`;try{return await this.apiRequest(r)}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.getLicensedTeamMembersFromFirestore(e)}}catch(t){return this.handleError(t,"getLicensedTeamMembers"),[]}}async getProjectTeamMembers(e){try{if(console.log("üöÄ [TeamMemberService] Getting team members for project:",e),this.isWebOnlyMode())return await this.getProjectTeamMembersFromFirestore(e);try{return await this.apiRequest(`projects/${e}/team-members`)}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.getProjectTeamMembersFromFirestore(e)}}catch(t){return this.handleError(t,`getProjectTeamMembers(${e})`),[]}}async addTeamMemberToProject(e,t,r=f.DO_ER){try{if(console.log("üöÄ [TeamMemberService] Adding team member to project:",{projectId:e,teamMemberId:t,role:r}),this.isWebOnlyMode())return await this.addTeamMemberToProjectInFirestore(e,t,r);try{return await this.apiRequest(`projects/${e}/team-members`,"POST",{teamMemberId:t,role:r}),!0}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.addTeamMemberToProjectInFirestore(e,t,r)}}catch(a){return this.handleError(a,`addTeamMemberToProject(${e}, ${t})`),!1}}async removeTeamMemberFromProject(e,t){try{if(console.log("üöÄ [TeamMemberService] Removing team member from project:",{projectId:e,teamMemberId:t}),this.isWebOnlyMode())return await this.removeTeamMemberFromProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}/team-members/${t}`,"DELETE"),!0}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.removeTeamMemberFromProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`removeTeamMemberFromProject(${e}, ${t})`),!1}}async updateTeamMemberRole(e,t,r){try{if(console.log("üöÄ [TeamMemberService] Updating team member role:",{projectId:e,teamMemberId:t,role:r}),this.isWebOnlyMode())return await this.updateTeamMemberRoleInFirestore(e,t,r);try{return await this.apiRequest(`projects/${e}/team-members/${t}/role`,"PATCH",{role:r}),!0}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.updateTeamMemberRoleInFirestore(e,t,r)}}catch(a){return this.handleError(a,`updateTeamMemberRole(${e}, ${t})`),!1}}async validateTeamMemberCredentials(e,t){try{if(console.log("üöÄ [TeamMemberService] Validating team member credentials for:",e),this.isWebOnlyMode())return await this.validateTeamMemberCredentialsFromFirestore(e,t);try{return await this.apiRequest("team-members/validate-credentials","POST",{email:e,password:t})}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.validateTeamMemberCredentialsFromFirestore(e,t)}}catch(r){return this.handleError(r,"validateTeamMemberCredentials"),{isValid:!1,error:"Authentication failed"}}}async getLicensedTeamMembersFromFirestore(e){var t;try{console.log("üîç [TeamMemberService] Fetching licensed team members from Firestore with options:",e),await this.firestoreAdapter.initialize();const r=this.firestoreAdapter.getCurrentUser();if(!r)return console.warn("‚ö†Ô∏è [TeamMemberService] No authenticated user for team members fetch"),[];const i=((t=(await this.firestoreAdapter.queryDocuments("users",[{field:"uid",operator:"==",value:r.uid}]))[0])==null?void 0:t.organizationId)||this.config.organizationId;if(!i)return console.warn("‚ö†Ô∏è [TeamMemberService] No organization ID found for current user"),[];console.log("üè¢ [TeamMemberService] Fetching team members for organization:",i);const s=await this.firestoreAdapter.queryDocuments("teamMembers",[{field:"organizationId",operator:"==",value:i}]);let o=[];if(e!=null&&e.excludeProjectId)try{o=(await this.getProjectTeamMembersFromFirestore(e.excludeProjectId)).map(u=>u.teamMemberId)}catch(c){console.warn("Failed to get assigned team members:",c)}let n=s.filter(c=>{if(o.includes(c.id))return!1;if(e!=null&&e.search){const u=e.search.toLowerCase(),d=(c.name||"").toLowerCase(),h=(c.email||"").toLowerCase();return d.includes(u)||h.includes(u)}return!0});return n.sort((c,u)=>{const d=(c.name||"").toLowerCase(),h=(u.name||"").toLowerCase();return d.localeCompare(h)}),console.log(`‚úÖ [TeamMemberService] Found ${n.length} licensed team members`),n}catch(r){return this.handleError(r,"getLicensedTeamMembersFromFirestore"),[]}}async getProjectTeamMembersFromFirestore(e){try{console.log("üîç [TeamMemberService] Fetching team members from Firestore for project:",e),await this.firestoreAdapter.initialize();const t=[],r=await this.firestoreAdapter.getDocumentById("projects",e);if(r){const i=r.teamMembers||[];for(const s of i)t.push({id:s.userId||s.id,teamMemberId:s.userId||s.id,projectId:e,role:s.role||"member",permissions:s.permissions||["read"],assignedAt:s.assignedAt||new Date().toISOString(),isActive:s.isActive!==!1,email:s.email,name:s.name||s.email,status:s.status||"active"})}try{const i=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e}]);for(const s of i)t.find(o=>o.teamMemberId===s.teamMemberId)||t.push(s)}catch{console.log("‚ÑπÔ∏è [TeamMemberService] projectTeamMembers collection not found or accessible")}const a=[];for(const i of t)try{const s=await this.firestoreAdapter.getDocumentById("teamMembers",i.teamMemberId);s?a.push({...i,name:s.name||s.email||i.name||"Unnamed User",email:s.email||i.email||"No email",teamMember:s}):a.push(i)}catch(s){console.warn("‚ö†Ô∏è [TeamMemberService] Failed to get full profile for team member:",i.teamMemberId,s),a.push(i)}return console.log(`‚úÖ [TeamMemberService] Found ${a.length} team members for project ${e}`),a}catch(t){return this.handleError(t,`getProjectTeamMembersFromFirestore(${e})`),[]}}async addTeamMemberToProjectInFirestore(e,t,r){try{console.log("üîç [TeamMemberService] Adding team member to project in Firestore:",{projectId:e,teamMemberId:t,role:r}),await this.firestoreAdapter.initialize();const a=await this.firestoreAdapter.getDocumentById("teamMembers",t);if(!a)return console.warn("‚ö†Ô∏è [TeamMemberService] Team member not found:",t),!1;if(r===f.ADMIN&&(await this.getProjectTeamMembersFromFirestore(e)).some(c=>c.role===f.ADMIN))throw console.warn("‚ö†Ô∏è [TeamMemberService] Only one Admin is allowed per project"),new Error("Only one Admin is allowed per project. Please remove the existing Admin first.");const i={projectId:e,teamMemberId:t,role:r,assignedBy:"system",assignedAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0,teamMemberName:a.name||"Unknown User",teamMemberEmail:a.email||"No email",teamMemberRole:a.role||"MEMBER",teamMemberLicenseType:a.licenseType||"BASIC"};return await this.firestoreAdapter.createDocument("projectTeamMembers",i)!==null}catch(a){return this.handleError(a,`addTeamMemberToProjectInFirestore(${e}, ${t})`),!1}}async removeTeamMemberFromProjectInFirestore(e,t){try{console.log("üîç [TeamMemberService] Removing team member from project in Firestore:",{projectId:e,teamMemberId:t}),await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e},{field:"teamMemberId",operator:"==",value:t}]);return r.length===0?(console.warn("‚ö†Ô∏è [TeamMemberService] Team member not found in project"),!1):await this.firestoreAdapter.deleteDocument("projectTeamMembers",r[0].id)}catch(r){return this.handleError(r,`removeTeamMemberFromProjectInFirestore(${e}, ${t})`),!1}}async updateTeamMemberRoleInFirestore(e,t,r){try{console.log("üîç [TeamMemberService] Updating team member role in Firestore:",{projectId:e,teamMemberId:t,role:r}),await this.firestoreAdapter.initialize();const a=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e},{field:"teamMemberId",operator:"==",value:t}]);if(a.length===0)return console.warn("‚ö†Ô∏è [TeamMemberService] Team member not found in project"),!1;if(r===f.ADMIN&&(await this.getProjectTeamMembersFromFirestore(e)).some(n=>n.role===f.ADMIN&&n.teamMemberId!==t))throw console.warn("‚ö†Ô∏è [TeamMemberService] Only one Admin is allowed per project"),new Error("Only one Admin is allowed per project. Please remove the existing Admin first.");return await this.firestoreAdapter.updateDocument("projectTeamMembers",a[0].id,{role:r,updatedAt:new Date().toISOString()})}catch(a){return this.handleError(a,`updateTeamMemberRoleInFirestore(${e}, ${t})`),!1}}async validateTeamMemberCredentialsFromFirestore(e,t){try{await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.queryDocuments("teamMembers",[{field:"email",operator:"==",value:e}]);if(r.length===0)return{isValid:!1,error:"Team member not found"};const a=r[0];return t.length<1?{isValid:!1,error:"Password is required"}:{isValid:!0,teamMember:a,projectAccess:[]}}catch(r){return this.handleError(r,"validateTeamMemberCredentialsFromFirestore"),{isValid:!1,error:"Authentication failed"}}}};m(b,"instance");let A=b;const v=class v{constructor(){m(this,"config");m(this,"projectService",null);m(this,"datasetService",null);m(this,"teamMemberService",null);this.config={isWebOnlyMode:this.detectWebOnlyMode(),apiBaseUrl:"/api"},this.initializeFirestoreAdapter()}static getInstance(){return v.instance||(v.instance=new v),v.instance}initialize(e){this.config={...this.config,...e},console.log("üîß [ServiceFactory] Initialized with config:",this.config),this.projectService=null,this.datasetService=null,this.teamMemberService=null}getProjectService(){return this.projectService||(this.projectService=S.getInstance(this.config)),this.projectService}getDatasetService(){return this.datasetService||(this.datasetService=j.getInstance(this.config)),this.datasetService}getTeamMemberService(){return this.teamMemberService||(this.teamMemberService=A.getInstance(this.config)),this.teamMemberService}detectWebOnlyMode(){if(typeof window<"u"){const e=new URLSearchParams(window.location.search);if(e.has("webonly"))return e.get("webonly")==="true";const t=localStorage.getItem("webonly_mode");if(t)return t==="true";if(window.ENV&&window.ENV.WEBONLY)return window.ENV.WEBONLY===!0}return!0}async initializeFirestoreAdapter(){try{await T.getInstance().initialize()}catch(e){console.error("‚ùå [ServiceFactory] Failed to initialize Firestore adapter:",e)}}};m(v,"instance");let M=v;const F=class F{constructor(){m(this,"serviceFactory");m(this,"authTokenCallback",null);this.serviceFactory=M.getInstance(),this.serviceFactory.initialize({isWebOnlyMode:this.isWebOnlyMode()})}static getInstance(){return F.instance||(F.instance=new F),F.instance}isWebOnlyMode(){if(typeof window<"u"){const e=new URLSearchParams(window.location.search);if(e.has("webonly"))return e.get("webonly")==="true";const t=localStorage.getItem("webonly_mode");if(t)return t==="true";if(window.ENV&&window.ENV.WEBONLY)return window.ENV.WEBONLY===!0}return!0}setConfig(e){this.serviceFactory.initialize(e)}async getProjects(){return await this.serviceFactory.getProjectService().getProjects()}async getUserProjects(){return await this.serviceFactory.getProjectService().getProjects()}async getProject(e){return await this.serviceFactory.getProjectService().getProject(e)}async createProject(e){return await this.serviceFactory.getProjectService().createProject(e)}async createCloudProject(e){return await this.serviceFactory.getProjectService().createProject(e)}async createCloudProjectInFirestore(e){return await this.serviceFactory.getProjectService().createProject(e)}async updateProject(e,t){return await this.serviceFactory.getProjectService().updateProject(e,t)}async updateProjectInFirestore(e,t){return await this.serviceFactory.getProjectService().updateProject(e,t)}async archiveProject(e){return await this.serviceFactory.getProjectService().archiveProject(e)}async archiveProjectInFirestore(e){return await this.serviceFactory.getProjectService().archiveProject(e)}async restoreProject(e){return await this.serviceFactory.getProjectService().restoreProject(e)}async listDatasets(e){return await this.serviceFactory.getDatasetService().listDatasets(e)}async createDataset(e){return await this.serviceFactory.getDatasetService().createDataset(e)}async getProjectDatasets(e){return await this.serviceFactory.getDatasetService().getProjectDatasets(e)}async assignDatasetToProject(e,t){await this.serviceFactory.getDatasetService().assignDatasetToProject(e,t)}async unassignDatasetFromProject(e,t){await this.serviceFactory.getDatasetService().unassignDatasetFromProject(e,t)}async getLicensedTeamMembers(e){return await this.serviceFactory.getTeamMemberService().getLicensedTeamMembers(e)}async getProjectTeamMembers(e){return await this.serviceFactory.getTeamMemberService().getProjectTeamMembers(e)}async addTeamMemberToProject(e,t,r=f.DO_ER){await this.serviceFactory.getTeamMemberService().addTeamMemberToProject(e,t,r)}async removeTeamMemberFromProject(e,t){await this.serviceFactory.getTeamMemberService().removeTeamMemberFromProject(e,t)}async updateTeamMemberRole(e,t,r){await this.serviceFactory.getTeamMemberService().updateTeamMemberRole(e,t,r)}async validateTeamMemberCredentials(e,t){return await this.serviceFactory.getTeamMemberService().validateTeamMemberCredentials(e,t)}setAuthTokenCallback(e){this.authTokenCallback=e}setAuthToken(e){console.log("Setting auth token:",e),typeof localStorage<"u"&&localStorage.setItem("auth_token",e),this.authTokenCallback&&this.authTokenCallback()}cleanDocumentData(e){const t={};for(const[r,a]of Object.entries(e))if(a!==void 0){if(a===null){t[r]=null;continue}if(typeof a=="object"&&!Array.isArray(a)&&!(a instanceof Date)){t[r]=this.cleanDocumentData(a);continue}t[r]=a}return t}};m(F,"instance");let p=F;const I=p.getInstance();typeof window<"u"&&(window.cloudProjectIntegration=I);export{I as cloudProjectIntegration,p as default};
