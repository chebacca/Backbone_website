const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-fk-SiQU0.js","assets/index-CCLTFbMI.js","assets/mui-D8UjIA2s.js","assets/vendor-CjD1bmmO.js","assets/stripe-CUttI3Gx.js","assets/index-CBai7h7s.css","assets/index.esm-COtph9ny.js","assets/index.esm-CZcVTLdu.js","assets/index.esm-Bm1DnCIa.js"])))=>i.map(i=>d[i]);
var V=Object.defineProperty;var R=(D,s,i)=>s in D?V(D,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):D[s]=i;var x=(D,s,i)=>R(D,typeof s!="symbol"?s+"":s,i);import{_ as w}from"./index-CCLTFbMI.js";import{query as L,collection as m,where as _,getDocs as O,orderBy as W,limit as k,getDoc as $,doc as U,updateDoc as z,serverTimestamp as C}from"./index.esm-CZcVTLdu.js";import{signOut as M,signInWithEmailAndPassword as q}from"./index.esm-Bm1DnCIa.js";import"./index.esm-COtph9ny.js";import"./mui-D8UjIA2s.js";import"./vendor-CjD1bmmO.js";import"./stripe-CUttI3Gx.js";const T=class T{static getInstance(){return T.instance||(T.instance=new T),T.instance}isWebOnlyMode(){return!0}getFirebaseAuthGuidance(s){switch(s){case"auth/user-not-found":return"User not found in Firebase Auth. Contact your administrator to create a Firebase Auth user for your email address.";case"auth/wrong-password":return"Incorrect password for Firebase Auth. Please check your password and try again.";case"auth/too-many-requests":return"Too many authentication attempts. Please wait a few minutes and try again.";case"auth/invalid-email":return"Invalid email format. Please check your email address.";case"auth/user-disabled":return"Your account has been disabled. Contact your administrator to re-enable your account.";case"auth/network-request-failed":return"Network error. Please check your internet connection and try again.";default:return"Firebase Auth authentication failed. This may prevent access to some features. Contact support if the issue persists."}}async checkFirebaseAuthUser(s){try{const{auth:i}=await w(async()=>{const{auth:a}=await import("./firebase-fk-SiQU0.js");return{auth:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{fetchSignInMethodsForEmail:o}=await w(async()=>{const{fetchSignInMethodsForEmail:a}=await import("./index.esm-Bm1DnCIa.js");return{fetchSignInMethodsForEmail:a}},__vite__mapDeps([8,6]));return(await o(i,s)).length>0}catch(i){return console.error("‚ùå [FirestoreLicenseService] Error checking Firebase Auth user:",i),!1}}async ensureFirebaseAuth(s,i){try{const{auth:o}=await w(async()=>{const{auth:a}=await import("./firebase-fk-SiQU0.js");return{auth:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));return o.currentUser&&o.currentUser.email===s?(console.log("‚úÖ [FirestoreLicenseService] Already authenticated with Firebase Auth"),!0):(o.currentUser&&(await M(o),console.log("üîÑ [FirestoreLicenseService] Signed out previous user")),await this.checkFirebaseAuthUser(s)?(console.log("üîë [FirestoreLicenseService] Authenticating with Firebase Auth..."),await q(o,s,i),console.log("‚úÖ [FirestoreLicenseService] Successfully authenticated with Firebase Auth"),!0):(console.warn("‚ö†Ô∏è [FirestoreLicenseService] User not found in Firebase Auth - may need to create Firebase Auth user"),console.log("üí° [FirestoreLicenseService] Contact your administrator to create a Firebase Auth user for this email"),!1))}catch(o){if(console.error("‚ùå [FirestoreLicenseService] Failed to authenticate with Firebase Auth:",o),o&&typeof o=="object"&&"code"in o){const n=o.code;n==="auth/user-not-found"?(console.warn("‚ö†Ô∏è [FirestoreLicenseService] User not found in Firebase Auth - may need to create Firebase Auth user"),console.log("üí° [FirestoreLicenseService] Contact your administrator to create a Firebase Auth user for this email")):n==="auth/wrong-password"?(console.warn("‚ö†Ô∏è [FirestoreLicenseService] Wrong password for Firebase Auth"),console.log("üí° [FirestoreLicenseService] Please check your password and try again")):n==="auth/too-many-requests"?console.warn("‚ö†Ô∏è [FirestoreLicenseService] Too many authentication attempts - please try again later"):n==="auth/invalid-email"?console.warn("‚ö†Ô∏è [FirestoreLicenseService] Invalid email format"):n==="auth/user-disabled"&&(console.warn("‚ö†Ô∏è [FirestoreLicenseService] User account has been disabled"),console.log("üí° [FirestoreLicenseService] Contact your administrator to re-enable your account"))}return!1}}async createFirebaseAuthUser(s,i){try{if(!this.isWebOnlyMode())throw new Error("FirestoreLicenseService should only be used in web-only mode");console.log("üîç [FirestoreLicenseService] Creating Firebase Auth user for:",s);const{auth:o}=await w(async()=>{const{auth:a}=await import("./firebase-fk-SiQU0.js");return{auth:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{createUserWithEmailAndPassword:n}=await w(async()=>{const{createUserWithEmailAndPassword:a}=await import("./index.esm-Bm1DnCIa.js");return{createUserWithEmailAndPassword:a}},__vite__mapDeps([8,6]));return await n(o,s,i),console.log("‚úÖ [FirestoreLicenseService] Successfully created Firebase Auth user"),!0}catch(o){if(console.error("‚ùå [FirestoreLicenseService] Failed to create Firebase Auth user:",o),o&&typeof o=="object"&&"code"in o&&o.code==="auth/email-already-in-use"){console.log("‚ÑπÔ∏è [FirestoreLicenseService] User already exists, trying to sign in...");try{return await this.ensureFirebaseAuth(s,i)}catch(n){return console.error("‚ùå [FirestoreLicenseService] Failed to sign in existing user:",n),!1}}return!1}}async isFirebaseAuthAuthenticated(){try{const{auth:s}=await w(async()=>{const{auth:i}=await import("./firebase-fk-SiQU0.js");return{auth:i}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));return s.currentUser!==null}catch(s){return console.error("‚ùå [FirestoreLicenseService] Error checking Firebase Auth status:",s),!1}}async getCurrentFirebaseUser(){try{const{auth:s}=await w(async()=>{const{auth:i}=await import("./firebase-fk-SiQU0.js");return{auth:i}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));return s.currentUser?{uid:s.currentUser.uid,email:s.currentUser.email}:null}catch(s){return console.error("‚ùå [FirestoreLicenseService] Error getting current Firebase user:",s),null}}async getMyLicenses(s,i,o){try{if(!this.isWebOnlyMode())throw new Error("FirestoreLicenseService should only be used in web-only mode");console.log("üîç [FirestoreLicenseService] Fetching licenses for user:",s),i&&o&&(await this.ensureFirebaseAuth(i,o)||console.warn("‚ö†Ô∏è [FirestoreLicenseService] Firebase Auth failed, trying without authentication"));const{db:n}=await w(async()=>{const{db:t}=await import("./firebase-fk-SiQU0.js");return{db:t}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),a=L(m(n,"licenses"),_("userId","==",s)),c=await O(a),r=[];return c.forEach(t=>{var d,u,y,l,A,p,g,v,I,h,F,b,S,E,f;const e=t.data();r.push({id:t.id,key:e.key||t.id,tier:(e.tier||e.type||"BASIC").toUpperCase(),status:(e.status||"ACTIVE").toUpperCase(),userId:e.userId,subscriptionId:e.subscriptionId,organizationId:e.organizationId,assignedToUserId:e.assignedToUserId,assignedToEmail:e.assignedToEmail,activatedAt:((y=(u=(d=e.activatedAt)==null?void 0:d.toDate)==null?void 0:u.call(d))==null?void 0:y.toISOString())||e.activatedAt,expiresAt:((p=(A=(l=e.expiresAt)==null?void 0:l.toDate)==null?void 0:A.call(l))==null?void 0:p.toISOString())||e.expiresAt||e.currentPeriodEnd,createdAt:((I=(v=(g=e.createdAt)==null?void 0:g.toDate)==null?void 0:v.call(g))==null?void 0:I.toISOString())||e.createdAt||new Date().toISOString(),updatedAt:((b=(F=(h=e.updatedAt)==null?void 0:h.toDate)==null?void 0:F.call(h))==null?void 0:b.toISOString())||e.updatedAt||new Date().toISOString(),maxActivations:e.maxActivations||1,activationCount:e.activationCount||0,currentPeriodEnd:((f=(E=(S=e.currentPeriodEnd)==null?void 0:S.toDate)==null?void 0:E.call(S))==null?void 0:f.toISOString())||e.currentPeriodEnd,type:e.type})}),console.log(`‚úÖ [FirestoreLicenseService] Found ${r.length} licenses for user`),r}catch(n){if(console.error("‚ùå [FirestoreLicenseService] Error fetching user licenses:",n),n&&typeof n=="object"&&"code"in n){const a=n.code,c=this.getFirebaseAuthGuidance(a);console.log("üí° [FirestoreLicenseService] User guidance:",c)}return[]}}async getLicensesByEmail(s){try{if(!this.isWebOnlyMode())throw new Error("FirestoreLicenseService should only be used in web-only mode");console.log("üîç [FirestoreLicenseService] Fetching licenses for email:",s);const{db:i}=await w(async()=>{const{db:c}=await import("./firebase-fk-SiQU0.js");return{db:c}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),o=L(m(i,"licenses"),_("assignedToEmail","==",s)),n=await O(o),a=[];return n.forEach(c=>{var t,e,d,u,y,l,A,p,g,v,I,h,F,b,S;const r=c.data();a.push({id:c.id,key:r.key||c.id,tier:(r.tier||r.type||"BASIC").toUpperCase(),status:(r.status||"ACTIVE").toUpperCase(),userId:r.userId,subscriptionId:r.subscriptionId,organizationId:r.organizationId,assignedToUserId:r.assignedToUserId,assignedToEmail:r.assignedToEmail,activatedAt:((d=(e=(t=r.activatedAt)==null?void 0:t.toDate)==null?void 0:e.call(t))==null?void 0:d.toISOString())||r.activatedAt,expiresAt:((l=(y=(u=r.expiresAt)==null?void 0:u.toDate)==null?void 0:y.call(u))==null?void 0:l.toISOString())||r.expiresAt||r.currentPeriodEnd,createdAt:((g=(p=(A=r.createdAt)==null?void 0:A.toDate)==null?void 0:p.call(A))==null?void 0:g.toISOString())||r.createdAt||new Date().toISOString(),updatedAt:((h=(I=(v=r.updatedAt)==null?void 0:v.toDate)==null?void 0:I.call(v))==null?void 0:h.toISOString())||r.updatedAt||new Date().toISOString(),maxActivations:r.maxActivations||1,activationCount:r.activationCount||0,currentPeriodEnd:((S=(b=(F=r.currentPeriodEnd)==null?void 0:F.toDate)==null?void 0:b.call(F))==null?void 0:S.toISOString())||r.currentPeriodEnd,type:r.type})}),console.log(`‚úÖ [FirestoreLicenseService] Found ${a.length} licenses for email`),a}catch(i){return console.error("‚ùå [FirestoreLicenseService] Error fetching licenses by email:",i),[]}}async getLicensesByFirebaseUid(s){try{if(!this.isWebOnlyMode())throw new Error("FirestoreLicenseService should only be used in web-only mode");console.log("üîç [FirestoreLicenseService] Fetching licenses by Firebase UID:",s);const{db:i}=await w(async()=>{const{db:c}=await import("./firebase-fk-SiQU0.js");return{db:c}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),o=L(m(i,"licenses"),_("firebaseUid","==",s)),n=await O(o),a=[];return n.forEach(c=>{var t,e,d,u,y,l,A,p,g,v,I,h,F,b,S;const r=c.data();a.push({id:c.id,key:r.key||c.id,tier:(r.tier||r.type||"BASIC").toUpperCase(),status:(r.status||"ACTIVE").toUpperCase(),userId:r.userId,subscriptionId:r.subscriptionId,organizationId:r.organizationId,assignedToUserId:r.assignedToUserId,assignedToEmail:r.assignedToEmail,activatedAt:((d=(e=(t=r.activatedAt)==null?void 0:t.toDate)==null?void 0:e.call(t))==null?void 0:d.toISOString())||r.activatedAt,expiresAt:((l=(y=(u=r.expiresAt)==null?void 0:u.toDate)==null?void 0:y.call(u))==null?void 0:l.toISOString())||r.expiresAt||r.currentPeriodEnd,createdAt:((g=(p=(A=r.createdAt)==null?void 0:A.toDate)==null?void 0:p.call(A))==null?void 0:g.toISOString())||r.createdAt||new Date().toISOString(),updatedAt:((h=(I=(v=r.updatedAt)==null?void 0:v.toDate)==null?void 0:I.call(v))==null?void 0:h.toISOString())||r.updatedAt||new Date().toISOString(),maxActivations:r.maxActivations||1,activationCount:r.activationCount||0,currentPeriodEnd:((S=(b=(F=r.currentPeriodEnd)==null?void 0:F.toDate)==null?void 0:b.call(F))==null?void 0:S.toISOString())||r.currentPeriodEnd,type:r.type})}),console.log(`‚úÖ [FirestoreLicenseService] Found ${a.length} licenses by Firebase UID`),a}catch(i){return console.error("‚ùå [FirestoreLicenseService] Error fetching licenses by Firebase UID:",i),[]}}async getAllLicenses(s=200,i,o){try{if(!this.isWebOnlyMode())throw new Error("FirestoreLicenseService should only be used in web-only mode");console.log("üîç [FirestoreLicenseService] Fetching all licenses (admin)"),i&&o&&(await this.ensureFirebaseAuth(i,o)||console.warn("‚ö†Ô∏è [FirestoreLicenseService] Firebase Auth failed, trying without authentication"));const{db:n}=await w(async()=>{const{db:t}=await import("./firebase-fk-SiQU0.js");return{db:t}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),a=L(m(n,"licenses"),W("createdAt","desc"),k(s)),c=await O(a),r=[];return c.forEach(t=>{var d,u,y,l,A,p,g,v,I,h,F,b,S,E,f;const e=t.data();r.push({id:t.id,key:e.key||t.id,tier:(e.tier||e.type||"BASIC").toUpperCase(),status:(e.status||"ACTIVE").toUpperCase(),userId:e.userId,subscriptionId:e.subscriptionId,organizationId:e.organizationId,assignedToUserId:e.assignedToUserId,assignedToEmail:e.assignedToEmail,activatedAt:((y=(u=(d=e.activatedAt)==null?void 0:d.toDate)==null?void 0:u.call(d))==null?void 0:y.toISOString())||e.activatedAt,expiresAt:((p=(A=(l=e.expiresAt)==null?void 0:l.toDate)==null?void 0:A.call(l))==null?void 0:p.toISOString())||e.expiresAt||e.currentPeriodEnd,createdAt:((I=(v=(g=e.createdAt)==null?void 0:g.toDate)==null?void 0:v.call(g))==null?void 0:I.toISOString())||e.createdAt||new Date().toISOString(),updatedAt:((b=(F=(h=e.updatedAt)==null?void 0:h.toDate)==null?void 0:F.call(h))==null?void 0:b.toISOString())||e.updatedAt||new Date().toISOString(),maxActivations:e.maxActivations||1,activationCount:e.activationCount||0,currentPeriodEnd:((f=(E=(S=e.currentPeriodEnd)==null?void 0:S.toDate)==null?void 0:E.call(S))==null?void 0:f.toISOString())||e.currentPeriodEnd,type:e.type})}),console.log(`‚úÖ [FirestoreLicenseService] Found ${r.length} total licenses`),r}catch(n){if(console.error("‚ùå [FirestoreLicenseService] Error fetching all licenses:",n),n&&typeof n=="object"&&"code"in n){const a=n.code,c=this.getFirebaseAuthGuidance(a);console.log("üí° [FirestoreLicenseService] User guidance:",c)}return[]}}async getAllAccessibleLicenses(s,i){try{if(!this.isWebOnlyMode())throw new Error("FirestoreLicenseService should only be used in web-only mode");console.log("üîç [FirestoreLicenseService] Fetching all accessible licenses (fallback method)"),s&&i&&(await this.ensureFirebaseAuth(s,i)||console.warn("‚ö†Ô∏è [FirestoreLicenseService] Firebase Auth failed, trying without authentication"));const{db:o}=await w(async()=>{const{db:r}=await import("./firebase-fk-SiQU0.js");return{db:r}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),n=L(m(o,"licenses"),k(200)),a=await O(n),c=[];return a.forEach(r=>{var e,d,u,y,l,A,p,g,v,I,h,F,b,S,E;const t=r.data();c.push({id:r.id,key:t.key||r.id,tier:(t.tier||t.type||"BASIC").toUpperCase(),status:(t.status||"ACTIVE").toUpperCase(),userId:t.userId,subscriptionId:t.subscriptionId,organizationId:t.organizationId,assignedToUserId:t.assignedToUserId,assignedToEmail:t.assignedToEmail,activatedAt:((u=(d=(e=t.activatedAt)==null?void 0:e.toDate)==null?void 0:d.call(e))==null?void 0:u.toISOString())||t.activatedAt,expiresAt:((A=(l=(y=t.expiresAt)==null?void 0:y.toDate)==null?void 0:l.call(y))==null?void 0:A.toISOString())||t.expiresAt||t.currentPeriodEnd,createdAt:((v=(g=(p=t.createdAt)==null?void 0:p.toDate)==null?void 0:g.call(p))==null?void 0:v.toISOString())||t.createdAt||new Date().toISOString(),updatedAt:((F=(h=(I=t.updatedAt)==null?void 0:I.toDate)==null?void 0:h.call(I))==null?void 0:F.toISOString())||t.updatedAt||new Date().toISOString(),maxActivations:t.maxActivations||1,activationCount:t.activationCount||0,currentPeriodEnd:((E=(S=(b=t.currentPeriodEnd)==null?void 0:b.toDate)==null?void 0:S.call(b))==null?void 0:E.toISOString())||t.currentPeriodEnd,type:t.type})}),console.log(`‚úÖ [FirestoreLicenseService] Found ${c.length} total accessible licenses`),c}catch(o){return console.error("‚ùå [FirestoreLicenseService] Error fetching all accessible licenses:",o),[]}}async getUserInfoByFirebaseUid(s){try{const{db:i}=await w(async()=>{const{db:r}=await import("./firebase-fk-SiQU0.js");return{db:r}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),o=L(m(i,"users"),_("firebaseUid","==",s)),n=await O(o);if(n.empty)return console.log("‚ÑπÔ∏è [FirestoreLicenseService] No user found with Firebase UID:",s),null;const a=n.docs[0],c=a.data();return{id:a.id,email:c.email,name:c.name,role:c.role,organizationId:c.organizationId}}catch(i){return console.error("‚ùå [FirestoreLicenseService] Error fetching user info by Firebase UID:",i),null}}async getUserInfo(s){try{const{db:i}=await w(async()=>{const{db:n}=await import("./firebase-fk-SiQU0.js");return{db:n}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),o=await $(U(i,"users",s));if(o.exists()){const n=o.data();return{id:o.id,email:n.email,name:n.name,role:n.role,organizationId:n.organizationId}}return null}catch(i){return console.error("‚ùå [FirestoreLicenseService] Error fetching user info:",i),null}}async assignLicense(s,i){try{if(!this.isWebOnlyMode())throw new Error("FirestoreLicenseService should only be used in web-only mode");console.log(`üîç [FirestoreLicenseService] Assigning license ${s} to ${i}`);const{db:o}=await w(async()=>{const{db:d}=await import("./firebase-fk-SiQU0.js");return{db:d}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),n=L(m(o,"licenses"),_("assignedToEmail","==",i)),a=await O(n);if(!a.empty){const d=a.docs.map(u=>({id:u.id,...u.data()}));if(console.warn(`‚ö†Ô∏è [FirestoreLicenseService] User ${i} already has ${d.length} licenses assigned`),d.some(u=>u.id===s))return console.log(`‚úÖ [FirestoreLicenseService] License ${s} is already assigned to ${i}`),!0;throw new Error(`User ${i} already has a license assigned. Please unassign it first.`)}const c=L(m(o,"users"),_("email","==",i)),r=await O(c);let t=null;r.empty||(t=r.docs[0].id);const e=U(o,"licenses",s);return await z(e,{assignedToUserId:t||"pending",assignedToEmail:i,assignedAt:C(),updatedAt:C()}),console.log(`‚úÖ [FirestoreLicenseService] Successfully assigned license ${s} to ${i}`),!0}catch(o){throw console.error("‚ùå [FirestoreLicenseService] Failed to assign license:",o),o}}async getOrganizationLicenses(s,i,o){try{if(console.log(`üîç [FirestoreLicenseService] getOrganizationLicenses called with orgId: ${s}`),!this.isWebOnlyMode())throw console.log("‚ùå [FirestoreLicenseService] Not in web-only mode, rejecting request"),new Error("FirestoreLicenseService should only be used in web-only mode");console.log("‚úÖ [FirestoreLicenseService] Web-only mode confirmed"),console.log("üîç [FirestoreLicenseService] Fetching licenses for organization:",s),i&&o&&(await this.ensureFirebaseAuth(i,o)||console.warn("‚ö†Ô∏è [FirestoreLicenseService] Firebase Auth failed, trying without authentication"));const{db:n}=await w(async()=>{const{db:t}=await import("./firebase-fk-SiQU0.js");return{db:t}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));console.log("‚úÖ [FirestoreLicenseService] Firebase imported successfully");const a=L(m(n,"licenses"),_("organizationId","==",s));console.log("üîç [FirestoreLicenseService] Executing query for organization licenses...");const c=await O(a);console.log(`‚úÖ [FirestoreLicenseService] Query completed, found ${c.size} documents`);const r=[];return c.forEach(t=>{var d,u,y,l,A,p,g,v,I,h,F,b,S,E,f;const e=t.data();console.log(`üìÑ [FirestoreLicenseService] Processing document ${t.id}:`,{organizationId:e.organizationId,assignedToUserId:e.assignedToUserId,assignedToEmail:e.assignedToEmail,status:e.status}),r.push({id:t.id,key:e.key||t.id,tier:(e.tier||e.type||"BASIC").toUpperCase(),status:(e.status||"ACTIVE").toUpperCase(),userId:e.userId,subscriptionId:e.subscriptionId,organizationId:e.organizationId,assignedToUserId:e.assignedToUserId,assignedToEmail:e.assignedToEmail,activatedAt:((y=(u=(d=e.activatedAt)==null?void 0:d.toDate)==null?void 0:u.call(d))==null?void 0:y.toISOString())||e.activatedAt,expiresAt:((p=(A=(l=e.expiresAt)==null?void 0:l.toDate)==null?void 0:A.call(l))==null?void 0:p.toISOString())||e.expiresAt||e.currentPeriodEnd,createdAt:((I=(v=(g=e.createdAt)==null?void 0:g.toDate)==null?void 0:v.call(g))==null?void 0:I.toISOString())||e.createdAt||new Date().toISOString(),updatedAt:((b=(F=(h=e.updatedAt)==null?void 0:h.toDate)==null?void 0:F.call(h))==null?void 0:b.toISOString())||e.updatedAt||new Date().toISOString(),maxActivations:e.maxActivations||1,activationCount:e.activationCount||0,currentPeriodEnd:((f=(E=(S=e.currentPeriodEnd)==null?void 0:S.toDate)==null?void 0:E.call(S))==null?void 0:f.toISOString())||e.currentPeriodEnd,type:e.type})}),console.log(`‚úÖ [FirestoreLicenseService] Found ${r.length} licenses for organization`),r}catch(n){if(console.error("‚ùå [FirestoreLicenseService] Error fetching organization licenses:",n),n&&typeof n=="object"&&"code"in n){const a=n.code,c=this.getFirebaseAuthGuidance(a);console.log("üí° [FirestoreLicenseService] User guidance:",c)}return[]}}async getUnassignedLicenses(s,i,o){try{if(console.log(`üîç [FirestoreLicenseService] getUnassignedLicenses called with orgId: ${s}`),!this.isWebOnlyMode())throw console.log("‚ùå [FirestoreLicenseService] Not in web-only mode, rejecting request"),new Error("FirestoreLicenseService should only be used in web-only mode");console.log("‚úÖ [FirestoreLicenseService] Web-only mode confirmed"),console.log("üîç [FirestoreLicenseService] Fetching unassigned licenses for organization:",s),i&&o&&(await this.ensureFirebaseAuth(i,o)||console.warn("‚ö†Ô∏è [FirestoreLicenseService] Firebase Auth failed, trying without authentication"));const{db:n}=await w(async()=>{const{db:a}=await import("./firebase-fk-SiQU0.js");return{db:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));console.log("‚úÖ [FirestoreLicenseService] Firebase imported successfully");try{console.log("üîç [FirestoreLicenseService] Attempting composite query...");const a=L(m(n,"licenses"),_("organizationId","==",s),_("assignedToUserId","==",null));console.log("üîç [FirestoreLicenseService] Executing composite query for unassigned licenses...");const c=await O(a);console.log(`‚úÖ [FirestoreLicenseService] Composite query completed, found ${c.size} documents`);const r=[];return c.forEach(t=>{var d,u,y,l,A,p,g,v,I,h,F,b,S,E,f;const e=t.data();console.log(`üìÑ [FirestoreLicenseService] Processing document ${t.id}:`,{organizationId:e.organizationId,assignedToUserId:e.assignedToUserId,assignedToEmail:e.assignedToEmail,status:e.status}),r.push({id:t.id,key:e.key||t.id,tier:(e.tier||e.type||"BASIC").toUpperCase(),status:(e.status||"ACTIVE").toUpperCase(),userId:e.userId,subscriptionId:e.subscriptionId,organizationId:e.organizationId,assignedToUserId:e.assignedToUserId,assignedToEmail:e.assignedToEmail,activatedAt:((y=(u=(d=e.activatedAt)==null?void 0:d.toDate)==null?void 0:u.call(d))==null?void 0:y.toISOString())||e.activatedAt,expiresAt:((p=(A=(l=e.expiresAt)==null?void 0:l.toDate)==null?void 0:A.call(l))==null?void 0:p.toISOString())||e.expiresAt||e.currentPeriodEnd,createdAt:((I=(v=(g=e.createdAt)==null?void 0:g.toDate)==null?void 0:v.call(g))==null?void 0:I.toISOString())||e.createdAt||new Date().toISOString(),updatedAt:((b=(F=(h=e.updatedAt)==null?void 0:h.toDate)==null?void 0:F.call(h))==null?void 0:b.toISOString())||e.updatedAt||new Date().toISOString(),maxActivations:e.maxActivations||1,activationCount:e.activationCount||0,currentPeriodEnd:((f=(E=(S=e.currentPeriodEnd)==null?void 0:S.toDate)==null?void 0:E.call(S))==null?void 0:f.toISOString())||e.currentPeriodEnd,type:e.type})}),console.log(`‚úÖ [FirestoreLicenseService] Found ${r.length} unassigned licenses for organization`),r}catch(a){console.log("üîÑ [FirestoreLicenseService] Composite query failed, falling back to client-side filtering..."),console.log("üìù [FirestoreLicenseService] Composite query error:",a);const r=(await this.getOrganizationLicenses(s,i,o)).filter(t=>t.status==="ACTIVE"&&!t.assignedToUserId&&!t.assignedToEmail);return console.log(`‚úÖ [FirestoreLicenseService] Client-side filtering found ${r.length} unassigned licenses`),r}}catch(n){console.error("‚ùå [FirestoreLicenseService] Error fetching unassigned licenses:",n);try{console.log("üîÑ [FirestoreLicenseService] Final fallback to client-side filtering...");const c=(await this.getOrganizationLicenses(s,i,o)).filter(r=>r.status==="ACTIVE"&&!r.assignedToUserId&&!r.assignedToEmail);return console.log(`‚úÖ [FirestoreLicenseService] Final fallback found ${c.length} unassigned licenses`),c}catch(a){return console.error("‚ùå [FirestoreLicenseService] Final fallback also failed:",a),[]}}}async getAllUnassignedLicenses(s,i){try{if(!this.isWebOnlyMode())throw new Error("FirestoreLicenseService should only be used in web-only mode");console.log("üîç [FirestoreLicenseService] Fetching all unassigned licenses"),s&&i&&(await this.ensureFirebaseAuth(s,i)||console.warn("‚ö†Ô∏è [FirestoreLicenseService] Firebase Auth failed, trying without authentication"));const{db:o}=await w(async()=>{const{db:n}=await import("./firebase-fk-SiQU0.js");return{db:n}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));try{const n=L(m(o,"licenses"),_("assignedToUserId","==",null)),a=await O(n),c=[];return a.forEach(r=>{var e,d,u,y,l,A,p,g,v,I,h,F,b,S,E;const t=r.data();c.push({id:r.id,key:t.key||r.id,tier:(t.tier||t.type||"BASIC").toUpperCase(),status:(t.status||"ACTIVE").toUpperCase(),userId:t.userId,subscriptionId:t.subscriptionId,organizationId:t.organizationId,assignedToUserId:t.assignedToUserId,assignedToEmail:t.assignedToEmail,activatedAt:((u=(d=(e=t.activatedAt)==null?void 0:e.toDate)==null?void 0:d.call(e))==null?void 0:u.toISOString())||t.activatedAt,expiresAt:((A=(l=(y=t.expiresAt)==null?void 0:y.toDate)==null?void 0:l.call(y))==null?void 0:A.toISOString())||t.expiresAt||t.currentPeriodEnd,createdAt:((v=(g=(p=t.createdAt)==null?void 0:p.toDate)==null?void 0:g.call(p))==null?void 0:v.toISOString())||t.createdAt||new Date().toISOString(),updatedAt:((F=(h=(I=t.updatedAt)==null?void 0:I.toDate)==null?void 0:h.call(I))==null?void 0:F.toISOString())||t.updatedAt||new Date().toISOString(),maxActivations:t.maxActivations||1,activationCount:t.activationCount||0,currentPeriodEnd:((E=(S=(b=t.currentPeriodEnd)==null?void 0:b.toDate)==null?void 0:S.call(b))==null?void 0:E.toISOString())||t.currentPeriodEnd,type:t.type})}),console.log(`‚úÖ [FirestoreLicenseService] Found ${c.length} total unassigned licenses`),c}catch{console.log("üîÑ [FirestoreLicenseService] Direct query failed, using fallback method...");const c=(await this.getAllAccessibleLicenses(s,i)).filter(r=>r.status==="ACTIVE"&&!r.assignedToUserId&&!r.assignedToEmail);return console.log(`‚úÖ [FirestoreLicenseService] Fallback found ${c.length} unassigned licenses`),c}}catch(o){return console.error("‚ùå [FirestoreLicenseService] Error fetching all unassigned licenses:",o),[]}}async unassignLicense(s){try{if(!this.isWebOnlyMode())throw new Error("FirestoreLicenseService should only be used in web-only mode");console.log(`üîç [FirestoreLicenseService] Unassigning license ${s}`);const{db:i}=await w(async()=>{const{db:c}=await import("./firebase-fk-SiQU0.js");return{db:c}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),o=U(i,"licenses",s),n=await $(o);if(!n.exists())throw console.warn(`‚ö†Ô∏è [FirestoreLicenseService] License ${s} not found`),new Error(`License ${s} not found`);const a=n.data();return!a.assignedToUserId&&!a.assignedToEmail?(console.log(`‚ÑπÔ∏è [FirestoreLicenseService] License ${s} is not assigned to anyone`),!0):(console.log(`üîç [FirestoreLicenseService] Unassigning license ${s} from ${a.assignedToEmail||"unknown user"}`),await z(o,{assignedToUserId:null,assignedToEmail:null,assignedAt:null,updatedAt:C()}),console.log(`‚úÖ [FirestoreLicenseService] Successfully unassigned license ${s}`),!0)}catch(i){throw console.error("‚ùå [FirestoreLicenseService] Failed to unassign license:",i),i}}};x(T,"instance");let P=T;const K=P.getInstance();export{P as FirestoreLicenseService,K as firestoreLicenseService};
