import{j as e,B as y,b as _s,a9 as Js,T as g,r as D,G as C,t as de,v as ue,al as Ks,b2 as Ce,aa as qe,aj as _e,c as X,b7 as Xs,b8 as Ie,e as N,I as ae,g as V,c6 as Je,br as Ke,a as U,a5 as S,aq as De,ar as ne,as as ie,at as $,au as o,av as oe,aI as fs,aH as Zs,Q as Xe,b1 as et,c7 as st,ay as Ee,az as Pe,aB as Ue,aC as vs,aD as Ss,aE as As,aF as Ne,c8 as tt,d as ws,o as rt,p as at}from"./mui-Cr9U6iW2.js";import{u as nt,e as it,r as f}from"./vendor-CjD1bmmO.js";import{u as ot}from"./notistack.esm-Ca-E78ev.js";import{c as G,e as q,u as lt}from"./index-6RET3WBQ.js";import{query as T,collection as O,getDocs as W,where as Q,orderBy as ke,limit as le,getDoc as Re,doc as ce,Timestamp as ct,updateDoc as dt}from"./index.esm-B4qVkIPL.js";import{isWebOnlyMode as ut,db as k}from"./firebase-D3yviM3L.js";import{COLLECTIONS as R}from"./FirestoreCollectionManager-ZjCuqfsF.js";import"./stripe-ggaMUove.js";import"./index.esm-DmQE6AXN.js";import"./index.esm-DeaBpi77.js";class B{static isWebOnlyMode(){return ut()}static async getDashboardStats(){const r=this.isWebOnlyMode();return console.log(`üîç [AdminDashboardService] Mode detection: webOnlyMode=${r}, hostname=${window.location.hostname}`),r?(console.log("üìä [AdminDashboardService] Using Firestore direct access (webonly mode)"),this.getDashboardStatsFromFirestore()):(console.log("üåê [AdminDashboardService] Using API endpoints (non-webonly mode)"),this.getDashboardStatsFromAPI())}static async getDashboardStatsFromFirestore(){try{const r=T(O(k,R.USERS)),a=(await W(r)).size,n=T(O(k,R.SUBSCRIPTIONS),Q("status","==","ACTIVE")),p=(await W(n)).size;let j=0;const h=[];try{const x=T(O(k,R.PAYMENTS),Q("status","==","succeeded"),ke("createdAt","desc"),le(10));(await W(x)).forEach(c=>{const I=c.data(),b={id:c.id,...I};h.push(b),I.amount&&typeof I.amount=="number"&&(j+=I.amount)})}catch(x){console.warn("‚ö†Ô∏è [AdminDashboardService] Could not fetch from PAYMENTS collection:",x)}try{const x=T(O(k,R.INVOICES),ke("createdAt","desc"),le(10));(await W(x)).forEach(c=>{const I={id:c.id,...c.data()};h.push(I)})}catch(x){console.warn("‚ö†Ô∏è [AdminDashboardService] Could not fetch from INVOICES collection:",x)}j=0;try{const x=T(O(k,R.PAYMENTS),Q("status","==","succeeded")),i=await W(x);i.forEach(c=>{const I=c.data();I.amount&&typeof I.amount=="number"&&(j+=I.amount)}),console.log(`üí∞ [AdminDashboardService] Revenue from ${i.size} payments: $${j}`)}catch(x){console.warn("‚ö†Ô∏è [AdminDashboardService] Could not fetch all payments:",x);try{const i=T(O(k,R.INVOICES),Q("status","==","succeeded")),c=await W(i);c.forEach(I=>{const b=I.data();b.amount&&typeof b.amount=="number"&&(j+=b.amount)}),console.log(`üí∞ [AdminDashboardService] Fallback revenue from ${c.size} invoices: $${j}`)}catch(i){console.warn("‚ö†Ô∏è [AdminDashboardService] Could not fetch invoices either:",i)}}return{totalUsers:a,activeSubscriptions:p,totalRevenue:j,pendingApprovals:0,systemHealth:"healthy",recentPayments:h}}catch(r){return console.error("Error getting dashboard stats from Firestore:",r),{totalUsers:0,activeSubscriptions:0,totalRevenue:0,pendingApprovals:0,systemHealth:"error"}}}static async getDashboardStatsFromAPI(){var r,l;try{const n=((l=(r=(await G.get(q.admin.dashboardStats())).data)==null?void 0:r.data)==null?void 0:l.stats)||{};console.log("üåê [AdminDashboardService] Raw API response:",JSON.stringify(n,null,2)),console.log(`üí∞ [AdminDashboardService] API totalRevenue: ${n.totalRevenue} (type: ${typeof n.totalRevenue})`);const u={totalUsers:n.totalUsers||0,activeSubscriptions:n.activeSubscriptions||0,totalRevenue:n.totalRevenue||0,pendingApprovals:n.pendingApprovals||0,systemHealth:n.systemHealth||"healthy",recentPayments:n.recentPayments||[]};return console.log("üìä [AdminDashboardService] Processed API result:",JSON.stringify(u,null,2)),u}catch(a){throw console.error("‚ùå [AdminDashboardService] Error getting dashboard stats from API:",a),a}}static async getUsers(r=1,l=100){return this.isWebOnlyMode()?this.getUsersFromFirestore(r,l):this.getUsersFromAPI(r,l)}static async getUsersFromFirestore(r,l){var a,n,u;try{let p=T(O(k,R.USERS),ke("createdAt","desc"),le(l));r>1;const j=await W(p),h=[];for(const x of j.docs){const i=x.data(),c=T(O(k,R.SUBSCRIPTIONS),Q("userId","==",x.id),Q("status","==","ACTIVE")),I=await W(c),b=[];I.forEach(v=>{b.push({id:v.id,...v.data()})});const E={id:x.id,email:i.email||"",firstName:i.firstName||((a=i.name)==null?void 0:a.split(" ")[0])||"",lastName:i.lastName||((n=i.name)==null?void 0:n.split(" ").slice(1).join(" "))||"",name:i.name||`${i.firstName||""} ${i.lastName||""}`.trim(),role:i.role||"USER",status:i.status||"active",subscription:(u=b[0])==null?void 0:u.tier,lastLogin:i.lastLoginAt||i.updatedAt||i.createdAt,createdAt:i.createdAt,subscriptions:b};h.push(E)}return{users:h,pagination:{page:r,limit:l,total:h.length,pages:1}}}catch(p){return console.error("Error getting users from Firestore:",p),{users:[]}}}static async getUsersFromAPI(r,l){var a,n,u,p;try{const j=await G.get(`${q.admin.users()}?page=${r}&limit=${l}`),h=((n=(a=j.data)==null?void 0:a.data)==null?void 0:n.users)||[],x=(p=(u=j.data)==null?void 0:u.data)==null?void 0:p.pagination;return{users:h.map(c=>{var I,b,E,v,_;return{id:c.id,email:c.email,firstName:((I=c.name)==null?void 0:I.split(" ")[0])||"",lastName:((b=c.name)==null?void 0:b.split(" ").slice(1).join(" "))||"",name:c.name,role:c.role,status:((E=c.status)==null?void 0:E.toLowerCase())||"active",subscription:(_=(v=c.subscriptions)==null?void 0:v[0])==null?void 0:_.tier,lastLogin:c.lastLoginAt||new Date().toISOString(),createdAt:c.createdAt||new Date().toISOString(),subscriptions:c.subscriptions||[]}}),pagination:x}}catch(j){throw console.error("‚ùå [AdminDashboardService] Error getting users from API:",j),j}}static async getUserDetails(r){return this.isWebOnlyMode()?this.getUserDetailsFromFirestore(r):this.getUserDetailsFromAPI(r)}static async getUserDetailsFromFirestore(r){var l,a,n;try{console.log("üîç [AdminDashboardService] Getting user details from Firestore:",r);const u=await Re(ce(k,R.USERS,r));if(!u.exists())throw new Error("User not found");const p=u.data(),j=T(O(k,R.SUBSCRIPTIONS),Q("userId","==",r)),h=await W(j),x=[];h.forEach(E=>{x.push({id:E.id,...E.data()})});const i=T(O(k,R.LICENSES),Q("userId","==",r)),c=await W(i),I=[];c.forEach(E=>{const v=E.data();I.push({id:E.id,key:v.key||"",userId:v.userId||r,userEmail:p.email||"",tier:v.tier||"BASIC",status:v.status||"active",activatedAt:v.activatedAt||v.createdAt,expiresAt:v.expiresAt||v.createdAt,lastUsed:v.updatedAt||v.createdAt})});const b={id:u.id,email:p.email||"",firstName:p.firstName||((l=p.name)==null?void 0:l.split(" ")[0])||"",lastName:p.lastName||((a=p.name)==null?void 0:a.split(" ").slice(1).join(" "))||"",name:p.name||`${p.firstName||""} ${p.lastName||""}`.trim(),role:p.role||"USER",status:p.status||"active",subscription:(n=x[0])==null?void 0:n.tier,lastLogin:p.lastLoginAt||p.updatedAt||p.createdAt,createdAt:p.createdAt,subscriptions:x};return console.log("‚úÖ [AdminDashboardService] User details retrieved from Firestore"),{user:b,subscriptions:x,licenses:I}}catch(u){throw console.error("‚ùå [AdminDashboardService] Error getting user details from Firestore:",u),u}}static async getUserDetailsFromAPI(r){var l,a,n,u,p,j,h;try{const i=((l=(await G.get(q.admin.userDetails(r))).data)==null?void 0:l.data)||{},c=i.user||{},I=((a=i.user)==null?void 0:a.subscriptions)||[],b=(((n=i.user)==null?void 0:n.licenses)||[]).map(v=>({id:v.id,key:v.key,userId:v.userId||r,userEmail:c.email,tier:v.tier,status:v.status,activatedAt:v.activatedAt||v.createdAt,expiresAt:v.expiresAt||v.createdAt,lastUsed:v.updatedAt||v.createdAt}));return{user:{id:c.id||r,email:c.email||"",firstName:c.firstName||((u=c.name)==null?void 0:u.split(" ")[0])||"",lastName:c.lastName||((p=c.name)==null?void 0:p.split(" ").slice(1).join(" "))||"",name:c.name,role:c.role||"USER",status:((j=c.status)==null?void 0:j.toLowerCase())||"active",subscription:(h=I[0])==null?void 0:h.tier,lastLogin:c.lastLoginAt||new Date().toISOString(),createdAt:c.createdAt||new Date().toISOString(),subscriptions:I},subscriptions:I,licenses:b}}catch(x){throw console.error("‚ùå [AdminDashboardService] Error getting user details from API:",x),x}}static async updateUser(r,l){return this.isWebOnlyMode()?this.updateUserInFirestore(r,l):this.updateUserViaAPI(r,l)}static async updateUserInFirestore(r,l){try{console.log("üîç [AdminDashboardService] Updating user in Firestore:",r,l);const a=ce(k,R.USERS,r),n={updatedAt:ct.now()};l.role&&(n.role=l.role),l.status&&(n.status=l.status.toLowerCase()),await dt(a,n),console.log("‚úÖ [AdminDashboardService] User updated in Firestore")}catch(a){throw console.error("‚ùå [AdminDashboardService] Error updating user in Firestore:",a),a}}static async updateUserViaAPI(r,l){var a;try{await G.put(q.admin.updateUser(r),{role:l.role,status:(a=l.status)==null?void 0:a.toUpperCase()})}catch(n){throw console.error("‚ùå [AdminDashboardService] Error updating user via API:",n),n}}static async getPayments(r=1,l=100,a){return this.isWebOnlyMode()?this.getPaymentsFromFirestore(r,l,a):this.getPaymentsFromAPI(r,l,a)}static async getPaymentsFromFirestore(r,l,a){try{console.log("üîç [AdminDashboardService] Getting payments from Firestore...");const n=[];try{let h=T(O(k,R.PAYMENTS),ke("createdAt","desc"),le(l));a!=null&&a.status&&(h=T(h,Q("status","==",a.status)));const x=await W(h);for(const i of x.docs){const c=i.data();let I={};if(c.userId)try{const E=await Re(ce(k,R.USERS,c.userId));if(E.exists()){const v=E.data();I={email:v.email,name:v.name||`${v.firstName||""} ${v.lastName||""}`.trim()}}}catch{console.warn("Could not fetch user data for payment:",i.id)}const b={id:i.id,amount:c.amount||0,status:c.status||"unknown",createdAt:c.createdAt,user:I,subscription:c.subscription||{}};n.push(b)}console.log("‚úÖ [AdminDashboardService] Payments retrieved from PAYMENTS collection:",x.size)}catch(h){console.warn("‚ö†Ô∏è [AdminDashboardService] Could not fetch from PAYMENTS collection:",h)}console.log("‚ÑπÔ∏è [AdminDashboardService] Skipping INVOICES collection - using PAYMENTS only for accurate data"),n.sort((h,x)=>{const i=h.createdAt instanceof Date?h.createdAt:new Date(h.createdAt);return(x.createdAt instanceof Date?x.createdAt:new Date(x.createdAt)).getTime()-i.getTime()});const u=(r-1)*l,p=u+l,j=n.slice(u,p);return console.log("‚úÖ [AdminDashboardService] Total payments/invoices retrieved:",n.length),{payments:j,pagination:{page:r,limit:l,total:n.length,pages:Math.ceil(n.length/l)}}}catch(n){return console.error("‚ùå [AdminDashboardService] Error getting payments from Firestore:",n),{payments:[]}}}static async getPaymentsFromAPI(r,l,a){var n,u,p,j;try{const h=new URLSearchParams;h.set("page",String(r)),h.set("limit",String(l)),a!=null&&a.status&&h.set("status",a.status),a!=null&&a.email&&h.set("email",a.email),a!=null&&a.from&&h.set("from",a.from),a!=null&&a.to&&h.set("to",a.to);const x=await G.get(`${q.admin.payments()}?${h.toString()}`),i=((u=(n=x.data)==null?void 0:n.data)==null?void 0:u.payments)||[],c=(j=(p=x.data)==null?void 0:p.data)==null?void 0:j.pagination;return{payments:i.map(b=>({id:b.id,amount:b.amount||0,status:b.status||"unknown",createdAt:b.createdAt,user:b.user||{},subscription:b.subscription||{}})),pagination:c}}catch(h){throw console.error("‚ùå [AdminDashboardService] Error getting payments from API:",h),h}}static async getSystemHealth(){return this.isWebOnlyMode()?this.getSystemHealthFromFirestore():this.getSystemHealthFromAPI()}static async getSystemHealthFromFirestore(){try{console.log("üîç [AdminDashboardService] Checking system health from Firestore...");const r=Date.now(),l=T(O(k,R.USERS),le(1));await W(l);const a=Date.now()-r,n={overall:"healthy",checkedAt:new Date().toISOString(),database:{status:a<1e3?"healthy":a<3e3?"degraded":"unhealthy",responseTimeMs:a,message:`Database responding in ${a}ms`},email:{status:"healthy",message:"Email service status unknown in webonly mode"},payment:{status:"healthy",message:"Payment service status unknown in webonly mode"}},u=[n.database.status,n.email.status,n.payment.status];return u.includes("unhealthy")?n.overall="unhealthy":u.includes("degraded")&&(n.overall="degraded"),console.log("‚úÖ [AdminDashboardService] System health checked from Firestore"),n}catch(r){return console.error("‚ùå [AdminDashboardService] Error checking system health from Firestore:",r),{overall:"unhealthy",checkedAt:new Date().toISOString(),database:{status:"unhealthy",error:r instanceof Error?r.message:"Unknown error"},email:{status:"disabled",message:"Cannot check email service in webonly mode"},payment:{status:"disabled",message:"Cannot check payment service in webonly mode"}}}}static async getSystemHealthFromAPI(){var r,l,a;try{const n=await G.get(q.admin.systemHealth()),u=((l=(r=n.data)==null?void 0:r.data)==null?void 0:l.health)||((a=n.data)==null?void 0:a.data);return{overall:(u==null?void 0:u.overall)||(u==null?void 0:u.status)||"healthy",checkedAt:(u==null?void 0:u.checkedAt)||new Date().toISOString(),database:(u==null?void 0:u.database)||{status:"healthy"},email:(u==null?void 0:u.email)||{status:"healthy"},payment:(u==null?void 0:u.payment)||{status:"healthy"}}}catch(n){throw console.error("‚ùå [AdminDashboardService] Error getting system health from API:",n),n}}static async getPaymentDetails(r){return this.isWebOnlyMode()?this.getPaymentDetailsFromFirestore(r):this.getPaymentDetailsFromAPI(r)}static async getPaymentDetailsFromFirestore(r){try{console.log("üîç [AdminDashboardService] Getting payment details from Firestore:",r);const l=await Re(ce(k,R.PAYMENTS,r));if(!l.exists())throw new Error("Payment not found");const a=l.data();let n={};if(a.userId){const j=await Re(ce(k,R.USERS,a.userId));if(j.exists()){const h=j.data();n={email:h.email,name:h.name||`${h.firstName||""} ${h.lastName||""}`.trim()}}}const u={id:l.id,amount:a.amount||0,status:a.status||"unknown",createdAt:a.createdAt,user:n,subscription:a.subscription||{}},p=[];if(a.userId){const j=T(O(k,R.LICENSES),Q("userId","==",a.userId));(await W(j)).forEach(x=>{const i=x.data();p.push({id:x.id,key:i.key||"",userId:i.userId||a.userId,userEmail:n.email||"",tier:i.tier||"BASIC",status:i.status||"active",activatedAt:i.activatedAt||i.createdAt,expiresAt:i.expiresAt||i.createdAt,lastUsed:i.updatedAt||i.createdAt})})}return console.log("‚úÖ [AdminDashboardService] Payment details retrieved from Firestore"),{payment:u,licenses:p}}catch(l){throw console.error("‚ùå [AdminDashboardService] Error getting payment details from Firestore:",l),l}}static async getPaymentDetailsFromAPI(r){var l,a,n,u,p,j,h;try{const i=((l=(await G.get(q.admin.paymentDetails(r))).data)==null?void 0:l.data)||{},c={id:((a=i.payment)==null?void 0:a.id)||r,amount:((n=i.payment)==null?void 0:n.amount)||0,status:((u=i.payment)==null?void 0:u.status)||"unknown",createdAt:(p=i.payment)==null?void 0:p.createdAt,user:((j=i.payment)==null?void 0:j.user)||{},subscription:((h=i.payment)==null?void 0:h.subscription)||{}},I=(i.licenses||[]).map(b=>{var E;return{id:b.id,key:b.key,userId:b.userId,userEmail:b.userEmail||((E=c.user)==null?void 0:E.email)||"",tier:b.tier,status:b.status,activatedAt:b.activatedAt||b.createdAt,expiresAt:b.expiresAt||b.createdAt,lastUsed:b.updatedAt||b.createdAt}});return{payment:c,licenses:I}}catch(x){throw console.error("‚ùå [AdminDashboardService] Error getting payment details from API:",x),x}}}const Fe=({title:F,data:r})=>{const l=(r==null?void 0:r.status)==="healthy"?"success":(r==null?void 0:r.status)==="degraded"?"warning":(r==null?void 0:r.status)==="unhealthy"?"error":"default";return e.jsx(de,{variant:"outlined",children:e.jsxs(ue,{children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1},children:[e.jsx(g,{variant:"subtitle1",children:F}),e.jsx(D,{size:"small",label:((r==null?void 0:r.status)||"unknown").toUpperCase(),color:l})]}),e.jsxs(C,{container:!0,spacing:2,children:[e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(g,{variant:"body2",color:"text.secondary",children:["Response time: ",(r==null?void 0:r.responseTimeMs)!=null?`${r.responseTimeMs} ms`:"‚Äî"]})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsx(g,{variant:"body2",color:"text.secondary",children:(r==null?void 0:r.message)||""})}),(r==null?void 0:r.error)&&e.jsx(C,{item:!0,xs:12,children:e.jsx(ws,{severity:"warning",children:r.error})})]})]})})},St=()=>{var js,ys;const{enqueueSnackbar:F}=ot(),{user:r}=lt(),l=nt(),a=it(),[n,u]=f.useState(0),[p,j]=f.useState({totalUsers:0,activeSubscriptions:0,totalRevenue:0,pendingApprovals:0,systemHealth:"healthy"}),[h,x]=f.useState([]),[i,c]=f.useState({}),[I,b]=f.useState([]),[E,v]=f.useState([]),[_,Le]=f.useState(1),[Te,Cs]=f.useState(1),[z,he]=f.useState({}),[ze,Oe]=f.useState(new Set),[Is,We]=f.useState(!1),[H,Ds]=f.useState({}),[M,me]=f.useState(null),[Es,xe]=f.useState(!1),[Ps,pe]=f.useState(!1),[J,Ze]=f.useState(null),[es,ss]=f.useState(0),[Us,ge]=f.useState(!1),[Z,be]=f.useState({userId:"",subscriptionId:"",tier:"PRO",seats:1}),[ts,Me]=f.useState([]),[A,je]=f.useState(null),[rs,as]=f.useState(!1),[se,ns]=f.useState(""),[te,is]=f.useState(""),[re,os]=f.useState(""),[ee,$e]=f.useState({}),[ls,cs]=f.useState(null),[Be,ds]=f.useState(null),[us,ye]=f.useState([]),[Ns,hs]=f.useState(!1),Ye=f.useMemo(()=>{const s=se.trim().toLowerCase();return h.filter(t=>s?t.firstName.toLowerCase().includes(s)||t.lastName.toLowerCase().includes(s)||t.email.toLowerCase().includes(s)||t.role.toLowerCase().includes(s)||t.status.toLowerCase().includes(s)||t.subscription&&t.subscription.toLowerCase().includes(s):!0).filter(t=>i.role?t.role===i.role:!0).filter(t=>i.status?t.status===i.status.toLowerCase():!0).filter(t=>i.tier?(t.subscription||"").toUpperCase()===i.tier:!0)},[h,se,i]),Ve=f.useMemo(()=>{const s=re.trim().toLowerCase();return h.filter(t=>t.subscription).filter(t=>s?t.firstName.toLowerCase().includes(s)||t.lastName.toLowerCase().includes(s)||t.email.toLowerCase().includes(s)||t.subscription&&t.subscription.toLowerCase().includes(s):!0).filter(t=>ee.tier?(t.subscription||"").toUpperCase()===ee.tier:!0).filter(t=>ee.status?t.status===ee.status:!0)},[h,re,ee]),fe=s=>{if(!s)return new Date(NaN);if(typeof s=="string")return new Date(s);if(s instanceof Date)return s;if(typeof s=="object"&&s!==null){if(typeof s._seconds=="number")return new Date(s._seconds*1e3);if(typeof s.seconds=="number")return new Date(s.seconds*1e3);if(typeof s.toDate=="function")try{return s.toDate()}catch{}}return new Date(s)},Qe=s=>`$${(typeof s=="number"?s:0).toFixed(2)}`,K=f.useMemo(()=>{if(!te.trim())return E;const s=te.toLowerCase();return E.filter(t=>{var d,m;return t.id.toLowerCase().includes(s)||((d=t.user)==null?void 0:d.email)&&t.user.email.toLowerCase().includes(s)||((m=t.subscription)==null?void 0:m.tier)&&t.subscription.tier.toLowerCase().includes(s)||t.status.toLowerCase().includes(s)||fe(t.createdAt).toLocaleDateString().toLowerCase().includes(s)||Qe(t.amount).toLowerCase().includes(s)})},[E,te]),ms=f.useMemo(()=>{if(!K||K.length===0)return{};const s={};return K.forEach(t=>{var m;const d=((m=t.user)==null?void 0:m.email)||"Unknown User";s[d]||(s[d]=[]),s[d].push(t)}),Object.keys(s).forEach(t=>{s[t].sort((d,m)=>{var L,Y;const P=new Date(((L=d.createdAt)==null?void 0:L.seconds)*1e3||0);return new Date(((Y=m.createdAt)==null?void 0:Y.seconds)*1e3||0).getTime()-P.getTime()})}),s},[K]),He=f.useMemo(()=>{if(!K||K.length===0)return[];const s=[];return Object.entries(ms).forEach(([t,d])=>{var w,L;const m=d.reduce((Y,we)=>Y+(we.amount||0),0),P=((L=(w=d[0])==null?void 0:w.user)==null?void 0:L.name)||t;s.push({userEmail:t,userName:P,payments:d,totalAmount:m,paymentCount:d.length})}),s.sort((t,d)=>d.totalAmount-t.totalAmount),s},[ms,K]),ks=()=>ns(""),Rs=()=>is(""),Fs=()=>os(""),Ls=s=>{Oe(t=>{const d=new Set(t);return d.has(s)?d.delete(s):d.add(s),d})},Ts=()=>{const s=He.map(t=>t.userEmail);Oe(new Set(s))},zs=()=>{Oe(new Set)},xs=async(s,t)=>{s.stopPropagation(),s.preventDefault(),cs(s.currentTarget),ds(t),ye([]),hs(!0);try{const P=(await B.getUserDetails(t.id)).licenses.map(w=>({id:w.id,key:w.key,userId:w.userId,userEmail:w.userEmail,tier:w.tier,status:w.status==="inactive"?"suspended":w.status,activatedAt:new Date(fe(w.activatedAt)).toISOString(),expiresAt:new Date(fe(w.expiresAt)).toISOString(),lastUsed:new Date(fe(w.lastUsed)).toISOString()})).sort((w,L)=>{const Y=w.status==="active"?0:1,we=L.status==="active"?0:1;return Y!==we?Y-we:new Date(L.activatedAt).getTime()-new Date(w.activatedAt).getTime()});ye(P)}catch(d){console.error("Error loading user licenses:",d),F((d==null?void 0:d.message)||"Failed to load licenses",{variant:"error"}),ye([])}finally{hs(!1)}},Os=()=>{cs(null),ds(null),ye([])};f.useEffect(()=>{let s=!0;return(async()=>{try{if(String((r==null?void 0:r.role)||"").toUpperCase()!=="SUPERADMIN"){x([]),j(w=>({...w,systemHealth:"warning"}));return}const[d,m,P]=await Promise.all([B.getUsers(1,100),B.getDashboardStats(),B.getSystemHealth()]);if(!s)return;x(d.users.map(w=>{var L,Y;return{id:w.id,email:w.email,firstName:w.firstName,lastName:w.lastName,role:w.role,status:((Y=(L=w.status)==null?void 0:L.toLowerCase)==null?void 0:Y.call(L))||"active",subscription:w.subscription,lastLogin:w.lastLogin,createdAt:w.createdAt}})),j({totalUsers:m.totalUsers,activeSubscriptions:m.activeSubscriptions,totalRevenue:m.totalRevenue,pendingApprovals:m.pendingApprovals,systemHealth:m.systemHealth==="healthy"?"healthy":m.systemHealth==="warning"?"warning":"error"}),je({overall:P.overall,checkedAt:P.checkedAt,database:P.database,email:P.email,payment:P.payment}),b(m.recentPayments||[])}catch(t){if(!s)return;console.error("Admin Dashboard data loading error:",t),x([]),j(d=>({...d,systemHealth:"error"})),b([]),je(null)}})(),()=>{s=!1}},[r==null?void 0:r.role]);const Ws=async()=>{try{as(!0);const s=await B.getSystemHealth();je({overall:s.overall,checkedAt:s.checkedAt,database:s.database,email:s.email,payment:s.payment}),j(t=>({...t,systemHealth:s.overall==="healthy"?"healthy":s.overall==="degraded"?"warning":"error"}))}catch(s){console.error("Error refreshing health:",s),je(null),j(t=>({...t,systemHealth:"error"}))}finally{as(!1)}},ps=async(s=1)=>{var t,d;try{const m={};z.status&&(m.status=z.status),z.email&&(m.email=z.email),z.from&&(m.from=z.from),z.to&&(m.to=z.to);const P=await B.getPayments(s,100,m);v(P.payments),Le(((t=P.pagination)==null?void 0:t.page)||s),Cs(((d=P.pagination)==null?void 0:d.pages)||1)}catch(m){console.error("Error fetching payments:",m),v([])}};f.useEffect(()=>{String((r==null?void 0:r.role)||"").toUpperCase()==="SUPERADMIN"&&n===1&&ps(_).catch(()=>{})},[n,_,z,r==null?void 0:r.role]);const Ms=async s=>{try{const t=await B.getPaymentDetails(s);Ds({payment:t.payment,licenses:t.licenses}),We(!0)}catch(t){console.error("Error loading payment details:",t),F("Failed to load payment details",{variant:"error"})}},gs=s=>{me(s),xe(!0)},$s=async()=>{try{if(!M)return;await B.updateUser(M.id,{role:M.role,status:M.status}),F("User updated successfully",{variant:"success"}),xe(!1),me(null);const s=await B.getUsers(1,100);x(s.users.map(t=>{var d,m;return{id:t.id,email:t.email,firstName:t.firstName,lastName:t.lastName,role:t.role,status:((m=(d=t.status)==null?void 0:d.toLowerCase)==null?void 0:m.call(d))||"active",subscription:t.subscription,lastLogin:t.lastLogin,createdAt:t.createdAt}}))}catch(s){console.error("Error updating user:",s),F((s==null?void 0:s.message)||"Failed to update user",{variant:"error"})}},Ge=async s=>{try{const m=((await B.getUserDetails(s.id)).subscriptions||[]).find(P=>P.status==="ACTIVE"&&(String(P.tier).toUpperCase()==="PRO"||String(P.tier).toUpperCase()==="ENTERPRISE"));if(!m){F("No active PRO/ENTERPRISE subscription for this user",{variant:"warning"});return}Ze({id:m.id,tier:String(m.tier).toUpperCase(),seats:Number(m.seats||0)}),ss(Number(m.seats||0)),pe(!0)}catch(t){console.error("Error loading subscription:",t),F((t==null?void 0:t.message)||"Failed to load subscription",{variant:"error"})}},Bs=async()=>{var s,t;if(J)try{const d=J.tier,m=Number(es||0);if(d==="BASIC"&&m!==1){F("Basic plan supports exactly 1 seat.",{variant:"warning"});return}if(d==="PRO"&&(m<1||m>50)){F("Pro plan seats must be between 1 and 50.",{variant:"warning"});return}if(d==="ENTERPRISE"&&m<10){F("Enterprise requires minimum 10 seats.",{variant:"warning"});return}await G.put(q.subscriptions.update(J.id),{seats:m}),Ze({...J,seats:m}),F("Seats updated successfully",{variant:"success"}),pe(!1)}catch(d){F(((t=(s=d==null?void 0:d.response)==null?void 0:s.data)==null?void 0:t.message)||(d==null?void 0:d.message)||"Failed to update seats",{variant:"error"})}},bs=async()=>{ge(!0)},Ys=async s=>{if(be(t=>({...t,userId:s,subscriptionId:""})),s)try{const d=(await B.getUserDetails(s)).subscriptions||[];Me(d.filter(m=>m.status==="ACTIVE"))}catch(t){console.error("Error loading user subscriptions:",t),Me([])}else Me([])},Vs=async()=>{try{await G.post(q.admin.createLicense(),Z),F("License(s) created",{variant:"success"}),ge(!1)}catch(s){F((s==null?void 0:s.message)||"Failed to create license",{variant:"error"})}},ve=s=>{switch(s){case"active":return"success";case"pending":return"warning";case"suspended":return"error";default:return"default"}},Qs=s=>{switch(String(s||"").toUpperCase()){case"SUPERADMIN":return"secondary";case"ADMIN":return"primary";default:return"default"}},Se=s=>{switch(String(s||"").toUpperCase()){case"ENTERPRISE":return"secondary";case"PRO":return"success";case"BASIC":return"default";default:return"default"}},Ae=s=>String(s||"").toUpperCase()==="BASIC"?"outlined":"filled",Hs=s=>{switch(s){case"healthy":return"success";case"warning":return"warning";case"error":return"error";default:return"default"}},Gs=s=>{switch(s){case"healthy":return e.jsx(at,{});case"warning":return e.jsx(_e,{});case"error":return e.jsx(rt,{});default:return e.jsx(_e,{})}};f.useEffect(()=>{const s=(a.hash||"").toLowerCase(),t={"#users":0,"#licenses":1,"#invoices":2,"#system":3,"#system-health":3};s&&t[s]!=null&&t[s]!==n&&u(t[s])},[a.hash]);const qs=(s,t)=>{u(t);const m={0:"users",1:"licenses",2:"invoices",3:"system"}[t]||"users";(a.hash||"").toLowerCase()!==`#${m}`&&l(`/admin#${m}`,{replace:!0})};return e.jsx(e.Fragment,{children:e.jsx(y,{sx:{pb:4},children:e.jsxs(_s,{maxWidth:"xl",children:[e.jsxs(y,{sx:{opacity:0,transform:"translateY(20px)",animation:"fadeInUp 0.6s ease-out forwards","@keyframes fadeInUp":{"0%":{opacity:0,transform:"translateY(20px)"},"100%":{opacity:1,transform:"translateY(0)"}}},children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2,mb:4},children:[e.jsx(Js,{sx:{fontSize:32,color:"primary.main"}}),e.jsx(g,{variant:"h4",sx:{fontWeight:700},children:"Admin Dashboard"}),e.jsx(D,{icon:Gs(p.systemHealth),label:`System ${p.systemHealth}`,color:Hs(p.systemHealth),size:"small"})]}),e.jsxs(C,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(C,{item:!0,xs:12,sm:6,lg:3,children:e.jsx(y,{sx:{opacity:0,transform:"translateY(20px)",animation:"fadeInUp 0.6s ease-out 0.1s forwards"},children:e.jsx(de,{sx:{background:"linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%)",border:"1px solid rgba(0, 212, 255, 0.2)"},children:e.jsxs(ue,{children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(Ks,{sx:{color:"primary.main"}}),e.jsx(g,{variant:"h6",color:"text.secondary",children:"Total Users"})]}),e.jsx(g,{variant:"h3",sx:{fontWeight:700,color:"primary.main"},children:p.totalUsers.toLocaleString()})]})})})}),e.jsx(C,{item:!0,xs:12,sm:6,lg:3,children:e.jsx(y,{sx:{opacity:0,transform:"translateY(20px)",animation:"fadeInUp 0.6s ease-out 0.2s forwards"},children:e.jsx(de,{sx:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%)",border:"1px solid rgba(255, 255, 255, 0.1)"},children:e.jsxs(ue,{children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(Ce,{sx:{color:"secondary.main"}}),e.jsx(g,{variant:"h6",color:"text.secondary",children:"Active Subscriptions"})]}),e.jsx(g,{variant:"h3",sx:{fontWeight:700},children:p.activeSubscriptions.toLocaleString()})]})})})}),e.jsx(C,{item:!0,xs:12,sm:6,lg:3,children:e.jsx(y,{sx:{opacity:0,transform:"translateY(20px)",animation:"fadeInUp 0.6s ease-out 0.3s forwards"},children:e.jsx(de,{sx:{background:"linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(139, 195, 74, 0.1) 100%)",border:"1px solid rgba(76, 175, 80, 0.2)"},children:e.jsxs(ue,{children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(qe,{sx:{color:"success.main"}}),e.jsx(g,{variant:"h6",color:"text.secondary",children:"Total Revenue"})]}),e.jsxs(g,{variant:"h3",sx:{fontWeight:700,color:"success.main"},children:["$",p.totalRevenue.toLocaleString()]})]})})})}),e.jsx(C,{item:!0,xs:12,sm:6,lg:3,children:e.jsx(y,{sx:{opacity:0,transform:"translateY(20px)",animation:"fadeInUp 0.6s ease-out 0.4s forwards"},children:e.jsx(de,{sx:{background:"linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(255, 193, 7, 0.1) 100%)",border:"1px solid rgba(255, 152, 0, 0.2)"},children:e.jsxs(ue,{children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(_e,{sx:{color:"warning.main"}}),e.jsx(g,{variant:"h6",color:"text.secondary",children:"Pending Approvals"})]}),e.jsx(g,{variant:"h3",sx:{fontWeight:700,color:"warning.main"},children:p.pendingApprovals})]})})})})]}),e.jsx(X,{sx:{mb:3},children:e.jsxs(Xs,{value:n,onChange:qs,sx:{borderBottom:1,borderColor:"divider","& .MuiTab-root":{textTransform:"none",fontWeight:600}},children:[e.jsx(Ie,{label:"Users"}),e.jsx(Ie,{label:"Licenses"}),e.jsx(Ie,{label:"Invoices"}),e.jsx(Ie,{label:"System Health"})]})}),n===0&&e.jsxs(y,{sx:{opacity:0,transform:"translateY(20px)",animation:"fadeInUp 0.6s ease-out forwards"},children:[e.jsxs(y,{sx:{display:"flex",flexDirection:"column",gap:2,mb:2},children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(N,{placeholder:"Search users by name, email, role, status, or subscription...",value:se,onChange:s=>ns(s.target.value),size:"small",sx:{minWidth:400},InputProps:{startAdornment:e.jsx(ae,{position:"start",children:e.jsx(Ke,{})}),endAdornment:se&&e.jsx(ae,{position:"end",children:e.jsx(V,{size:"small",onClick:ks,children:e.jsx(Je,{})})})}}),se&&e.jsx(D,{label:`${Ye.length} of ${h.length} users found`,color:"primary",variant:"outlined"}),e.jsx(U,{variant:"contained",onClick:bs,children:"Add License"})]}),e.jsxs(y,{sx:{display:"flex",gap:2,flexWrap:"wrap"},children:[e.jsxs(N,{label:"Role",select:!0,size:"small",value:i.role||"",onChange:s=>c(t=>({...t,role:s.target.value||void 0})),children:[e.jsx(S,{value:"",children:"All"}),e.jsx(S,{value:"USER",children:"USER"}),e.jsx(S,{value:"ADMIN",children:"ADMIN"}),e.jsx(S,{value:"SUPERADMIN",children:"SUPERADMIN"})]}),e.jsxs(N,{label:"Status",select:!0,size:"small",value:i.status||"",onChange:s=>c(t=>({...t,status:s.target.value||void 0})),children:[e.jsx(S,{value:"",children:"All"}),e.jsx(S,{value:"active",children:"ACTIVE"}),e.jsx(S,{value:"suspended",children:"SUSPENDED"})]}),e.jsxs(N,{label:"Subscription Tier",select:!0,size:"small",value:i.tier||"",onChange:s=>c(t=>({...t,tier:s.target.value||void 0})),children:[e.jsx(S,{value:"",children:"All"}),e.jsx(S,{value:"BASIC",children:"BASIC"}),e.jsx(S,{value:"PRO",children:"PRO"}),e.jsx(S,{value:"ENTERPRISE",children:"ENTERPRISE"})]}),e.jsx(U,{variant:"outlined",children:"Apply Filters"}),e.jsx(U,{onClick:()=>c({}),children:"Clear"})]})]}),e.jsx(De,{component:X,children:e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsxs($,{children:[e.jsx(o,{children:"User"}),e.jsx(o,{children:"Role"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Subscription"}),e.jsx(o,{children:"Last Login"}),e.jsx(o,{children:"Actions"})]})}),e.jsx(oe,{children:Ye.length>0?Ye.map(s=>e.jsxs($,{children:[e.jsx(o,{children:e.jsxs(y,{children:[e.jsxs(g,{variant:"subtitle2",children:[s.firstName," ",s.lastName]}),e.jsx(g,{variant:"body2",color:"text.secondary",children:s.email})]})}),e.jsx(o,{children:e.jsx(D,{label:s.role,size:"small",color:Qs(s.role)})}),e.jsx(o,{children:e.jsx(D,{label:s.status,size:"small",color:ve(s.status)})}),e.jsx(o,{children:s.subscription&&e.jsx(D,{label:s.subscription,size:"small",color:Se(s.subscription),variant:Ae(s.subscription)})}),e.jsx(o,{children:e.jsx(g,{variant:"body2",children:new Date(s.lastLogin).toLocaleDateString()})}),e.jsxs(o,{children:[e.jsx(V,{size:"small",onClick:()=>gs(s),children:e.jsx(fs,{})}),e.jsx(V,{size:"small",onClick:t=>xs(t,s),title:"View user licenses",children:e.jsx(Ce,{})}),e.jsx(V,{size:"small",onClick:t=>{t.stopPropagation(),Ge(s)},title:"Manage seats",children:e.jsx(qe,{})}),e.jsx(V,{size:"small",color:"error",children:e.jsx(Zs,{})})]})]},s.id)):e.jsx($,{children:e.jsx(o,{colSpan:6,align:"center",children:e.jsx(y,{sx:{py:4},children:e.jsx(g,{variant:"body1",color:"text.secondary",children:se?"No users found matching your search criteria.":"No users available."})})})})})]})})]}),n===1&&e.jsxs(y,{sx:{opacity:0,transform:"translateY(20px)",animation:"fadeInUp 0.6s ease-out forwards"},children:[e.jsxs(y,{sx:{display:"flex",flexDirection:"column",gap:2,mb:2},children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(N,{placeholder:"Search licenses by user, tier, status, or subscription...",value:re,onChange:s=>os(s.target.value),size:"small",sx:{minWidth:400},InputProps:{startAdornment:e.jsx(ae,{position:"start",children:e.jsx(Ke,{})}),endAdornment:re&&e.jsx(ae,{position:"end",children:e.jsx(V,{size:"small",onClick:Fs,children:e.jsx(Je,{})})})}}),re&&e.jsx(D,{label:`${Ve.length} of ${h.filter(s=>s.subscription).length} licenses found`,color:"primary",variant:"outlined"}),e.jsx(U,{variant:"contained",onClick:bs,children:"Add License"})]}),e.jsxs(y,{sx:{display:"flex",gap:2,flexWrap:"wrap"},children:[e.jsxs(N,{label:"Subscription Tier",select:!0,size:"small",value:ee.tier||"",onChange:s=>$e(t=>({...t,tier:s.target.value||void 0})),sx:{minWidth:160},children:[e.jsx(S,{value:"",children:"All"}),e.jsx(S,{value:"BASIC",children:"BASIC"}),e.jsx(S,{value:"PRO",children:"PRO"}),e.jsx(S,{value:"ENTERPRISE",children:"ENTERPRISE"})]}),e.jsxs(N,{label:"Status",select:!0,size:"small",value:ee.status||"",onChange:s=>$e(t=>({...t,status:s.target.value||void 0})),sx:{minWidth:160},children:[e.jsx(S,{value:"",children:"All"}),e.jsx(S,{value:"active",children:"ACTIVE"}),e.jsx(S,{value:"expired",children:"EXPIRED"}),e.jsx(S,{value:"suspended",children:"SUSPENDED"}),e.jsx(S,{value:"pending",children:"PENDING"})]}),e.jsx(U,{variant:"outlined",children:"Apply Filters"}),e.jsx(U,{onClick:()=>$e({}),children:"Clear"})]})]}),e.jsx(De,{component:X,children:e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsxs($,{children:[e.jsx(o,{children:"User"}),e.jsx(o,{children:"Subscription Tier"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Seats"}),e.jsx(o,{children:"Activated"}),e.jsx(o,{children:"Expires"}),e.jsx(o,{children:"Actions"})]})}),e.jsx(oe,{children:Ve.length>0?Ve.map(s=>e.jsxs($,{children:[e.jsx(o,{children:e.jsxs(y,{children:[e.jsxs(g,{variant:"subtitle2",children:[s.firstName," ",s.lastName]}),e.jsx(g,{variant:"body2",color:"text.secondary",children:s.email})]})}),e.jsx(o,{children:e.jsx(D,{label:s.subscription,size:"small",color:Se(s.subscription),variant:Ae(s.subscription)})}),e.jsx(o,{children:e.jsx(D,{label:s.status,size:"small",color:ve(s.status)})}),e.jsx(o,{children:e.jsx(g,{variant:"body2",children:"-"})}),e.jsx(o,{children:e.jsx(g,{variant:"body2",children:new Date(s.lastLogin).toLocaleDateString()})}),e.jsx(o,{children:e.jsx(g,{variant:"body2",children:"-"})}),e.jsxs(o,{children:[e.jsx(V,{size:"small",onClick:()=>gs(s),children:e.jsx(fs,{})}),e.jsx(V,{size:"small",onClick:t=>xs(t,s),title:"View user licenses",children:e.jsx(Ce,{})}),e.jsx(V,{size:"small",onClick:t=>{t.stopPropagation(),Ge(s)},title:"Manage seats",children:e.jsx(qe,{})})]})]},s.id)):e.jsx($,{children:e.jsx(o,{colSpan:7,align:"center",children:e.jsx(y,{sx:{py:4},children:e.jsx(g,{variant:"body1",color:"text.secondary",children:re?"No licenses found matching your search criteria.":"No users with subscriptions found."})})})})})]})})]}),n===2&&e.jsxs(y,{sx:{opacity:0,transform:"translateY(20px)",animation:"fadeInUp 0.6s ease-out forwards"},children:[e.jsxs(y,{sx:{display:"flex",flexDirection:"column",gap:2,mb:2},children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(N,{placeholder:"Search payments by ID, email, tier, status, amount, or date...",value:te,onChange:s=>is(s.target.value),size:"small",sx:{minWidth:400},InputProps:{startAdornment:e.jsx(ae,{position:"start",children:e.jsx(Ke,{})}),endAdornment:te&&e.jsx(ae,{position:"end",children:e.jsx(V,{size:"small",onClick:Rs,children:e.jsx(Je,{})})})}}),te&&e.jsx(D,{label:`${K.length} of ${E.length} payments found`,color:"primary",variant:"outlined"})]}),e.jsxs(y,{sx:{display:"flex",gap:2,flexWrap:"wrap"},children:[e.jsx(N,{label:"Filter by Email",size:"small",value:z.email||"",onChange:s=>he(t=>({...t,email:s.target.value}))}),e.jsx(N,{label:"From",size:"small",type:"date",InputLabelProps:{shrink:!0},value:z.from||"",onChange:s=>he(t=>({...t,from:s.target.value}))}),e.jsx(N,{label:"To",size:"small",type:"date",InputLabelProps:{shrink:!0},value:z.to||"",onChange:s=>he(t=>({...t,to:s.target.value}))}),e.jsxs(N,{label:"Status",select:!0,size:"small",value:z.status||"",onChange:s=>he(t=>({...t,status:s.target.value||void 0})),sx:{minWidth:160},children:[e.jsx(S,{value:"",children:"All"}),e.jsx(S,{value:"SUCCEEDED",children:"SUCCEEDED"}),e.jsx(S,{value:"PENDING",children:"PENDING"}),e.jsx(S,{value:"FAILED",children:"FAILED"}),e.jsx(S,{value:"REFUNDED",children:"REFUNDED"})]}),e.jsx(U,{variant:"outlined",onClick:()=>ps(1),children:"Apply Filters"})]})]}),e.jsxs(y,{sx:{mt:2},children:[e.jsxs(y,{sx:{display:"flex",gap:2,mb:2,justifyContent:"flex-end"},children:[e.jsx(U,{size:"small",variant:"contained",onClick:Ts,startIcon:e.jsx(Xe,{}),sx:{backgroundColor:"primary.main",color:"primary.contrastText",fontWeight:"medium",borderRadius:"8px",textTransform:"none",boxShadow:"0 2px 8px rgba(0,0,0,0.15)","&:hover":{backgroundColor:"primary.dark",boxShadow:"0 4px 12px rgba(0,0,0,0.2)",transform:"translateY(-1px)"},transition:"all 0.2s cubic-bezier(0.4, 0, 0.2, 1)"},children:"Expand All"}),e.jsx(U,{size:"small",variant:"outlined",onClick:zs,startIcon:e.jsx(Xe,{sx:{transform:"rotate(180deg)"}}),sx:{color:"primary.main",borderColor:"primary.main",fontWeight:"medium",borderRadius:"8px",textTransform:"none","&:hover":{backgroundColor:"primary.light",borderColor:"primary.main",color:"primary.contrastText",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",transform:"translateY(-1px)"},transition:"all 0.2s cubic-bezier(0.4, 0, 0.2, 1)"},children:"Collapse All"})]}),He.length>0?He.map(s=>e.jsxs(X,{sx:{mb:3,border:"1px solid",borderColor:"primary.main",overflow:"hidden",borderRadius:"8px",boxShadow:"0 4px 20px rgba(0,0,0,0.15)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&:hover":{boxShadow:"0 8px 30px rgba(0,0,0,0.2)",transform:"translateY(-2px)"}},children:[e.jsxs(y,{sx:{p:2,background:"linear-gradient(135deg, primary.main 0%, primary.dark 100%)",color:"primary.contrastText",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between","&:hover":{background:"linear-gradient(135deg, primary.dark 0%, primary.main 100%)",transform:"translateY(-1px)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)"},transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",borderRadius:"8px 8px 0 0"},onClick:()=>Ls(s.userEmail),children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(et,{sx:{fontSize:"1.8rem",color:"#ffffff",filter:"drop-shadow(0 2px 2px rgba(0,0,0,0.2))"}}),e.jsx(g,{variant:"h6",fontWeight:"bold",sx:{color:"#ffffff",textShadow:"0 1px 2px rgba(0,0,0,0.2)",letterSpacing:"0.02em"},children:s.userName}),e.jsx(D,{label:`${s.paymentCount} payments`,color:"secondary",variant:"filled",sx:{color:"#ffffff",fontWeight:"medium",boxShadow:"0 2px 4px rgba(0,0,0,0.15)",backgroundColor:"rgba(255,255,255,0.2)",border:"1px solid rgba(255,255,255,0.3)"}}),e.jsxs(g,{variant:"body1",fontWeight:"bold",sx:{color:"#ffffff",textShadow:"0 1px 2px rgba(0,0,0,0.2)",backgroundColor:"rgba(255,255,255,0.15)",borderRadius:"4px",px:1.5,py:.5},children:["Total: ",Qe(s.totalAmount)]})]}),e.jsx(Xe,{sx:{transform:ze.has(s.userEmail)?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.3s ease",color:"#ffffff",fontSize:"1.8rem",filter:"drop-shadow(0 2px 2px rgba(0,0,0,0.2))","&:hover":{transform:ze.has(s.userEmail)?"rotate(180deg) scale(1.1)":"rotate(0deg) scale(1.1)",filter:"drop-shadow(0 3px 3px rgba(0,0,0,0.3))"}}})]}),e.jsx(st,{in:ze.has(s.userEmail),children:e.jsx(De,{sx:{boxShadow:"0 4px 12px rgba(0,0,0,0.1)",borderRadius:"0 0 8px 8px",overflow:"hidden"},children:e.jsxs(ne,{size:"small",sx:{"& .MuiTableCell-root":{borderColor:"divider"}},children:[e.jsx(ie,{children:e.jsxs($,{sx:{backgroundColor:"primary.light","& .MuiTableCell-head":{color:"primary.contrastText",fontWeight:"bold",fontSize:"0.875rem"}},children:[e.jsx(o,{children:"Payment ID"}),e.jsx(o,{children:"Type"}),e.jsx(o,{children:"User"}),e.jsx(o,{children:"Tier"}),e.jsx(o,{children:"Amount"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Date"}),e.jsx(o,{children:"Details"})]})}),e.jsx(oe,{children:s.payments.map(t=>{var d,m,P,w,L;return e.jsxs($,{sx:{"&:hover":{backgroundColor:"action.hover",transform:"translateY(-1px)",boxShadow:"0 2px 8px rgba(0,0,0,0.15)",transition:"all 0.2s ease-in-out"},transition:"all 0.2s ease-in-out",cursor:"pointer"},children:[e.jsx(o,{children:e.jsx(g,{variant:"body2",fontFamily:"monospace",children:t.id})}),e.jsx(o,{children:e.jsx(D,{size:"small",label:"Payment",color:"success",variant:"outlined",sx:{fontWeight:"bold"}})}),e.jsx(o,{children:e.jsx(g,{variant:"body2",children:((d=t.user)==null?void 0:d.email)||"‚Äî"})}),e.jsx(o,{children:e.jsx(D,{size:"small",label:((m=t.subscription)==null?void 0:m.tier)||"‚Äî",color:Se((P=t.subscription)==null?void 0:P.tier),variant:Ae((w=t.subscription)==null?void 0:w.tier)})}),e.jsx(o,{children:e.jsx(g,{variant:"body2",children:Qe(t.amount)})}),e.jsx(o,{children:e.jsx(D,{size:"small",label:t.status,color:t.status==="succeeded"?"success":t.status==="FAILED"?"error":"default"})}),e.jsx(o,{children:e.jsx(g,{variant:"body2",children:(L=t.createdAt)!=null&&L.seconds?new Date(t.createdAt.seconds*1e3).toLocaleDateString():"‚Äî"})}),e.jsx(o,{children:e.jsx(U,{size:"small",variant:"contained",onClick:()=>Ms(t.id),sx:{backgroundColor:"primary.main",color:"primary.contrastText","&:hover":{backgroundColor:"primary.dark",transform:"translateY(-1px)",boxShadow:"0 4px 12px rgba(0,0,0,0.3)"},"&:active":{transform:"translateY(0px)",boxShadow:"0 2px 6px rgba(0,0,0,0.2)"},transition:"all 0.2s cubic-bezier(0.4, 0, 0.2, 1)",fontWeight:"medium",textTransform:"none",borderRadius:"8px",px:2},children:"Open"})})]},t.id)})})]})})})]},s.userEmail)):e.jsx(X,{sx:{p:4,textAlign:"center"},children:e.jsx(g,{variant:"body1",color:"text.secondary",children:"No payments available."})})]}),e.jsxs(y,{sx:{display:"flex",gap:1,justifyContent:"flex-end",mt:2},children:[e.jsx(U,{disabled:_<=1,onClick:()=>Le(s=>Math.max(1,s-1)),children:"Prev"}),e.jsx(D,{label:`Page ${_} of ${Te}`}),e.jsx(U,{disabled:_>=Te,onClick:()=>Le(s=>Math.min(Te,s+1)),children:"Next"})]})]}),n===3&&e.jsx(y,{sx:{opacity:0,transform:"translateY(20px)",animation:"fadeInUp 0.6s ease-out forwards"},children:e.jsxs(C,{container:!0,spacing:3,children:[e.jsx(C,{item:!0,xs:12,md:6,children:e.jsxs(X,{sx:{p:3},children:[e.jsx(g,{variant:"h6",sx:{mb:2},children:"System Status"}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(D,{label:`Overall: ${((A==null?void 0:A.overall)||"unknown").toUpperCase()}`,color:(A==null?void 0:A.overall)==="healthy"?"success":(A==null?void 0:A.overall)==="degraded"?"warning":(A==null?void 0:A.overall)==="unhealthy"?"error":"default"}),e.jsx(U,{size:"small",onClick:Ws,disabled:rs,children:rs?"Refreshing‚Ä¶":"Refresh"})]}),e.jsxs(C,{container:!0,spacing:2,children:[e.jsx(C,{item:!0,xs:12,children:e.jsx(Fe,{title:"Database",data:A==null?void 0:A.database})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(Fe,{title:"Email (SendGrid)",data:A==null?void 0:A.email})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(Fe,{title:"Payments (Stripe)",data:A==null?void 0:A.payment})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(Fe,{title:"Webhooks",data:A==null?void 0:A.webhooks})})]})]})}),e.jsx(C,{item:!0,xs:12,md:6,children:e.jsxs(X,{sx:{p:3},children:[e.jsx(g,{variant:"h6",sx:{mb:2},children:"Recent Activity"}),e.jsxs(y,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(g,{variant:"body2",color:"text.secondary",children:["Checked at: ",A!=null&&A.checkedAt?new Date(A.checkedAt).toLocaleString():"‚Äî"]}),(js=A==null?void 0:A.webhooks)!=null&&js.metrics?e.jsxs(e.Fragment,{children:[e.jsxs(g,{variant:"body2",children:["Recent webhooks (24h): ",A.webhooks.metrics.recentWebhooks]}),e.jsxs(g,{variant:"body2",children:["Failed webhooks: ",A.webhooks.metrics.failedWebhooks]})]}):e.jsx(g,{variant:"body2",color:"text.secondary",children:"No metrics available"})]})]})})]})})]}),e.jsxs(Ee,{open:Es,onClose:()=>xe(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Pe,{children:"Edit User"}),e.jsx(Ue,{children:M&&e.jsxs(C,{container:!0,spacing:3,sx:{mt:1},children:[e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsx(N,{fullWidth:!0,label:"First Name",value:M.firstName,disabled:!0})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsx(N,{fullWidth:!0,label:"Last Name",value:M.lastName,disabled:!0})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(N,{fullWidth:!0,label:"Email",value:M.email,disabled:!0})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(vs,{fullWidth:!0,children:[e.jsx(Ss,{children:"Role"}),e.jsxs(As,{value:M.role,label:"Role",inputProps:{"aria-label":"Select user role",title:"Choose the user role"},onChange:s=>me(t=>t&&{...t,role:String(s.target.value)}),children:[e.jsx(S,{value:"USER",children:"User"}),e.jsx(S,{value:"ADMIN",children:"Admin"})]})]})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(g,{variant:"caption",color:"text.secondary",children:"Role is enforced by active subscription tier: BASIC ‚Üí User; PRO/ENTERPRISE ‚Üí Admin. Elevation to SuperAdmin is not allowed via UI."})}),e.jsx(C,{item:!0,xs:12,sm:6,children:e.jsxs(vs,{fullWidth:!0,children:[e.jsx(Ss,{children:"Status"}),e.jsxs(As,{value:M.status,label:"Status",inputProps:{"aria-label":"Select user status",title:"Choose the user status"},onChange:s=>me(t=>t&&{...t,status:String(s.target.value)}),children:[e.jsx(S,{value:"active",children:"Active"}),e.jsx(S,{value:"suspended",children:"Suspended"}),e.jsx(S,{value:"pending",children:"Pending"})]})]})})]})}),e.jsxs(Ne,{children:[e.jsx(U,{onClick:()=>xe(!1),children:"Cancel"}),M&&e.jsx(U,{onClick:()=>Ge(M),children:"Manage Seats"}),e.jsx(U,{onClick:$s,variant:"contained",children:"Save Changes"})]})]}),e.jsxs(Ee,{open:Is,onClose:()=>We(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Pe,{children:"Payment Details"}),e.jsx(Ue,{children:H.payment?e.jsxs(y,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(y,{sx:{display:"flex",gap:2,flexWrap:"wrap"},children:[e.jsx(D,{label:`ID: ${H.payment.id}`}),e.jsx(D,{label:`User: ${((ys=H.payment.user)==null?void 0:ys.email)||"‚Äî"}`}),e.jsx(D,{label:`Amount: $${(H.payment.amount/100).toFixed(2)}`}),e.jsx(D,{label:`Status: ${H.payment.status}`}),e.jsx(D,{label:`Date: ${new Date(H.payment.createdAt).toLocaleString()}`}),H.payment.receiptUrl&&e.jsx(U,{size:"small",variant:"outlined",onClick:()=>window.open(H.payment.receiptUrl,"_blank"),children:"View Invoice"})]}),e.jsx(g,{variant:"subtitle2",children:"Related Licenses"}),e.jsx(De,{component:X,children:e.jsxs(ne,{size:"small",children:[e.jsx(ie,{children:e.jsxs($,{children:[e.jsx(o,{children:"License Key"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Activated"}),e.jsx(o,{children:"Expires"})]})}),e.jsx(oe,{children:(H.licenses||[]).map(s=>e.jsxs($,{children:[e.jsx(o,{children:e.jsx(g,{variant:"body2",fontFamily:"monospace",children:s.key})}),e.jsx(o,{children:e.jsx(D,{size:"small",label:s.status,color:ve(String(s.status).toLowerCase())})}),e.jsx(o,{children:s.activatedAt?new Date(s.activatedAt).toLocaleDateString():"‚Äî"}),e.jsx(o,{children:s.expiresAt?new Date(s.expiresAt).toLocaleDateString():"‚Äî"})]},s.id))})]})})]}):e.jsx(g,{variant:"body2",color:"text.secondary",children:"No details."})}),e.jsx(Ne,{children:e.jsx(U,{onClick:()=>We(!1),children:"Close"})})]}),e.jsxs(tt,{open:!!ls,anchorEl:ls,onClose:Os,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},PaperProps:{sx:{p:2,maxWidth:560}},children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(Ce,{fontSize:"small",color:"action"}),e.jsx(g,{variant:"subtitle1",children:(Be==null?void 0:Be.email)||"Licenses"})]}),Ns?e.jsx(g,{variant:"body2",color:"text.secondary",children:"Loading..."}):us.length>0?e.jsxs(ne,{size:"small",children:[e.jsx(ie,{children:e.jsxs($,{children:[e.jsx(o,{children:"License Key"}),e.jsx(o,{children:"Tier"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Expires"})]})}),e.jsx(oe,{children:us.map(s=>e.jsxs($,{children:[e.jsx(o,{children:e.jsx(g,{variant:"body2",fontFamily:"monospace",children:s.key})}),e.jsx(o,{children:e.jsx(D,{size:"small",label:s.tier,color:Se(s.tier),variant:Ae(s.tier)})}),e.jsx(o,{children:e.jsx(D,{size:"small",label:s.status,color:ve(s.status)})}),e.jsx(o,{children:e.jsx(g,{variant:"body2",children:new Date(s.expiresAt).toLocaleDateString()})})]},s.id))})]}):e.jsx(g,{variant:"body2",color:"text.secondary",children:"No licenses found for this user."})]}),e.jsxs(Ee,{open:Us,onClose:()=>ge(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Pe,{children:"Add License"}),e.jsx(Ue,{children:e.jsxs(C,{container:!0,spacing:2,sx:{mt:.5},children:[e.jsx(C,{item:!0,xs:12,children:e.jsx(N,{select:!0,fullWidth:!0,label:"User",value:Z.userId,onChange:s=>Ys(s.target.value),children:h.map(s=>e.jsx(S,{value:s.id,children:s.email},s.id))})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(N,{select:!0,fullWidth:!0,label:"Subscription",value:Z.subscriptionId,onChange:s=>be(t=>({...t,subscriptionId:s.target.value})),disabled:!ts.length,children:ts.map(s=>e.jsxs(S,{value:s.id,children:[s.tier," ‚Äî seats ",s.seats]},s.id))})}),e.jsx(C,{item:!0,xs:6,children:e.jsxs(N,{select:!0,fullWidth:!0,label:"Tier",value:Z.tier,onChange:s=>be(t=>({...t,tier:s.target.value})),children:[e.jsx(S,{value:"BASIC",children:"BASIC"}),e.jsx(S,{value:"PRO",children:"PRO"}),e.jsx(S,{value:"ENTERPRISE",children:"ENTERPRISE"})]})}),e.jsx(C,{item:!0,xs:6,children:e.jsx(N,{fullWidth:!0,type:"number",label:"Seats",inputProps:{min:1,max:1e3},value:Z.seats,onChange:s=>be(t=>({...t,seats:Math.max(1,Math.min(1e3,parseInt(s.target.value)||1))}))})})]})}),e.jsxs(Ne,{children:[e.jsx(U,{onClick:()=>ge(!1),children:"Cancel"}),e.jsx(U,{variant:"contained",onClick:Vs,disabled:!Z.userId||!Z.subscriptionId,children:"Create"})]})]}),e.jsxs(Ee,{open:Ps,onClose:()=>pe(!1),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Pe,{children:"Manage Seats"}),e.jsx(Ue,{children:J?e.jsxs(C,{container:!0,spacing:2,sx:{mt:.5},children:[e.jsx(C,{item:!0,xs:12,children:e.jsxs(ws,{severity:"info",children:[J.tier," subscription"]})}),e.jsx(C,{item:!0,xs:12,children:e.jsx(N,{fullWidth:!0,type:"number",label:"Total Seats",value:es,onChange:s=>ss(parseInt(s.target.value||"0",10)),inputProps:{min:1,max:J.tier==="PRO"?50:1e3}})})]}):e.jsx(g,{variant:"body2",color:"text.secondary",children:"No active subscription found."})}),e.jsxs(Ne,{children:[e.jsx(U,{onClick:()=>pe(!1),children:"Cancel"}),e.jsx(U,{onClick:Bs,variant:"contained",disabled:!J,children:"Save"})]})]})]})})})};export{St as default};
