import{j as e,B as l,C as ve,T as a,d as M,ai as K,w as Se,x as Q,y as X,aj as xe,z as Z,H as _,a as u,u as ee,G as s,az as Ce,ac as Pe,am as ue,c6 as Ie,t as te,v as se,r as W,c as O,aS as De,ag as Ee,ay as we,g as Ae,aH as We,aW as Re,af as ne,aB as Te,aC as Me,aD as Oe,aE as re,aF as p,aG as ke,aI as ae,aJ as ie,aK as oe,e as P,aL as le,as as Le,at as Ue,au as ze,a5 as b,D as Be,a4 as Ne,aa as Fe,aA as Ye,p as He}from"./mui-DWTWYqgO.js";import{r as o}from"./vendor-CjD1bmmO.js";import{u as Ge}from"./notistack.esm-Ca-E78ev.js";import{b as Ve,c as $e,d as Je}from"./useStreamlinedData-BZC6qJCG.js";import{unifiedDataService as k}from"./UnifiedDataService-C4gR6DrL.js";import{M as R}from"./MetricCard-Tj_JLw4Z.js";import"./index-0TU2Slwu.js";import"./stripe-TYTTXgaF.js";import"./index.esm-C6E5jVjx.js";import"./index.esm--uL3Qa3r.js";import"./FirestoreCollectionManager-BZKNcIYq.js";import"./firebase-98o7oaNz.js";import"./index.esm-K73FumZQ.js";const qe=()=>{const[n,c]=o.useState(null),[x,h]=o.useState(!0),[g,j]=o.useState(null),m=async()=>{try{h(!0),j(null);const i=await k.getSubscriptionForOrganization();c(i)}catch(i){console.error("❌ [useOrganizationSubscription] Error:",i),j(i.message||"Failed to fetch subscription"),c(null)}finally{h(!1)}};return o.useEffect(()=>{m()},[]),{data:n,loading:x,error:g,refetch:m}},Ke=()=>{const[n,c]=o.useState([]),[x,h]=o.useState(!0),[g,j]=o.useState(null),m=async()=>{try{h(!0),j(null);const i=await k.getInvoicesForOrganization();c(i)}catch(i){console.error("❌ [useOrganizationInvoices] Error:",i),j(i.message||"Failed to fetch invoices"),c([])}finally{h(!1)}};return o.useEffect(()=>{m()},[]),{data:n,loading:x,error:g,refetch:m}},Qe=()=>{const[n,c]=o.useState([]),[x,h]=o.useState(!0),[g,j]=o.useState(null),m=async()=>{try{h(!0),j(null);const i=await k.getPaymentsForOrganization();c(i)}catch(i){console.error("❌ [useOrganizationPayments] Error:",i),j(i.message||"Failed to fetch payments"),c([])}finally{h(!1)}};return o.useEffect(()=>{m()},[]),{data:n,loading:x,error:g,refetch:m}},Xe=()=>{var i,v,y,D,E,w;const n=qe(),c=Ke(),x=Qe(),h=n.loading||c.loading||x.loading,g=n.error||c.error||x.error,j={monthlyTotal:((i=n.data)==null?void 0:i.totalAmount)||0,totalSeats:((v=n.data)==null?void 0:v.seats)||0,daysUntilRenewal:(y=n.data)!=null&&y.currentPeriodEnd?Math.max(0,Math.ceil((new Date(n.data.currentPeriodEnd).getTime()-Date.now())/(1e3*60*60*24))):0,activeInvoices:((D=c.data)==null?void 0:D.filter(d=>d.status==="paid"||d.status==="pending").length)||0,totalPaid:((E=x.data)==null?void 0:E.filter(d=>d.status==="succeeded").reduce((d,f)=>d+(f.amount||0),0))||0,lastPayment:((w=x.data)==null?void 0:w.filter(d=>d.status==="succeeded").sort((d,f)=>new Date(f.processedAt||f.createdAt).getTime()-new Date(d.processedAt||d.createdAt).getTime())[0])||null},m=async()=>{await Promise.all([n.refetch(),c.refetch(),x.refetch()])};return{subscription:n.data,invoices:c.data,payments:x.data,metrics:j,loading:h,error:g,refetch:m}},Ze=[{id:"1",type:"card",last4:"4242",brand:"Visa",expiryMonth:12,expiryYear:2025,isDefault:!0},{id:"2",type:"card",last4:"5555",brand:"Mastercard",expiryMonth:8,expiryYear:2026,isDefault:!1}],I=n=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(n),ce=n=>{switch(n.toLowerCase()){case"succeeded":case"paid":case"active":return"success";case"pending":case"processing":return"warning";case"failed":case"cancelled":case"canceled":return"error";case"refunded":return"info";default:return"default"}},de=n=>{switch(n.toLowerCase()){case"succeeded":case"paid":case"active":return e.jsx(He,{});case"pending":case"processing":return e.jsx(ue,{});case"failed":case"cancelled":case"canceled":return e.jsx(xe,{});case"refunded":return e.jsx(Ye,{});default:return e.jsx(Fe,{})}},ut=()=>{var F,Y,H,G,V,$,J;const{enqueueSnackbar:n}=Ge(),{loading:c,error:x}=Ve(),{loading:h,error:g}=$e(),{loading:j,error:m}=Je(),{subscription:i,invoices:v,metrics:y,loading:D,error:E}=Xe(),[w,d]=o.useState(!1),[f,S]=o.useState(!1),[L,A]=o.useState("PRO"),[U,z]=o.useState(1),[B,C]=o.useState(null),he=c||h||j||D,je=x||g||m||E,r=o.useMemo(()=>({subscription:i,invoices:v||[],paymentMethods:Ze,nextPaymentAmount:y.monthlyTotal,daysUntilRenewal:y.daysUntilRenewal}),[i,v,y]),me=()=>{n("Payment method added successfully",{variant:"success"}),d(!1)},pe=()=>{n("Subscription updated successfully",{variant:"success"}),S(!1)},N=()=>{var t;r.subscription&&(z(r.subscription.plan.seats||1),A(((t=r.subscription.plan)==null?void 0:t.tier)||"PRO")),S(!0)},ge=t=>{n(`Downloading invoice ${t.number}...`,{variant:"info"})},ye=()=>({BASIC:29,PRO:99,ENTERPRISE:199})[L]*U,fe=t=>{z(t),t<=50?A("PRO"):A("ENTERPRISE")},T=t=>{const be={BASIC:29,PRO:99,ENTERPRISE:199}[t];return`${t} - $${be}/seat/month`};return he?e.jsx(l,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(l,{textAlign:"center",children:[e.jsx(ve,{size:60}),e.jsx(a,{variant:"h6",sx:{mt:2},children:"Loading Billing Information..."}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Fetching your subscription and payment details"})]})}):je?e.jsx(l,{sx:{p:3},children:e.jsxs(M,{severity:"error",children:[e.jsx(K,{children:"Unable to Load Billing Data"}),e.jsx(a,{variant:"body2",sx:{mb:2},children:"We encountered an issue loading your billing information. This could be due to:"}),e.jsxs(Se,{dense:!0,children:[e.jsxs(Q,{children:[e.jsx(X,{children:e.jsx(xe,{fontSize:"small"})}),e.jsx(Z,{primary:"Network connectivity issues"})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsx(_,{fontSize:"small"})}),e.jsx(Z,{primary:"Authentication token expired"})]})]}),e.jsx(l,{sx:{mt:2},children:e.jsx(u,{variant:"contained",onClick:()=>window.location.reload(),children:"Retry"})})]})}):r.subscription?e.jsxs(l,{children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4},children:[e.jsxs(l,{children:[e.jsx(a,{variant:"h4",sx:{fontWeight:700,mb:1},children:"Billing & Payments"}),e.jsx(a,{variant:"body1",color:"text.secondary",children:"Manage your subscription, payment methods, and billing history"})]}),e.jsx(u,{variant:"contained",startIcon:e.jsx(ee,{}),onClick:N,sx:{background:"linear-gradient(135deg, #00d4ff 0%, #667eea 100%)",color:"#000",fontWeight:600},children:"Upgrade Plan"})]}),e.jsxs(s,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(s,{item:!0,xs:12,sm:6,md:3,children:e.jsx(R,{title:"Monthly Cost",value:I(r.nextPaymentAmount),icon:e.jsx(Ce,{}),color:"primary"})}),e.jsx(s,{item:!0,xs:12,sm:6,md:3,children:e.jsx(R,{title:"Total Seats",value:y.totalSeats,icon:e.jsx(Pe,{}),color:"secondary"})}),e.jsx(s,{item:!0,xs:12,sm:6,md:3,children:e.jsx(R,{title:"Days to Renewal",value:r.daysUntilRenewal,icon:e.jsx(ue,{}),color:"warning",trend:{value:Math.max(0,30-r.daysUntilRenewal),direction:"down"}})}),e.jsx(s,{item:!0,xs:12,sm:6,md:3,children:e.jsx(R,{title:"Active Invoices",value:y.activeInvoices,icon:e.jsx(Ie,{}),color:"success"})})]}),e.jsx(te,{sx:{mb:4,background:"linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%)",border:"1px solid rgba(0, 212, 255, 0.2)"},children:e.jsx(se,{sx:{p:4},children:e.jsxs(s,{container:!0,spacing:4,alignItems:"center",children:[e.jsxs(s,{item:!0,xs:12,md:8,children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(W,{label:((F=r.subscription)==null?void 0:F.tier)||"PRO",color:"primary",sx:{fontWeight:600,fontSize:"1rem",px:2,py:1}}),e.jsx(W,{icon:de(((Y=r.subscription)==null?void 0:Y.status)||"active"),label:(((H=r.subscription)==null?void 0:H.status)||"ACTIVE").toUpperCase(),color:ce(((G=r.subscription)==null?void 0:G.status)||"active"),sx:{fontWeight:500}})]}),e.jsxs(a,{variant:"h5",sx:{fontWeight:600,mb:1},children:[I(r.nextPaymentAmount)," / month"]}),e.jsxs(a,{variant:"body1",color:"text.secondary",sx:{mb:2},children:[y.totalSeats," seats • Next payment in ",r.daysUntilRenewal," days"]}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:["Current period: ",(V=r.subscription)!=null&&V.currentPeriodStart?new Date(r.subscription.currentPeriodStart).toLocaleDateString():"N/A"," - ",($=r.subscription)!=null&&$.currentPeriodEnd?new Date(r.subscription.currentPeriodEnd).toLocaleDateString():"N/A"]})]}),e.jsx(s,{item:!0,xs:12,md:4,children:e.jsxs(l,{sx:{textAlign:"right"},children:[e.jsx(a,{variant:"h6",color:"text.secondary",sx:{mb:1},children:"Next Payment"}),e.jsx(a,{variant:"h4",sx:{fontWeight:700,mb:1},children:I(r.nextPaymentAmount)}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:["on ",(J=r.subscription)!=null&&J.currentPeriodEnd?new Date(r.subscription.currentPeriodEnd).toLocaleDateString():"N/A"]})]})})]})})}),e.jsxs(s,{container:!0,spacing:4,children:[e.jsx(s,{item:!0,xs:12,md:8,children:e.jsxs(O,{sx:{p:3},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(a,{variant:"h6",sx:{fontWeight:600},children:"Payment Methods"}),e.jsx(u,{variant:"outlined",startIcon:e.jsx(De,{}),onClick:()=>d(!0),children:"Add Method"})]}),e.jsx(l,{sx:{display:"flex",flexDirection:"column",gap:2},children:r.paymentMethods.map(t=>e.jsx(te,{sx:{border:"1px solid rgba(255,255,255,0.1)"},children:e.jsx(se,{sx:{p:2},children:e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ee,{sx:{bgcolor:"primary.main"},children:e.jsx(we,{})}),e.jsxs(l,{children:[e.jsxs(a,{variant:"body1",sx:{fontWeight:500},children:[t.brand," •••• ",t.last4]}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:["Expires ",t.expiryMonth.toString().padStart(2,"0"),"/",t.expiryYear]})]})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.isDefault&&e.jsx(W,{label:"Default",size:"small",color:"primary"}),e.jsx(Ae,{size:"small",onClick:q=>C(q.currentTarget),children:e.jsx(We,{})})]})]})})},t.id))})]})}),e.jsx(s,{item:!0,xs:12,md:4,children:e.jsxs(O,{sx:{p:3},children:[e.jsx(a,{variant:"h6",sx:{fontWeight:600,mb:3},children:"Quick Actions"}),e.jsxs(s,{container:!0,spacing:2,children:[e.jsx(s,{item:!0,xs:12,children:e.jsx(u,{variant:"outlined",startIcon:e.jsx(ee,{}),fullWidth:!0,sx:{justifyContent:"flex-start",py:1.5},onClick:()=>S(!0),children:"Upgrade Plan"})}),e.jsx(s,{item:!0,xs:12,children:e.jsx(u,{variant:"outlined",startIcon:e.jsx(Re,{}),fullWidth:!0,sx:{justifyContent:"flex-start",py:1.5},children:"Update Billing Info"})}),e.jsx(s,{item:!0,xs:12,children:e.jsx(u,{variant:"outlined",startIcon:e.jsx(ne,{}),fullWidth:!0,sx:{justifyContent:"flex-start",py:1.5},children:"Download All Invoices"})}),e.jsx(s,{item:!0,xs:12,children:e.jsx(u,{variant:"outlined",startIcon:e.jsx(_,{}),fullWidth:!0,sx:{justifyContent:"flex-start",py:1.5},children:"Billing Security Settings"})})]})]})}),e.jsx(s,{item:!0,xs:12,children:e.jsxs(O,{sx:{p:3},children:[e.jsx(a,{variant:"h6",sx:{fontWeight:600,mb:3},children:"Billing History"}),e.jsx(Te,{children:e.jsxs(Me,{children:[e.jsx(Oe,{children:e.jsxs(re,{children:[e.jsx(p,{sx:{fontWeight:600},children:"Invoice"}),e.jsx(p,{sx:{fontWeight:600},children:"Date"}),e.jsx(p,{sx:{fontWeight:600},children:"Description"}),e.jsx(p,{sx:{fontWeight:600},children:"Amount"}),e.jsx(p,{sx:{fontWeight:600},children:"Status"}),e.jsx(p,{sx:{fontWeight:600},children:"Actions"})]})}),e.jsx(ke,{children:r.invoices.map(t=>e.jsxs(re,{hover:!0,children:[e.jsx(p,{children:e.jsx(a,{variant:"body2",sx:{fontWeight:500,fontFamily:"monospace"},children:t.number})}),e.jsx(p,{children:e.jsx(a,{variant:"body2",children:new Date(t.date).toLocaleDateString()})}),e.jsx(p,{children:e.jsx(a,{variant:"body2",children:t.description})}),e.jsx(p,{children:e.jsx(a,{variant:"body2",sx:{fontWeight:500},children:I(t.amount)})}),e.jsx(p,{children:e.jsx(W,{icon:de(t.status),label:t.status.toUpperCase(),color:ce(t.status),size:"small"})}),e.jsx(p,{children:e.jsx(u,{variant:"contained",size:"small",startIcon:e.jsx(ne,{}),onClick:()=>ge(t),children:"Receipt"})})]},t.id))})]})})]})})]}),e.jsxs(ae,{open:w,onClose:()=>d(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ie,{children:"Add Payment Method"}),e.jsxs(oe,{children:[e.jsx(M,{severity:"info",sx:{mb:3},children:"Your payment information is securely processed by Stripe and never stored on our servers."}),e.jsxs(s,{container:!0,spacing:3,children:[e.jsx(s,{item:!0,xs:12,children:e.jsx(P,{fullWidth:!0,label:"Card Number",placeholder:"1234 5678 9012 3456",sx:{mt:1}})}),e.jsx(s,{item:!0,xs:6,children:e.jsx(P,{fullWidth:!0,label:"Expiry Date",placeholder:"MM/YY"})}),e.jsx(s,{item:!0,xs:6,children:e.jsx(P,{fullWidth:!0,label:"CVC",placeholder:"123"})}),e.jsx(s,{item:!0,xs:12,children:e.jsx(P,{fullWidth:!0,label:"Cardholder Name",placeholder:"John Doe"})})]})]}),e.jsxs(le,{children:[e.jsx(u,{onClick:()=>d(!1),children:"Cancel"}),e.jsx(u,{onClick:me,variant:"contained",children:"Add Payment Method"})]})]}),e.jsxs(ae,{open:f,onClose:()=>S(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ie,{children:"Upgrade Your Plan"}),e.jsx(oe,{children:e.jsxs(s,{container:!0,spacing:3,children:[e.jsx(s,{item:!0,xs:12,sm:6,children:e.jsxs(Le,{fullWidth:!0,children:[e.jsx(Ue,{children:"Select Plan"}),e.jsxs(ze,{value:L,label:"Select Plan",onChange:t=>A(t.target.value),children:[e.jsx(b,{value:"BASIC",children:T("BASIC")}),e.jsx(b,{value:"PRO",children:T("PRO")}),e.jsx(b,{value:"ENTERPRISE",children:T("ENTERPRISE")})]})]})}),e.jsx(s,{item:!0,xs:12,sm:6,children:e.jsx(P,{fullWidth:!0,label:"Number of Seats",type:"number",value:U,onChange:t=>fe(parseInt(t.target.value)),inputProps:{min:1,max:100},helperText:"Up to 50 seats: Pro plan. 51+ seats: Enterprise plan."})}),e.jsxs(s,{item:!0,xs:12,children:[e.jsx(Be,{sx:{my:2}}),e.jsxs(a,{variant:"h6",children:["Total: ",I(ye())," / month"]})]})]})}),e.jsxs(le,{children:[e.jsx(u,{onClick:()=>S(!1),children:"Cancel"}),e.jsx(u,{onClick:pe,variant:"contained",children:"Upgrade Now"})]})]}),e.jsxs(Ne,{anchorEl:B,open:!!B,onClose:()=>C(null),children:[e.jsx(b,{onClick:()=>C(null),children:"Set as Default"}),e.jsx(b,{onClick:()=>C(null),children:"Edit"}),e.jsx(b,{onClick:()=>C(null),sx:{color:"error.main"},children:"Remove"})]})]}):e.jsx(l,{sx:{p:3},children:e.jsxs(M,{severity:"info",children:[e.jsx(K,{children:"No Active Subscription"}),e.jsx(a,{variant:"body2",sx:{mb:2},children:"You don't have an active subscription yet. Get started with one of our plans:"}),e.jsx(l,{sx:{mt:2},children:e.jsx(u,{variant:"contained",onClick:N,children:"Choose Plan"})})]})})};export{ut as default};
