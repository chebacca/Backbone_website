var b=Object.defineProperty;var T=(n,e,t)=>e in n?b(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var h=(n,e,t)=>T(n,typeof e!="symbol"?e+"":e,t);import{s as w}from"./UnifiedProjectCreationDialog-BXarYN6t.js";import"./mui-T5zcPaKR.js";import"./vendor-OeuszDaU.js";import"./index-BCTuZqxR.js";import"./stripe-Bd-xCkZF.js";import"./proxy-Bigtmpzy.js";const g=class g{constructor(){h(this,"baseURL");h(this,"authToken",null);this.baseURL=this.getBaseURL(),this.initializeAuth()}static getInstance(){return this.instance||(this.instance=new g),this.instance}initializeAuth(){this.authToken=localStorage.getItem("auth_token")}getBaseURL(){return window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"&&!window.location.hostname.includes("localhost"),"/api"}async apiRequest(e,t="GET",r){const o=this.baseURL.replace(/\/$/,""),a=String(e||"").replace(/^\//,""),l=`${o}/${a}`,c={"Content-Type":"application/json"};this.authToken&&(c.Authorization=`Bearer ${this.authToken}`);const y={method:t,headers:c,...r&&{body:JSON.stringify(r)}};try{const i=await fetch(l,y);if(!i.ok){if(i.status===401)throw await this.handleAuthError(),new Error("Authentication required");let u="",f;try{const s=await i.clone().json();u=(s==null?void 0:s.error)||(s==null?void 0:s.message)||"",s!=null&&s.details&&(f=s.details)}catch{try{u=await i.text()||""}catch{}}const k=i.statusText||"Bad Request",j=u?` - ${u}`:"",P=f?` | details=${JSON.stringify(f)}`:"";throw new Error(`API request failed: ${i.status} ${k}${j}${P}`)}const d=await i.json();if(!d.success)throw new Error(d.error||d.message||"API request failed");return d.data}catch(i){throw console.error("API request error:",i),i}}async handleAuthError(){var e,t;try{const r=localStorage.getItem("refresh_token");if(!r)throw new Error("No refresh token available");const o=await fetch(`${this.baseURL}/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:r})});if(o.ok){const a=await o.json();if(a.success&&((t=(e=a.data)==null?void 0:e.tokens)!=null&&t.accessToken)){const l=a.data.tokens.accessToken;this.authToken=l,localStorage.setItem("auth_token",l);const c=a.data.tokens.refreshToken;c&&localStorage.setItem("refresh_token",c);return}}}catch(r){console.error("Token refresh failed:",r)}localStorage.removeItem("auth_token"),localStorage.removeItem("refresh_token"),this.authToken=null,await w.reset()}setAuthToken(e){this.authToken=e,localStorage.setItem("auth_token",e)}async createCloudProject(e){try{const t=this.mapToCloudProjectPayload(e),r=await this.apiRequest("projects","POST",t);return console.log("Cloud project created:",r),await this.setupProjectResources(r.id,e),typeof window<"u"&&window.dispatchEvent(new CustomEvent("project:created",{detail:{projectId:r.id,project:r}})),r.id}catch(t){console.error("Failed to create cloud project:",t);const r=t instanceof Error?t.message:String(t);throw new Error(`Failed to create cloud project: ${r}`)}}mapToCloudProjectPayload(e){const t=w.getState(),r=t.selectedMode||"shared_network",o={name:e.name,description:e.description,type:this.mapApplicationModeToType(r),applicationMode:r,visibility:"private",storageBackend:this.mapStorageModeToBackend(t.storageMode)};return e.cloudConfig&&(e.cloudConfig.provider==="gcs"?(o.storageBackend="gcs",o.gcsBucket=e.cloudConfig.bucket,o.gcsPrefix=e.cloudConfig.prefix):o.storageBackend="firestore"),e.collaborationSettings&&r==="shared_network"&&(o.allowCollaboration=!0,o.maxCollaborators=Math.max(1,Math.round(e.collaborationSettings.maxCollaborators)),o.realTimeEnabled=e.collaborationSettings.enableRealTime,o.enableComments=e.collaborationSettings.enableComments,o.enableActivityLog=!0,o.enablePresenceIndicators=!0),r==="standalone"&&(o.autoSave=!0,o.backupEnabled=!0,o.offlineMode=t.storageMode==="local"),e.preferredPorts&&(e.preferredPorts.website||e.preferredPorts.api)&&(o.settings={...o.settings||{},preferredPorts:{...e.preferredPorts.website?{website:e.preferredPorts.website}:{},...e.preferredPorts.api?{api:e.preferredPorts.api}:{}}}),o}mapApplicationModeToType(e){switch(e){case"standalone":return"standalone";case"shared_network":return"networked";default:return"networked"}}mapStorageModeToBackend(e){switch(e){case"cloud":return"firestore";case"hybrid":return"firestore";case"local":return"firestore";default:return"firestore"}}async setupProjectResources(e,t){var r,o;(r=t.localNetworkConfig)!=null&&r.enabled&&await this.setupLocalNetworkDeployment(e,t.localNetworkConfig),((o=t.cloudConfig)==null?void 0:o.provider)==="gcs"&&await this.validateGCSConfiguration(e,t.cloudConfig),await this.initializeProjectWorkspace(e,t)}async setupLocalNetworkDeployment(e,t){try{console.log("Setting up local network deployment:",{projectId:e,port:t.port,address:t.address,maxUsers:t.maxUsers}),await this.apiRequest(`projects/${e}`,"PATCH",{metadata:{localNetwork:{enabled:!0,port:t.port,address:t.address,maxUsers:t.maxUsers,deployedAt:new Date().toISOString()}}})}catch(r){console.error("Failed to setup local network deployment:",r)}}async validateGCSConfiguration(e,t){try{await this.apiRequest(`projects/${e}/storage/signed-url`,"POST",{filename:"test-validation.txt",operation:"upload"}),console.log("GCS configuration validated for project:",e)}catch(r){throw console.error("GCS configuration validation failed:",r),new Error("GCS storage configuration is invalid")}}async initializeProjectWorkspace(e,t){try{console.log("Initializing project workspace for:",e)}catch(r){console.error("Failed to initialize project workspace:",r)}}async getUserProjects(){try{const e=this.authToken?"projects":"projects/public";return await this.apiRequest(e)}catch(e){return console.error("Failed to fetch user projects:",e),[]}}async getProject(e){try{return await this.apiRequest(`projects/${e}`)}catch(t){return console.error("Failed to fetch project:",t),null}}async validateProjectAccess(e){try{return await this.getProject(e)!==null}catch{return!1}}async generateSignedUrl(e,t,r="upload",o){try{const a=await this.apiRequest(`projects/${e}/storage/signed-url`,"POST",{filename:t,operation:r,contentType:o});return{url:a.url,method:a.method,headers:a.headers}}catch(a){throw console.error("Failed to generate signed URL:",a),a}}async updateProject(e,t){try{return await this.apiRequest(`projects/${e}`,"PATCH",t)}catch(r){throw console.error("Failed to update project:",r),r}}async archiveProject(e){try{await this.apiRequest(`projects/${e}`,"DELETE")}catch(t){throw console.error("Failed to archive project:",t),t}}async restoreProject(e){try{await this.apiRequest(`projects/${e}/archive`,"PATCH",{isArchived:!1})}catch(t){throw console.error("Failed to restore project:",t),t}}async listDatasets(e){const t=new URLSearchParams;return e!=null&&e.organizationId&&t.append("organizationId",e.organizationId),e!=null&&e.visibility&&t.append("visibility",e.visibility),e!=null&&e.backend&&t.append("backend",e.backend),e!=null&&e.query&&t.append("query",e.query),this.apiRequest(`datasets${t.toString()?`?${t}`:""}`)}async createDataset(e){const t={...e};return(t.organizationId==null||t.organizationId==="")&&delete t.organizationId,Array.isArray(t.tags)&&t.tags.length===0&&delete t.tags,t.schema&&typeof t.schema=="object"&&Object.keys(t.schema).length===0&&delete t.schema,t.storage&&typeof t.storage=="object"&&(t.storage.backend||delete t.storage.backend,t.storage.gcsBucket||delete t.storage.gcsBucket,t.storage.gcsPrefix||delete t.storage.gcsPrefix,t.storage.path||delete t.storage.path,Object.keys(t.storage).length===0&&delete t.storage),this.apiRequest("datasets","POST",t)}async getProjectDatasets(e){return this.apiRequest(`datasets/project/${e}`,"GET")}async assignDatasetToProject(e,t){await this.apiRequest(`datasets/project/${e}/${t}`,"POST")}async unassignDatasetFromProject(e,t){await this.apiRequest(`datasets/project/${e}/${t}`,"DELETE")}};h(g,"instance");let p=g;const m=p.getInstance();typeof window<"u"&&(window.cloudProjectIntegration=m);export{m as cloudProjectIntegration,p as default};
