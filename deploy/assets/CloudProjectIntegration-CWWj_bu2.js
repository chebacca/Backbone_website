const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-CbWLKc5U.js","assets/index-DFn9BWkZ.js","assets/mui-SoXCytG7.js","assets/vendor-CjD1bmmO.js","assets/stripe-CJ03RTEk.js","assets/index-CBai7h7s.css","assets/index.esm-BANGvNYi.js","assets/index.esm-9jaBBmwp.js","assets/index.esm-CiRfLMBX.js","assets/UnifiedDataService-zaxS59cN.js","assets/FirestoreCollectionManager-dWYSAXFK.js"])))=>i.map(i=>d[i]);
var Q=Object.defineProperty;var Y=(A,e,t)=>e in A?Q(A,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):A[e]=t;var D=(A,e,t)=>Y(A,typeof e!="symbol"?e+"":e,t);import{_ as p}from"./index-DFn9BWkZ.js";const M=class M{constructor(){D(this,"db");D(this,"auth")}static arrayUnion(e){return{_method:"arrayUnion",value:e}}static arrayRemove(e){return{_method:"arrayRemove",value:e}}static getInstance(){return M.instance||(M.instance=new M),M.instance}async initialize(){const e=await p(()=>import("./firebase-CbWLKc5U.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));this.db=e.db,this.auth=e.auth}getCurrentUser(){var e;return(e=this.auth)==null?void 0:e.currentUser}async getDocumentById(e,t){try{const{doc:r,getDoc:o}=await p(async()=>{const{doc:a,getDoc:n}=await import("./index.esm-9jaBBmwp.js");return{doc:a,getDoc:n}},__vite__mapDeps([7,6])),s=r(this.db,e,t),i=await o(s);if(i.exists()){const a=i.data();return{id:i.id,...this.convertFirestoreDates(a)}}return null}catch(r){return console.error(`❌ [FirestoreAdapter] Error getting document ${t} from ${e}:`,r),null}}async queryDocuments(e,t=[]){try{const{collection:r,query:o,where:s,getDocs:i}=await p(async()=>{const{collection:d,query:m,where:P,getDocs:j}=await import("./index.esm-9jaBBmwp.js");return{collection:d,query:m,where:P,getDocs:j}},__vite__mapDeps([7,6])),a=r(this.db,e);let n;if(t.length>0){let d=[];for(const m of t)d.push(s(m.field,m.operator,m.value));n=o(a,...d)}else n=o(a);const l=await i(n),c=[];return l.forEach(d=>{const m=d.data();c.push({id:d.id,...this.convertFirestoreDates(m)})}),c}catch(r){return console.error(`❌ [FirestoreAdapter] Error querying ${e}:`,r),[]}}async createDocument(e,t){try{const{collection:r,addDoc:o}=await p(async()=>{const{collection:a,addDoc:n}=await import("./index.esm-9jaBBmwp.js");return{collection:a,addDoc:n}},__vite__mapDeps([7,6])),s=this.cleanDocumentData({...t,createdAt:new Date,updatedAt:new Date});return{id:(await o(r(this.db,e),s)).id,...s}}catch(r){return console.error(`❌ [FirestoreAdapter] Error creating document in ${e}:`,r),null}}async updateDocumentWithArrayOps(e,t,r){try{const{doc:o,updateDoc:s}=await p(async()=>{const{doc:c,updateDoc:d}=await import("./index.esm-9jaBBmwp.js");return{doc:c,updateDoc:d}},__vite__mapDeps([7,6])),{arrayUnion:i,arrayRemove:a}=await p(async()=>{const{arrayUnion:c,arrayRemove:d}=await import("./index.esm-9jaBBmwp.js");return{arrayUnion:c,arrayRemove:d}},__vite__mapDeps([7,6])),n={};for(const[c,d]of Object.entries(r))d&&typeof d=="object"&&d._method==="arrayUnion"?n[c]=i(d.value):d&&typeof d=="object"&&d._method==="arrayRemove"?n[c]=a(d.value):n[c]=d;const l=this.cleanDocumentData({...n,updatedAt:new Date});return await s(o(this.db,e,t),l),!0}catch(o){return console.error(`❌ [FirestoreAdapter] Error updating document ${t} in ${e} with array ops:`,o),!1}}async updateDocument(e,t,r){try{const{doc:o,updateDoc:s}=await p(async()=>{const{doc:a,updateDoc:n}=await import("./index.esm-9jaBBmwp.js");return{doc:a,updateDoc:n}},__vite__mapDeps([7,6])),i=this.cleanDocumentData({...r,updatedAt:new Date});return await s(o(this.db,e,t),i),!0}catch(o){return console.error(`❌ [FirestoreAdapter] Error updating document ${t} in ${e}:`,o),!1}}async deleteDocument(e,t){try{const{doc:r,deleteDoc:o}=await p(async()=>{const{doc:s,deleteDoc:i}=await import("./index.esm-9jaBBmwp.js");return{doc:s,deleteDoc:i}},__vite__mapDeps([7,6]));return await o(r(this.db,e,t)),!0}catch(r){return console.error(`❌ [FirestoreAdapter] Error deleting document ${t} from ${e}:`,r),!1}}cleanDocumentData(e){const t={};for(const[r,o]of Object.entries(e))if(o!==void 0){if(o===null){t[r]=null;continue}if(typeof o=="object"&&!Array.isArray(o)&&!(o instanceof Date)){t[r]=this.cleanDocumentData(o);continue}t[r]=o}return t}convertFirestoreDates(e){const t={};for(const[r,o]of Object.entries(e))o&&typeof o=="object"&&o.toDate&&typeof o.toDate=="function"?t[r]=o.toDate().toISOString():o&&typeof o=="object"&&!Array.isArray(o)?t[r]=this.convertFirestoreDates(o):t[r]=o;return t}};D(M,"instance");let R=M;class V{constructor(e){D(this,"config");D(this,"firestoreAdapter");this.config=e,this.firestoreAdapter=R.getInstance()}isWebOnlyMode(){return this.config.isWebOnlyMode}getConfig(){return this.config}async apiRequest(e,t="GET",r,o){try{const i=`${this.config.apiBaseUrl||"/api"}/${e.startsWith("/")?e.substring(1):e}`,a={"Content-Type":"application/json",...o},n={method:t,headers:a,credentials:"include"};r&&(t==="POST"||t==="PATCH")&&(n.body=JSON.stringify(r));const l=await fetch(i,n);if(!l.ok)throw new Error(`API request failed: ${l.status} ${l.statusText}`);const c=l.headers.get("content-type");return c&&c.includes("application/json")?await l.json():await l.text()}catch(s){throw console.error(`❌ [BaseService] API request failed for ${e}:`,s),s}}handleError(e,t){console.error(`❌ [${this.constructor.name}] Error in ${t}:`,e)}}var k=(A=>(A.ACTIVE="ACTIVE",A.INACTIVE="INACTIVE",A.PENDING="PENDING",A.DELETED="DELETED",A))(k||{}),S=(A=>(A.ADMIN="ADMIN",A.MEMBER="MEMBER",A))(S||{}),$=(A=>(A.ACTIVE="active",A.ARCHIVED="archived",A.DELETED="deleted",A.DRAFT="draft",A))($||{});const E=class E extends V{constructor(e){super(e)}static getInstance(e){return E.instance||(E.instance=new E(e)),E.instance}async getProjects(){try{if(console.log("🚀 [ProjectService] Getting all projects"),this.isWebOnlyMode())return await this.getProjectsFromFirestore();try{return await this.apiRequest("projects")}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.getProjectsFromFirestore()}}catch(e){return this.handleError(e,"getProjects"),[]}}async getProject(e){try{if(console.log(`🚀 [ProjectService] Getting project: ${e}`),this.isWebOnlyMode())return await this.getProjectFromFirestore(e);try{return await this.apiRequest(`projects/${e}`)}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.getProjectFromFirestore(e)}}catch(t){return this.handleError(t,`getProject(${e})`),null}}async createProject(e){try{if(console.log("🚀 [ProjectService] Creating new project"),this.isWebOnlyMode())return await this.createProjectInFirestore(e);try{return await this.apiRequest("projects","POST",e)}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.createProjectInFirestore(e)}}catch(t){return this.handleError(t,"createProject"),null}}async updateProject(e,t){try{if(console.log(`🚀 [ProjectService] Updating project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}`,"PATCH",t)}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`updateProject(${e})`),null}}async archiveProject(e){try{if(console.log(`🚀 [ProjectService] Archiving project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,{status:$.ARCHIVED})!==null;try{return await this.apiRequest(`projects/${e}/archive`,"POST"),!0}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,{status:$.ARCHIVED})!==null}}catch(t){return this.handleError(t,`archiveProject(${e})`),!1}}async restoreProject(e){try{if(console.log(`🚀 [ProjectService] Restoring project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,{status:$.ACTIVE})!==null;try{return await this.apiRequest(`projects/${e}/restore`,"POST"),!0}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,{status:$.ACTIVE})!==null}}catch(t){return this.handleError(t,`restoreProject(${e})`),!1}}async deleteProject(e){try{if(console.log(`🗑️ [ProjectService] Deleting project: ${e}`),this.isWebOnlyMode())return await this.deleteProjectFromFirestore(e);try{return await this.apiRequest(`projects/${e}`,"DELETE"),!0}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.deleteProjectFromFirestore(e)}}catch(t){return this.handleError(t,`deleteProject(${e})`),!1}}async getProjectsFromFirestore(){try{console.log("🔍 [ProjectService] Getting projects from Firestore"),await this.firestoreAdapter.initialize();const e=this.firestoreAdapter.getCurrentUser();if(!e)return console.log("❌ [ProjectService] No authenticated user found"),[];let t=null;try{const r=await this.firestoreAdapter.getDocumentById("users",e.uid);if(r&&r.organizationId)t=r.organizationId,console.log("✅ [ProjectService] Found organization ID from user document:",t);else{const o=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:e.email}]);o.length>0&&o[0].organizationId&&(t=o[0].organizationId,console.log("✅ [ProjectService] Found organization ID from user email query:",t))}}catch(r){console.warn("⚠️ [ProjectService] Error getting user organization:",r)}if(!t)return console.log("❌ [ProjectService] No organization ID found for user"),[];try{const r=await this.firestoreAdapter.queryDocuments("projects",[{field:"organizationId",operator:"==",value:t}]);console.log(`✅ [ProjectService] Found ${r.length} projects for organization: ${t}`),console.log("🔍 [ProjectService] Raw projects from Firestore:",r);const o=r.sort((s,i)=>{const a=s.lastAccessedAt?new Date(s.lastAccessedAt).getTime():0;return(i.lastAccessedAt?new Date(i.lastAccessedAt).getTime():0)-a});return console.log("🔍 [ProjectService] Sorted projects:",o),o}catch(r){if(r.message&&r.message.includes("requires an index"))return console.warn("⚠️ [ProjectService] Missing Firestore index detected. Projects query requires composite index."),console.warn("📋 Required index: organizationId (Ascending) + createdAt (Ascending) + __name__ (Ascending)"),console.warn("🔗 Create index at: https://console.firebase.google.com/v1/r/project/backbone-logic/firestore/indexes"),console.warn("📝 Note: Index creation can take several minutes. Returning empty array for now."),[];throw r}}catch(e){return this.handleError(e,"getProjectsFromFirestore"),[]}}async getProjectFromFirestore(e){try{return console.log(`🔍 [ProjectService] Getting project from Firestore: ${e}`),await this.firestoreAdapter.initialize(),await this.firestoreAdapter.getDocumentById("projects",e)}catch(t){return this.handleError(t,`getProjectFromFirestore(${e})`),null}}async createProjectInFirestore(e){try{console.log("🔍 [ProjectService] Creating project in Firestore"),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();if(!t)return console.warn("⚠️ [ProjectService] No authenticated user for project creation"),null;const r={...e,ownerId:e.ownerId||t.uid,status:e.status||$.ACTIVE,teamMembers:e.teamMembers||[]};return await this.firestoreAdapter.createDocument("projects",r)}catch(t){return this.handleError(t,"createProjectInFirestore"),null}}async updateProjectInFirestore(e,t){try{console.log(`🔍 [ProjectService] Updating project in Firestore: ${e}`),await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.getDocumentById("projects",e);return r?await this.firestoreAdapter.updateDocument("projects",e,t)?{...r,...t,id:e}:null:(console.warn(`⚠️ [ProjectService] Project not found: ${e}`),null)}catch(r){return this.handleError(r,`updateProjectInFirestore(${e})`),null}}async deleteProjectFromFirestore(e){try{return console.log(`🗑️ [ProjectService] Deleting project from Firestore: ${e}`),await this.firestoreAdapter.initialize(),await this.firestoreAdapter.getDocumentById("projects",e)?await this.firestoreAdapter.deleteDocument("projects",e)?(console.log(`✅ [ProjectService] Project successfully deleted from Firestore: ${e}`),!0):(console.warn(`⚠️ [ProjectService] Failed to delete project from Firestore: ${e}`),!1):(console.warn(`⚠️ [ProjectService] Project not found for deletion: ${e}`),!1)}catch(t){return this.handleError(t,`deleteProjectFromFirestore(${e})`),!1}}};D(E,"instance");let N=E;const C=class C extends V{constructor(e){super(e)}static getInstance(e){return C.instance||(C.instance=new C(e)),C.instance}async getLicensedTeamMembers(e){try{if(console.log("🚀 [TeamMemberService] Getting licensed team members with options:",e),this.isWebOnlyMode())return await this.getLicensedTeamMembersFromFirestore(e);const t=new URLSearchParams;e!=null&&e.search&&t.append("search",e.search),e!=null&&e.excludeProjectId&&t.append("excludeProjectId",e.excludeProjectId);const r=`team-members/licensed${t.toString()?`?${t.toString()}`:""}`;try{return await this.apiRequest(r)}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.getLicensedTeamMembersFromFirestore(e)}}catch(t){return this.handleError(t,"getLicensedTeamMembers"),[]}}async getProjectTeamMembers(e){try{if(console.log("🚀 [TeamMemberService] Getting team members for project:",e),this.isWebOnlyMode())return await this.getProjectTeamMembersFromFirestore(e);try{return await this.apiRequest(`projects/${e}/team-members`)}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.getProjectTeamMembersFromFirestore(e)}}catch(t){return this.handleError(t,`getProjectTeamMembers(${e})`),[]}}async addTeamMemberToProject(e,t,r=S.MEMBER){try{if(console.log("🚀 [TeamMemberService] Adding team member to project:",{projectId:e,teamMemberId:t,role:r}),this.isWebOnlyMode())return await this.addTeamMemberToProjectInFirestore(e,t,r);try{return await this.apiRequest(`projects/${e}/team-members`,"POST",{teamMemberId:t,role:r}),!0}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.addTeamMemberToProjectInFirestore(e,t,r)}}catch(o){return this.handleError(o,`addTeamMemberToProject(${e}, ${t})`),!1}}async removeTeamMemberFromProject(e,t){try{if(console.log("🚀 [TeamMemberService] Removing team member from project:",{projectId:e,teamMemberId:t}),this.isWebOnlyMode())return await this.removeTeamMemberFromProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}/team-members/${t}`,"DELETE"),!0}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.removeTeamMemberFromProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`removeTeamMemberFromProject(${e}, ${t})`),!1}}async updateTeamMemberRole(e,t,r){try{if(console.log("🚀 [TeamMemberService] Updating team member role:",{projectId:e,teamMemberId:t,role:r}),this.isWebOnlyMode())return await this.updateTeamMemberRoleInFirestore(e,t,r);try{return await this.apiRequest(`projects/${e}/team-members/${t}/role`,"PATCH",{role:r}),!0}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.updateTeamMemberRoleInFirestore(e,t,r)}}catch(o){return this.handleError(o,`updateTeamMemberRole(${e}, ${t})`),!1}}async validateTeamMemberCredentials(e,t){try{if(console.log("🚀 [TeamMemberService] Validating team member credentials for:",e),this.isWebOnlyMode())return await this.validateTeamMemberCredentialsFromFirestore(e,t);try{return await this.apiRequest("team-members/validate-credentials","POST",{email:e,password:t})}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.validateTeamMemberCredentialsFromFirestore(e,t)}}catch(r){return this.handleError(r,"validateTeamMemberCredentials"),{isValid:!1,error:"Authentication failed"}}}async refreshTeamMembers(){try{console.log("🔄 [TeamMemberService] Refreshing team member data..."),console.log("✅ [TeamMemberService] Team member data refresh initiated")}catch(e){console.error("❌ [TeamMemberService] Failed to refresh team member data:",e)}}async createTeamMemberWithFirebaseAuth(e){try{if(console.log("🚀 [TeamMemberService] Creating team member with Firebase Auth:",e),this.isWebOnlyMode())return await this.createTeamMemberWithFirebaseAuthInFirestore(e);try{return await this.apiRequest("team-members/create","POST",e)}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.createTeamMemberWithFirebaseAuthInFirestore(e)}}catch(t){return this.handleError(t,"createTeamMemberWithFirebaseAuth"),{success:!1,error:"Failed to create team member with Firebase Auth"}}}async getLicensedTeamMembersFromFirestore(e){try{console.log("🔍 [TeamMemberService] Fetching licensed team members from Firestore with options:",e),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();if(!t)return console.log("❌ [TeamMemberService] No authenticated user found"),[];let r=null;try{const n=await this.firestoreAdapter.getDocumentById("users",t.uid);if(n&&n.organizationId)r=n.organizationId,console.log("✅ [TeamMemberService] Found organization ID from user document:",r);else{const l=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:t.email}]);l.length>0&&l[0].organizationId&&(r=l[0].organizationId,console.log("✅ [TeamMemberService] Found organization ID from user email query:",r))}}catch(n){console.warn("⚠️ [TeamMemberService] Error getting user organization:",n)}if(!r)return console.log("❌ [TeamMemberService] No organization ID found for user"),[];console.log("🏢 [TeamMemberService] Fetching team members for organization:",r),console.log("🔍 [TeamMemberService] Using UnifiedDataService for enhanced team member fetching...");let o=[];try{const{unifiedDataService:n}=await p(async()=>{const{unifiedDataService:c}=await import("./UnifiedDataService-zaxS59cN.js");return{unifiedDataService:c}},__vite__mapDeps([9,1,2,3,4,5,7,6,10,0,8])),l=await n.getTeamMembersForOrganization();console.log(`📊 [TeamMemberService] Found ${l.length} team members from UnifiedDataService`),o=l.filter(c=>c.status==="active").map(c=>{var d,m;return{id:c.id,email:c.email,firstName:c.firstName,lastName:c.lastName,name:`${c.firstName} ${c.lastName}`.trim()||c.email,role:c.role,status:k.ACTIVE,department:c.department,organizationId:c.organization.id,licenseType:((d=c.licenseAssignment)==null?void 0:d.licenseType)||"BASIC",assignedProjects:c.assignedProjects,createdAt:c.createdAt.toISOString(),updatedAt:c.updatedAt.toISOString(),isActive:!0,joinedAt:c.joinedAt.toISOString(),lastActive:(m=c.lastActive)==null?void 0:m.toISOString(),invitedBy:c.invitedBy,avatar:c.avatar}}),console.log(`✅ [TeamMemberService] Converted ${o.length} active team members from UnifiedDataService`)}catch(n){console.warn("⚠️ [TeamMemberService] UnifiedDataService failed, falling back to direct Firestore query:",n);const l=await this.firestoreAdapter.queryDocuments("teamMembers",[{field:"organizationId",operator:"==",value:r}]);console.log(`🔍 [TeamMemberService] Raw team members found: ${l.length}`),o=l.filter(c=>{var m,P;const d=((P=(m=c.status)==null?void 0:m.toUpperCase)==null?void 0:P.call(m))||c.status||"UNKNOWN";return d!=="ACTIVE"&&d!=="active"?(console.log(`⚠️ [TeamMemberService] Excluding team member ${c.email} with status: ${d}`),!1):c.isActive===!1?(console.log(`⚠️ [TeamMemberService] Excluding team member ${c.email} with isActive: false`),!1):c.revokedAt||c.removedAt||c.suspendedAt?(console.log(`⚠️ [TeamMemberService] Excluding team member ${c.email} with revocation/removal dates`),!1):!0}),console.log(`✅ [TeamMemberService] Active team members after filtering: ${o.length}`)}let s=[];if(e!=null&&e.excludeProjectId)try{s=(await this.getProjectTeamMembersFromFirestore(e.excludeProjectId)).map(l=>l.teamMemberId),console.log(`🔍 [TeamMemberService] Excluding ${s.length} already assigned team members`)}catch(n){console.warn("⚠️ [TeamMemberService] Failed to get assigned team members:",n)}const a=o.filter(n=>{if(s.includes(n.id))return!1;if(e!=null&&e.search){const l=e.search.toLowerCase(),c=(n.name||"").toLowerCase(),d=(n.firstName||"").toLowerCase(),m=(n.lastName||"").toLowerCase(),P=(n.email||"").toLowerCase();return c.includes(l)||d.includes(l)||m.includes(l)||P.includes(l)}return!0}).map(n=>{let l=n.name;l||(n.firstName&&n.lastName?l=`${n.firstName} ${n.lastName}`:n.firstName?l=n.firstName:n.lastName?l=n.lastName:n.email?l=n.email.split("@")[0].replace(/[._-]/g," ").split(" ").map(P=>P.charAt(0).toUpperCase()+P.slice(1).toLowerCase()).join(" "):l="Unknown User");let c=n.licenseType;return c||(c="professional"),{...n,name:l,licenseType:c,status:"active",isActive:!0}});return a.sort((n,l)=>{const c=(n.name||"").toLowerCase(),d=(l.name||"").toLowerCase();return c.localeCompare(d)}),console.log(`✅ [TeamMemberService] Final filtered and mapped team members: ${a.length}`),a}catch(t){return this.handleError(t,"getLicensedTeamMembersFromFirestore"),[]}}async getProjectTeamMembersFromFirestore(e){try{console.log("🔍 [TeamMemberService] Fetching team members from Firestore for project:",e),await this.firestoreAdapter.initialize();const t=[],r=await this.firestoreAdapter.getDocumentById("projects",e);if(r){const s=r.teamMembers||[];for(const i of s)t.push({id:i.userId||i.id,teamMemberId:i.userId||i.id,projectId:e,role:i.role||"member",permissions:i.permissions||["read"],assignedAt:i.assignedAt||new Date().toISOString(),isActive:i.isActive!==!1,email:i.email,name:i.name||i.email,status:i.status||"active"})}try{const s=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e}]);for(const i of s)t.find(a=>a.teamMemberId===i.teamMemberId)||t.push(i)}catch{console.log("ℹ️ [TeamMemberService] projectTeamMembers collection not found or accessible")}const o=[];for(const s of t)try{let i=null;try{i=await this.firestoreAdapter.getDocumentById("teamMembers",s.teamMemberId),i&&console.log("✅ [TeamMemberService] Found team member in teamMembers collection:",i.name||i.email)}catch{console.log("🔍 [TeamMemberService] Team member not found in teamMembers, trying users collection...")}if(!i)try{i=await this.firestoreAdapter.getDocumentById("users",s.teamMemberId),i&&console.log("✅ [TeamMemberService] Found team member in users collection:",i.name||i.email)}catch{console.log("🔍 [TeamMemberService] Team member not found in users collection either")}if(i){let a="Unnamed User";i.name&&i.name!=="Unnamed User"?a=i.name:i.firstName&&i.lastName?a=`${i.firstName} ${i.lastName}`:i.firstName?a=i.firstName:i.lastName?a=i.lastName:i.email&&(a=i.email.split("@")[0].replace(/[._-]/g," ").split(" ").map(l=>l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join(" ")),console.log("🔍 [TeamMemberService] Extracted display name:",a,"from profile:",{name:i.name,firstName:i.firstName,lastName:i.lastName,email:i.email}),o.push({...s,name:a,email:i.email||s.email||"No email",teamMember:{...i,name:a}})}else console.warn("⚠️ [TeamMemberService] No profile found for team member:",s.teamMemberId),o.push(s)}catch(i){console.warn("⚠️ [TeamMemberService] Failed to get full profile for team member:",s.teamMemberId,i),o.push(s)}return console.log(`✅ [TeamMemberService] Found ${o.length} team members for project ${e}`),o}catch(t){return this.handleError(t,`getProjectTeamMembersFromFirestore(${e})`),[]}}async addTeamMemberToProjectInFirestore(e,t,r){try{console.log("🔍 [TeamMemberService] Adding team member to project in Firestore:",{projectId:e,teamMemberId:t,role:r}),await this.firestoreAdapter.initialize();let o=null;if(o=await this.firestoreAdapter.getDocumentById("teamMembers",t),!o){console.log("🔍 [TeamMemberService] Team member not found in teamMembers, trying users collection...");const a=await this.firestoreAdapter.getDocumentById("users",t);a&&(o={id:a.id,email:a.email,name:a.name||`${a.firstName||""} ${a.lastName||""}`.trim(),firstName:a.firstName,lastName:a.lastName,role:a.role||"MEMBER",licenseType:a.licenseType||"BASIC",status:a.status||"ACTIVE",organizationId:a.organizationId,department:a.department,company:a.company,createdAt:a.createdAt||new Date,updatedAt:a.updatedAt||new Date},console.log("✅ [TeamMemberService] Found team member in users collection:",o.name))}if(!o){console.log("🔍 [TeamMemberService] Team member not found in users, trying orgMembers collection...");const a=await this.firestoreAdapter.getDocumentById("orgMembers",t);a&&(o={id:a.id,email:a.email,name:a.name||`${a.firstName||""} ${a.lastName||""}`.trim(),firstName:a.firstName,lastName:a.lastName,role:a.role||"MEMBER",licenseType:a.licenseType||"BASIC",status:a.status||"ACTIVE",organizationId:a.organizationId,department:a.department,company:a.company,createdAt:a.createdAt||new Date,updatedAt:a.updatedAt||new Date},console.log("✅ [TeamMemberService] Found team member in orgMembers collection:",o.name))}if(!o)throw console.warn("⚠️ [TeamMemberService] Team member not found in any collection:",t),new Error(`Team member not found: ${t}`);if(r===S.ADMIN&&(await this.getProjectTeamMembersFromFirestore(e)).some(l=>l.role===S.ADMIN))throw console.warn("⚠️ [TeamMemberService] Only one Admin is allowed per project"),new Error("Only one Admin is allowed per project. Please remove the existing Admin first.");const s={projectId:e,teamMemberId:t,role:r,assignedBy:"system",assignedAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0,teamMemberName:o.name||"Unknown User",teamMemberEmail:o.email||"No email",teamMemberRole:o.role||"MEMBER",teamMemberLicenseType:o.licenseType||"BASIC"};return await this.firestoreAdapter.createDocument("projectTeamMembers",s)!==null}catch(o){return this.handleError(o,`addTeamMemberToProjectInFirestore(${e}, ${t})`),!1}}async removeTeamMemberFromProjectInFirestore(e,t){try{console.log("🔍 [TeamMemberService] Removing team member from project in Firestore:",{projectId:e,teamMemberId:t}),await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e},{field:"teamMemberId",operator:"==",value:t}]);return r.length===0?(console.warn("⚠️ [TeamMemberService] Team member not found in project"),!1):await this.firestoreAdapter.deleteDocument("projectTeamMembers",r[0].id)}catch(r){return this.handleError(r,`removeTeamMemberFromProjectInFirestore(${e}, ${t})`),!1}}async updateTeamMemberRoleInFirestore(e,t,r){try{console.log("🔍 [TeamMemberService] Updating team member role in Firestore:",{projectId:e,teamMemberId:t,role:r}),await this.firestoreAdapter.initialize();const o=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e},{field:"teamMemberId",operator:"==",value:t}]);if(o.length===0)return console.warn("⚠️ [TeamMemberService] Team member not found in project"),!1;if(r===S.ADMIN&&(await this.getProjectTeamMembersFromFirestore(e)).some(n=>n.role===S.ADMIN&&n.teamMemberId!==t))throw console.warn("⚠️ [TeamMemberService] Only one Admin is allowed per project"),new Error("Only one Admin is allowed per project. Please remove the existing Admin first.");return await this.firestoreAdapter.updateDocument("projectTeamMembers",o[0].id,{role:r,updatedAt:new Date().toISOString()})}catch(o){return this.handleError(o,`updateTeamMemberRoleInFirestore(${e}, ${t})`),!1}}async validateTeamMemberCredentialsFromFirestore(e,t){try{await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.queryDocuments("teamMembers",[{field:"email",operator:"==",value:e}]);if(r.length===0)return{isValid:!1,error:"Team member not found"};const o=r[0];return t.length<1?{isValid:!1,error:"Password is required"}:{isValid:!0,teamMember:o,projectAccess:[]}}catch(r){return this.handleError(r,"validateTeamMemberCredentialsFromFirestore"),{isValid:!1,error:"Authentication failed"}}}async createTeamMemberWithFirebaseAuthInFirestore(e){try{console.log("🔍 [TeamMemberService] Creating team member with Firebase Auth in Firestore:",e),await this.firestoreAdapter.initialize();const{auth:t}=await p(async()=>{const{auth:c}=await import("./firebase-CbWLKc5U.js");return{auth:c}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{createUserWithEmailAndPassword:r}=await p(async()=>{const{createUserWithEmailAndPassword:c}=await import("./index.esm-CiRfLMBX.js");return{createUserWithEmailAndPassword:c}},__vite__mapDeps([8,6])),o=e.temporaryPassword||this.generateSecurePassword();let s;try{s=(await r(t,e.email,o)).user,console.log("✅ [TeamMemberService] Firebase Auth user created successfully:",s.uid)}catch(c){if(c.code==="auth/email-already-in-use")return{success:!1,error:"User with this email already exists in Firebase Authentication"};throw c}const i={id:s.uid,email:e.email,firstName:e.firstName,lastName:e.lastName,name:`${e.firstName} ${e.lastName}`,licenseType:e.licenseType||"PROFESSIONAL",status:"ACTIVE",organizationId:e.organizationId,department:e.department,role:e.role||"MEMBER",firebaseUid:s.uid,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0},a={id:s.uid,email:e.email,name:`${e.firstName} ${e.lastName}`,firstName:e.firstName,lastName:e.lastName,role:"TEAM_MEMBER",firebaseUid:s.uid,isEmailVerified:!1,twoFactorEnabled:!1,twoFactorBackupCodes:[],privacyConsent:[],marketingConsent:!1,dataProcessingConsent:!1,identityVerified:!1,kycStatus:"PENDING",isTeamMember:!0,organizationId:e.organizationId,memberRole:e.role||"MEMBER",memberStatus:"ACTIVE",department:e.department,licenseType:e.licenseType||"PROFESSIONAL",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};let n=null,l=null;if(n=await this.firestoreAdapter.createDocument("teamMembers",i),n&&(l=await this.firestoreAdapter.createDocument("users",a)),!n||!l){try{await s.delete(),console.log("🔄 [TeamMemberService] Rolled back Firebase Auth user after Firestore failure")}catch(c){console.error("❌ [TeamMemberService] Failed to rollback Firebase Auth user:",c)}return{success:!1,error:"Failed to create required documents in Firestore"}}return console.log("✅ [TeamMemberService] Team member created successfully in Firestore"),{success:!0,teamMember:i,firebaseUid:s.uid,temporaryPassword:o}}catch(t){return this.handleError(t,"createTeamMemberWithFirebaseAuthInFirestore"),{success:!1,error:(t==null?void 0:t.message)||"Failed to create team member with Firebase Auth"}}}generateSecurePassword(){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";let r="";r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)],r+="abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random()*26)],r+="0123456789"[Math.floor(Math.random()*10)],r+="!@#$%^&*"[Math.floor(Math.random()*8)];for(let o=4;o<12;o++)r+=t[Math.floor(Math.random()*t.length)];return r.split("").sort(()=>Math.random()-.5).join("")}};D(C,"instance");let L=C;const _=class _{constructor(){D(this,"config");D(this,"projectService",null);D(this,"teamMemberService",null);this.config={isWebOnlyMode:this.detectWebOnlyMode(),apiBaseUrl:"/api"},this.initializeFirestoreAdapter()}static getInstance(){return _.instance||(_.instance=new _),_.instance}initialize(e){this.config={...this.config,...e},console.log("🔧 [ServiceFactory] Initialized with config:",this.config),this.projectService=null,this.teamMemberService=null}getProjectService(){return this.projectService||(this.projectService=N.getInstance(this.config)),this.projectService}getTeamMemberService(){return this.teamMemberService||(this.teamMemberService=L.getInstance(this.config)),this.teamMemberService}detectWebOnlyMode(){if(typeof window<"u"){const e=new URLSearchParams(window.location.search);if(e.has("webonly"))return e.get("webonly")==="true";const t=localStorage.getItem("webonly_mode");if(t)return t==="true";if(window.ENV&&window.ENV.WEBONLY)return window.ENV.WEBONLY===!0}return!0}async initializeFirestoreAdapter(){try{await R.getInstance().initialize()}catch(e){console.error("❌ [ServiceFactory] Failed to initialize Firestore adapter:",e)}}};D(_,"instance");let q=_;const O=class O{constructor(){D(this,"serviceFactory");D(this,"authTokenCallback",null);D(this,"isInitialized",!1);this.serviceFactory=q.getInstance(),this.serviceFactory.initialize({isWebOnlyMode:this.isWebOnlyMode()})}static getInstance(){return O.instance||(O.instance=new O),O.instance}isWebOnlyMode(){if(typeof window<"u"){const e=new URLSearchParams(window.location.search);if(e.has("webonly"))return e.get("webonly")==="true";const t=localStorage.getItem("webonly_mode");if(t)return t==="true";if(window.ENV&&window.ENV.WEBONLY)return window.ENV.WEBONLY===!0}return!0}setConfig(e){this.serviceFactory.initialize(e)}async getProjects(){return await this.serviceFactory.getProjectService().getProjects()}async getUserProjects(){return await this.serviceFactory.getProjectService().getProjects()}async getProject(e){return await this.serviceFactory.getProjectService().getProject(e)}async createProject(e){return await this.serviceFactory.getProjectService().createProject(e)}async createCloudProject(e){return await this.serviceFactory.getProjectService().createProject(e)}async createCloudProjectInFirestore(e){return await this.serviceFactory.getProjectService().createProject(e)}async updateProject(e,t){return await this.serviceFactory.getProjectService().updateProject(e,t)}async updateProjectInFirestore(e,t){return await this.serviceFactory.getProjectService().updateProject(e,t)}async archiveProject(e){return await this.serviceFactory.getProjectService().archiveProject(e)}async archiveProjectInFirestore(e){return await this.serviceFactory.getProjectService().archiveProject(e)}async restoreProject(e){return await this.serviceFactory.getProjectService().restoreProject(e)}async deleteProject(e){return await this.serviceFactory.getProjectService().deleteProject(e)}async listDatasets(e){try{return console.log("🔍 [CloudProjectIntegration] Listing all datasets with params:",e),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - fetching all datasets from Firestore"),await this.getAllDatasetsFromFirestore(e)):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.getAllDatasetsFromFirestore(e))}catch(t){return console.error("❌ [CloudProjectIntegration] Failed to list datasets:",t),[]}}async createDataset(e){try{return console.log("🔍 [CloudProjectIntegration] Creating dataset with input:",e),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - creating dataset in Firestore"),await this.createDatasetInFirestore(e)):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.createDatasetInFirestore(e))}catch(t){throw console.error("❌ [CloudProjectIntegration] Failed to create dataset:",t),t}}async updateDataset(e,t){try{return console.log("🔍 [CloudProjectIntegration] Updating dataset:",e,"with updates:",t),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - updating dataset in Firestore"),await this.updateDatasetInFirestore(e,t)):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.updateDatasetInFirestore(e,t))}catch(r){throw console.error("❌ [CloudProjectIntegration] Failed to update dataset:",r),r}}async getProjectDatasets(e){try{return console.log("🔍 [CloudProjectIntegration] Getting datasets for project:",e),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - fetching datasets from Firestore for project:",e),await this.getProjectDatasetsFromFirestore(e)):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.getProjectDatasetsFromFirestore(e))}catch(t){return console.error("❌ [CloudProjectIntegration] Failed to get project datasets:",t),[]}}async assignDatasetToProject(e,t){try{return console.log("🔍 [CloudProjectIntegration] Assigning dataset to project:",{projectId:e,datasetId:t}),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - assigning dataset to project in Firestore"),await this.assignDatasetToProjectInFirestore(e,t)):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.assignDatasetToProjectInFirestore(e,t))}catch(r){throw console.error("❌ [CloudProjectIntegration] Failed to assign dataset to project:",r),r}}async unassignDatasetFromProject(e,t){await this.unassignDatasetFromProjectInFirestore(e,t)}async unassignDatasetFromProjectInFirestore(e,t){try{console.log("🔍 [CloudProjectIntegration] Unassigning dataset from project in Firestore:",{projectId:e,datasetId:t});const{db:r}=await p(async()=>{const{db:u}=await import("./firebase-CbWLKc5U.js");return{db:u}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{doc:o,updateDoc:s,getDoc:i,collection:a,query:n,where:l,getDocs:c,deleteDoc:d}=await p(async()=>{const{doc:u,updateDoc:b,getDoc:T,collection:F,query:w,where:g,getDocs:I,deleteDoc:z}=await import("./index.esm-9jaBBmwp.js");return{doc:u,updateDoc:b,getDoc:T,collection:F,query:w,where:g,getDocs:I,deleteDoc:z}},__vite__mapDeps([7,6])),m=o(r,"datasets",t),P=await i(m);if(!P.exists())throw new Error("Dataset not found");P.data().projectId!==e&&console.log("⚠️ [CloudProjectIntegration] Dataset is not assigned to this project, but continuing cleanup..."),await s(m,{projectId:null,updatedAt:new Date().toISOString()}),console.log("✅ [CloudProjectIntegration] Cleared projectId from dataset");const v=n(a(r,"project_datasets"),l("projectId","==",e),l("datasetId","==",t)),f=await c(v);console.log(`🔍 [CloudProjectIntegration] Found ${f.size} project_datasets links to remove`);const y=[];f.forEach(u=>{console.log(`🗑️ [CloudProjectIntegration] Removing project_datasets link: ${u.id}`),y.push(d(u.ref))}),await Promise.all(y),console.log(`✅ [CloudProjectIntegration] Removed ${y.length} project_datasets links`);const h=o(r,"projects",e);await s(h,{updatedAt:new Date().toISOString()}),console.log("✅ [CloudProjectIntegration] Updated project timestamp"),console.log("🎉 [CloudProjectIntegration] Successfully unassigned dataset from project")}catch(r){throw console.error("❌ [CloudProjectIntegration] Error unassigning dataset from project:",r),r}}async deleteDataset(e){try{console.log("🗑️ [CloudProjectIntegration] Deleting dataset:",e);const{db:t}=await p(async()=>{const{db:y}=await import("./firebase-CbWLKc5U.js");return{db:y}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{doc:r,getDoc:o,collection:s,query:i,where:a,getDocs:n,deleteDoc:l,writeBatch:c}=await p(async()=>{const{doc:y,getDoc:h,collection:u,query:b,where:T,getDocs:F,deleteDoc:w,writeBatch:g}=await import("./index.esm-9jaBBmwp.js");return{doc:y,getDoc:h,collection:u,query:b,where:T,getDocs:F,deleteDoc:w,writeBatch:g}},__vite__mapDeps([7,6])),d=r(t,"datasets",e),m=await o(d);if(!m.exists())throw new Error("Dataset not found");const P=m.data();console.log("🔍 [CloudProjectIntegration] Dataset found:",P.name);const j=c(t),v=i(s(t,"project_datasets"),a("datasetId","==",e)),f=await n(v);return console.log(`🔍 [CloudProjectIntegration] Found ${f.size} project_datasets links to remove`),f.forEach(y=>{console.log("🗑️ [CloudProjectIntegration] Deleting project_datasets link:",y.id),j.delete(y.ref)}),j.delete(d),await j.commit(),console.log("✅ [CloudProjectIntegration] Dataset deleted successfully"),!0}catch(t){throw console.error("❌ [CloudProjectIntegration] Failed to delete dataset:",t),t}}async cleanupCorruptedDatasets(){return{cleaned:0,errors:[]}}async createDatasetInFirestore(e){var t;try{console.log("🔍 [CloudProjectIntegration] Creating dataset in Firestore:",e);const{db:r,auth:o}=await p(async()=>{const{db:h,auth:u}=await import("./firebase-CbWLKc5U.js");return{db:h,auth:u}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{doc:s,setDoc:i,collection:a,getDoc:n}=await p(async()=>{const{doc:h,setDoc:u,collection:b,getDoc:T}=await import("./index.esm-9jaBBmwp.js");return{doc:h,setDoc:u,collection:b,getDoc:T}},__vite__mapDeps([7,6])),l=await this.waitForFirebaseAuth();if(!l)throw console.warn("⚠️ [CloudProjectIntegration] Cannot create dataset - authentication required"),new Error("Authentication required to create dataset");const d=(await n(s(r,"users",l.uid))).data();let m=(d==null?void 0:d.organizationId)||e.organizationId;if(!m)try{const h=localStorage.getItem("auth_user");if(h){const u=JSON.parse(h);m=(u==null?void 0:u.organizationId)||((t=u==null?void 0:u.teamMemberData)==null?void 0:t.organizationId)}}catch(h){console.warn("⚠️ [CloudProjectIntegration] Could not get organization ID from localStorage during creation:",h)}m||(m=l.uid),console.log("🔍 [CloudProjectIntegration] Creating dataset with organization ID:",{userId:l.uid,organizationId:m,inputOrganizationId:e.organizationId,userDataOrganizationId:d==null?void 0:d.organizationId});const P=s(a(r,"datasets")),j=new Date,v=e.collectionAssignment,f=(v==null?void 0:v.selectedCollections)||[],y={id:P.id,name:e.name,description:e.description||"",visibility:e.visibility||"private",tags:e.tags||[],schema:e.schema||{},storage:e.storage||{backend:"firestore"},ownerId:l.uid,organizationId:m,projectId:e.projectId||null,status:"ACTIVE",createdAt:j.toISOString(),updatedAt:j.toISOString(),lastAccessedAt:j.toISOString(),size:0,fileCount:0,collections:f,collectionAssignment:v||null};return await i(P,y),console.log("✅ [CloudProjectIntegration] Dataset created successfully in Firestore:",P.id),y}catch(r){throw console.error("❌ [CloudProjectIntegration] Failed to create dataset in Firestore:",r),r}}async updateDatasetInFirestore(e,t){var r,o;try{console.log("🔍 [CloudProjectIntegration] Updating dataset in Firestore:",e);const{db:s,auth:i}=await p(async()=>{const{db:w,auth:g}=await import("./firebase-CbWLKc5U.js");return{db:w,auth:g}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{doc:a,getDoc:n,updateDoc:l,serverTimestamp:c}=await p(async()=>{const{doc:w,getDoc:g,updateDoc:I,serverTimestamp:z}=await import("./index.esm-9jaBBmwp.js");return{doc:w,getDoc:g,updateDoc:I,serverTimestamp:z}},__vite__mapDeps([7,6])),d=await this.waitForFirebaseAuth();if(!d)throw new Error("User not authenticated");const m=a(s,"datasets",e),P=await n(m);if(!P.exists())throw new Error("Dataset not found");const j=P.data(),{doc:v}=await p(async()=>{const{doc:w}=await import("./index.esm-9jaBBmwp.js");return{doc:w}},__vite__mapDeps([7,6])),y=(await n(v(s,"users",d.uid))).data();let h=y==null?void 0:y.organizationId;if(!h)try{const w=localStorage.getItem("auth_user");if(w){const g=JSON.parse(w);h=(g==null?void 0:g.organizationId)||((r=g==null?void 0:g.teamMemberData)==null?void 0:r.organizationId)}}catch(w){console.warn("⚠️ [CloudProjectIntegration] Could not get organization ID from localStorage:",w)}if(h||(h=d.uid),console.log("🔍 [CloudProjectIntegration] Authorization check:",{datasetId:e,currentUserId:d.uid,datasetOrganizationId:j.organizationId,userOrganizationId:h,userData:y}),!(j.organizationId===h||j.ownerId===d.uid||!j.organizationId))throw console.error("❌ [CloudProjectIntegration] Authorization failed:",{reason:"Organization mismatch",datasetOrganizationId:j.organizationId,userOrganizationId:h,datasetOwnerId:j.ownerId,currentUserId:d.uid}),new Error("Unauthorized: Dataset belongs to different organization");const b={...t,updatedAt:new Date().toISOString(),lastAccessedAt:new Date().toISOString()};(o=b.collectionAssignment)!=null&&o.selectedCollections&&(b.collections=b.collectionAssignment.selectedCollections),delete b.id,delete b.ownerId,delete b.createdAt,console.log("🔄 [CloudProjectIntegration] Updating dataset with data:",b),await l(m,b);const F=(await n(m)).data();return console.log("✅ [CloudProjectIntegration] Dataset updated successfully in Firestore:",e),F}catch(s){throw console.error("❌ [CloudProjectIntegration] Failed to update dataset in Firestore:",s),s}}async getProjectDatasetsFromFirestore(e){var t,r,o,s,i,a;try{console.log("🔍 [CloudProjectIntegration] Getting datasets from Firestore for project:",e);const{db:n,auth:l}=await p(async()=>{const{db:b,auth:T}=await import("./firebase-CbWLKc5U.js");return{db:b,auth:T}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{collection:c,query:d,where:m,getDocs:P,doc:j,getDoc:v}=await p(async()=>{const{collection:b,query:T,where:F,getDocs:w,doc:g,getDoc:I}=await import("./index.esm-9jaBBmwp.js");return{collection:b,query:T,where:F,getDocs:w,doc:g,getDoc:I}},__vite__mapDeps([7,6]));if(!await this.waitForFirebaseAuth())return console.warn("⚠️ [CloudProjectIntegration] Cannot get project datasets - returning empty list"),[];const y=[],h=d(c(n,"project_datasets"),m("projectId","==",e)),u=await P(h);if(u.empty)return console.log(`✅ [CloudProjectIntegration] No dataset assignments found for project ${e}`),[];console.log(`🔍 [CloudProjectIntegration] Found ${u.size} dataset assignments for project ${e}`);for(const b of u.docs){const F=b.data().datasetId;if(!F){console.warn("⚠️ [CloudProjectIntegration] Project dataset link missing datasetId:",b.id);continue}try{const w=await v(j(n,"datasets",F));if(w.exists()){const g=w.data(),I={id:w.id,name:g.name||"Untitled Dataset",description:g.description||"",projectId:e,type:g.type||"general",status:g.status||"active",createdAt:((o=(r=(t=g.createdAt)==null?void 0:t.toDate)==null?void 0:r.call(t))==null?void 0:o.toISOString())||g.createdAt||new Date().toISOString(),updatedAt:((a=(i=(s=g.updatedAt)==null?void 0:s.toDate)==null?void 0:i.call(s))==null?void 0:a.toISOString())||g.updatedAt||new Date().toISOString(),size:g.size||0,recordCount:g.recordCount||0,schema:g.schema||{},tags:g.tags||[],isPublic:g.isPublic||!1,ownerId:g.ownerId,storage:g.storage||{backend:"firestore"},visibility:g.visibility||"private",collections:g.collections||[],collectionAssignment:g.collectionAssignment||null};y.push(I),console.log(`✅ [CloudProjectIntegration] Added dataset "${I.name}" (${I.id}) for project ${e}`)}else console.warn(`⚠️ [CloudProjectIntegration] Dataset ${F} referenced in project_datasets but not found in datasets collection`)}catch(w){console.error(`❌ [CloudProjectIntegration] Failed to fetch dataset ${F}:`,w)}}return y.sort((b,T)=>{const F=new Date(b.createdAt).getTime();return new Date(T.createdAt).getTime()-F}),console.log(`✅ [CloudProjectIntegration] Successfully loaded ${y.length} datasets for project ${e}`),y}catch(n){return console.error("❌ [CloudProjectIntegration] Failed to get datasets from Firestore:",n),[]}}async getAllDatasetsFromFirestore(e){try{console.log("🔍 [CloudProjectIntegration] Getting all datasets from Firestore with params:",e);const{db:t,auth:r}=await p(async()=>{const{db:h,auth:u}=await import("./firebase-CbWLKc5U.js");return{db:h,auth:u}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{collection:o,query:s,where:i,getDocs:a,orderBy:n}=await p(async()=>{const{collection:h,query:u,where:b,getDocs:T,orderBy:F}=await import("./index.esm-9jaBBmwp.js");return{collection:h,query:u,where:b,getDocs:T,orderBy:F}},__vite__mapDeps([7,6])),l=await this.waitForFirebaseAuth();if(!l)return console.warn("⚠️ [CloudProjectIntegration] Cannot get all datasets - returning empty list"),[];const{doc:c,getDoc:d}=await p(async()=>{const{doc:h,getDoc:u}=await import("./index.esm-9jaBBmwp.js");return{doc:h,getDoc:u}},__vite__mapDeps([7,6])),P=(await d(c(t,"users",l.uid))).data(),j=(P==null?void 0:P.organizationId)||(e==null?void 0:e.organizationId);let v=s(o(t,"datasets"),i("status","==","ACTIVE"),n("updatedAt","desc"));j&&(v=s(o(t,"datasets"),i("organizationId","==",j),i("status","==","ACTIVE"),n("updatedAt","desc")));let y=(await a(v)).docs.map(h=>({...h.data(),id:h.id}));if(e!=null&&e.visibility&&(y=y.filter(h=>h.visibility===e.visibility)),e!=null&&e.query){const h=e.query.toLowerCase();y=y.filter(u=>u.name.toLowerCase().includes(h)||u.description&&u.description.toLowerCase().includes(h))}return console.log(`✅ [CloudProjectIntegration] Found ${y.length} datasets`),y}catch(t){return console.error("❌ [CloudProjectIntegration] Failed to get all datasets from Firestore:",t),[]}}async getAllOrganizationDatasets(){try{return console.log("🔍 [CloudProjectIntegration] Getting all datasets for organization"),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - fetching all organization datasets from Firestore"),await this.getAllDatasetsFromFirestore()):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.getAllDatasetsFromFirestore())}catch(e){return console.error("❌ [CloudProjectIntegration] Failed to get organization datasets:",e),[]}}async assignDatasetToProjectInFirestore(e,t){var r,o;try{console.log("🔍 [CloudProjectIntegration] Assigning dataset to project in Firestore:",{projectId:e,datasetId:t});const{db:s}=await p(async()=>{const{db:w}=await import("./firebase-CbWLKc5U.js");return{db:w}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{doc:i,updateDoc:a,getDoc:n,collection:l,addDoc:c,query:d,where:m,getDocs:P}=await p(async()=>{const{doc:w,updateDoc:g,getDoc:I,collection:z,addDoc:B,query:x,where:G,getDocs:H}=await import("./index.esm-9jaBBmwp.js");return{doc:w,updateDoc:g,getDoc:I,collection:z,addDoc:B,query:x,where:G,getDocs:H}},__vite__mapDeps([7,6])),j=i(s,"datasets",t),v=await n(j);if(!v.exists())throw new Error("Dataset not found");const f=v.data();console.log("🔍 [CloudProjectIntegration] Dataset data:",{id:t,name:f==null?void 0:f.name,collections:f==null?void 0:f.collections,collectionAssignment:f==null?void 0:f.collectionAssignment});const y=i(s,"projects",e),h=await n(y);if(!h.exists())throw new Error("Project not found");const u=h.data(),b=(u==null?void 0:u.organizationId)||(u==null?void 0:u.organization_id);console.log("🔍 [CloudProjectIntegration] Project data:",{id:e,name:u==null?void 0:u.name,organizationId:b}),await a(j,{projectId:e,updatedAt:new Date().toISOString()});const T=d(l(s,"project_datasets"),m("projectId","==",e),m("datasetId","==",t)),F=await P(T);if(F.empty){console.log("🔍 [CloudProjectIntegration] Creating new dataset assignment with collection data");const w=(f==null?void 0:f.collections)||((o=f==null?void 0:f.collectionAssignment)==null?void 0:o.selectedCollections)||[];console.log("🔍 [CloudProjectIntegration] Extracted collections for assignment:",w);const g={projectId:e,datasetId:t,addedByUserId:(f==null?void 0:f.ownerId)||"system",addedAt:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),assignedCollections:w,collectionAssignment:{selectedCollections:w,assignmentMode:"EXCLUSIVE",priority:1,routingEnabled:!0},organizationId:b,tenantId:b,isActive:!0};await c(l(s,"project_datasets"),g),console.log("✅ [CloudProjectIntegration] Created new dataset assignment with collection data")}else{console.log("⚠️ [CloudProjectIntegration] Dataset already assigned to project, updating existing assignment");const w=F.docs[0],g=w.data(),I=(f==null?void 0:f.collections)||((r=f==null?void 0:f.collectionAssignment)==null?void 0:r.selectedCollections)||[];await a(w.ref,{assignedCollections:I,collectionAssignment:{selectedCollections:I,assignmentMode:"EXCLUSIVE",priority:1,routingEnabled:!0},organizationId:b,tenantId:b,isActive:!0,updatedAt:new Date().toISOString()}),console.log("✅ [CloudProjectIntegration] Updated existing dataset assignment with collection data")}await a(y,{updatedAt:new Date().toISOString(),lastAccessedAt:new Date().toISOString()}),console.log("✅ [CloudProjectIntegration] Dataset assigned to project successfully in Firestore")}catch(s){throw console.error("❌ [CloudProjectIntegration] Failed to assign dataset to project in Firestore:",s),s}}async getLicensedTeamMembers(e){return await this.serviceFactory.getTeamMemberService().getLicensedTeamMembers(e)}async getProjectTeamMembers(e){return await this.serviceFactory.getTeamMemberService().getProjectTeamMembers(e)}async addTeamMemberToProject(e,t,r=S.MEMBER){await this.serviceFactory.getTeamMemberService().addTeamMemberToProject(e,t,r)}async removeTeamMemberFromProject(e,t){await this.serviceFactory.getTeamMemberService().removeTeamMemberFromProject(e,t)}async updateTeamMemberRole(e,t,r){await this.serviceFactory.getTeamMemberService().updateTeamMemberRole(e,t,r)}async validateTeamMemberCredentials(e,t){return await this.serviceFactory.getTeamMemberService().validateTeamMemberCredentials(e,t)}setAuthTokenCallback(e){this.authTokenCallback=e}setAuthToken(e){console.log("Setting auth token:",e),typeof localStorage<"u"&&localStorage.setItem("auth_token",e),this.authTokenCallback&&this.authTokenCallback()}cleanDocumentData(e){const t={};for(const[r,o]of Object.entries(e))if(o!==void 0){if(o===null){t[r]=null;continue}if(typeof o=="object"&&!Array.isArray(o)&&!(o instanceof Date)){t[r]=this.cleanDocumentData(o);continue}t[r]=o}return t}async waitForFirebaseAuth(e=5e3){const{auth:t}=await p(async()=>{const{auth:o}=await import("./firebase-CbWLKc5U.js");return{auth:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{onAuthStateChanged:r}=await p(async()=>{const{onAuthStateChanged:o}=await import("./index.esm-CiRfLMBX.js");return{onAuthStateChanged:o}},__vite__mapDeps([8,6]));return t.currentUser?t.currentUser:(console.log("⏳ [CloudProjectIntegration] Waiting for Firebase Auth initialization..."),new Promise(o=>{const s=setTimeout(()=>{console.warn("⚠️ [CloudProjectIntegration] Firebase Auth timeout after waiting"),o(null)},e),i=r(t,a=>{clearTimeout(s),i(),a?console.log("✅ [CloudProjectIntegration] Firebase Auth ready, user authenticated:",a.email):console.log("ℹ️ [CloudProjectIntegration] Firebase Auth ready, but no user authenticated"),o(a)})}))}};D(O,"instance");let U=O;const W=U.getInstance();typeof window<"u"&&(window.cloudProjectIntegration=W);const K=Object.freeze(Object.defineProperty({__proto__:null,cloudProjectIntegration:W},Symbol.toStringTag,{value:"Module"}));export{K as C,S as T,L as a,W as c};
