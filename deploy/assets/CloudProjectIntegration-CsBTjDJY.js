const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-9RUeii3H.js","assets/index-C07VFfex.js","assets/mui-DuSXeEGQ.js","assets/vendor-CjD1bmmO.js","assets/stripe-C4BKHrkR.js","assets/index-CBai7h7s.css","assets/index.esm--uL3Qa3r.js","assets/index.esm-C6E5jVjx.js","assets/index.esm-K73FumZQ.js","assets/UnifiedDataService-DN5XLEWa.js","assets/FirestoreCollectionManager-BtBvBaPP.js"])))=>i.map(i=>d[i]);
var L=Object.defineProperty;var V=(w,e,t)=>e in w?L(w,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):w[e]=t;var b=(w,e,t)=>V(w,typeof e!="symbol"?e+"":e,t);import{_ as g}from"./index-C07VFfex.js";import"./mui-DuSXeEGQ.js";import"./vendor-CjD1bmmO.js";import"./stripe-C4BKHrkR.js";const A=class A{constructor(){b(this,"db");b(this,"auth")}static arrayUnion(e){return{_method:"arrayUnion",value:e}}static arrayRemove(e){return{_method:"arrayRemove",value:e}}static getInstance(){return A.instance||(A.instance=new A),A.instance}async initialize(){const e=await g(()=>import("./firebase-9RUeii3H.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));this.db=e.db,this.auth=e.auth}getCurrentUser(){var e;return(e=this.auth)==null?void 0:e.currentUser}async getDocumentById(e,t){try{const{doc:r,getDoc:o}=await g(async()=>{const{doc:u,getDoc:i}=await import("./index.esm-C6E5jVjx.js");return{doc:u,getDoc:i}},__vite__mapDeps([7,6])),n=r(this.db,e,t),s=await o(n);if(s.exists()){const u=s.data();return{id:s.id,...this.convertFirestoreDates(u)}}return null}catch(r){return console.error(`❌ [FirestoreAdapter] Error getting document ${t} from ${e}:`,r),null}}async queryDocuments(e,t=[]){try{const{collection:r,query:o,where:n,getDocs:s}=await g(async()=>{const{collection:l,query:m,where:h,getDocs:v}=await import("./index.esm-C6E5jVjx.js");return{collection:l,query:m,where:h,getDocs:v}},__vite__mapDeps([7,6])),u=r(this.db,e);let i;if(t.length>0){let l=[];for(const m of t)l.push(n(m.field,m.operator,m.value));i=o(u,...l)}else i=o(u);const c=await s(i),a=[];return c.forEach(l=>{const m=l.data();a.push({id:l.id,...this.convertFirestoreDates(m)})}),a}catch(r){return console.error(`❌ [FirestoreAdapter] Error querying ${e}:`,r),[]}}async createDocument(e,t){try{const{collection:r,addDoc:o}=await g(async()=>{const{collection:u,addDoc:i}=await import("./index.esm-C6E5jVjx.js");return{collection:u,addDoc:i}},__vite__mapDeps([7,6])),n=this.cleanDocumentData({...t,createdAt:new Date,updatedAt:new Date});return{id:(await o(r(this.db,e),n)).id,...n}}catch(r){return console.error(`❌ [FirestoreAdapter] Error creating document in ${e}:`,r),null}}async updateDocumentWithArrayOps(e,t,r){try{const{doc:o,updateDoc:n}=await g(async()=>{const{doc:a,updateDoc:l}=await import("./index.esm-C6E5jVjx.js");return{doc:a,updateDoc:l}},__vite__mapDeps([7,6])),{arrayUnion:s,arrayRemove:u}=await g(async()=>{const{arrayUnion:a,arrayRemove:l}=await import("./index.esm-C6E5jVjx.js");return{arrayUnion:a,arrayRemove:l}},__vite__mapDeps([7,6])),i={};for(const[a,l]of Object.entries(r))l&&typeof l=="object"&&l._method==="arrayUnion"?i[a]=s(l.value):l&&typeof l=="object"&&l._method==="arrayRemove"?i[a]=u(l.value):i[a]=l;const c=this.cleanDocumentData({...i,updatedAt:new Date});return await n(o(this.db,e,t),c),!0}catch(o){return console.error(`❌ [FirestoreAdapter] Error updating document ${t} in ${e} with array ops:`,o),!1}}async updateDocument(e,t,r){try{const{doc:o,updateDoc:n}=await g(async()=>{const{doc:u,updateDoc:i}=await import("./index.esm-C6E5jVjx.js");return{doc:u,updateDoc:i}},__vite__mapDeps([7,6])),s=this.cleanDocumentData({...r,updatedAt:new Date});return await n(o(this.db,e,t),s),!0}catch(o){return console.error(`❌ [FirestoreAdapter] Error updating document ${t} in ${e}:`,o),!1}}async deleteDocument(e,t){try{const{doc:r,deleteDoc:o}=await g(async()=>{const{doc:n,deleteDoc:s}=await import("./index.esm-C6E5jVjx.js");return{doc:n,deleteDoc:s}},__vite__mapDeps([7,6]));return await o(r(this.db,e,t)),!0}catch(r){return console.error(`❌ [FirestoreAdapter] Error deleting document ${t} from ${e}:`,r),!1}}cleanDocumentData(e){const t={};for(const[r,o]of Object.entries(e))if(o!==void 0){if(o===null){t[r]=null;continue}if(typeof o=="object"&&!Array.isArray(o)&&!(o instanceof Date)){t[r]=this.cleanDocumentData(o);continue}t[r]=o}return t}convertFirestoreDates(e){const t={};for(const[r,o]of Object.entries(e))o&&typeof o=="object"&&o.toDate&&typeof o.toDate=="function"?t[r]=o.toDate().toISOString():o&&typeof o=="object"&&!Array.isArray(o)?t[r]=this.convertFirestoreDates(o):t[r]=o;return t}};b(A,"instance");let C=A;class z{constructor(e){b(this,"config");b(this,"firestoreAdapter");this.config=e,this.firestoreAdapter=C.getInstance()}isWebOnlyMode(){return this.config.isWebOnlyMode}getConfig(){return this.config}async apiRequest(e,t="GET",r,o){try{const s=`${this.config.apiBaseUrl||"/api"}/${e.startsWith("/")?e.substring(1):e}`,u={"Content-Type":"application/json",...o},i={method:t,headers:u,credentials:"include"};r&&(t==="POST"||t==="PATCH")&&(i.body=JSON.stringify(r));const c=await fetch(s,i);if(!c.ok)throw new Error(`API request failed: ${c.status} ${c.statusText}`);const a=c.headers.get("content-type");return a&&a.includes("application/json")?await c.json():await c.text()}catch(n){throw console.error(`❌ [BaseService] API request failed for ${e}:`,n),n}}handleError(e,t){console.error(`❌ [${this.constructor.name}] Error in ${t}:`,e)}}var p=(w=>(w.ADMIN="ADMIN",w.MEMBER="MEMBER",w.VIEWER="VIEWER",w.OWNER="OWNER",w.DO_ER="DO_ER",w))(p||{}),D=(w=>(w.ACTIVE="active",w.ARCHIVED="archived",w.DELETED="deleted",w.DRAFT="draft",w))(D||{});const T=class T extends z{constructor(e){super(e)}static getInstance(e){return T.instance||(T.instance=new T(e)),T.instance}async getProjects(){try{if(console.log("🚀 [ProjectService] Getting all projects"),this.isWebOnlyMode())return await this.getProjectsFromFirestore();try{return await this.apiRequest("projects")}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.getProjectsFromFirestore()}}catch(e){return this.handleError(e,"getProjects"),[]}}async getProject(e){try{if(console.log(`🚀 [ProjectService] Getting project: ${e}`),this.isWebOnlyMode())return await this.getProjectFromFirestore(e);try{return await this.apiRequest(`projects/${e}`)}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.getProjectFromFirestore(e)}}catch(t){return this.handleError(t,`getProject(${e})`),null}}async createProject(e){try{if(console.log("🚀 [ProjectService] Creating new project"),this.isWebOnlyMode())return await this.createProjectInFirestore(e);try{return await this.apiRequest("projects","POST",e)}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.createProjectInFirestore(e)}}catch(t){return this.handleError(t,"createProject"),null}}async updateProject(e,t){try{if(console.log(`🚀 [ProjectService] Updating project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}`,"PATCH",t)}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`updateProject(${e})`),null}}async archiveProject(e){try{if(console.log(`🚀 [ProjectService] Archiving project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,{status:D.ARCHIVED})!==null;try{return await this.apiRequest(`projects/${e}/archive`,"POST"),!0}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,{status:D.ARCHIVED})!==null}}catch(t){return this.handleError(t,`archiveProject(${e})`),!1}}async restoreProject(e){try{if(console.log(`🚀 [ProjectService] Restoring project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,{status:D.ACTIVE})!==null;try{return await this.apiRequest(`projects/${e}/restore`,"POST"),!0}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,{status:D.ACTIVE})!==null}}catch(t){return this.handleError(t,`restoreProject(${e})`),!1}}async deleteProject(e){try{if(console.log(`🗑️ [ProjectService] Deleting project: ${e}`),this.isWebOnlyMode())return await this.deleteProjectFromFirestore(e);try{return await this.apiRequest(`projects/${e}`,"DELETE"),!0}catch{return console.warn("⚠️ [ProjectService] API request failed, falling back to Firestore"),await this.deleteProjectFromFirestore(e)}}catch(t){return this.handleError(t,`deleteProject(${e})`),!1}}async getProjectsFromFirestore(){try{console.log("🔍 [ProjectService] Getting projects from Firestore"),await this.firestoreAdapter.initialize();const e=this.firestoreAdapter.getCurrentUser();if(!e)return console.log("❌ [ProjectService] No authenticated user found"),[];let t=null;try{const r=await this.firestoreAdapter.getDocumentById("users",e.uid);if(r&&r.organizationId)t=r.organizationId,console.log("✅ [ProjectService] Found organization ID from user document:",t);else{const o=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:e.email}]);o.length>0&&o[0].organizationId&&(t=o[0].organizationId,console.log("✅ [ProjectService] Found organization ID from user email query:",t))}}catch(r){console.warn("⚠️ [ProjectService] Error getting user organization:",r)}if(!t)return console.log("❌ [ProjectService] No organization ID found for user"),[];try{const r=await this.firestoreAdapter.queryDocuments("projects",[{field:"organizationId",operator:"==",value:t}]);console.log(`✅ [ProjectService] Found ${r.length} projects for organization: ${t}`),console.log("🔍 [ProjectService] Raw projects from Firestore:",r);const o=r.sort((n,s)=>{const u=n.lastAccessedAt?new Date(n.lastAccessedAt).getTime():0;return(s.lastAccessedAt?new Date(s.lastAccessedAt).getTime():0)-u});return console.log("🔍 [ProjectService] Sorted projects:",o),o}catch(r){if(r.message&&r.message.includes("requires an index"))return console.warn("⚠️ [ProjectService] Missing Firestore index detected. Projects query requires composite index."),console.warn("📋 Required index: organizationId (Ascending) + createdAt (Ascending) + __name__ (Ascending)"),console.warn("🔗 Create index at: https://console.firebase.google.com/v1/r/project/backbone-logic/firestore/indexes"),console.warn("📝 Note: Index creation can take several minutes. Returning empty array for now."),[];throw r}}catch(e){return this.handleError(e,"getProjectsFromFirestore"),[]}}async getProjectFromFirestore(e){try{return console.log(`🔍 [ProjectService] Getting project from Firestore: ${e}`),await this.firestoreAdapter.initialize(),await this.firestoreAdapter.getDocumentById("projects",e)}catch(t){return this.handleError(t,`getProjectFromFirestore(${e})`),null}}async createProjectInFirestore(e){try{console.log("🔍 [ProjectService] Creating project in Firestore"),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();if(!t)return console.warn("⚠️ [ProjectService] No authenticated user for project creation"),null;const r={...e,ownerId:e.ownerId||t.uid,status:e.status||D.ACTIVE,teamMembers:e.teamMembers||[]};return await this.firestoreAdapter.createDocument("projects",r)}catch(t){return this.handleError(t,"createProjectInFirestore"),null}}async updateProjectInFirestore(e,t){try{console.log(`🔍 [ProjectService] Updating project in Firestore: ${e}`),await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.getDocumentById("projects",e);return r?await this.firestoreAdapter.updateDocument("projects",e,t)?{...r,...t,id:e}:null:(console.warn(`⚠️ [ProjectService] Project not found: ${e}`),null)}catch(r){return this.handleError(r,`updateProjectInFirestore(${e})`),null}}async deleteProjectFromFirestore(e){try{return console.log(`🗑️ [ProjectService] Deleting project from Firestore: ${e}`),await this.firestoreAdapter.initialize(),await this.firestoreAdapter.getDocumentById("projects",e)?await this.firestoreAdapter.deleteDocument("projects",e)?(console.log(`✅ [ProjectService] Project successfully deleted from Firestore: ${e}`),!0):(console.warn(`⚠️ [ProjectService] Failed to delete project from Firestore: ${e}`),!1):(console.warn(`⚠️ [ProjectService] Project not found for deletion: ${e}`),!1)}catch(t){return this.handleError(t,`deleteProjectFromFirestore(${e})`),!1}}};b(T,"instance");let _=T;const j=class j extends z{constructor(e){super(e)}static getInstance(e){return j.instance||(j.instance=new j(e)),j.instance}async getLicensedTeamMembers(e){try{if(console.log("🚀 [TeamMemberService] Getting licensed team members with options:",e),this.isWebOnlyMode())return await this.getLicensedTeamMembersFromFirestore(e);const t=new URLSearchParams;e!=null&&e.search&&t.append("search",e.search),e!=null&&e.excludeProjectId&&t.append("excludeProjectId",e.excludeProjectId);const r=`team-members/licensed${t.toString()?`?${t.toString()}`:""}`;try{return await this.apiRequest(r)}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.getLicensedTeamMembersFromFirestore(e)}}catch(t){return this.handleError(t,"getLicensedTeamMembers"),[]}}async getProjectTeamMembers(e){try{if(console.log("🚀 [TeamMemberService] Getting team members for project:",e),this.isWebOnlyMode())return await this.getProjectTeamMembersFromFirestore(e);try{return await this.apiRequest(`projects/${e}/team-members`)}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.getProjectTeamMembersFromFirestore(e)}}catch(t){return this.handleError(t,`getProjectTeamMembers(${e})`),[]}}async addTeamMemberToProject(e,t,r=p.DO_ER){try{if(console.log("🚀 [TeamMemberService] Adding team member to project:",{projectId:e,teamMemberId:t,role:r}),this.isWebOnlyMode())return await this.addTeamMemberToProjectInFirestore(e,t,r);try{return await this.apiRequest(`projects/${e}/team-members`,"POST",{teamMemberId:t,role:r}),!0}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.addTeamMemberToProjectInFirestore(e,t,r)}}catch(o){return this.handleError(o,`addTeamMemberToProject(${e}, ${t})`),!1}}async removeTeamMemberFromProject(e,t){try{if(console.log("🚀 [TeamMemberService] Removing team member from project:",{projectId:e,teamMemberId:t}),this.isWebOnlyMode())return await this.removeTeamMemberFromProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}/team-members/${t}`,"DELETE"),!0}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.removeTeamMemberFromProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`removeTeamMemberFromProject(${e}, ${t})`),!1}}async updateTeamMemberRole(e,t,r){try{if(console.log("🚀 [TeamMemberService] Updating team member role:",{projectId:e,teamMemberId:t,role:r}),this.isWebOnlyMode())return await this.updateTeamMemberRoleInFirestore(e,t,r);try{return await this.apiRequest(`projects/${e}/team-members/${t}/role`,"PATCH",{role:r}),!0}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.updateTeamMemberRoleInFirestore(e,t,r)}}catch(o){return this.handleError(o,`updateTeamMemberRole(${e}, ${t})`),!1}}async validateTeamMemberCredentials(e,t){try{if(console.log("🚀 [TeamMemberService] Validating team member credentials for:",e),this.isWebOnlyMode())return await this.validateTeamMemberCredentialsFromFirestore(e,t);try{return await this.apiRequest("team-members/validate-credentials","POST",{email:e,password:t})}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.validateTeamMemberCredentialsFromFirestore(e,t)}}catch(r){return this.handleError(r,"validateTeamMemberCredentials"),{isValid:!1,error:"Authentication failed"}}}async refreshTeamMembers(){try{console.log("🔄 [TeamMemberService] Refreshing team member data..."),console.log("✅ [TeamMemberService] Team member data refresh initiated")}catch(e){console.error("❌ [TeamMemberService] Failed to refresh team member data:",e)}}async createTeamMemberWithFirebaseAuth(e){try{if(console.log("🚀 [TeamMemberService] Creating team member with Firebase Auth:",e),this.isWebOnlyMode())return await this.createTeamMemberWithFirebaseAuthInFirestore(e);try{return await this.apiRequest("team-members/create","POST",e)}catch{return console.warn("⚠️ [TeamMemberService] API request failed, falling back to Firestore"),await this.createTeamMemberWithFirebaseAuthInFirestore(e)}}catch(t){return this.handleError(t,"createTeamMemberWithFirebaseAuth"),{success:!1,error:"Failed to create team member with Firebase Auth"}}}async getLicensedTeamMembersFromFirestore(e){try{console.log("🔍 [TeamMemberService] Fetching licensed team members from Firestore with options:",e),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();if(!t)return console.log("❌ [TeamMemberService] No authenticated user found"),[];let r=null;try{const i=await this.firestoreAdapter.getDocumentById("users",t.uid);if(i&&i.organizationId)r=i.organizationId,console.log("✅ [TeamMemberService] Found organization ID from user document:",r);else{const c=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:t.email}]);c.length>0&&c[0].organizationId&&(r=c[0].organizationId,console.log("✅ [TeamMemberService] Found organization ID from user email query:",r))}}catch(i){console.warn("⚠️ [TeamMemberService] Error getting user organization:",i)}if(!r)return console.log("❌ [TeamMemberService] No organization ID found for user"),[];console.log("🏢 [TeamMemberService] Fetching team members for organization:",r),console.log("🔍 [TeamMemberService] Using UnifiedDataService for enhanced team member fetching...");let o=[];try{const{unifiedDataService:i}=await g(async()=>{const{unifiedDataService:a}=await import("./UnifiedDataService-DN5XLEWa.js");return{unifiedDataService:a}},__vite__mapDeps([9,1,2,3,4,5,7,6,10,0,8])),c=await i.getTeamMembersForOrganization();console.log(`📊 [TeamMemberService] Found ${c.length} team members from UnifiedDataService`),o=c.filter(a=>a.status==="active").map(a=>{var l,m;return{id:a.id,email:a.email,firstName:a.firstName,lastName:a.lastName,name:`${a.firstName} ${a.lastName}`.trim()||a.email,role:a.role,status:"ACTIVE",department:a.department,organizationId:a.organization.id,licenseType:((l=a.licenseAssignment)==null?void 0:l.licenseType)||"BASIC",assignedProjects:a.assignedProjects,createdAt:a.createdAt.toISOString(),updatedAt:a.updatedAt.toISOString(),isActive:!0,joinedAt:a.joinedAt.toISOString(),lastActive:(m=a.lastActive)==null?void 0:m.toISOString(),invitedBy:a.invitedBy,avatar:a.avatar}}),console.log(`✅ [TeamMemberService] Converted ${o.length} active team members from UnifiedDataService`)}catch(i){console.warn("⚠️ [TeamMemberService] UnifiedDataService failed, falling back to direct Firestore query:",i);const c=await this.firestoreAdapter.queryDocuments("teamMembers",[{field:"organizationId",operator:"==",value:r}]);console.log(`🔍 [TeamMemberService] Raw team members found: ${c.length}`),o=c.filter(a=>{var m,h;const l=((h=(m=a.status)==null?void 0:m.toUpperCase)==null?void 0:h.call(m))||a.status||"UNKNOWN";return l!=="ACTIVE"&&l!=="active"?(console.log(`⚠️ [TeamMemberService] Excluding team member ${a.email} with status: ${l}`),!1):a.isActive===!1?(console.log(`⚠️ [TeamMemberService] Excluding team member ${a.email} with isActive: false`),!1):a.revokedAt||a.removedAt||a.suspendedAt?(console.log(`⚠️ [TeamMemberService] Excluding team member ${a.email} with revocation/removal dates`),!1):!0}),console.log(`✅ [TeamMemberService] Active team members after filtering: ${o.length}`)}let n=[];if(e!=null&&e.excludeProjectId)try{n=(await this.getProjectTeamMembersFromFirestore(e.excludeProjectId)).map(c=>c.teamMemberId),console.log(`🔍 [TeamMemberService] Excluding ${n.length} already assigned team members`)}catch(i){console.warn("⚠️ [TeamMemberService] Failed to get assigned team members:",i)}const u=o.filter(i=>{if(n.includes(i.id))return!1;if(e!=null&&e.search){const c=e.search.toLowerCase(),a=(i.name||"").toLowerCase(),l=(i.firstName||"").toLowerCase(),m=(i.lastName||"").toLowerCase(),h=(i.email||"").toLowerCase();return a.includes(c)||l.includes(c)||m.includes(c)||h.includes(c)}return!0}).map(i=>{let c=i.name;c||(i.firstName&&i.lastName?c=`${i.firstName} ${i.lastName}`:i.firstName?c=i.firstName:i.lastName?c=i.lastName:i.email?c=i.email.split("@")[0].replace(/[._-]/g," ").split(" ").map(h=>h.charAt(0).toUpperCase()+h.slice(1).toLowerCase()).join(" "):c="Unknown User");let a=i.licenseType;return a||(a="professional"),{...i,name:c,licenseType:a,status:"active",isActive:!0}});return u.sort((i,c)=>{const a=(i.name||"").toLowerCase(),l=(c.name||"").toLowerCase();return a.localeCompare(l)}),console.log(`✅ [TeamMemberService] Final filtered and mapped team members: ${u.length}`),u}catch(t){return this.handleError(t,"getLicensedTeamMembersFromFirestore"),[]}}async getProjectTeamMembersFromFirestore(e){try{console.log("🔍 [TeamMemberService] Fetching team members from Firestore for project:",e),await this.firestoreAdapter.initialize();const t=[],r=await this.firestoreAdapter.getDocumentById("projects",e);if(r){const n=r.teamMembers||[];for(const s of n)t.push({id:s.userId||s.id,teamMemberId:s.userId||s.id,projectId:e,role:s.role||"member",permissions:s.permissions||["read"],assignedAt:s.assignedAt||new Date().toISOString(),isActive:s.isActive!==!1,email:s.email,name:s.name||s.email,status:s.status||"active"})}try{const n=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e}]);for(const s of n)t.find(u=>u.teamMemberId===s.teamMemberId)||t.push(s)}catch{console.log("ℹ️ [TeamMemberService] projectTeamMembers collection not found or accessible")}const o=[];for(const n of t)try{const s=await this.firestoreAdapter.getDocumentById("teamMembers",n.teamMemberId);s?o.push({...n,name:s.name||s.email||n.name||"Unnamed User",email:s.email||n.email||"No email",teamMember:s}):o.push(n)}catch(s){console.warn("⚠️ [TeamMemberService] Failed to get full profile for team member:",n.teamMemberId,s),o.push(n)}return console.log(`✅ [TeamMemberService] Found ${o.length} team members for project ${e}`),o}catch(t){return this.handleError(t,`getProjectTeamMembersFromFirestore(${e})`),[]}}async addTeamMemberToProjectInFirestore(e,t,r){try{console.log("🔍 [TeamMemberService] Adding team member to project in Firestore:",{projectId:e,teamMemberId:t,role:r}),await this.firestoreAdapter.initialize();const o=await this.firestoreAdapter.getDocumentById("teamMembers",t);if(!o)return console.warn("⚠️ [TeamMemberService] Team member not found:",t),!1;if(r===p.ADMIN&&(await this.getProjectTeamMembersFromFirestore(e)).some(c=>c.role===p.ADMIN))throw console.warn("⚠️ [TeamMemberService] Only one Admin is allowed per project"),new Error("Only one Admin is allowed per project. Please remove the existing Admin first.");const n={projectId:e,teamMemberId:t,role:r,assignedBy:"system",assignedAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0,teamMemberName:o.name||"Unknown User",teamMemberEmail:o.email||"No email",teamMemberRole:o.role||"MEMBER",teamMemberLicenseType:o.licenseType||"BASIC"};return await this.firestoreAdapter.createDocument("projectTeamMembers",n)!==null}catch(o){return this.handleError(o,`addTeamMemberToProjectInFirestore(${e}, ${t})`),!1}}async removeTeamMemberFromProjectInFirestore(e,t){try{console.log("🔍 [TeamMemberService] Removing team member from project in Firestore:",{projectId:e,teamMemberId:t}),await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e},{field:"teamMemberId",operator:"==",value:t}]);return r.length===0?(console.warn("⚠️ [TeamMemberService] Team member not found in project"),!1):await this.firestoreAdapter.deleteDocument("projectTeamMembers",r[0].id)}catch(r){return this.handleError(r,`removeTeamMemberFromProjectInFirestore(${e}, ${t})`),!1}}async updateTeamMemberRoleInFirestore(e,t,r){try{console.log("🔍 [TeamMemberService] Updating team member role in Firestore:",{projectId:e,teamMemberId:t,role:r}),await this.firestoreAdapter.initialize();const o=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e},{field:"teamMemberId",operator:"==",value:t}]);if(o.length===0)return console.warn("⚠️ [TeamMemberService] Team member not found in project"),!1;if(r===p.ADMIN&&(await this.getProjectTeamMembersFromFirestore(e)).some(i=>i.role===p.ADMIN&&i.teamMemberId!==t))throw console.warn("⚠️ [TeamMemberService] Only one Admin is allowed per project"),new Error("Only one Admin is allowed per project. Please remove the existing Admin first.");return await this.firestoreAdapter.updateDocument("projectTeamMembers",o[0].id,{role:r,updatedAt:new Date().toISOString()})}catch(o){return this.handleError(o,`updateTeamMemberRoleInFirestore(${e}, ${t})`),!1}}async validateTeamMemberCredentialsFromFirestore(e,t){try{await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.queryDocuments("teamMembers",[{field:"email",operator:"==",value:e}]);if(r.length===0)return{isValid:!1,error:"Team member not found"};const o=r[0];return t.length<1?{isValid:!1,error:"Password is required"}:{isValid:!0,teamMember:o,projectAccess:[]}}catch(r){return this.handleError(r,"validateTeamMemberCredentialsFromFirestore"),{isValid:!1,error:"Authentication failed"}}}async createTeamMemberWithFirebaseAuthInFirestore(e){try{console.log("🔍 [TeamMemberService] Creating team member with Firebase Auth in Firestore:",e),await this.firestoreAdapter.initialize();const{auth:t}=await g(async()=>{const{auth:a}=await import("./firebase-9RUeii3H.js");return{auth:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{createUserWithEmailAndPassword:r}=await g(async()=>{const{createUserWithEmailAndPassword:a}=await import("./index.esm-K73FumZQ.js");return{createUserWithEmailAndPassword:a}},__vite__mapDeps([8,6])),o=e.temporaryPassword||this.generateSecurePassword();let n;try{n=(await r(t,e.email,o)).user,console.log("✅ [TeamMemberService] Firebase Auth user created successfully:",n.uid)}catch(a){if(a.code==="auth/email-already-in-use")return{success:!1,error:"User with this email already exists in Firebase Authentication"};throw a}const s={id:n.uid,email:e.email,firstName:e.firstName,lastName:e.lastName,name:`${e.firstName} ${e.lastName}`,licenseType:e.licenseType||"PROFESSIONAL",status:"ACTIVE",organizationId:e.organizationId,department:e.department,role:e.role||"MEMBER",firebaseUid:n.uid,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0},u={id:n.uid,email:e.email,name:`${e.firstName} ${e.lastName}`,firstName:e.firstName,lastName:e.lastName,role:"TEAM_MEMBER",firebaseUid:n.uid,isEmailVerified:!1,twoFactorEnabled:!1,twoFactorBackupCodes:[],privacyConsent:[],marketingConsent:!1,dataProcessingConsent:!1,identityVerified:!1,kycStatus:"PENDING",isTeamMember:!0,organizationId:e.organizationId,memberRole:e.role||"MEMBER",memberStatus:"ACTIVE",department:e.department,licenseType:e.licenseType||"PROFESSIONAL",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};let i=null,c=null;if(i=await this.firestoreAdapter.createDocument("teamMembers",s),i&&(c=await this.firestoreAdapter.createDocument("users",u)),!i||!c){try{await n.delete(),console.log("🔄 [TeamMemberService] Rolled back Firebase Auth user after Firestore failure")}catch(a){console.error("❌ [TeamMemberService] Failed to rollback Firebase Auth user:",a)}return{success:!1,error:"Failed to create required documents in Firestore"}}return console.log("✅ [TeamMemberService] Team member created successfully in Firestore"),{success:!0,teamMember:s,firebaseUid:n.uid,temporaryPassword:o}}catch(t){return this.handleError(t,"createTeamMemberWithFirebaseAuthInFirestore"),{success:!1,error:(t==null?void 0:t.message)||"Failed to create team member with Firebase Auth"}}}generateSecurePassword(){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";let r="";r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)],r+="abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random()*26)],r+="0123456789"[Math.floor(Math.random()*10)],r+="!@#$%^&*"[Math.floor(Math.random()*8)];for(let o=4;o<12;o++)r+=t[Math.floor(Math.random()*t.length)];return r.split("").sort(()=>Math.random()-.5).join("")}};b(j,"instance");let R=j;const M=class M{constructor(){b(this,"config");b(this,"projectService",null);b(this,"teamMemberService",null);this.config={isWebOnlyMode:this.detectWebOnlyMode(),apiBaseUrl:"/api"},this.initializeFirestoreAdapter()}static getInstance(){return M.instance||(M.instance=new M),M.instance}initialize(e){this.config={...this.config,...e},console.log("🔧 [ServiceFactory] Initialized with config:",this.config),this.projectService=null,this.teamMemberService=null}getProjectService(){return this.projectService||(this.projectService=_.getInstance(this.config)),this.projectService}getTeamMemberService(){return this.teamMemberService||(this.teamMemberService=R.getInstance(this.config)),this.teamMemberService}detectWebOnlyMode(){if(typeof window<"u"){const e=new URLSearchParams(window.location.search);if(e.has("webonly"))return e.get("webonly")==="true";const t=localStorage.getItem("webonly_mode");if(t)return t==="true";if(window.ENV&&window.ENV.WEBONLY)return window.ENV.WEBONLY===!0}return!0}async initializeFirestoreAdapter(){try{await C.getInstance().initialize()}catch(e){console.error("❌ [ServiceFactory] Failed to initialize Firestore adapter:",e)}}};b(M,"instance");let $=M;const S=class S{constructor(){b(this,"serviceFactory");b(this,"authTokenCallback",null);this.serviceFactory=$.getInstance(),this.serviceFactory.initialize({isWebOnlyMode:this.isWebOnlyMode()})}static getInstance(){return S.instance||(S.instance=new S),S.instance}isWebOnlyMode(){if(typeof window<"u"){const e=new URLSearchParams(window.location.search);if(e.has("webonly"))return e.get("webonly")==="true";const t=localStorage.getItem("webonly_mode");if(t)return t==="true";if(window.ENV&&window.ENV.WEBONLY)return window.ENV.WEBONLY===!0}return!0}setConfig(e){this.serviceFactory.initialize(e)}async getProjects(){return await this.serviceFactory.getProjectService().getProjects()}async getUserProjects(){return await this.serviceFactory.getProjectService().getProjects()}async getProject(e){return await this.serviceFactory.getProjectService().getProject(e)}async createProject(e){return await this.serviceFactory.getProjectService().createProject(e)}async createCloudProject(e){return await this.serviceFactory.getProjectService().createProject(e)}async createCloudProjectInFirestore(e){return await this.serviceFactory.getProjectService().createProject(e)}async updateProject(e,t){return await this.serviceFactory.getProjectService().updateProject(e,t)}async updateProjectInFirestore(e,t){return await this.serviceFactory.getProjectService().updateProject(e,t)}async archiveProject(e){return await this.serviceFactory.getProjectService().archiveProject(e)}async archiveProjectInFirestore(e){return await this.serviceFactory.getProjectService().archiveProject(e)}async restoreProject(e){return await this.serviceFactory.getProjectService().restoreProject(e)}async deleteProject(e){return await this.serviceFactory.getProjectService().deleteProject(e)}async listDatasets(e){try{return console.log("🔍 [CloudProjectIntegration] Listing all datasets with params:",e),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - fetching all datasets from Firestore"),await this.getAllDatasetsFromFirestore(e)):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.getAllDatasetsFromFirestore(e))}catch(t){return console.error("❌ [CloudProjectIntegration] Failed to list datasets:",t),[]}}async createDataset(e){try{return console.log("🔍 [CloudProjectIntegration] Creating dataset with input:",e),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - creating dataset in Firestore"),await this.createDatasetInFirestore(e)):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.createDatasetInFirestore(e))}catch(t){throw console.error("❌ [CloudProjectIntegration] Failed to create dataset:",t),t}}async getProjectDatasets(e){try{return console.log("🔍 [CloudProjectIntegration] Getting datasets for project:",e),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - fetching datasets from Firestore for project:",e),await this.getProjectDatasetsFromFirestore(e)):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.getProjectDatasetsFromFirestore(e))}catch(t){return console.error("❌ [CloudProjectIntegration] Failed to get project datasets:",t),[]}}async assignDatasetToProject(e,t){try{return console.log("🔍 [CloudProjectIntegration] Assigning dataset to project:",{projectId:e,datasetId:t}),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - assigning dataset to project in Firestore"),await this.assignDatasetToProjectInFirestore(e,t)):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.assignDatasetToProjectInFirestore(e,t))}catch(r){throw console.error("❌ [CloudProjectIntegration] Failed to assign dataset to project:",r),r}}async unassignDatasetFromProject(e,t){}async updateDataset(e,t){return null}async deleteDataset(e){return!1}async cleanupCorruptedDatasets(){return{cleaned:0,errors:[]}}async createDatasetInFirestore(e){try{console.log("🔍 [CloudProjectIntegration] Creating dataset in Firestore:",e);const{db:t,auth:r}=await g(async()=>{const{db:y,auth:F}=await import("./firebase-9RUeii3H.js");return{db:y,auth:F}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{doc:o,setDoc:n,collection:s,getDoc:u}=await g(async()=>{const{doc:y,setDoc:F,collection:P,getDoc:d}=await import("./index.esm-C6E5jVjx.js");return{doc:y,setDoc:F,collection:P,getDoc:d}},__vite__mapDeps([7,6])),i=r.currentUser;if(!i)throw new Error("No authenticated user");const a=(await u(o(t,"users",i.uid))).data(),l=(a==null?void 0:a.organizationId)||e.organizationId,m=o(s(t,"datasets")),h=new Date,v={id:m.id,name:e.name,description:e.description||"",visibility:e.visibility||"private",tags:e.tags||[],schema:e.schema||{},storage:e.storage||{backend:"firestore"},ownerId:i.uid,organizationId:l,projectId:e.projectId||null,status:"ACTIVE",createdAt:h.toISOString(),updatedAt:h.toISOString(),lastAccessedAt:h.toISOString(),size:0,fileCount:0};return await n(m,v),console.log("✅ [CloudProjectIntegration] Dataset created successfully in Firestore:",m.id),v}catch(t){throw console.error("❌ [CloudProjectIntegration] Failed to create dataset in Firestore:",t),t}}async getProjectDatasetsFromFirestore(e){try{console.log("🔍 [CloudProjectIntegration] Getting datasets from Firestore for project:",e);const{db:t,auth:r}=await g(async()=>{const{db:d,auth:f}=await import("./firebase-9RUeii3H.js");return{db:d,auth:f}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{collection:o,query:n,where:s,getDocs:u,orderBy:i,getDoc:c}=await g(async()=>{const{collection:d,query:f,where:E,getDocs:I,orderBy:O,getDoc:q}=await import("./index.esm-C6E5jVjx.js");return{collection:d,query:f,where:E,getDocs:I,orderBy:O,getDoc:q}},__vite__mapDeps([7,6])),a=r.currentUser;if(!a)throw new Error("No authenticated user");const{doc:l}=await g(async()=>{const{doc:d}=await import("./index.esm-C6E5jVjx.js");return{doc:d}},__vite__mapDeps([7,6])),h=(await c(l(t,"users",a.uid))).data(),v=h==null?void 0:h.organizationId;let y;if(e&&e!=="all")try{y=n(o(t,"datasets"),s("projectId","==",e),s("status","==","ACTIVE"),i("updatedAt","desc"))}catch{console.log("⚠️ [CloudProjectIntegration] Composite index query failed, falling back to simple query"),y=n(o(t,"datasets"),s("projectId","==",e),s("status","==","ACTIVE"))}else try{y=n(o(t,"datasets"),s("organizationId","==",v),s("status","==","ACTIVE"),i("updatedAt","desc"))}catch{console.log("⚠️ [CloudProjectIntegration] Composite index query failed, falling back to simple query"),y=n(o(t,"datasets"),s("organizationId","==",v),s("status","==","ACTIVE"))}const P=(await u(y)).docs.map(d=>({...d.data(),id:d.id}));return P.sort((d,f)=>{const E=d.updatedAt?new Date(d.updatedAt).getTime():0;return(f.updatedAt?new Date(f.updatedAt).getTime():0)-E}),console.log(`✅ [CloudProjectIntegration] Found ${P.length} datasets for project ${e}`),P}catch(t){return console.error("❌ [CloudProjectIntegration] Failed to get datasets from Firestore:",t),[]}}async getAllDatasetsFromFirestore(e){try{console.log("🔍 [CloudProjectIntegration] Getting all datasets from Firestore with params:",e);const{db:t,auth:r}=await g(async()=>{const{db:d,auth:f}=await import("./firebase-9RUeii3H.js");return{db:d,auth:f}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{collection:o,query:n,where:s,getDocs:u,orderBy:i}=await g(async()=>{const{collection:d,query:f,where:E,getDocs:I,orderBy:O}=await import("./index.esm-C6E5jVjx.js");return{collection:d,query:f,where:E,getDocs:I,orderBy:O}},__vite__mapDeps([7,6])),c=r.currentUser;if(!c)throw new Error("No authenticated user");const{doc:a,getDoc:l}=await g(async()=>{const{doc:d,getDoc:f}=await import("./index.esm-C6E5jVjx.js");return{doc:d,getDoc:f}},__vite__mapDeps([7,6])),h=(await l(a(t,"users",c.uid))).data(),v=(h==null?void 0:h.organizationId)||(e==null?void 0:e.organizationId);let y=n(o(t,"datasets"),s("status","==","ACTIVE"),i("updatedAt","desc"));v&&(y=n(o(t,"datasets"),s("organizationId","==",v),s("status","==","ACTIVE"),i("updatedAt","desc")));let P=(await u(y)).docs.map(d=>({...d.data(),id:d.id}));if(e!=null&&e.visibility&&(P=P.filter(d=>d.visibility===e.visibility)),e!=null&&e.query){const d=e.query.toLowerCase();P=P.filter(f=>f.name.toLowerCase().includes(d)||f.description&&f.description.toLowerCase().includes(d))}return console.log(`✅ [CloudProjectIntegration] Found ${P.length} datasets`),P}catch(t){return console.error("❌ [CloudProjectIntegration] Failed to get all datasets from Firestore:",t),[]}}async getAllOrganizationDatasets(){try{return console.log("🔍 [CloudProjectIntegration] Getting all datasets for organization"),this.isWebOnlyMode()?(console.log("🔍 [CloudProjectIntegration] WebOnly mode - fetching all organization datasets from Firestore"),await this.getAllDatasetsFromFirestore()):(console.log("🔄 [CloudProjectIntegration] Non-webonly mode detected, falling back to Firestore"),await this.getAllDatasetsFromFirestore())}catch(e){return console.error("❌ [CloudProjectIntegration] Failed to get organization datasets:",e),[]}}async assignDatasetToProjectInFirestore(e,t){var r;try{console.log("🔍 [CloudProjectIntegration] Assigning dataset to project in Firestore:",{projectId:e,datasetId:t});const{db:o}=await g(async()=>{const{db:y}=await import("./firebase-9RUeii3H.js");return{db:y}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{doc:n,updateDoc:s,getDoc:u,collection:i,addDoc:c}=await g(async()=>{const{doc:y,updateDoc:F,getDoc:P,collection:d,addDoc:f}=await import("./index.esm-C6E5jVjx.js");return{doc:y,updateDoc:F,getDoc:P,collection:d,addDoc:f}},__vite__mapDeps([7,6])),a=n(o,"datasets",t),l=await u(a);if(!l.exists())throw new Error("Dataset not found");const m=n(o,"projects",e);if(!(await u(m)).exists())throw new Error("Project not found");await s(a,{projectId:e,updatedAt:new Date().toISOString()});const v={projectId:e,datasetId:t,addedByUserId:((r=l.data())==null?void 0:r.ownerId)||"system",addedAt:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};await c(i(o,"project_datasets"),v),await s(m,{updatedAt:new Date().toISOString(),lastAccessedAt:new Date().toISOString()}),console.log("✅ [CloudProjectIntegration] Dataset assigned to project successfully in Firestore")}catch(o){throw console.error("❌ [CloudProjectIntegration] Failed to assign dataset to project in Firestore:",o),o}}async getLicensedTeamMembers(e){return await this.serviceFactory.getTeamMemberService().getLicensedTeamMembers(e)}async getProjectTeamMembers(e){return await this.serviceFactory.getTeamMemberService().getProjectTeamMembers(e)}async addTeamMemberToProject(e,t,r=p.DO_ER){await this.serviceFactory.getTeamMemberService().addTeamMemberToProject(e,t,r)}async removeTeamMemberFromProject(e,t){await this.serviceFactory.getTeamMemberService().removeTeamMemberFromProject(e,t)}async updateTeamMemberRole(e,t,r){await this.serviceFactory.getTeamMemberService().updateTeamMemberRole(e,t,r)}async validateTeamMemberCredentials(e,t){return await this.serviceFactory.getTeamMemberService().validateTeamMemberCredentials(e,t)}setAuthTokenCallback(e){this.authTokenCallback=e}setAuthToken(e){console.log("Setting auth token:",e),typeof localStorage<"u"&&localStorage.setItem("auth_token",e),this.authTokenCallback&&this.authTokenCallback()}cleanDocumentData(e){const t={};for(const[r,o]of Object.entries(e))if(o!==void 0){if(o===null){t[r]=null;continue}if(typeof o=="object"&&!Array.isArray(o)&&!(o instanceof Date)){t[r]=this.cleanDocumentData(o);continue}t[r]=o}return t}};b(S,"instance");let N=S;const U=N.getInstance();typeof window<"u"&&(window.cloudProjectIntegration=U);export{U as cloudProjectIntegration,N as default};
