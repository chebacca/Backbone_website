const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-Dm8Ngwai.js","assets/index-DkiLlagR.js","assets/mui-Dvh35qVf.js","assets/vendor-CjD1bmmO.js","assets/stripe-CbtnRl6i.js","assets/index-CBai7h7s.css","assets/index.esm-D7ujsXeY.js","assets/index.esm-DonjM_pP.js","assets/index.esm-D2YDx4vs.js"])))=>i.map(i=>d[i]);
var O=Object.defineProperty;var q=(m,e,t)=>e in m?O(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var f=(m,e,t)=>q(m,typeof e!="symbol"?e+"":e,t);import{_ as g}from"./index-DkiLlagR.js";import"./mui-Dvh35qVf.js";import"./vendor-CjD1bmmO.js";import"./stripe-CbtnRl6i.js";const v=class v{constructor(){f(this,"db");f(this,"auth")}static arrayUnion(e){return{_method:"arrayUnion",value:e}}static arrayRemove(e){return{_method:"arrayRemove",value:e}}static getInstance(){return v.instance||(v.instance=new v),v.instance}async initialize(){const e=await g(()=>import("./firebase-Dm8Ngwai.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8]));this.db=e.db,this.auth=e.auth}getCurrentUser(){var e;return(e=this.auth)==null?void 0:e.currentUser}async getDocumentById(e,t){try{const{doc:r,getDoc:a}=await g(async()=>{const{doc:i,getDoc:n}=await import("./index.esm-DonjM_pP.js");return{doc:i,getDoc:n}},__vite__mapDeps([7,6])),c=r(this.db,e,t),s=await a(c);if(s.exists()){const i=s.data();return{id:s.id,...this.convertFirestoreDates(i)}}return null}catch(r){return console.error(`‚ùå [FirestoreAdapter] Error getting document ${t} from ${e}:`,r),null}}async queryDocuments(e,t=[]){try{const{collection:r,query:a,where:c,getDocs:s}=await g(async()=>{const{collection:u,query:d,where:h,getDocs:w}=await import("./index.esm-DonjM_pP.js");return{collection:u,query:d,where:h,getDocs:w}},__vite__mapDeps([7,6])),i=r(this.db,e);let n;if(t.length>0){let u=[];for(const d of t)u.push(c(d.field,d.operator,d.value));n=a(i,...u)}else n=a(i);const o=await s(n),l=[];return o.forEach(u=>{const d=u.data();l.push({id:u.id,...this.convertFirestoreDates(d)})}),l}catch(r){return console.error(`‚ùå [FirestoreAdapter] Error querying ${e}:`,r),[]}}async createDocument(e,t){try{const{collection:r,addDoc:a}=await g(async()=>{const{collection:i,addDoc:n}=await import("./index.esm-DonjM_pP.js");return{collection:i,addDoc:n}},__vite__mapDeps([7,6])),c=this.cleanDocumentData({...t,createdAt:new Date,updatedAt:new Date});return{id:(await a(r(this.db,e),c)).id,...c}}catch(r){return console.error(`‚ùå [FirestoreAdapter] Error creating document in ${e}:`,r),null}}async updateDocumentWithArrayOps(e,t,r){try{const{doc:a,updateDoc:c}=await g(async()=>{const{doc:l,updateDoc:u}=await import("./index.esm-DonjM_pP.js");return{doc:l,updateDoc:u}},__vite__mapDeps([7,6])),{arrayUnion:s,arrayRemove:i}=await g(async()=>{const{arrayUnion:l,arrayRemove:u}=await import("./index.esm-DonjM_pP.js");return{arrayUnion:l,arrayRemove:u}},__vite__mapDeps([7,6])),n={};for(const[l,u]of Object.entries(r))u&&typeof u=="object"&&u._method==="arrayUnion"?n[l]=s(u.value):u&&typeof u=="object"&&u._method==="arrayRemove"?n[l]=i(u.value):n[l]=u;const o=this.cleanDocumentData({...n,updatedAt:new Date});return await c(a(this.db,e,t),o),!0}catch(a){return console.error(`‚ùå [FirestoreAdapter] Error updating document ${t} in ${e} with array ops:`,a),!1}}async updateDocument(e,t,r){try{const{doc:a,updateDoc:c}=await g(async()=>{const{doc:i,updateDoc:n}=await import("./index.esm-DonjM_pP.js");return{doc:i,updateDoc:n}},__vite__mapDeps([7,6])),s=this.cleanDocumentData({...r,updatedAt:new Date});return await c(a(this.db,e,t),s),!0}catch(a){return console.error(`‚ùå [FirestoreAdapter] Error updating document ${t} in ${e}:`,a),!1}}async deleteDocument(e,t){try{const{doc:r,deleteDoc:a}=await g(async()=>{const{doc:c,deleteDoc:s}=await import("./index.esm-DonjM_pP.js");return{doc:c,deleteDoc:s}},__vite__mapDeps([7,6]));return await a(r(this.db,e,t)),!0}catch(r){return console.error(`‚ùå [FirestoreAdapter] Error deleting document ${t} from ${e}:`,r),!1}}cleanDocumentData(e){const t={};for(const[r,a]of Object.entries(e))if(a!==void 0){if(a===null){t[r]=null;continue}if(typeof a=="object"&&!Array.isArray(a)&&!(a instanceof Date)){t[r]=this.cleanDocumentData(a);continue}t[r]=a}return t}convertFirestoreDates(e){const t={};for(const[r,a]of Object.entries(e))a&&typeof a=="object"&&a.toDate&&typeof a.toDate=="function"?t[r]=a.toDate().toISOString():a&&typeof a=="object"&&!Array.isArray(a)?t[r]=this.convertFirestoreDates(a):t[r]=a;return t}};f(v,"instance");let y=v;class ${constructor(e){f(this,"config");f(this,"firestoreAdapter");this.config=e,this.firestoreAdapter=y.getInstance()}isWebOnlyMode(){return this.config.isWebOnlyMode}getConfig(){return this.config}async apiRequest(e,t="GET",r,a){try{const s=`${this.config.apiBaseUrl||"/api"}/${e.startsWith("/")?e.substring(1):e}`,i={"Content-Type":"application/json",...a},n={method:t,headers:i,credentials:"include"};r&&(t==="POST"||t==="PATCH")&&(n.body=JSON.stringify(r));const o=await fetch(s,n);if(!o.ok)throw new Error(`API request failed: ${o.status} ${o.statusText}`);const l=o.headers.get("content-type");return l&&l.includes("application/json")?await o.json():await o.text()}catch(c){throw console.error(`‚ùå [BaseService] API request failed for ${e}:`,c),c}}handleError(e,t){console.error(`‚ùå [${this.constructor.name}] Error in ${t}:`,e)}}var D=(m=>(m.ADMIN="ADMIN",m.MEMBER="MEMBER",m.VIEWER="VIEWER",m.OWNER="OWNER",m.DO_ER="DO_ER",m))(D||{}),P=(m=>(m.ACTIVE="active",m.ARCHIVED="archived",m.DELETED="deleted",m.DRAFT="draft",m))(P||{});const p=class p extends ${constructor(e){super(e)}static getInstance(e){return p.instance||(p.instance=new p(e)),p.instance}async getProjects(){try{if(console.log("üöÄ [ProjectService] Getting all projects"),this.isWebOnlyMode())return await this.getProjectsFromFirestore();try{return await this.apiRequest("projects")}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.getProjectsFromFirestore()}}catch(e){return this.handleError(e,"getProjects"),[]}}async getProject(e){try{if(console.log(`üöÄ [ProjectService] Getting project: ${e}`),this.isWebOnlyMode())return await this.getProjectFromFirestore(e);try{return await this.apiRequest(`projects/${e}`)}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.getProjectFromFirestore(e)}}catch(t){return this.handleError(t,`getProject(${e})`),null}}async createProject(e){try{if(console.log("üöÄ [ProjectService] Creating new project"),this.isWebOnlyMode())return await this.createProjectInFirestore(e);try{return await this.apiRequest("projects","POST",e)}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.createProjectInFirestore(e)}}catch(t){return this.handleError(t,"createProject"),null}}async updateProject(e,t){try{if(console.log(`üöÄ [ProjectService] Updating project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}`,"PATCH",t)}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`updateProject(${e})`),null}}async archiveProject(e){try{if(console.log(`üöÄ [ProjectService] Archiving project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,{status:P.ARCHIVED})!==null;try{return await this.apiRequest(`projects/${e}/archive`,"POST"),!0}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,{status:P.ARCHIVED})!==null}}catch(t){return this.handleError(t,`archiveProject(${e})`),!1}}async restoreProject(e){try{if(console.log(`üöÄ [ProjectService] Restoring project: ${e}`),this.isWebOnlyMode())return await this.updateProjectInFirestore(e,{status:P.ACTIVE})!==null;try{return await this.apiRequest(`projects/${e}/restore`,"POST"),!0}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.updateProjectInFirestore(e,{status:P.ACTIVE})!==null}}catch(t){return this.handleError(t,`restoreProject(${e})`),!1}}async deleteProject(e){try{if(console.log(`üóëÔ∏è [ProjectService] Deleting project: ${e}`),this.isWebOnlyMode())return await this.deleteProjectFromFirestore(e);try{return await this.apiRequest(`projects/${e}`,"DELETE"),!0}catch{return console.warn("‚ö†Ô∏è [ProjectService] API request failed, falling back to Firestore"),await this.deleteProjectFromFirestore(e)}}catch(t){return this.handleError(t,`deleteProject(${e})`),!1}}async getProjectsFromFirestore(){try{console.log("üîç [ProjectService] Getting projects from Firestore"),await this.firestoreAdapter.initialize();const e=this.firestoreAdapter.getCurrentUser();if(!e)return console.log("‚ùå [ProjectService] No authenticated user found"),[];let t=null;try{const r=await this.firestoreAdapter.getDocumentById("users",e.uid);if(r&&r.organizationId)t=r.organizationId,console.log("‚úÖ [ProjectService] Found organization ID from user document:",t);else{const a=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:e.email}]);a.length>0&&a[0].organizationId&&(t=a[0].organizationId,console.log("‚úÖ [ProjectService] Found organization ID from user email query:",t))}}catch(r){console.warn("‚ö†Ô∏è [ProjectService] Error getting user organization:",r)}if(!t)return console.log("‚ùå [ProjectService] No organization ID found for user"),[];try{const r=await this.firestoreAdapter.queryDocuments("projects",[{field:"organizationId",operator:"==",value:t}]);console.log(`‚úÖ [ProjectService] Found ${r.length} projects for organization: ${t}`),console.log("üîç [ProjectService] Raw projects from Firestore:",r);const a=r.sort((c,s)=>{const i=c.lastAccessedAt?new Date(c.lastAccessedAt).getTime():0;return(s.lastAccessedAt?new Date(s.lastAccessedAt).getTime():0)-i});return console.log("üîç [ProjectService] Sorted projects:",a),a}catch(r){if(r.message&&r.message.includes("requires an index"))return console.warn("‚ö†Ô∏è [ProjectService] Missing Firestore index detected. Projects query requires composite index."),console.warn("üìã Required index: organizationId (Ascending) + createdAt (Ascending) + __name__ (Ascending)"),console.warn("üîó Create index at: https://console.firebase.google.com/v1/r/project/backbone-logic/firestore/indexes"),console.warn("üìù Note: Index creation can take several minutes. Returning empty array for now."),[];throw r}}catch(e){return this.handleError(e,"getProjectsFromFirestore"),[]}}async getProjectFromFirestore(e){try{return console.log(`üîç [ProjectService] Getting project from Firestore: ${e}`),await this.firestoreAdapter.initialize(),await this.firestoreAdapter.getDocumentById("projects",e)}catch(t){return this.handleError(t,`getProjectFromFirestore(${e})`),null}}async createProjectInFirestore(e){try{console.log("üîç [ProjectService] Creating project in Firestore"),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();if(!t)return console.warn("‚ö†Ô∏è [ProjectService] No authenticated user for project creation"),null;const r={...e,ownerId:e.ownerId||t.uid,status:e.status||P.ACTIVE,teamMembers:e.teamMembers||[]};return await this.firestoreAdapter.createDocument("projects",r)}catch(t){return this.handleError(t,"createProjectInFirestore"),null}}async updateProjectInFirestore(e,t){try{console.log(`üîç [ProjectService] Updating project in Firestore: ${e}`),await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.getDocumentById("projects",e);return r?await this.firestoreAdapter.updateDocument("projects",e,t)?{...r,...t,id:e}:null:(console.warn(`‚ö†Ô∏è [ProjectService] Project not found: ${e}`),null)}catch(r){return this.handleError(r,`updateProjectInFirestore(${e})`),null}}async deleteProjectFromFirestore(e){try{return console.log(`üóëÔ∏è [ProjectService] Deleting project from Firestore: ${e}`),await this.firestoreAdapter.initialize(),await this.firestoreAdapter.getDocumentById("projects",e)?await this.firestoreAdapter.deleteDocument("projects",e)?(console.log(`‚úÖ [ProjectService] Project successfully deleted from Firestore: ${e}`),!0):(console.warn(`‚ö†Ô∏è [ProjectService] Failed to delete project from Firestore: ${e}`),!1):(console.warn(`‚ö†Ô∏è [ProjectService] Project not found for deletion: ${e}`),!1)}catch(t){return this.handleError(t,`deleteProjectFromFirestore(${e})`),!1}}};f(p,"instance");let j=p;const F=class F extends ${constructor(e){super(e)}static getInstance(e){return F.instance||(F.instance=new F(e)),F.instance}async listDatasets(e){try{if(console.log("üöÄ [DatasetService] Listing datasets with params:",e),this.isWebOnlyMode())return await this.getAvailableDatasetsFromFirestore(e);const t=new URLSearchParams;e!=null&&e.organizationId&&t.append("organizationId",e.organizationId),e!=null&&e.visibility&&t.append("visibility",e.visibility),e!=null&&e.backend&&e.backend!=="all"&&t.append("backend",e.backend),e!=null&&e.query&&t.append("query",e.query);try{return await this.apiRequest(`datasets${t.toString()?`?${t}`:""}`)}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.getAvailableDatasetsFromFirestore(e)}}catch(t){return this.handleError(t,"listDatasets"),[]}}async createDataset(e){try{if(console.log("üöÄ [DatasetService] Creating dataset"),this.isWebOnlyMode())return await this.createDatasetInFirestore(e);const t={...e};try{return await this.apiRequest("datasets","POST",t)}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.createDatasetInFirestore(e)}}catch(t){return this.handleError(t,"createDataset"),null}}async getProjectDatasets(e){try{if(console.log(`üöÄ [DatasetService] Getting datasets for project: ${e}`),this.isWebOnlyMode())return await this.getProjectDatasetsFromFirestore(e);try{return await this.apiRequest(`datasets/project/${e}`,"GET")}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.getProjectDatasetsFromFirestore(e)}}catch(t){return this.handleError(t,`getProjectDatasets(${e})`),[]}}async assignDatasetToProject(e,t){try{if(console.log(`üöÄ [DatasetService] Assigning dataset ${t} to project ${e}`),this.isWebOnlyMode())return await this.assignDatasetToProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}/datasets/${t}`,"POST"),!0}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.assignDatasetToProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`assignDatasetToProject(${e}, ${t})`),!1}}async unassignDatasetFromProject(e,t){try{if(console.log(`üöÄ [DatasetService] Unassigning dataset ${t} from project ${e}`),this.isWebOnlyMode())return await this.unassignDatasetFromProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}/datasets/${t}`,"DELETE"),!0}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.unassignDatasetFromProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`unassignDatasetFromProject(${e}, ${t})`),!1}}async getAvailableDatasetsFromFirestore(e){try{console.log("üîç [DatasetService] Fetching available datasets from Firestore"),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();if(!t)return console.log("‚ùå [DatasetService] No authenticated user found"),[];let r=null;try{const i=await this.firestoreAdapter.getDocumentById("users",t.uid);if(i&&i.organizationId)r=i.organizationId,console.log("‚úÖ [DatasetService] Found organization ID from user document:",r);else{const n=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:t.email}]);n.length>0&&n[0].organizationId&&(r=n[0].organizationId,console.log("‚úÖ [DatasetService] Found organization ID from user email query:",r))}}catch(i){console.warn("‚ö†Ô∏è [DatasetService] Error getting user organization:",i)}if(!r)return console.log("‚ùå [DatasetService] No organization ID found for user"),[];console.log("üè¢ [DatasetService] Fetching available datasets for organization:",r);let s=(await this.firestoreAdapter.queryDocuments("datasets",[{field:"organizationId",operator:"==",value:(e==null?void 0:e.organizationId)||r}])).filter(i=>!(i.projectIds&&i.projectIds.length>0));if(e!=null&&e.backend&&e.backend!=="all"&&(s=s.filter(i=>{var o;return(((o=i.storage)==null?void 0:o.backend)||"firestore")===e.backend})),e!=null&&e.query){const i=e.query.toLowerCase();s=s.filter(n=>{const o=(n.name||"").toLowerCase(),l=(n.description||"").toLowerCase();return o.includes(i)||l.includes(i)})}return e!=null&&e.visibility&&(s=s.filter(i=>(i.visibility||"private")===e.visibility)),s.sort((i,n)=>{const o=new Date(i.createdAt||"").getTime();return new Date(n.createdAt||"").getTime()-o}),console.log(`‚úÖ [DatasetService] Found ${s.length} available datasets from Firestore`),s}catch(t){return this.handleError(t,"getAvailableDatasetsFromFirestore"),[]}}async listDatasetsFromFirestore(e){try{console.log("üîç [DatasetService] Fetching datasets from Firestore with params:",e),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();if(!t)return console.log("‚ùå [DatasetService] No authenticated user found"),[];let r=null;try{const i=await this.firestoreAdapter.getDocumentById("users",t.uid);if(i&&i.organizationId)r=i.organizationId,console.log("‚úÖ [DatasetService] Found organization ID from user document:",r);else{const n=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:t.email}]);n.length>0&&n[0].organizationId&&(r=n[0].organizationId,console.log("‚úÖ [DatasetService] Found organization ID from user email query:",r))}}catch(i){console.warn("‚ö†Ô∏è [DatasetService] Error getting user organization:",i)}if(!r)return console.log("‚ùå [DatasetService] No organization ID found for user"),[];console.log("üè¢ [DatasetService] Fetching datasets for organization:",r);const a=[];a.push({field:"organizationId",operator:"==",value:r});let s=await this.firestoreAdapter.queryDocuments("datasets",a);if(e!=null&&e.backend&&e.backend!=="all"&&(s=s.filter(i=>{var o;return(((o=i.storage)==null?void 0:o.backend)||"firestore")===e.backend})),e!=null&&e.query){const i=e.query.toLowerCase();s=s.filter(n=>{const o=(n.name||"").toLowerCase(),l=(n.description||"").toLowerCase();return o.includes(i)||l.includes(i)})}return e!=null&&e.visibility&&(s=s.filter(i=>(i.visibility||"private")===e.visibility)),s.sort((i,n)=>{const o=new Date(i.createdAt||"").getTime();return new Date(n.createdAt||"").getTime()-o}),console.log(`‚úÖ [DatasetService] Found ${s.length} datasets from Firestore`),s}catch(t){return this.handleError(t,"listDatasetsFromFirestore"),[]}}async createDatasetInFirestore(e){try{console.log("üîç [DatasetService] Creating dataset in Firestore"),await this.firestoreAdapter.initialize();let t=e.organizationId;if(!t){const a=this.firestoreAdapter.getCurrentUser();if(a)try{const c=await this.firestoreAdapter.getDocumentById("users",a.uid);if(c&&c.organizationId)t=c.organizationId;else{const s=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:a.email}]);s.length>0&&s[0].organizationId&&(t=s[0].organizationId)}}catch(c){console.warn("‚ö†Ô∏è [DatasetService] Error getting user organization for dataset creation:",c)}if(!t)return console.warn("‚ö†Ô∏è [DatasetService] No organization ID found for dataset creation"),null;console.log("‚úÖ [DatasetService] Using organization ID for dataset creation:",t)}const r={...e,ownerId:"l5YKvrhAD72EV2MnugbS",organizationId:t,visibility:e.visibility||"private",storage:e.storage||{backend:"firestore"},status:e.status||"active",projectIds:[],primaryProjectId:null};return await this.firestoreAdapter.createDocument("datasets",r)}catch(t){return this.handleError(t,"createDatasetInFirestore"),null}}async getProjectDatasetsFromFirestore(e){try{console.log(`üîç [DatasetService] Fetching datasets from Firestore for project: ${e}`),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();if(!t)return console.warn("‚ö†Ô∏è [DatasetService] No authenticated user found"),[];let r=null;try{const i=await this.firestoreAdapter.getDocumentById("users",t.uid);if(i&&i.organizationId)r=i.organizationId;else{const n=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:t.email}]);n.length>0&&n[0].organizationId&&(r=n[0].organizationId)}}catch(i){console.warn("‚ö†Ô∏è [DatasetService] Error getting user organization:",i)}if(!r)return console.warn("‚ö†Ô∏è [DatasetService] No organization ID found for user"),[];const a=await this.firestoreAdapter.queryDocuments("project_datasets",[{field:"projectId",operator:"==",value:e},{field:"organizationId",operator:"==",value:r}]);if(a.length===0)return console.log(`‚úÖ [DatasetService] No datasets found for project ${e}`),[];const c=a.map(i=>i.datasetId),s=[];for(const i of c){const n=await this.firestoreAdapter.getDocumentById("datasets",i);n&&s.push(n)}return s.sort((i,n)=>{const o=new Date(i.createdAt||"").getTime();return new Date(n.createdAt||"").getTime()-o}),console.log(`‚úÖ [DatasetService] Found ${s.length} datasets for project ${e}`),s}catch(t){return this.handleError(t,`getProjectDatasetsFromFirestore(${e})`),[]}}async assignDatasetToProjectInFirestore(e,t){try{console.log(`üîç [DatasetService] Assigning dataset to project in Firestore: ${e}, ${t}`),await this.firestoreAdapter.initialize();const r=this.firestoreAdapter.getCurrentUser();let a=null;if(r)try{const d=await this.firestoreAdapter.getDocumentById("users",r.uid);if(d&&d.organizationId)a=d.organizationId;else{const h=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:r.email}]);h.length>0&&h[0].organizationId&&(a=h[0].organizationId)}}catch(d){console.warn("‚ö†Ô∏è [DatasetService] Error getting user organization for validation:",d)}if(!a)return console.warn("‚ö†Ô∏è [DatasetService] No organization ID found for current user"),!1;const c=await this.firestoreAdapter.getDocumentById("datasets",t);if(!c){console.warn(`‚ö†Ô∏è [DatasetService] Dataset not found: ${t}`);try{const d=await this.firestoreAdapter.queryDocuments("datasets",[{field:"organizationId",operator:"==",value:a}]);console.log(`üîç [DatasetService] Available datasets in user's organization (${a}):`,d),console.log("üîç [DatasetService] Available dataset IDs:",d.map(h=>h.id)),console.log(`üîç [DatasetService] Requested dataset ID: "${t}" (type: ${typeof t})`),d.forEach((h,w)=>{const z=h.id===t;console.log(`üîç [DatasetService] Dataset ${w}: ID="${h.id}", Name="${h.name}", Matches=${z}`)})}catch(d){console.warn("‚ö†Ô∏è [DatasetService] Could not fetch datasets for debugging:",d)}return!1}if(c.organizationId!==a)return console.error(`üö® [DatasetService] SECURITY VIOLATION: User tried to access dataset from different organization. User org: ${a}, Dataset org: ${c.organizationId}`),!1;const s=await this.firestoreAdapter.getDocumentById("projects",e);if(!s)return console.warn(`‚ö†Ô∏è [DatasetService] Project not found: ${e}`),!1;if(s.organizationId!==a)return console.error(`üö® [DatasetService] SECURITY VIOLATION: User tried to assign dataset to project from different organization. User org: ${a}, Project org: ${s.organizationId}`),!1;if(!await this.firestoreAdapter.updateDocumentWithArrayOps("datasets",t,{projectIds:y.arrayUnion(e),primaryProjectId:e,updatedAt:new Date().toISOString()}))return console.warn(`‚ö†Ô∏è [DatasetService] Failed to update dataset: ${t}`),!1;const o={projectId:e,datasetId:t,organizationId:a,addedByUserId:(r==null?void 0:r.uid)||"system",addedAt:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await this.firestoreAdapter.createDocument("project_datasets",o)?(await this.firestoreAdapter.updateDocument("projects",e,{updatedAt:new Date().toISOString(),lastAccessedAt:new Date().toISOString()})||console.warn(`‚ö†Ô∏è [DatasetService] Failed to update project: ${e}, but dataset assignment succeeded`),console.log("‚úÖ [DatasetService] Dataset successfully assigned to project in Firestore"),!0):(console.warn("‚ö†Ô∏è [DatasetService] Failed to create project-dataset link"),await this.firestoreAdapter.updateDocumentWithArrayOps("datasets",t,{projectIds:y.arrayRemove(e),primaryProjectId:null,updatedAt:new Date().toISOString()}),!1)}catch(r){return this.handleError(r,`assignDatasetToProjectInFirestore(${e}, ${t})`),!1}}async unassignDatasetFromProjectInFirestore(e,t){var r;try{console.log(`üîç [DatasetService] Unassigning dataset from project in Firestore: ${e}, ${t}`),await this.firestoreAdapter.initialize();const a=await this.firestoreAdapter.getDocumentById("datasets",t);if(!a)return console.warn(`‚ö†Ô∏è [DatasetService] Dataset not found: ${t}`),!1;if(!((r=a.projectIds)!=null&&r.includes(e)))return console.warn(`‚ö†Ô∏è [DatasetService] Dataset is not assigned to this project: ${t}, ${e}`),!1;if(!await this.firestoreAdapter.updateDocumentWithArrayOps("datasets",t,{projectIds:y.arrayRemove(e),updatedAt:new Date().toISOString()}))return console.warn(`‚ö†Ô∏è [DatasetService] Failed to update dataset: ${t}`),!1;const s=this.firestoreAdapter.getCurrentUser();let i=null;if(s)try{const l=await this.firestoreAdapter.getDocumentById("users",s.uid);if(l&&l.organizationId)i=l.organizationId;else{const u=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:s.email}]);u.length>0&&u[0].organizationId&&(i=u[0].organizationId)}}catch(l){console.warn("‚ö†Ô∏è [DatasetService] Error getting user organization:",l)}if(!i)return console.warn("‚ö†Ô∏è [DatasetService] No organization ID found for user"),!1;const n=await this.firestoreAdapter.queryDocuments("project_datasets",[{field:"projectId",operator:"==",value:e},{field:"datasetId",operator:"==",value:t},{field:"organizationId",operator:"==",value:i}]);return n.length>0&&!await this.firestoreAdapter.deleteDocument("project_datasets",n[0].id)?(console.warn("‚ö†Ô∏è [DatasetService] Failed to delete project-dataset link"),await this.firestoreAdapter.updateDocumentWithArrayOps("datasets",t,{projectIds:y.arrayUnion(e),updatedAt:new Date().toISOString()}),!1):(await this.firestoreAdapter.updateDocument("projects",e,{updatedAt:new Date().toISOString(),lastAccessedAt:new Date().toISOString()})||console.warn(`‚ö†Ô∏è [DatasetService] Failed to update project: ${e}, but dataset unassignment succeeded`),console.log("‚úÖ [DatasetService] Dataset successfully unassigned from project in Firestore"),!0)}catch(a){return this.handleError(a,`unassignDatasetFromProjectInFirestore(${e}, ${t})`),!1}}async updateDataset(e,t){try{if(console.log(`üîÑ [DatasetService] Updating dataset: ${e}`,t),this.isWebOnlyMode())return await this.updateDatasetInFirestore(e,t);try{return(await this.apiRequest(`datasets/${e}`,"PATCH",t)).data}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.updateDatasetInFirestore(e,t)}}catch(r){return this.handleError(r,`updateDataset(${e})`),null}}async updateDatasetInFirestore(e,t){try{console.log(`üîÑ [DatasetService] Updating dataset in Firestore: ${e}`,t),await this.firestoreAdapter.initialize();const r=this.firestoreAdapter.getCurrentUser();let a=null;if(r)try{const o=await this.firestoreAdapter.getDocumentById("users",r.uid);if(o&&o.organizationId)a=o.organizationId;else{const l=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:r.email}]);l.length>0&&l[0].organizationId&&(a=l[0].organizationId)}}catch(o){console.warn("‚ö†Ô∏è [DatasetService] Error getting user organization:",o)}if(!a)return console.warn("‚ö†Ô∏è [DatasetService] No organization ID found for user"),null;const c=await this.firestoreAdapter.getDocumentById("datasets",e);if(!c)return console.warn(`‚ö†Ô∏è [DatasetService] Dataset not found: ${e}`),null;if(c.organizationId!==a)return console.error(`üö® [DatasetService] SECURITY VIOLATION: User tried to update dataset from different organization. User org: ${a}, Dataset org: ${c.organizationId}`),null;const s={...t,updatedAt:new Date().toISOString(),organizationId:c.organizationId},i=Object.fromEntries(Object.entries(s).filter(([o,l])=>l!==void 0&&o!=="id"));if(await this.firestoreAdapter.updateDocument("datasets",e,i)){const o=await this.firestoreAdapter.getDocumentById("datasets",e);return console.log(`‚úÖ [DatasetService] Dataset successfully updated in Firestore: ${e}`),o}return console.warn(`‚ö†Ô∏è [DatasetService] Failed to update dataset in Firestore: ${e}`),null}catch(r){return this.handleError(r,`updateDatasetInFirestore(${e})`),null}}async deleteDataset(e){try{if(console.log(`üóëÔ∏è [DatasetService] Deleting dataset: ${e}`),this.isWebOnlyMode())return await this.deleteDatasetFromFirestore(e);try{return await this.apiRequest(`datasets/${e}`,"DELETE"),!0}catch{return console.warn("‚ö†Ô∏è [DatasetService] API request failed, falling back to Firestore"),await this.deleteDatasetFromFirestore(e)}}catch(t){return this.handleError(t,`deleteDataset(${e})`),!1}}async deleteDatasetFromFirestore(e){try{console.log(`üóëÔ∏è [DatasetService] Deleting dataset from Firestore: ${e}`),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();let r=null;if(t)try{const i=await this.firestoreAdapter.getDocumentById("users",t.uid);if(i&&i.organizationId)r=i.organizationId;else{const n=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:t.email}]);n.length>0&&n[0].organizationId&&(r=n[0].organizationId)}}catch(i){console.warn("‚ö†Ô∏è [DatasetService] Error getting user organization:",i)}if(!r)return console.warn("‚ö†Ô∏è [DatasetService] No organization ID found for user"),!1;const a=await this.firestoreAdapter.getDocumentById("datasets",e);if(!a)return console.warn(`‚ö†Ô∏è [DatasetService] Dataset not found: ${e}`),!1;if(a.organizationId!==r)return console.error(`üö® [DatasetService] SECURITY VIOLATION: User tried to delete dataset from different organization. User org: ${r}, Dataset org: ${a.organizationId}`),!1;const c=await this.firestoreAdapter.queryDocuments("project_datasets",[{field:"datasetId",operator:"==",value:e},{field:"organizationId",operator:"==",value:r}]);for(const i of c)await this.firestoreAdapter.deleteDocument("project_datasets",i.id);if(a.projectIds&&a.projectIds.length>0)for(const i of a.projectIds)try{const n=await this.firestoreAdapter.getDocumentById("projects",i);n&&n.organizationId===r&&await this.firestoreAdapter.updateDocumentWithArrayOps("projects",i,{datasetIds:y.arrayRemove(e),updatedAt:new Date().toISOString()})}catch(n){console.warn(`‚ö†Ô∏è [DatasetService] Failed to update project ${i} during dataset deletion:`,n)}return await this.firestoreAdapter.deleteDocument("datasets",e)?(console.log(`‚úÖ [DatasetService] Dataset successfully deleted from Firestore: ${e}`),!0):(console.warn(`‚ö†Ô∏è [DatasetService] Failed to delete dataset from Firestore: ${e}`),!1)}catch(t){return this.handleError(t,`deleteDatasetFromFirestore(${e})`),!1}}async cleanupCorruptedDatasets(){try{console.log("üßπ [DatasetService] Starting cleanup of corrupted datasets"),await this.firestoreAdapter.initialize();const e=this.firestoreAdapter.getCurrentUser();let t=null;if(e)try{const i=await this.firestoreAdapter.getDocumentById("users",e.uid);if(i&&i.organizationId)t=i.organizationId;else{const n=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:e.email}]);n.length>0&&n[0].organizationId&&(t=n[0].organizationId)}}catch(i){console.warn("‚ö†Ô∏è [DatasetService] Error getting user organization:",i)}if(!t)throw new Error("No organization ID found for user");const a=(await this.firestoreAdapter.queryDocuments("datasets",[{field:"organizationId",operator:"==",value:t}])).filter(i=>!i.name||!i.id||i.id==="dataset-001"||i.id==="dataset-002"||typeof i.id!="string"||i.id.trim()==="");console.log(`üîç [DatasetService] Found ${a.length} corrupted datasets to clean up`);const c=[];let s=0;for(const i of a)try{await this.deleteDatasetFromFirestore(i.id)?(s++,console.log(`‚úÖ [DatasetService] Cleaned up corrupted dataset: ${i.id}`)):c.push(`Failed to delete dataset: ${i.id}`)}catch(n){c.push(`Error deleting dataset ${i.id}: ${n}`)}return console.log(`üßπ [DatasetService] Cleanup completed. Cleaned: ${s}, Errors: ${c.length}`),{cleaned:s,errors:c}}catch(e){return this.handleError(e,"cleanupCorruptedDatasets()"),{cleaned:0,errors:[e.toString()]}}}};f(F,"instance");let T=F;const b=class b extends ${constructor(e){super(e)}static getInstance(e){return b.instance||(b.instance=new b(e)),b.instance}async getLicensedTeamMembers(e){try{if(console.log("üöÄ [TeamMemberService] Getting licensed team members with options:",e),this.isWebOnlyMode())return await this.getLicensedTeamMembersFromFirestore(e);const t=new URLSearchParams;e!=null&&e.search&&t.append("search",e.search),e!=null&&e.excludeProjectId&&t.append("excludeProjectId",e.excludeProjectId);const r=`team-members/licensed${t.toString()?`?${t.toString()}`:""}`;try{return await this.apiRequest(r)}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.getLicensedTeamMembersFromFirestore(e)}}catch(t){return this.handleError(t,"getLicensedTeamMembers"),[]}}async getProjectTeamMembers(e){try{if(console.log("üöÄ [TeamMemberService] Getting team members for project:",e),this.isWebOnlyMode())return await this.getProjectTeamMembersFromFirestore(e);try{return await this.apiRequest(`projects/${e}/team-members`)}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.getProjectTeamMembersFromFirestore(e)}}catch(t){return this.handleError(t,`getProjectTeamMembers(${e})`),[]}}async addTeamMemberToProject(e,t,r=D.DO_ER){try{if(console.log("üöÄ [TeamMemberService] Adding team member to project:",{projectId:e,teamMemberId:t,role:r}),this.isWebOnlyMode())return await this.addTeamMemberToProjectInFirestore(e,t,r);try{return await this.apiRequest(`projects/${e}/team-members`,"POST",{teamMemberId:t,role:r}),!0}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.addTeamMemberToProjectInFirestore(e,t,r)}}catch(a){return this.handleError(a,`addTeamMemberToProject(${e}, ${t})`),!1}}async removeTeamMemberFromProject(e,t){try{if(console.log("üöÄ [TeamMemberService] Removing team member from project:",{projectId:e,teamMemberId:t}),this.isWebOnlyMode())return await this.removeTeamMemberFromProjectInFirestore(e,t);try{return await this.apiRequest(`projects/${e}/team-members/${t}`,"DELETE"),!0}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.removeTeamMemberFromProjectInFirestore(e,t)}}catch(r){return this.handleError(r,`removeTeamMemberFromProject(${e}, ${t})`),!1}}async updateTeamMemberRole(e,t,r){try{if(console.log("üöÄ [TeamMemberService] Updating team member role:",{projectId:e,teamMemberId:t,role:r}),this.isWebOnlyMode())return await this.updateTeamMemberRoleInFirestore(e,t,r);try{return await this.apiRequest(`projects/${e}/team-members/${t}/role`,"PATCH",{role:r}),!0}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.updateTeamMemberRoleInFirestore(e,t,r)}}catch(a){return this.handleError(a,`updateTeamMemberRole(${e}, ${t})`),!1}}async validateTeamMemberCredentials(e,t){try{if(console.log("üöÄ [TeamMemberService] Validating team member credentials for:",e),this.isWebOnlyMode())return await this.validateTeamMemberCredentialsFromFirestore(e,t);try{return await this.apiRequest("team-members/validate-credentials","POST",{email:e,password:t})}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.validateTeamMemberCredentialsFromFirestore(e,t)}}catch(r){return this.handleError(r,"validateTeamMemberCredentials"),{isValid:!1,error:"Authentication failed"}}}async refreshTeamMembers(){try{console.log("üîÑ [TeamMemberService] Refreshing team member data..."),console.log("‚úÖ [TeamMemberService] Team member data refresh initiated")}catch(e){console.error("‚ùå [TeamMemberService] Failed to refresh team member data:",e)}}async createTeamMemberWithFirebaseAuth(e){try{if(console.log("üöÄ [TeamMemberService] Creating team member with Firebase Auth:",e),this.isWebOnlyMode())return await this.createTeamMemberWithFirebaseAuthInFirestore(e);try{return await this.apiRequest("team-members/create","POST",e)}catch{return console.warn("‚ö†Ô∏è [TeamMemberService] API request failed, falling back to Firestore"),await this.createTeamMemberWithFirebaseAuthInFirestore(e)}}catch(t){return this.handleError(t,"createTeamMemberWithFirebaseAuth"),{success:!1,error:"Failed to create team member with Firebase Auth"}}}async getLicensedTeamMembersFromFirestore(e){try{console.log("üîç [TeamMemberService] Fetching licensed team members from Firestore with options:",e),await this.firestoreAdapter.initialize();const t=this.firestoreAdapter.getCurrentUser();if(!t)return console.log("‚ùå [TeamMemberService] No authenticated user found"),[];let r=null;try{const o=await this.firestoreAdapter.getDocumentById("users",t.uid);if(o&&o.organizationId)r=o.organizationId,console.log("‚úÖ [TeamMemberService] Found organization ID from user document:",r);else{const l=await this.firestoreAdapter.queryDocuments("users",[{field:"email",operator:"==",value:t.email}]);l.length>0&&l[0].organizationId&&(r=l[0].organizationId,console.log("‚úÖ [TeamMemberService] Found organization ID from user email query:",r))}}catch(o){console.warn("‚ö†Ô∏è [TeamMemberService] Error getting user organization:",o)}if(!r)return console.log("‚ùå [TeamMemberService] No organization ID found for user"),[];console.log("üè¢ [TeamMemberService] Fetching team members for organization:",r);const a=await this.firestoreAdapter.queryDocuments("teamMembers",[{field:"organizationId",operator:"==",value:r}]);console.log(`üîç [TeamMemberService] Raw team members found: ${a.length}`);const c=a.filter(o=>{var u,d;const l=((d=(u=o.status)==null?void 0:u.toUpperCase)==null?void 0:d.call(u))||o.status||"UNKNOWN";return l!=="ACTIVE"&&l!=="active"?(console.log(`‚ö†Ô∏è [TeamMemberService] Excluding team member ${o.email} with status: ${l}`),!1):o.isActive===!1?(console.log(`‚ö†Ô∏è [TeamMemberService] Excluding team member ${o.email} with isActive: false`),!1):o.revokedAt||o.removedAt||o.suspendedAt?(console.log(`‚ö†Ô∏è [TeamMemberService] Excluding team member ${o.email} with revocation/removal dates`),!1):!0});console.log(`‚úÖ [TeamMemberService] Active team members after filtering: ${c.length}`);let s=[];if(e!=null&&e.excludeProjectId)try{s=(await this.getProjectTeamMembersFromFirestore(e.excludeProjectId)).map(l=>l.teamMemberId),console.log(`üîç [TeamMemberService] Excluding ${s.length} already assigned team members`)}catch(o){console.warn("‚ö†Ô∏è [TeamMemberService] Failed to get assigned team members:",o)}const n=c.filter(o=>{if(s.includes(o.id))return!1;if(e!=null&&e.search){const l=e.search.toLowerCase(),u=(o.name||"").toLowerCase(),d=(o.firstName||"").toLowerCase(),h=(o.lastName||"").toLowerCase(),w=(o.email||"").toLowerCase();return u.includes(l)||d.includes(l)||h.includes(l)||w.includes(l)}return!0}).map(o=>{let l=o.name;l||(o.firstName&&o.lastName?l=`${o.firstName} ${o.lastName}`:o.firstName?l=o.firstName:o.lastName?l=o.lastName:o.email?l=o.email.split("@")[0].replace(/[._-]/g," ").split(" ").map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(" "):l="Unknown User");let u=o.licenseType;return u||(u="professional"),{...o,name:l,licenseType:u,status:"active",isActive:!0}});return n.sort((o,l)=>{const u=(o.name||"").toLowerCase(),d=(l.name||"").toLowerCase();return u.localeCompare(d)}),console.log(`‚úÖ [TeamMemberService] Final filtered and mapped team members: ${n.length}`),n}catch(t){return this.handleError(t,"getLicensedTeamMembersFromFirestore"),[]}}async getProjectTeamMembersFromFirestore(e){try{console.log("üîç [TeamMemberService] Fetching team members from Firestore for project:",e),await this.firestoreAdapter.initialize();const t=[],r=await this.firestoreAdapter.getDocumentById("projects",e);if(r){const c=r.teamMembers||[];for(const s of c)t.push({id:s.userId||s.id,teamMemberId:s.userId||s.id,projectId:e,role:s.role||"member",permissions:s.permissions||["read"],assignedAt:s.assignedAt||new Date().toISOString(),isActive:s.isActive!==!1,email:s.email,name:s.name||s.email,status:s.status||"active"})}try{const c=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e}]);for(const s of c)t.find(i=>i.teamMemberId===s.teamMemberId)||t.push(s)}catch{console.log("‚ÑπÔ∏è [TeamMemberService] projectTeamMembers collection not found or accessible")}const a=[];for(const c of t)try{const s=await this.firestoreAdapter.getDocumentById("teamMembers",c.teamMemberId);s?a.push({...c,name:s.name||s.email||c.name||"Unnamed User",email:s.email||c.email||"No email",teamMember:s}):a.push(c)}catch(s){console.warn("‚ö†Ô∏è [TeamMemberService] Failed to get full profile for team member:",c.teamMemberId,s),a.push(c)}return console.log(`‚úÖ [TeamMemberService] Found ${a.length} team members for project ${e}`),a}catch(t){return this.handleError(t,`getProjectTeamMembersFromFirestore(${e})`),[]}}async addTeamMemberToProjectInFirestore(e,t,r){try{console.log("üîç [TeamMemberService] Adding team member to project in Firestore:",{projectId:e,teamMemberId:t,role:r}),await this.firestoreAdapter.initialize();const a=await this.firestoreAdapter.getDocumentById("teamMembers",t);if(!a)return console.warn("‚ö†Ô∏è [TeamMemberService] Team member not found:",t),!1;if(r===D.ADMIN&&(await this.getProjectTeamMembersFromFirestore(e)).some(o=>o.role===D.ADMIN))throw console.warn("‚ö†Ô∏è [TeamMemberService] Only one Admin is allowed per project"),new Error("Only one Admin is allowed per project. Please remove the existing Admin first.");const c={projectId:e,teamMemberId:t,role:r,assignedBy:"system",assignedAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0,teamMemberName:a.name||"Unknown User",teamMemberEmail:a.email||"No email",teamMemberRole:a.role||"MEMBER",teamMemberLicenseType:a.licenseType||"BASIC"};return await this.firestoreAdapter.createDocument("projectTeamMembers",c)!==null}catch(a){return this.handleError(a,`addTeamMemberToProjectInFirestore(${e}, ${t})`),!1}}async removeTeamMemberFromProjectInFirestore(e,t){try{console.log("üîç [TeamMemberService] Removing team member from project in Firestore:",{projectId:e,teamMemberId:t}),await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e},{field:"teamMemberId",operator:"==",value:t}]);return r.length===0?(console.warn("‚ö†Ô∏è [TeamMemberService] Team member not found in project"),!1):await this.firestoreAdapter.deleteDocument("projectTeamMembers",r[0].id)}catch(r){return this.handleError(r,`removeTeamMemberFromProjectInFirestore(${e}, ${t})`),!1}}async updateTeamMemberRoleInFirestore(e,t,r){try{console.log("üîç [TeamMemberService] Updating team member role in Firestore:",{projectId:e,teamMemberId:t,role:r}),await this.firestoreAdapter.initialize();const a=await this.firestoreAdapter.queryDocuments("projectTeamMembers",[{field:"projectId",operator:"==",value:e},{field:"teamMemberId",operator:"==",value:t}]);if(a.length===0)return console.warn("‚ö†Ô∏è [TeamMemberService] Team member not found in project"),!1;if(r===D.ADMIN&&(await this.getProjectTeamMembersFromFirestore(e)).some(n=>n.role===D.ADMIN&&n.teamMemberId!==t))throw console.warn("‚ö†Ô∏è [TeamMemberService] Only one Admin is allowed per project"),new Error("Only one Admin is allowed per project. Please remove the existing Admin first.");return await this.firestoreAdapter.updateDocument("projectTeamMembers",a[0].id,{role:r,updatedAt:new Date().toISOString()})}catch(a){return this.handleError(a,`updateTeamMemberRoleInFirestore(${e}, ${t})`),!1}}async validateTeamMemberCredentialsFromFirestore(e,t){try{await this.firestoreAdapter.initialize();const r=await this.firestoreAdapter.queryDocuments("teamMembers",[{field:"email",operator:"==",value:e}]);if(r.length===0)return{isValid:!1,error:"Team member not found"};const a=r[0];return t.length<1?{isValid:!1,error:"Password is required"}:{isValid:!0,teamMember:a,projectAccess:[]}}catch(r){return this.handleError(r,"validateTeamMemberCredentialsFromFirestore"),{isValid:!1,error:"Authentication failed"}}}async createTeamMemberWithFirebaseAuthInFirestore(e){try{console.log("üîç [TeamMemberService] Creating team member with Firebase Auth in Firestore:",e),await this.firestoreAdapter.initialize();const{auth:t}=await g(async()=>{const{auth:l}=await import("./firebase-Dm8Ngwai.js");return{auth:l}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),{createUserWithEmailAndPassword:r}=await g(async()=>{const{createUserWithEmailAndPassword:l}=await import("./index.esm-D2YDx4vs.js");return{createUserWithEmailAndPassword:l}},__vite__mapDeps([8,6])),a=e.temporaryPassword||this.generateSecurePassword();let c;try{c=(await r(t,e.email,a)).user,console.log("‚úÖ [TeamMemberService] Firebase Auth user created successfully:",c.uid)}catch(l){if(l.code==="auth/email-already-in-use")return{success:!1,error:"User with this email already exists in Firebase Authentication"};throw l}const s={id:c.uid,email:e.email,firstName:e.firstName,lastName:e.lastName,name:`${e.firstName} ${e.lastName}`,licenseType:e.licenseType||"PROFESSIONAL",status:"ACTIVE",organizationId:e.organizationId,department:e.department,role:e.role||"MEMBER",firebaseUid:c.uid,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0},i={id:c.uid,email:e.email,name:`${e.firstName} ${e.lastName}`,firstName:e.firstName,lastName:e.lastName,role:"TEAM_MEMBER",firebaseUid:c.uid,isEmailVerified:!1,twoFactorEnabled:!1,twoFactorBackupCodes:[],privacyConsent:[],marketingConsent:!1,dataProcessingConsent:!1,identityVerified:!1,kycStatus:"PENDING",isTeamMember:!0,organizationId:e.organizationId,memberRole:e.role||"MEMBER",memberStatus:"ACTIVE",department:e.department,licenseType:e.licenseType||"PROFESSIONAL",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};let n=null,o=null;if(n=await this.firestoreAdapter.createDocument("teamMembers",s),n&&(o=await this.firestoreAdapter.createDocument("users",i)),!n||!o){try{await c.delete(),console.log("üîÑ [TeamMemberService] Rolled back Firebase Auth user after Firestore failure")}catch(l){console.error("‚ùå [TeamMemberService] Failed to rollback Firebase Auth user:",l)}return{success:!1,error:"Failed to create required documents in Firestore"}}return console.log("‚úÖ [TeamMemberService] Team member created successfully in Firestore"),{success:!0,teamMember:s,firebaseUid:c.uid,temporaryPassword:a}}catch(t){return this.handleError(t,"createTeamMemberWithFirebaseAuthInFirestore"),{success:!1,error:(t==null?void 0:t.message)||"Failed to create team member with Firebase Auth"}}}generateSecurePassword(){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";let r="";r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random()*26)],r+="abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random()*26)],r+="0123456789"[Math.floor(Math.random()*10)],r+="!@#$%^&*"[Math.floor(Math.random()*8)];for(let a=4;a<12;a++)r+=t[Math.floor(Math.random()*t.length)];return r.split("").sort(()=>Math.random()-.5).join("")}};f(b,"instance");let M=b;const S=class S{constructor(){f(this,"config");f(this,"projectService",null);f(this,"datasetService",null);f(this,"teamMemberService",null);this.config={isWebOnlyMode:this.detectWebOnlyMode(),apiBaseUrl:"/api"},this.initializeFirestoreAdapter()}static getInstance(){return S.instance||(S.instance=new S),S.instance}initialize(e){this.config={...this.config,...e},console.log("üîß [ServiceFactory] Initialized with config:",this.config),this.projectService=null,this.datasetService=null,this.teamMemberService=null}getProjectService(){return this.projectService||(this.projectService=j.getInstance(this.config)),this.projectService}getDatasetService(){return this.datasetService||(this.datasetService=T.getInstance(this.config)),this.datasetService}getTeamMemberService(){return this.teamMemberService||(this.teamMemberService=M.getInstance(this.config)),this.teamMemberService}detectWebOnlyMode(){if(typeof window<"u"){const e=new URLSearchParams(window.location.search);if(e.has("webonly"))return e.get("webonly")==="true";const t=localStorage.getItem("webonly_mode");if(t)return t==="true";if(window.ENV&&window.ENV.WEBONLY)return window.ENV.WEBONLY===!0}return!0}async initializeFirestoreAdapter(){try{await y.getInstance().initialize()}catch(e){console.error("‚ùå [ServiceFactory] Failed to initialize Firestore adapter:",e)}}};f(S,"instance");let E=S;const A=class A{constructor(){f(this,"serviceFactory");f(this,"authTokenCallback",null);this.serviceFactory=E.getInstance(),this.serviceFactory.initialize({isWebOnlyMode:this.isWebOnlyMode()})}static getInstance(){return A.instance||(A.instance=new A),A.instance}isWebOnlyMode(){if(typeof window<"u"){const e=new URLSearchParams(window.location.search);if(e.has("webonly"))return e.get("webonly")==="true";const t=localStorage.getItem("webonly_mode");if(t)return t==="true";if(window.ENV&&window.ENV.WEBONLY)return window.ENV.WEBONLY===!0}return!0}setConfig(e){this.serviceFactory.initialize(e)}async getProjects(){return await this.serviceFactory.getProjectService().getProjects()}async getUserProjects(){return await this.serviceFactory.getProjectService().getProjects()}async getProject(e){return await this.serviceFactory.getProjectService().getProject(e)}async createProject(e){return await this.serviceFactory.getProjectService().createProject(e)}async createCloudProject(e){return await this.serviceFactory.getProjectService().createProject(e)}async createCloudProjectInFirestore(e){return await this.serviceFactory.getProjectService().createProject(e)}async updateProject(e,t){return await this.serviceFactory.getProjectService().updateProject(e,t)}async updateProjectInFirestore(e,t){return await this.serviceFactory.getProjectService().updateProject(e,t)}async archiveProject(e){return await this.serviceFactory.getProjectService().archiveProject(e)}async archiveProjectInFirestore(e){return await this.serviceFactory.getProjectService().archiveProject(e)}async restoreProject(e){return await this.serviceFactory.getProjectService().restoreProject(e)}async deleteProject(e){return await this.serviceFactory.getProjectService().deleteProject(e)}async listDatasets(e){return await this.serviceFactory.getDatasetService().listDatasets(e)}async createDataset(e){return await this.serviceFactory.getDatasetService().createDataset(e)}async getProjectDatasets(e){return await this.serviceFactory.getDatasetService().getProjectDatasets(e)}async assignDatasetToProject(e,t){await this.serviceFactory.getDatasetService().assignDatasetToProject(e,t)}async unassignDatasetFromProject(e,t){await this.serviceFactory.getDatasetService().unassignDatasetFromProject(e,t)}async updateDataset(e,t){return await this.serviceFactory.getDatasetService().updateDataset(e,t)}async deleteDataset(e){return await this.serviceFactory.getDatasetService().deleteDataset(e)}async cleanupCorruptedDatasets(){return await this.serviceFactory.getDatasetService().cleanupCorruptedDatasets()}async getLicensedTeamMembers(e){return await this.serviceFactory.getTeamMemberService().getLicensedTeamMembers(e)}async getProjectTeamMembers(e){return await this.serviceFactory.getTeamMemberService().getProjectTeamMembers(e)}async addTeamMemberToProject(e,t,r=D.DO_ER){await this.serviceFactory.getTeamMemberService().addTeamMemberToProject(e,t,r)}async removeTeamMemberFromProject(e,t){await this.serviceFactory.getTeamMemberService().removeTeamMemberFromProject(e,t)}async updateTeamMemberRole(e,t,r){await this.serviceFactory.getTeamMemberService().updateTeamMemberRole(e,t,r)}async validateTeamMemberCredentials(e,t){return await this.serviceFactory.getTeamMemberService().validateTeamMemberCredentials(e,t)}setAuthTokenCallback(e){this.authTokenCallback=e}setAuthToken(e){console.log("Setting auth token:",e),typeof localStorage<"u"&&localStorage.setItem("auth_token",e),this.authTokenCallback&&this.authTokenCallback()}cleanDocumentData(e){const t={};for(const[r,a]of Object.entries(e))if(a!==void 0){if(a===null){t[r]=null;continue}if(typeof a=="object"&&!Array.isArray(a)&&!(a instanceof Date)){t[r]=this.cleanDocumentData(a);continue}t[r]=a}return t}};f(A,"instance");let I=A;const R=I.getInstance();typeof window<"u"&&(window.cloudProjectIntegration=R);export{R as cloudProjectIntegration,I as default};
