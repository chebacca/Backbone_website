import{ab as B,j as e,a as S,T as j,d as y,bb as oe,bc as G,U as H,aO as le,aP as ce,aQ as ne,u as _,aT as R,bU as A,aV as I,a4 as m,aR as de,W as ue,X as he,Y as ge,h as V,I as $}from"./mui-BeS5Ygr6.js";import{r as n}from"./vendor-OeuszDaU.js";import{r as M}from"./createSvgIcon-DUz8CuB7.js";import{c as g,d as xe}from"./index-B2KrmW02.js";import"./stripe-TmI1MsK7.js";var D={},ve=B;Object.defineProperty(D,"__esModule",{value:!0});var Q=D.default=void 0,me=ve(M()),pe=e;Q=D.default=(0,me.default)((0,pe.jsx)("path",{d:"M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96"}),"Cloud");var E={},je=B;Object.defineProperty(E,"__esModule",{value:!0});var X=E.default=void 0,fe=je(M()),ye=e;X=E.default=(0,fe.default)((0,ye.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"}),"Delete");var F={},be=B;Object.defineProperty(F,"__esModule",{value:!0});var Y=F.default=void 0,Ce=be(M()),we=e;Y=F.default=(0,Ce.default)((0,we.jsx)("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9m-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8z"}),"Restore");var U={},ke=B;Object.defineProperty(U,"__esModule",{value:!0});var J=U.default=void 0,Pe=ke(M()),Se=e;J=U.default=(0,Pe.default)((0,Se.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add");const N={async getSignedUrl(h,o,x,i){var b,p;const d=await g.post(`projects/${h}/storage/signed-url`,{filename:o,operation:x,contentType:i});if(!((b=d.data)!=null&&b.success))throw new Error(((p=d.data)==null?void 0:p.error)||"Failed to get signed URL");return d.data.data},async uploadAsset(h,o){const x=await this.getSignedUrl(h,o.name,"upload",o.type||"application/octet-stream"),i=await fetch(x.url,{method:"PUT",headers:{"Content-Type":o.type||"application/octet-stream",...x.headers||{}},body:o});if(!i.ok){const d=await i.text().catch(()=>"");throw new Error(d||`Upload failed with status ${i.status}`)}},async downloadAsset(h,o){const x=await this.getSignedUrl(h,o,"download"),i=document.createElement("a");i.href=x.url,i.download=o,document.body.appendChild(i),i.click(),document.body.removeChild(i)}},Ae=()=>{const[h,o]=n.useState(0),[x,i]=n.useState(!1),[d,b]=n.useState([]),[p,W]=n.useState([]),[C,l]=n.useState(null),[K,f]=n.useState(!1),[w,z]=n.useState(!1),[L,q]=n.useState(null),[s,u]=n.useState({name:"",description:"",visibility:"private",storageMode:"cloud",cloudType:"firestore",gcsBucket:"",gcsPrefix:""}),k=async()=>{try{l(null);const t=await xe.withLoading(()=>g.get("projects"),i);b(Array.isArray(t)?t:[])}catch(t){l((t==null?void 0:t.message)||"Failed to load projects")}},P=async()=>{var t,a,r;try{l(null);try{const T=((t=(await g.get("projects/archived/list")).data)==null?void 0:t.data)||[];W(Array.isArray(T)?T:[]);return}catch(c){if(((c==null?void 0:c.status)||((a=c==null?void 0:c.response)==null?void 0:a.status))!==404)throw c}const ie=((r=(await g.get("projects",{params:{includeArchived:!0}})).data)==null?void 0:r.data)||[];W(ie.filter(c=>c.isArchived))}catch(v){l((v==null?void 0:v.message)||"Failed to load archived projects")}};n.useEffect(()=>{k(),P()},[]);const Z=()=>{z(!1),q(null),u({name:"",description:"",visibility:"private",storageMode:"cloud",cloudType:"firestore",gcsBucket:"",gcsPrefix:""}),f(!0)},ee=t=>{z(!0),q(t.id),u({name:t.name||"",description:t.description||"",visibility:t.visibility||"private",storageMode:t.storageBackend?"cloud":"local",cloudType:t.storageBackend||"firestore",gcsBucket:t.gcsBucket||"",gcsPrefix:t.gcsPrefix||""}),f(!0)},te=()=>s.name.trim()?s.storageMode==="cloud"&&s.cloudType==="gcs"&&!s.gcsBucket.trim()?"GCS Bucket is required for GCS storage":null:"Project name is required",ae=async()=>{const t=te();if(t){l(t);return}try{l(null),w&&L?await g.patch(`projects/${L}`,{name:s.name,description:s.description,visibility:s.visibility}):await g.post("projects",{name:s.name,description:s.description,type:"network",applicationMode:"shared_network",visibility:s.visibility,storageBackend:s.storageMode==="cloud"?s.cloudType:void 0,gcsBucket:s.storageMode==="cloud"&&s.cloudType==="gcs"&&s.gcsBucket||void 0,gcsPrefix:s.storageMode==="cloud"&&s.cloudType==="gcs"&&s.gcsPrefix||void 0}),f(!1),await Promise.all([k(),P()])}catch(a){l((a==null?void 0:a.message)||"Save failed")}},se=async t=>{try{await g.delete(`projects/${t}`),await Promise.all([k(),P()])}catch(a){l((a==null?void 0:a.message)||"Delete failed")}},re=async t=>{try{await g.post(`projects/${t}/restore`,{}),await Promise.all([k(),P()])}catch(a){l((a==null?void 0:a.message)||"Restore failed")}},O=(t,a)=>e.jsxs(ue,{sx:{border:"1px solid",borderColor:"divider",borderRadius:1,mb:1},secondaryAction:a?e.jsx($,{onClick:()=>re(t.id),"aria-label":"Restore project",children:e.jsx(Y,{})}):e.jsxs(S,{children:[e.jsx($,{onClick:()=>ee(t),"aria-label":"Edit project",sx:{mr:1},children:e.jsx("span",{role:"img","aria-label":"edit",children:"✏️"})}),e.jsx($,{onClick:()=>se(t.id),"aria-label":"Delete project",children:e.jsx(X,{})}),t.storageBackend==="gcs"&&e.jsxs(e.Fragment,{children:[e.jsx(y,{size:"small",sx:{ml:1},onClick:async()=>{try{const r=document.createElement("input");r.type="file",r.onchange=async()=>{const v=r.files&&r.files[0]||null;v&&await N.uploadAsset(t.id,v)},r.click()}catch(r){l((r==null?void 0:r.message)||"Upload failed")}},children:"Upload"}),e.jsx(y,{size:"small",onClick:async()=>{try{const r=window.prompt("Enter filename to download (exact match):");if(!r)return;await N.downloadAsset(t.id,r)}catch(r){l((r==null?void 0:r.message)||"Download failed")}},children:"Download"})]})]}),children:[e.jsx(he,{children:e.jsx(Q,{color:a?"disabled":"primary"})}),e.jsx(ge,{primary:e.jsxs(S,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(j,{variant:"subtitle2",sx:{flexGrow:1},children:t.name}),t.storageBackend&&e.jsx(V,{size:"small",variant:"outlined",label:t.storageBackend==="gcs"?"GCS":"Firestore",color:t.storageBackend==="gcs"?"secondary":"primary"}),e.jsx(V,{size:"small",variant:"outlined",label:t.visibility})]}),secondary:t.description||""})]},t.id);return e.jsxs(S,{children:[e.jsxs(S,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(j,{variant:"h5",sx:{fontWeight:700},children:"Cloud Projects"}),e.jsx(y,{variant:"contained",startIcon:e.jsx(J,{}),onClick:Z,children:"Create Project"})]}),e.jsxs(oe,{value:h,onChange:(t,a)=>o(a),sx:{mb:2},children:[e.jsx(G,{label:`Active (${d.length})`}),e.jsx(G,{label:`Recycle Bin (${p.length})`})]}),C&&e.jsx(j,{color:"error",sx:{mb:2},children:C}),h===0?e.jsx(H,{children:d.length===0?e.jsx(j,{variant:"body2",color:"text.secondary",children:"No projects yet."}):d.map(t=>O(t,!1))}):e.jsx(H,{children:p.length===0?e.jsx(j,{variant:"body2",color:"text.secondary",children:"Recycle Bin is empty."}):p.map(t=>O(t,!0))}),e.jsxs(le,{open:K,onClose:()=>f(!1),fullWidth:!0,maxWidth:"sm",children:[e.jsx(ce,{children:w?"Edit Project":"Create Project"}),e.jsxs(ne,{children:[C&&e.jsx(j,{color:"error",sx:{mb:2},children:C}),e.jsx(_,{fullWidth:!0,label:"Project Name",value:s.name,onChange:t=>u(a=>({...a,name:t.target.value})),sx:{mt:1,mb:2}}),e.jsx(_,{fullWidth:!0,label:"Description",value:s.description,onChange:t=>u(a=>({...a,description:t.target.value})),multiline:!0,rows:3,sx:{mb:2}}),e.jsxs(R,{fullWidth:!0,sx:{mb:2},children:[e.jsx(A,{children:"Visibility"}),e.jsxs(I,{value:s.visibility,onChange:t=>u(a=>({...a,visibility:t.target.value})),children:[e.jsx(m,{value:"private",children:"Private"}),e.jsx(m,{value:"organization",children:"Organization"}),e.jsx(m,{value:"public",children:"Public"})]})]}),!w&&e.jsxs(e.Fragment,{children:[e.jsxs(R,{fullWidth:!0,sx:{mb:2},children:[e.jsx(A,{children:"Storage Location"}),e.jsxs(I,{value:s.storageMode,onChange:t=>u(a=>({...a,storageMode:t.target.value})),children:[e.jsx(m,{value:"cloud",children:"Cloud"}),e.jsx(m,{value:"local",children:"Local (.dbproj)"})]})]}),s.storageMode==="cloud"&&e.jsxs(R,{fullWidth:!0,sx:{mb:2},children:[e.jsx(A,{children:"Cloud Type"}),e.jsxs(I,{value:s.cloudType,onChange:t=>u(a=>({...a,cloudType:t.target.value})),children:[e.jsx(m,{value:"firestore",children:"Firestore (metadata)"}),e.jsx(m,{value:"gcs",children:"Google Cloud Storage (assets)"})]})]}),s.storageMode==="cloud"&&s.cloudType==="gcs"&&e.jsxs(e.Fragment,{children:[e.jsx(_,{fullWidth:!0,label:"GCS Bucket",value:s.gcsBucket,onChange:t=>u(a=>({...a,gcsBucket:t.target.value})),sx:{mb:2}}),e.jsx(_,{fullWidth:!0,label:"GCS Prefix (optional)",value:s.gcsPrefix,onChange:t=>u(a=>({...a,gcsPrefix:t.target.value})),sx:{mb:2}})]})]})]}),e.jsxs(de,{children:[e.jsx(y,{onClick:()=>f(!1),children:"Cancel"}),e.jsx(y,{variant:"contained",onClick:ae,children:w?"Save":"Create"})]})]})]})};export{Ae as default};
