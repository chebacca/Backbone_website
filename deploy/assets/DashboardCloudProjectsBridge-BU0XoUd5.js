import{j as e,b as Ye,a as x,T as g,d as h,az as me,t as K,aA as He,aB as je,G as fe,k as Oe,l as Je,I as Ke,ak as Qe,h as w,aC as Ve,Z as be,aD as ye,aE as ve,aF as Xe,aG as Ce,U as ke,W as S,X as W,Y as D,aH as we,aI as Se,aJ as De,u as P,a4 as z,F as Ze,Q as et,aj as tt,aK as Pe}from"./mui-CqGO0PUa.js";import{r as o}from"./vendor-OeuszDaU.js";import{cloudProjectIntegration as d}from"./CloudProjectIntegration-CX7Ino_u.js";import{U as at,s as T}from"./UnifiedProjectCreationDialog-DqA0P_g-.js";import"./index-CBOk7eEB.js";import"./stripe-jpbJ1A2u.js";const st="_hiddenFileInput_wx11h_1",nt={hiddenFileInput:st},xt=({onProjectLaunch:G})=>{const[U,Ie]=o.useState([]),[Q,V]=o.useState(!0),[X,b]=o.useState(null),[j,Fe]=o.useState(0),[Be,E]=o.useState(!1),[ot,rt]=o.useState(!1),[n,I]=o.useState(null),[Z,y]=o.useState([]),[Ae,v]=o.useState(!1),[$e,F]=o.useState([]),[B,ee]=o.useState(""),[p,te]=o.useState("all"),[A,Le]=o.useState(""),[ae,se]=o.useState(null),[u,ne]=o.useState(null),[oe,N]=o.useState({}),[_e,R]=o.useState({}),[re,le]=o.useState(!1),[ie,ce]=o.useState(null),[Me,q]=o.useState(0),[We,C]=o.useState(!1),[Y,de]=o.useState(!1),[ue,H]=o.useState(null),[he,ze]=o.useState(!0),[c,f]=o.useState({name:"",description:"",backend:"firestore",gcsBucket:"",gcsPrefix:""}),Te=async t=>{try{v(!0);const a=await d.getProjectDatasets(t.id);y(a),N(m=>({...m,[t.id]:a.length}));const s=p==="all"?t.storageBackend:p;p==="all"&&te(s);const i=(await d.listDatasets({backend:s,query:A||void 0})).map(m=>{var l;return{...m,__label:`${m.name} ${((l=m.storage)==null?void 0:l.backend)==="gcs"?"(GCS)":"(Firestore)"}`}});F(i)}catch(a){console.error("Failed to load datasets for project",a)}finally{v(!1)}};o.useEffect(()=>{n&&(Te(n),f(t=>({...t,backend:n.storageBackend||"firestore",gcsBucket:n.gcsBucket||"",gcsPrefix:n.gcsPrefix||""})))},[n]),o.useEffect(()=>{$();const t=a=>{$()};return window.addEventListener("project:created",t),()=>window.removeEventListener("project:created",t)},[]);const $=async()=>{try{b(null),V(!0);const t=await d.getUserProjects();Ie(t);const a={};for(const s of t){const r=`launch_pref_${s.id}`,i=localStorage.getItem(r)||"web";a[s.id]=i}R(a)}catch(t){b((t==null?void 0:t.message)||"Failed to load projects")}finally{V(!1)}},xe=async t=>{try{await T.selectMode(t.applicationMode,"cloud"),await T.selectProject(t.id),G==null||G(t.id)}catch(a){console.error("Failed to launch project:",a),b("Failed to launch project")}},Ge=(t,a)=>{se(t.currentTarget),ne(a)},O=()=>{se(null),ne(null)},Ue=async()=>{var t,a;if(u){try{localStorage.setItem(`launch_pref_${u.id}`,"web"),R(l=>({...l,[u.id]:"web"}));let s="";try{const l=(a=(t=u.settings)==null?void 0:t.preferredPorts)==null?void 0:a.website,k=localStorage.getItem("preferred_website_port"),M=k?Number(k):0,qe=["localhost","127.0.0.1"].includes(window.location.hostname);l&&l>=1024&&l<=65535?s=`http://localhost:${l}`:M&&M>=1024&&M<=65535?s=`http://localhost:${M}`:qe?s="http://localhost:3002":s=window.location.origin}catch{s=window.location.origin}s=String(s).replace(/\/$/,"");const i=/^http:\/\/localhost:\d+$/i.test(s)?`${s}/#/?projectId=${encodeURIComponent(u.id)}&mode=${encodeURIComponent(u.applicationMode)}`:`${s}/?projectId=${encodeURIComponent(u.id)}&mode=${encodeURIComponent(u.applicationMode)}`;let m=!1;try{const l=document.createElement("a");l.href=i,l.target="_blank",l.rel="noopener noreferrer",document.body.appendChild(l),l.click(),document.body.removeChild(l),m=!0}catch{}m||(window.location.href=i),(async()=>{try{await T.selectMode(u.applicationMode,"cloud"),await T.selectProject(u.id)}catch{}})()}catch{}O()}},Ee=()=>{if(u)try{localStorage.setItem(`launch_pref_${u.id}`,"desktop"),R(r=>({...r,[u.id]:"desktop"}));const s=`dashboardv14://open-project?id=${encodeURIComponent(u.id)}`;window.location.href=s}catch(t){console.error("Failed to open desktop deep link",t),b("Unable to open Desktop app. Please ensure it is installed.")}finally{O()}},ge=()=>{E(!0)},Ne=async t=>{E(!1),await $(),setTimeout(()=>{const a=(j===0?L:_).find(s=>s.id===t)||U.find(s=>s.id===t);a&&xe(a)},0)},pe=t=>{switch(t){case"firestore":return e.jsx(be,{});case"gcs":return e.jsx(we,{});default:return e.jsx(Pe,{})}},J=t=>t==="standalone"?e.jsx(Pe,{}):e.jsx(Se,{}),Re=t=>{const a=new Date(t),r=new Date().getTime()-a.getTime(),i=Math.floor(r/(1e3*60*60*24));return i===0?"Today":i===1?"Yesterday":i<7?`${i} days ago`:a.toLocaleDateString()},L=U.filter(t=>t.isActive),_=U.filter(t=>!t.isActive);return e.jsxs(Ye,{maxWidth:"lg",sx:{py:4},children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(x,{children:[e.jsx(g,{variant:"h4",component:"h1",fontWeight:"bold",gutterBottom:!0,children:"Cloud Projects"}),e.jsx(g,{variant:"body1",color:"text.secondary",children:"Manage your projects with Firebase and Google Cloud Storage integration"})]}),e.jsx(h,{variant:"contained",startIcon:e.jsx(me,{}),onClick:ge,size:"large",children:"Create Project"})]}),e.jsx(K,{severity:"info",sx:{mb:3},children:e.jsxs(g,{variant:"body2",children:[e.jsx("strong",{children:"Integrated Startup System:"})," Projects created here will automatically integrate with the unified startup flow and support both standalone and network modes with Firebase/GCS storage options."]})}),X&&e.jsx(K,{severity:"error",sx:{mb:3},onClose:()=>b(null),children:X}),e.jsxs(He,{value:j,onChange:(t,a)=>Fe(a),sx:{borderBottom:1,borderColor:"divider",mb:3},children:[e.jsx(je,{label:`Active Projects (${L.length})`}),e.jsx(je,{label:`Archived (${_.length})`})]}),e.jsxs(x,{children:[Q?e.jsx(x,{sx:{textAlign:"center",py:4},children:e.jsx(g,{children:"Loading projects..."})}):e.jsx(fe,{container:!0,spacing:3,children:(j===0?L:_).map(t=>e.jsx(fe,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(Oe,{sx:{height:"100%",display:"flex",flexDirection:"column",transition:"all 0.2s ease","&:hover":{transform:"translateY(-2px)",boxShadow:a=>a.shadows[4]}},children:[e.jsxs(Je,{sx:{flexGrow:1},children:[e.jsxs(x,{sx:{display:"flex",alignItems:"center",mb:2},children:[J(t.applicationMode),e.jsx(g,{variant:"h6",component:"h3",sx:{ml:1,flexGrow:1},children:t.name}),e.jsx(Ke,{size:"small",onClick:()=>I(t),children:e.jsx(Qe,{})})]}),t.description&&e.jsx(g,{variant:"body2",color:"text.secondary",paragraph:!0,children:t.description}),e.jsxs(x,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:[e.jsx(w,{size:"small",icon:J(t.applicationMode),label:t.applicationMode==="standalone"?"Standalone":"Network",color:"primary",variant:"outlined"}),e.jsx(w,{size:"small",icon:pe(t.storageBackend),label:t.storageBackend,variant:"outlined"}),typeof oe[t.id]=="number"&&e.jsx(w,{size:"small",label:`Datasets: ${oe[t.id]}`,variant:"outlined"}),e.jsx(w,{size:"small",label:`Launch: ${(_e[t.id]||"web")==="desktop"?"Desktop":"Web"}`,variant:"outlined"}),t.allowCollaboration&&e.jsx(w,{size:"small",label:`${t.maxCollaborators} users`,variant:"outlined"})]}),e.jsxs(g,{variant:"caption",color:"text.secondary",children:["Last accessed: ",Re(t.lastAccessedAt)]})]}),e.jsxs(x,{sx:{p:2,pt:0,display:"flex",gap:1},children:[e.jsx(h,{fullWidth:!0,variant:"contained",startIcon:e.jsx(Ve,{}),onClick:a=>Ge(a,t),disabled:!t.isActive,children:t.isActive?"Launch":"Archived"}),e.jsx(h,{fullWidth:!0,variant:"outlined",color:t.isActive?"warning":"success",onClick:async()=>{try{t.isActive?await d.archiveProject(t.id):await d.restoreProject(t.id),await $()}catch(a){console.error("Failed to toggle archive",a),b("Failed to update project")}},children:t.isActive?"Archive":"Restore"})]})]})},t.id))}),!Q&&(j===0?L:_).length===0&&e.jsxs(x,{sx:{textAlign:"center",py:8},children:[e.jsx(be,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(g,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:j===0?"No active projects yet":"No archived projects"}),e.jsx(g,{variant:"body2",color:"text.secondary",paragraph:!0,children:j===0?"Create your first cloud project to get started with Firebase and GCS integration":"Archived projects will appear here"}),j===0&&e.jsx(h,{variant:"contained",startIcon:e.jsx(me,{}),onClick:ge,size:"large",children:"Create Your First Project"})]})]}),e.jsx(at,{open:Be,onClose:()=>E(!1),mode:"shared_network",onSuccess:Ne,onCreate:async t=>{var s,r;try{const i=localStorage.getItem("auth_token");i&&((r=(s=window.cloudProjectIntegration)==null?void 0:s.setAuthToken)==null||r.call(s,i))}catch{}return await d.createCloudProject(t)}}),e.jsxs(ye,{open:!!n,onClose:()=>I(null),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ve,{children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Xe,{}),"Project Details"]})}),e.jsxs(Ce,{children:[n&&e.jsxs(ke,{children:[e.jsxs(S,{children:[e.jsx(W,{children:J(n.applicationMode)}),e.jsx(D,{primary:"Mode",secondary:n.applicationMode==="standalone"?"Standalone":"Network"})]}),e.jsxs(S,{children:[e.jsx(W,{children:pe(n.storageBackend)}),e.jsx(D,{primary:"Storage Backend",secondary:n.storageBackend})]}),n.gcsBucket&&e.jsxs(S,{children:[e.jsx(W,{children:e.jsx(we,{})}),e.jsx(D,{primary:"GCS Bucket",secondary:n.gcsBucket})]}),n.allowCollaboration&&e.jsxs(S,{children:[e.jsx(W,{children:e.jsx(Se,{})}),e.jsx(D,{primary:"Collaboration",secondary:`Up to ${n.maxCollaborators} users`})]})]}),n&&e.jsxs(x,{sx:{mt:2},children:[e.jsx(g,{variant:"subtitle1",sx:{mb:1},children:"Assigned Datasets"}),e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1,mb:1,flexWrap:"wrap"},children:[e.jsx("input",{id:"project-file-upload",type:"file",className:nt.hiddenFileInput,onChange:async t=>{var s;const a=(s=t.target.files)==null?void 0:s[0];if(!(!a||!n)){ce(null),le(!0),q(0);try{await d.uploadFileViaSignedUrl(n.id,a,{targetPath:n.gcsPrefix||`projects/${n.id}`,onProgress:r=>q(r)})}catch(r){const i=r instanceof Error?r.message:"Upload failed";ce(i)}finally{le(!1),setTimeout(()=>q(0),800)}}}}),e.jsx("label",{htmlFor:"project-file-upload",children:e.jsx(h,{component:"span",size:"small",variant:"outlined",disabled:re,children:re?`Uploadingâ€¦ ${Me}%`:"Upload File"})}),ie&&e.jsx(g,{variant:"caption",color:"error",children:ie})]}),e.jsx(h,{size:"small",variant:"outlined",onClick:async()=>{if(n)try{v(!0);const t=await d.getProjectDatasets(n.id);y(t);const s=(await d.listDatasets({backend:p==="all"?void 0:p,query:A||void 0})).map(r=>{var i;return{...r,__label:`${r.name} ${((i=r.storage)==null?void 0:i.backend)==="gcs"?"(GCS)":"(Firestore)"}`}});F(s)}catch(t){console.error("Failed to load datasets",t)}finally{v(!1)}},sx:{mb:1},children:Ae?"Loading...":"Refresh"}),e.jsx(h,{size:"small",variant:"contained",color:"primary",onClick:()=>{H(null),C(!0)},sx:{mb:1,ml:1},children:"New Dataset"}),e.jsxs(x,{sx:{display:"flex",gap:1,alignItems:"center",mb:1,flexWrap:"wrap"},children:[e.jsx("label",{htmlFor:"dataset-backend",className:"visually-hidden",children:"Backend"}),e.jsxs("select",{id:"dataset-backend","aria-label":"Backend filter",value:p,onChange:t=>te(t.target.value),children:[e.jsx("option",{value:"all",children:"All backends"}),e.jsx("option",{value:"firestore",children:"Firestore"}),e.jsx("option",{value:"gcs",children:"GCS"})]}),e.jsx("input",{type:"text",placeholder:"Search datasetsâ€¦",value:A,onChange:t=>Le(t.target.value),"aria-label":"Search datasets",className:"dataset-search-input"}),e.jsx("label",{htmlFor:"dataset-select",className:"visually-hidden",children:"Select dataset"}),e.jsxs("select",{id:"dataset-select","aria-label":"Select dataset",value:B,onChange:t=>ee(t.target.value),className:"dataset-select-input",children:[e.jsx("option",{value:"",children:"Select datasetâ€¦"}),$e.map(t=>e.jsx("option",{value:t.id,children:t.__label||t.name},t.id))]}),e.jsx(h,{size:"small",variant:"contained",disabled:!B,onClick:async()=>{if(!(!n||!B))try{await d.assignDatasetToProject(n.id,B);const t=await d.getProjectDatasets(n.id);y(t),ee("")}catch(t){console.error("Failed to assign dataset",t)}},children:"Assign"}),e.jsx(h,{size:"small",variant:"outlined",onClick:async()=>{if(n)try{v(!0);const t=await d.getProjectDatasets(n.id);y(t);const s=(await d.listDatasets({backend:p==="all"?void 0:p,query:A||void 0})).map(r=>{var i;return{...r,__label:`${r.name} ${((i=r.storage)==null?void 0:i.backend)==="gcs"?"(GCS)":"(Firestore)"}`}});F(s)}catch(t){console.error("Failed to load datasets",t)}finally{v(!1)}},children:"Apply Filters"})]}),Z.length===0?e.jsx(g,{variant:"body2",color:"text.secondary",children:"No datasets assigned"}):e.jsx(ke,{children:Z.map(t=>e.jsx(S,{secondaryAction:e.jsx(h,{size:"small",color:"error",onClick:async()=>{try{await d.unassignDatasetFromProject(n.id,t.id),y(a=>a.filter(s=>s.id!==t.id)),N(a=>({...a,[n.id]:Math.max(0,(a[n.id]||1)-1)}))}catch(a){console.error("Failed to unassign dataset",a)}},children:"Remove"}),children:e.jsx(D,{primary:t.name,secondary:t.description})},t.id))})]})]}),e.jsxs(De,{children:[e.jsx(h,{onClick:()=>I(null),children:"Close"}),n&&e.jsx(h,{variant:"contained",onClick:()=>{xe(n),I(null)},children:"Launch Project"})]})]}),e.jsxs(ye,{open:We,onClose:()=>C(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ve,{children:"Create Dataset"}),e.jsxs(Ce,{children:[ue&&e.jsx(K,{severity:"error",sx:{mb:2},children:ue}),e.jsxs(x,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[e.jsx(P,{label:"Name",value:c.name,onChange:t=>f({...c,name:t.target.value}),required:!0,fullWidth:!0}),e.jsx(P,{label:"Description",value:c.description,onChange:t=>f({...c,description:t.target.value}),multiline:!0,minRows:2,fullWidth:!0}),e.jsxs(P,{select:!0,label:"Storage Backend",value:c.backend,onChange:t=>f({...c,backend:t.target.value}),fullWidth:!0,children:[e.jsx(z,{value:"firestore",children:"Firestore"}),e.jsx(z,{value:"gcs",children:"Google Cloud Storage (GCS)"})]}),c.backend==="gcs"&&e.jsxs(e.Fragment,{children:[e.jsx(P,{label:"GCS Bucket",placeholder:"my-bucket",value:c.gcsBucket,onChange:t=>f({...c,gcsBucket:t.target.value}),fullWidth:!0}),e.jsx(P,{label:"GCS Prefix (optional)",placeholder:"datasets/project-123/",value:c.gcsPrefix,onChange:t=>f({...c,gcsPrefix:t.target.value}),fullWidth:!0})]}),e.jsx(Ze,{control:e.jsx(et,{checked:he,onChange:(t,a)=>ze(a)}),label:"Assign to this project after creation"})]})]}),e.jsxs(De,{children:[e.jsx(h,{onClick:()=>C(!1),disabled:Y,children:"Cancel"}),e.jsx(h,{variant:"contained",disabled:Y||!c.name.trim(),onClick:async()=>{if(!n){C(!1);return}H(null),de(!0);try{const t={backend:c.backend};c.backend==="gcs"&&(c.gcsBucket&&(t.gcsBucket=c.gcsBucket),c.gcsPrefix&&(t.gcsPrefix=c.gcsPrefix));const a=await d.createDataset({name:c.name.trim(),description:c.description.trim()||void 0,visibility:"private",organizationId:null,tags:[],schema:{},storage:t});he&&await d.assignDatasetToProject(n.id,a.id);const s=await d.getProjectDatasets(n.id);y(s),N(l=>({...l,[n.id]:s.length}));const r=p==="all"?n.storageBackend:p,m=(await d.listDatasets({backend:r})).map(l=>{var k;return{...l,__label:`${l.name} ${((k=l.storage)==null?void 0:k.backend)==="gcs"?"(GCS)":"(Firestore)"}`}});F(m),C(!1),f(l=>({...l,name:"",description:""}))}catch(t){H((t==null?void 0:t.message)||"Failed to create dataset")}finally{de(!1)}},children:Y?"Creatingâ€¦":"Create Dataset"})]})]}),e.jsxs(tt,{anchorEl:ae,open:!!ae,onClose:O,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:[e.jsx(z,{onClick:Ue,children:"Launch (Web)"}),e.jsx(z,{onClick:Ee,children:"Launch (Desktop)"})]})]})};export{xt as DashboardCloudProjectsBridge,xt as default};
