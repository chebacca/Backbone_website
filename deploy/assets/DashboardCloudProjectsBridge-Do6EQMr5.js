import{j as t,b as Ee,a as g,T as m,d as u,az as ue,t as J,aA as Ne,aB as xe,G as ge,k as Ue,l as Re,I as qe,ak as Ye,h as w,aC as He,Z as me,aD as je,aE as pe,aF as Oe,aG as fe,U as be,W as S,X as W,Y as D,aH as ye,aI as ve,aJ as Ce,u as P,a4 as z,F as Je,Q as Ke,aj as Qe,aK as ke}from"./mui-T5zcPaKR.js";import{r as o}from"./vendor-OeuszDaU.js";import{cloudProjectIntegration as c}from"./CloudProjectIntegration-COpxgpLl.js";import{U as Xe,s as G}from"./UnifiedProjectCreationDialog-CbzPKvdd.js";import"./index-TWce8Qxd.js";import"./stripe-Bd-xCkZF.js";import"./proxy-Bigtmpzy.js";const lt=({onProjectLaunch:T})=>{const[E,we]=o.useState([]),[K,Q]=o.useState(!0),[X,y]=o.useState(null),[f,Se]=o.useState(0),[De,N]=o.useState(!1),[Ze,Ve]=o.useState(!1),[n,I]=o.useState(null),[Z,v]=o.useState([]),[Pe,C]=o.useState(!1),[Ie,F]=o.useState([]),[B,V]=o.useState(""),[j,ee]=o.useState("all"),[A,Fe]=o.useState(""),[te,ae]=o.useState(null),[x,se]=o.useState(null),[ne,U]=o.useState({}),[Be,R]=o.useState({}),[Ae,k]=o.useState(!1),[q,oe]=o.useState(!1),[re,Y]=o.useState(null),[le,Le]=o.useState(!0),[r,b]=o.useState({name:"",description:"",backend:"firestore",gcsBucket:"",gcsPrefix:""}),$e=async e=>{try{C(!0);const a=await c.getProjectDatasets(e.id);v(a),U(p=>({...p,[e.id]:a.length}));const s=j==="all"?e.storageBackend:j;j==="all"&&ee(s);const i=(await c.listDatasets({backend:s,query:A||void 0})).map(p=>{var h;return{...p,__label:`${p.name} ${((h=p.storage)==null?void 0:h.backend)==="gcs"?"(GCS)":"(Firestore)"}`}});F(i)}catch(a){console.error("Failed to load datasets for project",a)}finally{C(!1)}};o.useEffect(()=>{n&&($e(n),b(e=>({...e,backend:n.storageBackend||"firestore",gcsBucket:n.gcsBucket||"",gcsPrefix:n.gcsPrefix||""})))},[n]),o.useEffect(()=>{L();const e=a=>{L()};return window.addEventListener("project:created",e),()=>window.removeEventListener("project:created",e)},[]);const L=async()=>{try{y(null),Q(!0);const e=await c.getUserProjects();we(e);const a={};for(const s of e){const l=`launch_pref_${s.id}`,i=localStorage.getItem(l)||"web";a[s.id]=i}R(a)}catch(e){y((e==null?void 0:e.message)||"Failed to load projects")}finally{Q(!1)}},ie=async e=>{try{await G.selectMode(e.applicationMode,"cloud"),await G.selectProject(e.id),T==null||T(e.id)}catch(a){console.error("Failed to launch project:",a),y("Failed to launch project")}},Me=(e,a)=>{ae(e.currentTarget),se(a)},H=()=>{ae(null),se(null)},_e=async()=>{var e,a;if(x){try{localStorage.setItem(`launch_pref_${x.id}`,"web"),R(d=>({...d,[x.id]:"web"}));let s="";try{const d=(a=(e=x.settings)==null?void 0:e.preferredPorts)==null?void 0:a.website,he=localStorage.getItem("preferred_website_port"),_=he?Number(he):0,Te=["localhost","127.0.0.1"].includes(window.location.hostname);d&&d>=1024&&d<=65535?s=`http://localhost:${d}`:_&&_>=1024&&_<=65535?s=`http://localhost:${_}`:Te?s="http://localhost:3002":s=window.location.origin}catch{s=window.location.origin}s=String(s).replace(/\/$/,"");const i=/^http:\/\/localhost:\d+$/i.test(s)?"/index.html":"/",p=`${s}${i}?projectId=${encodeURIComponent(x.id)}&mode=${encodeURIComponent(x.applicationMode)}`;let h=!1;try{const d=document.createElement("a");d.href=p,d.target="_blank",d.rel="noopener noreferrer",document.body.appendChild(d),d.click(),document.body.removeChild(d),h=!0}catch{}h||(window.location.href=p),(async()=>{try{await G.selectMode(x.applicationMode,"cloud"),await G.selectProject(x.id)}catch{}})()}catch{}H()}},We=()=>{if(x)try{localStorage.setItem(`launch_pref_${x.id}`,"desktop"),R(l=>({...l,[x.id]:"desktop"}));const s=`dashboardv14://open-project?id=${encodeURIComponent(x.id)}`;window.location.href=s}catch(e){console.error("Failed to open desktop deep link",e),y("Unable to open Desktop app. Please ensure it is installed.")}finally{H()}},ce=()=>{N(!0)},ze=async e=>{N(!1),await L(),setTimeout(()=>{const a=(f===0?$:M).find(s=>s.id===e)||E.find(s=>s.id===e);a&&ie(a)},0)},de=e=>{switch(e){case"firestore":return t.jsx(me,{});case"gcs":return t.jsx(ye,{});default:return t.jsx(ke,{})}},O=e=>e==="standalone"?t.jsx(ke,{}):t.jsx(ve,{}),Ge=e=>{const a=new Date(e),l=new Date().getTime()-a.getTime(),i=Math.floor(l/(1e3*60*60*24));return i===0?"Today":i===1?"Yesterday":i<7?`${i} days ago`:a.toLocaleDateString()},$=E.filter(e=>e.isActive),M=E.filter(e=>!e.isActive);return t.jsxs(Ee,{maxWidth:"lg",sx:{py:4},children:[t.jsxs(g,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[t.jsxs(g,{children:[t.jsx(m,{variant:"h4",component:"h1",fontWeight:"bold",gutterBottom:!0,children:"Cloud Projects"}),t.jsx(m,{variant:"body1",color:"text.secondary",children:"Manage your projects with Firebase and Google Cloud Storage integration"})]}),t.jsx(u,{variant:"contained",startIcon:t.jsx(ue,{}),onClick:ce,size:"large",children:"Create Project"})]}),t.jsx(J,{severity:"info",sx:{mb:3},children:t.jsxs(m,{variant:"body2",children:[t.jsx("strong",{children:"Integrated Startup System:"})," Projects created here will automatically integrate with the unified startup flow and support both standalone and network modes with Firebase/GCS storage options."]})}),X&&t.jsx(J,{severity:"error",sx:{mb:3},onClose:()=>y(null),children:X}),t.jsxs(Ne,{value:f,onChange:(e,a)=>Se(a),sx:{borderBottom:1,borderColor:"divider",mb:3},children:[t.jsx(xe,{label:`Active Projects (${$.length})`}),t.jsx(xe,{label:`Archived (${M.length})`})]}),t.jsxs(g,{children:[K?t.jsx(g,{sx:{textAlign:"center",py:4},children:t.jsx(m,{children:"Loading projects..."})}):t.jsx(ge,{container:!0,spacing:3,children:(f===0?$:M).map(e=>t.jsx(ge,{item:!0,xs:12,sm:6,md:4,children:t.jsxs(Ue,{sx:{height:"100%",display:"flex",flexDirection:"column",transition:"all 0.2s ease","&:hover":{transform:"translateY(-2px)",boxShadow:a=>a.shadows[4]}},children:[t.jsxs(Re,{sx:{flexGrow:1},children:[t.jsxs(g,{sx:{display:"flex",alignItems:"center",mb:2},children:[O(e.applicationMode),t.jsx(m,{variant:"h6",component:"h3",sx:{ml:1,flexGrow:1},children:e.name}),t.jsx(qe,{size:"small",onClick:()=>I(e),children:t.jsx(Ye,{})})]}),e.description&&t.jsx(m,{variant:"body2",color:"text.secondary",paragraph:!0,children:e.description}),t.jsxs(g,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:[t.jsx(w,{size:"small",icon:O(e.applicationMode),label:e.applicationMode==="standalone"?"Standalone":"Network",color:"primary",variant:"outlined"}),t.jsx(w,{size:"small",icon:de(e.storageBackend),label:e.storageBackend,variant:"outlined"}),typeof ne[e.id]=="number"&&t.jsx(w,{size:"small",label:`Datasets: ${ne[e.id]}`,variant:"outlined"}),t.jsx(w,{size:"small",label:`Launch: ${(Be[e.id]||"web")==="desktop"?"Desktop":"Web"}`,variant:"outlined"}),e.allowCollaboration&&t.jsx(w,{size:"small",label:`${e.maxCollaborators} users`,variant:"outlined"})]}),t.jsxs(m,{variant:"caption",color:"text.secondary",children:["Last accessed: ",Ge(e.lastAccessedAt)]})]}),t.jsxs(g,{sx:{p:2,pt:0,display:"flex",gap:1},children:[t.jsx(u,{fullWidth:!0,variant:"contained",startIcon:t.jsx(He,{}),onClick:a=>Me(a,e),disabled:!e.isActive,children:e.isActive?"Launch":"Archived"}),t.jsx(u,{fullWidth:!0,variant:"outlined",color:e.isActive?"warning":"success",onClick:async()=>{try{e.isActive?await c.archiveProject(e.id):await c.restoreProject(e.id),await L()}catch(a){console.error("Failed to toggle archive",a),y("Failed to update project")}},children:e.isActive?"Archive":"Restore"})]})]})},e.id))}),!K&&(f===0?$:M).length===0&&t.jsxs(g,{sx:{textAlign:"center",py:8},children:[t.jsx(me,{sx:{fontSize:64,color:"text.secondary",mb:2}}),t.jsx(m,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:f===0?"No active projects yet":"No archived projects"}),t.jsx(m,{variant:"body2",color:"text.secondary",paragraph:!0,children:f===0?"Create your first cloud project to get started with Firebase and GCS integration":"Archived projects will appear here"}),f===0&&t.jsx(u,{variant:"contained",startIcon:t.jsx(ue,{}),onClick:ce,size:"large",children:"Create Your First Project"})]})]}),t.jsx(Xe,{open:De,onClose:()=>N(!1),mode:"shared_network",onSuccess:ze,onCreate:async e=>{var s,l;try{const i=localStorage.getItem("auth_token");i&&((l=(s=window.cloudProjectIntegration)==null?void 0:s.setAuthToken)==null||l.call(s,i))}catch{}return await c.createCloudProject(e)}}),t.jsxs(je,{open:!!n,onClose:()=>I(null),maxWidth:"sm",fullWidth:!0,children:[t.jsx(pe,{children:t.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(Oe,{}),"Project Details"]})}),t.jsxs(fe,{children:[n&&t.jsxs(be,{children:[t.jsxs(S,{children:[t.jsx(W,{children:O(n.applicationMode)}),t.jsx(D,{primary:"Mode",secondary:n.applicationMode==="standalone"?"Standalone":"Network"})]}),t.jsxs(S,{children:[t.jsx(W,{children:de(n.storageBackend)}),t.jsx(D,{primary:"Storage Backend",secondary:n.storageBackend})]}),n.gcsBucket&&t.jsxs(S,{children:[t.jsx(W,{children:t.jsx(ye,{})}),t.jsx(D,{primary:"GCS Bucket",secondary:n.gcsBucket})]}),n.allowCollaboration&&t.jsxs(S,{children:[t.jsx(W,{children:t.jsx(ve,{})}),t.jsx(D,{primary:"Collaboration",secondary:`Up to ${n.maxCollaborators} users`})]})]}),n&&t.jsxs(g,{sx:{mt:2},children:[t.jsx(m,{variant:"subtitle1",sx:{mb:1},children:"Assigned Datasets"}),t.jsx(u,{size:"small",variant:"outlined",onClick:async()=>{if(n)try{C(!0);const e=await c.getProjectDatasets(n.id);v(e);const s=(await c.listDatasets({backend:j==="all"?void 0:j,query:A||void 0})).map(l=>{var i;return{...l,__label:`${l.name} ${((i=l.storage)==null?void 0:i.backend)==="gcs"?"(GCS)":"(Firestore)"}`}});F(s)}catch(e){console.error("Failed to load datasets",e)}finally{C(!1)}},sx:{mb:1},children:Pe?"Loading...":"Refresh"}),t.jsx(u,{size:"small",variant:"contained",color:"primary",onClick:()=>{Y(null),k(!0)},sx:{mb:1,ml:1},children:"New Dataset"}),t.jsxs(g,{sx:{display:"flex",gap:1,alignItems:"center",mb:1,flexWrap:"wrap"},children:[t.jsx("label",{htmlFor:"dataset-backend",className:"visually-hidden",children:"Backend"}),t.jsxs("select",{id:"dataset-backend","aria-label":"Backend filter",value:j,onChange:e=>ee(e.target.value),children:[t.jsx("option",{value:"all",children:"All backends"}),t.jsx("option",{value:"firestore",children:"Firestore"}),t.jsx("option",{value:"gcs",children:"GCS"})]}),t.jsx("input",{type:"text",placeholder:"Search datasets…",value:A,onChange:e=>Fe(e.target.value),"aria-label":"Search datasets",className:"dataset-search-input"}),t.jsx("label",{htmlFor:"dataset-select",className:"visually-hidden",children:"Select dataset"}),t.jsxs("select",{id:"dataset-select","aria-label":"Select dataset",value:B,onChange:e=>V(e.target.value),className:"dataset-select-input",children:[t.jsx("option",{value:"",children:"Select dataset…"}),Ie.map(e=>t.jsx("option",{value:e.id,children:e.__label||e.name},e.id))]}),t.jsx(u,{size:"small",variant:"contained",disabled:!B,onClick:async()=>{if(!(!n||!B))try{await c.assignDatasetToProject(n.id,B);const e=await c.getProjectDatasets(n.id);v(e),V("")}catch(e){console.error("Failed to assign dataset",e)}},children:"Assign"}),t.jsx(u,{size:"small",variant:"outlined",onClick:async()=>{if(n)try{C(!0);const e=await c.getProjectDatasets(n.id);v(e);const s=(await c.listDatasets({backend:j==="all"?void 0:j,query:A||void 0})).map(l=>{var i;return{...l,__label:`${l.name} ${((i=l.storage)==null?void 0:i.backend)==="gcs"?"(GCS)":"(Firestore)"}`}});F(s)}catch(e){console.error("Failed to load datasets",e)}finally{C(!1)}},children:"Apply Filters"})]}),Z.length===0?t.jsx(m,{variant:"body2",color:"text.secondary",children:"No datasets assigned"}):t.jsx(be,{children:Z.map(e=>t.jsx(S,{secondaryAction:t.jsx(u,{size:"small",color:"error",onClick:async()=>{try{await c.unassignDatasetFromProject(n.id,e.id),v(a=>a.filter(s=>s.id!==e.id)),U(a=>({...a,[n.id]:Math.max(0,(a[n.id]||1)-1)}))}catch(a){console.error("Failed to unassign dataset",a)}},children:"Remove"}),children:t.jsx(D,{primary:e.name,secondary:e.description})},e.id))})]})]}),t.jsxs(Ce,{children:[t.jsx(u,{onClick:()=>I(null),children:"Close"}),n&&t.jsx(u,{variant:"contained",onClick:()=>{ie(n),I(null)},children:"Launch Project"})]})]}),t.jsxs(je,{open:Ae,onClose:()=>k(!1),maxWidth:"sm",fullWidth:!0,children:[t.jsx(pe,{children:"Create Dataset"}),t.jsxs(fe,{children:[re&&t.jsx(J,{severity:"error",sx:{mb:2},children:re}),t.jsxs(g,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[t.jsx(P,{label:"Name",value:r.name,onChange:e=>b({...r,name:e.target.value}),required:!0,fullWidth:!0}),t.jsx(P,{label:"Description",value:r.description,onChange:e=>b({...r,description:e.target.value}),multiline:!0,minRows:2,fullWidth:!0}),t.jsxs(P,{select:!0,label:"Storage Backend",value:r.backend,onChange:e=>b({...r,backend:e.target.value}),fullWidth:!0,children:[t.jsx(z,{value:"firestore",children:"Firestore"}),t.jsx(z,{value:"gcs",children:"Google Cloud Storage (GCS)"})]}),r.backend==="gcs"&&t.jsxs(t.Fragment,{children:[t.jsx(P,{label:"GCS Bucket",placeholder:"my-bucket",value:r.gcsBucket,onChange:e=>b({...r,gcsBucket:e.target.value}),fullWidth:!0}),t.jsx(P,{label:"GCS Prefix (optional)",placeholder:"datasets/project-123/",value:r.gcsPrefix,onChange:e=>b({...r,gcsPrefix:e.target.value}),fullWidth:!0})]}),t.jsx(Je,{control:t.jsx(Ke,{checked:le,onChange:(e,a)=>Le(a)}),label:"Assign to this project after creation"})]})]}),t.jsxs(Ce,{children:[t.jsx(u,{onClick:()=>k(!1),disabled:q,children:"Cancel"}),t.jsx(u,{variant:"contained",disabled:q||!r.name.trim(),onClick:async()=>{if(!n){k(!1);return}Y(null),oe(!0);try{const e={backend:r.backend};r.backend==="gcs"&&(r.gcsBucket&&(e.gcsBucket=r.gcsBucket),r.gcsPrefix&&(e.gcsPrefix=r.gcsPrefix));const a=await c.createDataset({name:r.name.trim(),description:r.description.trim()||void 0,visibility:"private",organizationId:null,tags:[],schema:{},storage:e});le&&await c.assignDatasetToProject(n.id,a.id);const s=await c.getProjectDatasets(n.id);v(s),U(h=>({...h,[n.id]:s.length}));const l=j==="all"?n.storageBackend:j,p=(await c.listDatasets({backend:l})).map(h=>{var d;return{...h,__label:`${h.name} ${((d=h.storage)==null?void 0:d.backend)==="gcs"?"(GCS)":"(Firestore)"}`}});F(p),k(!1),b(h=>({...h,name:"",description:""}))}catch(e){Y((e==null?void 0:e.message)||"Failed to create dataset")}finally{oe(!1)}},children:q?"Creating…":"Create Dataset"})]})]}),t.jsxs(Qe,{anchorEl:te,open:!!te,onClose:H,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:[t.jsx(z,{onClick:_e,children:"Launch (Web)"}),t.jsx(z,{onClick:We,children:"Launch (Desktop)"})]})]})};export{lt as DashboardCloudProjectsBridge,lt as default};
