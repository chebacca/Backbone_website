import{j as e,B as l,C as oe,T as i,d as q,ai as H,w as P,x as h,y as u,aj as ce,z as m,H as K,K as le,a as b,ak as de,al as V,am as xe,G as y,ae as J,an as T,ao as he,t as E,v as U,i as ue,q as M,D as F,aa as me,r as R,p as je,u as ge}from"./mui-D_3t3Wff.js";import{u as pe,r as j,b as be}from"./vendor-CjD1bmmO.js";import{u as ye}from"./index-CiEVUhtI.js";import{db as O}from"./firebase-BFzrvsUF.js";import{getDoc as X,doc as Z,query as _,collection as ee,where as N,orderBy as fe,limit as ve,getDocs as te}from"./index.esm-B4qVkIPL.js";import{M as B}from"./MetricCard-CmTmSA-Z.js";import{u as we,a as De}from"./useStreamlinedData-QxFDKam0.js";import"./stripe-DQqYxQf-.js";import"./index.esm-DmQE6AXN.js";import"./index.esm-DeaBpi77.js";import"./UnifiedDataService-25t_6E47.js";const f=r=>{if(!r)return null;if(r instanceof Date)return r;if(r&&typeof r=="object"&&typeof r.toDate=="function")try{return r.toDate()}catch(t){return console.warn("Failed to convert Firestore timestamp:",t),null}if(typeof r=="string")try{return new Date(r)}catch(t){return console.warn("Failed to parse date string:",t),null}if(typeof r=="number")try{return new Date(r)}catch(t){return console.warn("Failed to convert timestamp number:",t),null}return null},Re=()=>{const r=pe(),{user:t,isAuthenticated:D,isLoading:A}=ye(),{data:v}=we(),{data:k}=De(),[c,re]=j.useState(null),[g,se]=j.useState(null),[n,ae]=j.useState([]),[C,ne]=j.useState([]),[z,W]=j.useState(!0),[ie,Q]=j.useState(null);j.useEffect(()=>{console.log("ðŸ” [DashboardOverview] State Debug:",{authLoading:A,loading:z,user:t,isAuthenticated:D,currentUser:c,organization:g,projects:n,teamMembers:C})},[A,z,t,D,c,g,n,C]),j.useEffect(()=>{console.log("ðŸ” [DashboardOverview] State Debug:",{authLoading:A,loading:z,user:t,isAuthenticated:D,currentUser:c,organization:g,projects:n,teamMembers:C})},[A,z,t,D,c,g,n,C]),j.useEffect(()=>{if(!D||!t)return;(async()=>{try{W(!0),Q(null),console.log("ðŸ” [DashboardOverview] Fetching data for user:",{userId:t.id,firebaseUid:t.firebaseUid,organizationId:t.organizationId,email:t.email});const p=t.firebaseUid||t.id,I=await X(Z(O,"users",p));if(I.exists()){const a=I.data();re({id:I.id,...a,createdAt:f(a.createdAt)||new Date,updatedAt:f(a.updatedAt)||new Date})}if(t.organizationId){const a=await X(Z(O,"organizations",t.organizationId));if(a.exists()){const d=a.data();se({id:a.id,...d,createdAt:f(d.createdAt)||new Date,updatedAt:f(d.updatedAt)||new Date})}}if(t.organizationId){console.log("ðŸ” [DashboardOverview] Querying projects for organizationId:",t.organizationId);try{const a=_(ee(O,"projects"),N("organizationId","==",t.organizationId),fe("createdAt","desc"),ve(10)),d=await te(a);console.log("âœ… [DashboardOverview] Projects found:",d.size);const S=d.docs.map(x=>({id:x.id,...x.data(),createdAt:f(x.data().createdAt)||new Date,updatedAt:f(x.data().updatedAt)||new Date}));ae(S)}catch(a){throw console.error("âŒ [DashboardOverview] Error fetching projects:",a),a}}if(t.organizationId){console.log("ðŸ” [DashboardOverview] Querying team members for organizationId:",t.organizationId);try{const a=_(ee(O,"teamMembers"),N("organizationId","==",t.organizationId),N("status","==","ACTIVE")),d=await te(a);console.log("âœ… [DashboardOverview] Team members found:",d.size);const S=d.docs.map(x=>({id:x.id,...x.data(),createdAt:f(x.data().createdAt)||new Date,updatedAt:f(x.data().updatedAt)||new Date}));ne(S)}catch(a){throw console.error("âŒ [DashboardOverview] Error fetching team members:",a),a}}}catch(p){console.error("Error fetching dashboard data:",p),Q(p instanceof Error?p.message:"Failed to fetch dashboard data")}finally{W(!1)}})()},[D,t]);const s=j.useMemo(()=>{if(!c||!g)return{activeLicenses:0,totalLicenses:0,monthlyUsage:0,totalDownloads:0,currentPlan:"Unknown",daysUntilRenewal:"N/A",hasEnterpriseFeatures:!1,projectCount:0,teamMemberCount:0,licenseUtilization:0};const o=(v==null?void 0:v.length)||0,p=(v==null?void 0:v.filter(L=>L.status==="ACTIVE").length)||0,I=o>0?p/o*100:0,a=n.reduce((L,$)=>L+($.status==="ACTIVE"?100:0),0),d=n.reduce((L,$)=>L+($.status==="ACTIVE"?50:0),0),S=(k==null?void 0:k.length)||C.length,x=n.length,Y=g.tier||"BASIC";return{activeLicenses:p,totalLicenses:o,monthlyUsage:a,totalDownloads:d,currentPlan:Y,daysUntilRenewal:"30 days",hasEnterpriseFeatures:Y==="ENTERPRISE",projectCount:x,teamMemberCount:S,licenseUtilization:I}},[c,g,n,C,v,k]),w=j.useMemo(()=>{var o;return c?((o=c.role)==null?void 0:o.toLowerCase())||"member":"unknown"},[c]),G=w==="admin"||w==="owner"||w==="superadmin";return A||z?e.jsx(l,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(l,{textAlign:"center",children:[e.jsx(oe,{size:60}),e.jsx(i,{variant:"h6",sx:{mt:2},children:"Loading Dashboard Data..."}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Fetching your organization and project information"})]})}):ie?e.jsx(l,{sx:{p:3},children:e.jsxs(q,{severity:"error",children:[e.jsx(H,{children:"Unable to Load Dashboard Data"}),e.jsx(i,{variant:"body2",sx:{mb:2},children:"We encountered an issue loading your dashboard information. This could be due to:"}),e.jsxs(P,{dense:!0,children:[e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(ce,{fontSize:"small"})}),e.jsx(m,{primary:"Network connectivity issues"})]}),e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(K,{fontSize:"small"})}),e.jsx(m,{primary:"Authentication token expired"})]}),e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(le,{fontSize:"small"})}),e.jsx(m,{primary:"Firebase service temporarily unavailable"})]})]}),e.jsxs(l,{sx:{mt:2},children:[e.jsx(b,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(b,{variant:"outlined",onClick:()=>r("/dashboard/support"),children:"Contact Support"})]})]})}):!c||!g?e.jsx(l,{sx:{p:3},children:e.jsxs(q,{severity:"info",children:[e.jsx(H,{children:"Setting Up Your Dashboard"}),e.jsx(i,{variant:"body2",sx:{mb:2},children:"We're preparing your dashboard. This usually happens when:"}),e.jsxs(P,{dense:!0,children:[e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(de,{fontSize:"small"})}),e.jsx(m,{primary:"Your account is being set up for the first time"})]}),e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(V,{fontSize:"small"})}),e.jsx(m,{primary:"You're being added to an organization"})]}),e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(xe,{fontSize:"small"})}),e.jsx(m,{primary:"Data synchronization is in progress"})]})]}),e.jsxs(l,{sx:{mt:2},children:[e.jsx(b,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Refresh"}),e.jsx(b,{variant:"outlined",onClick:()=>r("/dashboard/team"),children:"Check Team Status"})]})]})}):e.jsxs(l,{sx:{flexGrow:1,p:3},children:[e.jsxs(l,{sx:{mb:4},children:[e.jsxs(i,{variant:"h4",component:"h1",gutterBottom:!0,children:["Welcome back, ",c.name||c.email]}),e.jsxs(i,{variant:"subtitle1",color:"text.secondary",children:[g.name," â€¢ ",s.currentPlan," Plan â€¢ ",w.charAt(0).toUpperCase()+w.slice(1)]})]}),e.jsxs(y,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(B,{title:"Active Licenses",value:`${s.activeLicenses}/${s.totalLicenses}`,icon:e.jsx(J,{}),color:"primary"})}),e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(B,{title:"Projects",value:s.projectCount.toString(),icon:e.jsx(T,{}),color:"success"})}),e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(B,{title:"Team Members",value:s.teamMemberCount.toString(),icon:e.jsx(V,{}),color:"secondary"})}),e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(B,{title:"Monthly Usage",value:s.monthlyUsage.toLocaleString(),icon:e.jsx(he,{}),color:"warning"})})]}),s.totalLicenses>0&&e.jsx(E,{sx:{mb:4},children:e.jsxs(U,{children:[e.jsx(i,{variant:"h6",sx:{fontWeight:600,mb:2},children:"License Utilization"}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2,mb:1},children:[e.jsx(ue,{variant:"determinate",value:s.licenseUtilization,sx:{flex:1,height:8,borderRadius:4}}),e.jsxs(i,{variant:"body2",sx:{minWidth:60},children:[s.licenseUtilization.toFixed(1),"%"]})]}),e.jsxs(i,{variant:"body2",color:"text.secondary",children:[s.activeLicenses," of ",s.totalLicenses," licenses are currently active"]})]})}),e.jsxs(y,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(y,{item:!0,xs:12,md:6,children:e.jsx(E,{children:e.jsxs(U,{children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsxs(P,{children:[e.jsxs(h,{button:!0,onClick:()=>r("/dashboard/projects"),children:[e.jsx(u,{children:e.jsx(T,{})}),e.jsx(m,{primary:"Manage Projects",secondary:`${s.projectCount} active projects`}),e.jsx(M,{})]}),e.jsx(F,{}),e.jsxs(h,{button:!0,onClick:()=>r("/dashboard/team"),children:[e.jsx(u,{children:e.jsx(V,{})}),e.jsx(m,{primary:"Team Management",secondary:`${s.teamMemberCount} team members`}),e.jsx(M,{})]}),e.jsx(F,{}),e.jsxs(h,{button:!0,onClick:()=>r("/dashboard/licenses"),children:[e.jsx(u,{children:e.jsx(J,{})}),e.jsx(m,{primary:"License Management",secondary:`${s.activeLicenses} active licenses`}),e.jsx(M,{})]}),G&&e.jsxs(e.Fragment,{children:[e.jsx(F,{}),e.jsxs(h,{button:!0,onClick:()=>r("/dashboard/billing"),children:[e.jsx(u,{children:e.jsx(me,{})}),e.jsx(m,{primary:"Billing & Subscription",secondary:`${s.currentPlan} plan â€¢ Renews ${s.daysUntilRenewal}`}),e.jsx(M,{})]})]})]})]})})}),e.jsx(y,{item:!0,xs:12,md:6,children:e.jsx(E,{children:e.jsxs(U,{children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"Account Status"}),e.jsxs(l,{sx:{mb:2},children:[e.jsx(R,{icon:e.jsx(je,{}),label:`${s.currentPlan} Plan`,color:"primary",sx:{mr:1,mb:1}}),e.jsx(R,{icon:e.jsx(K,{}),label:w.charAt(0).toUpperCase()+w.slice(1),color:"secondary",sx:{mr:1,mb:1}}),s.hasEnterpriseFeatures&&e.jsx(R,{icon:e.jsx(ge,{}),label:"Enterprise",color:"warning",sx:{mr:1,mb:1}})]}),e.jsxs(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Organization: ",g.name]}),e.jsxs(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Next renewal: ",s.daysUntilRenewal]}),e.jsxs(l,{sx:{mt:2},children:[e.jsx(b,{variant:"outlined",size:"small",onClick:()=>r("/dashboard/settings"),sx:{mr:1},children:"Account Settings"}),G&&e.jsx(b,{variant:"outlined",size:"small",onClick:()=>r("/dashboard/billing"),children:"Manage Billing"})]})]})})})]}),n&&n.length>0&&e.jsx(E,{children:e.jsxs(U,{children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"Recent Projects"}),e.jsx(P,{children:n.slice(0,5).map((o,p)=>e.jsxs(be.Fragment,{children:[e.jsxs(h,{button:!0,onClick:()=>r(`/dashboard/projects/${o.id}`),children:[e.jsx(u,{children:e.jsx(T,{})}),e.jsx(m,{primary:o.name,secondary:`Created ${new Date(o.createdAt).toLocaleDateString()}`}),e.jsx(R,{label:o.status||"ACTIVE",size:"small",color:o.status==="ACTIVE"?"success":"default"})]}),p<Math.min(n.length-1,4)&&e.jsx(F,{})]},o.id))}),n.length>5&&e.jsx(l,{sx:{mt:2,textAlign:"center"},children:e.jsxs(b,{variant:"outlined",onClick:()=>r("/dashboard/projects"),children:["View All Projects (",n.length,")"]})})]})}),n&&n.length===0&&e.jsx(E,{children:e.jsxs(U,{sx:{textAlign:"center",py:4},children:[e.jsx(T,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"h6",gutterBottom:!0,children:"No Projects Yet"}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Get started by creating your first project"}),e.jsx(b,{variant:"contained",onClick:()=>r("/dashboard/projects"),children:"Create Project"})]})})]})};export{Re as default};
