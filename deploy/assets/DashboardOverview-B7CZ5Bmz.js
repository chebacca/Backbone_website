import{j as e,B as l,C as ne,T as i,d as G,ai as Y,w as L,x as h,y as u,aj as ie,z as m,H as q,K as oe,a as b,ak as ce,al as O,am as le,G as y,ae as H,an as U,ao as de,t as S,v as E,i as xe,q as k,D as P,aa as he,r as M,p as ue,u as me}from"./mui-D_3t3Wff.js";import{u as je,r as j,b as ge}from"./vendor-CjD1bmmO.js";import{u as pe}from"./index-DuKkf7hY.js";import{db as T}from"./firebase-Dc019MtE.js";import{getDoc as K,doc as J,query as X,collection as Z,where as $,orderBy as be,limit as ye,getDocs as _}from"./index.esm-B4qVkIPL.js";import{M as F}from"./MetricCard-CmTmSA-Z.js";import"./stripe-DQqYxQf-.js";import"./index.esm-DmQE6AXN.js";import"./index.esm-DeaBpi77.js";const f=r=>{if(!r)return null;if(r instanceof Date)return r;if(r&&typeof r=="object"&&typeof r.toDate=="function")try{return r.toDate()}catch(t){return console.warn("Failed to convert Firestore timestamp:",t),null}if(typeof r=="string")try{return new Date(r)}catch(t){return console.warn("Failed to parse date string:",t),null}if(typeof r=="number")try{return new Date(r)}catch(t){return console.warn("Failed to convert timestamp number:",t),null}return null},Ue=()=>{const r=je(),{user:t,isAuthenticated:w,isLoading:C}=pe(),[o,ee]=j.useState(null),[g,te]=j.useState(null),[n,re]=j.useState([]),[D,se]=j.useState([]),[A,V]=j.useState(!0),[ae,N]=j.useState(null);j.useEffect(()=>{console.log("🔍 [DashboardOverview] State Debug:",{authLoading:C,loading:A,user:t,isAuthenticated:w,currentUser:o,organization:g,projects:n,teamMembers:D})},[C,A,t,w,o,g,n,D]),j.useEffect(()=>{console.log("🔍 [DashboardOverview] State Debug:",{authLoading:C,loading:A,user:t,isAuthenticated:w,currentUser:o,organization:g,projects:n,teamMembers:D})},[C,A,t,w,o,g,n,D]),j.useEffect(()=>{if(!w||!t)return;(async()=>{try{V(!0),N(null),console.log("🔍 [DashboardOverview] Fetching data for user:",{userId:t.id,firebaseUid:t.firebaseUid,organizationId:t.organizationId,email:t.email});const p=t.firebaseUid||t.id,z=await K(J(T,"users",p));if(z.exists()){const a=z.data();ee({id:z.id,...a,createdAt:f(a.createdAt)||new Date,updatedAt:f(a.updatedAt)||new Date})}if(t.organizationId){const a=await K(J(T,"organizations",t.organizationId));if(a.exists()){const d=a.data();te({id:a.id,...d,createdAt:f(d.createdAt)||new Date,updatedAt:f(d.updatedAt)||new Date})}}if(t.organizationId){console.log("🔍 [DashboardOverview] Querying projects for organizationId:",t.organizationId);try{const a=X(Z(T,"projects"),$("organizationId","==",t.organizationId),be("createdAt","desc"),ye(10)),d=await _(a);console.log("✅ [DashboardOverview] Projects found:",d.size);const I=d.docs.map(x=>({id:x.id,...x.data(),createdAt:f(x.data().createdAt)||new Date,updatedAt:f(x.data().updatedAt)||new Date}));re(I)}catch(a){throw console.error("❌ [DashboardOverview] Error fetching projects:",a),a}}if(t.organizationId){console.log("🔍 [DashboardOverview] Querying team members for organizationId:",t.organizationId);try{const a=X(Z(T,"teamMembers"),$("organizationId","==",t.organizationId),$("status","==","ACTIVE")),d=await _(a);console.log("✅ [DashboardOverview] Team members found:",d.size);const I=d.docs.map(x=>({id:x.id,...x.data(),createdAt:f(x.data().createdAt)||new Date,updatedAt:f(x.data().updatedAt)||new Date}));se(I)}catch(a){throw console.error("❌ [DashboardOverview] Error fetching team members:",a),a}}}catch(p){console.error("Error fetching dashboard data:",p),N(p instanceof Error?p.message:"Failed to fetch dashboard data")}finally{V(!1)}})()},[w,t]);const s=j.useMemo(()=>{if(!o||!g)return{activeLicenses:0,totalLicenses:0,monthlyUsage:0,totalDownloads:0,currentPlan:"Unknown",daysUntilRenewal:"N/A",hasEnterpriseFeatures:!1,projectCount:0,teamMemberCount:0,licenseUtilization:0};const c=o.status==="ACTIVE"?1:0,p=1,z=c/p*100,a=n.reduce((R,B)=>R+(B.status==="ACTIVE"?100:0),0),d=n.reduce((R,B)=>R+(B.status==="ACTIVE"?50:0),0),I=D.length,x=n.length,Q=g.tier||"BASIC";return{activeLicenses:c,totalLicenses:p,monthlyUsage:a,totalDownloads:d,currentPlan:Q,daysUntilRenewal:"30 days",hasEnterpriseFeatures:Q==="ENTERPRISE",projectCount:x,teamMemberCount:I,licenseUtilization:z}},[o,g,n,D]),v=j.useMemo(()=>{var c;return o?((c=o.role)==null?void 0:c.toLowerCase())||"member":"unknown"},[o]),W=v==="admin"||v==="owner"||v==="superadmin";return C||A?e.jsx(l,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(l,{textAlign:"center",children:[e.jsx(ne,{size:60}),e.jsx(i,{variant:"h6",sx:{mt:2},children:"Loading Dashboard Data..."}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"Fetching your organization and project information"})]})}):ae?e.jsx(l,{sx:{p:3},children:e.jsxs(G,{severity:"error",children:[e.jsx(Y,{children:"Unable to Load Dashboard Data"}),e.jsx(i,{variant:"body2",sx:{mb:2},children:"We encountered an issue loading your dashboard information. This could be due to:"}),e.jsxs(L,{dense:!0,children:[e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(ie,{fontSize:"small"})}),e.jsx(m,{primary:"Network connectivity issues"})]}),e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(q,{fontSize:"small"})}),e.jsx(m,{primary:"Authentication token expired"})]}),e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(oe,{fontSize:"small"})}),e.jsx(m,{primary:"Firebase service temporarily unavailable"})]})]}),e.jsxs(l,{sx:{mt:2},children:[e.jsx(b,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(b,{variant:"outlined",onClick:()=>r("/dashboard/support"),children:"Contact Support"})]})]})}):!o||!g?e.jsx(l,{sx:{p:3},children:e.jsxs(G,{severity:"info",children:[e.jsx(Y,{children:"Setting Up Your Dashboard"}),e.jsx(i,{variant:"body2",sx:{mb:2},children:"We're preparing your dashboard. This usually happens when:"}),e.jsxs(L,{dense:!0,children:[e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(ce,{fontSize:"small"})}),e.jsx(m,{primary:"Your account is being set up for the first time"})]}),e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(O,{fontSize:"small"})}),e.jsx(m,{primary:"You're being added to an organization"})]}),e.jsxs(h,{children:[e.jsx(u,{children:e.jsx(le,{fontSize:"small"})}),e.jsx(m,{primary:"Data synchronization is in progress"})]})]}),e.jsxs(l,{sx:{mt:2},children:[e.jsx(b,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Refresh"}),e.jsx(b,{variant:"outlined",onClick:()=>r("/dashboard/team"),children:"Check Team Status"})]})]})}):e.jsxs(l,{sx:{flexGrow:1,p:3},children:[e.jsxs(l,{sx:{mb:4},children:[e.jsxs(i,{variant:"h4",component:"h1",gutterBottom:!0,children:["Welcome back, ",o.name||o.email]}),e.jsxs(i,{variant:"subtitle1",color:"text.secondary",children:[g.name," • ",s.currentPlan," Plan • ",v.charAt(0).toUpperCase()+v.slice(1)]})]}),e.jsxs(y,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Active Licenses",value:`${s.activeLicenses}/${s.totalLicenses}`,icon:e.jsx(H,{}),color:"primary"})}),e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Projects",value:s.projectCount.toString(),icon:e.jsx(U,{}),color:"success"})}),e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Team Members",value:s.teamMemberCount.toString(),icon:e.jsx(O,{}),color:"secondary"})}),e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Monthly Usage",value:s.monthlyUsage.toLocaleString(),icon:e.jsx(de,{}),color:"warning"})})]}),s.totalLicenses>0&&e.jsx(S,{sx:{mb:4},children:e.jsxs(E,{children:[e.jsx(i,{variant:"h6",sx:{fontWeight:600,mb:2},children:"License Utilization"}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2,mb:1},children:[e.jsx(xe,{variant:"determinate",value:s.licenseUtilization,sx:{flex:1,height:8,borderRadius:4}}),e.jsxs(i,{variant:"body2",sx:{minWidth:60},children:[s.licenseUtilization.toFixed(1),"%"]})]}),e.jsxs(i,{variant:"body2",color:"text.secondary",children:[s.activeLicenses," of ",s.totalLicenses," licenses are currently active"]})]})}),e.jsxs(y,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(y,{item:!0,xs:12,md:6,children:e.jsx(S,{children:e.jsxs(E,{children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsxs(L,{children:[e.jsxs(h,{button:!0,onClick:()=>r("/dashboard/projects"),children:[e.jsx(u,{children:e.jsx(U,{})}),e.jsx(m,{primary:"Manage Projects",secondary:`${s.projectCount} active projects`}),e.jsx(k,{})]}),e.jsx(P,{}),e.jsxs(h,{button:!0,onClick:()=>r("/dashboard/team"),children:[e.jsx(u,{children:e.jsx(O,{})}),e.jsx(m,{primary:"Team Management",secondary:`${s.teamMemberCount} team members`}),e.jsx(k,{})]}),e.jsx(P,{}),e.jsxs(h,{button:!0,onClick:()=>r("/dashboard/licenses"),children:[e.jsx(u,{children:e.jsx(H,{})}),e.jsx(m,{primary:"License Management",secondary:`${s.activeLicenses} active licenses`}),e.jsx(k,{})]}),W&&e.jsxs(e.Fragment,{children:[e.jsx(P,{}),e.jsxs(h,{button:!0,onClick:()=>r("/dashboard/billing"),children:[e.jsx(u,{children:e.jsx(he,{})}),e.jsx(m,{primary:"Billing & Subscription",secondary:`${s.currentPlan} plan • Renews ${s.daysUntilRenewal}`}),e.jsx(k,{})]})]})]})]})})}),e.jsx(y,{item:!0,xs:12,md:6,children:e.jsx(S,{children:e.jsxs(E,{children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"Account Status"}),e.jsxs(l,{sx:{mb:2},children:[e.jsx(M,{icon:e.jsx(ue,{}),label:`${s.currentPlan} Plan`,color:"primary",sx:{mr:1,mb:1}}),e.jsx(M,{icon:e.jsx(q,{}),label:v.charAt(0).toUpperCase()+v.slice(1),color:"secondary",sx:{mr:1,mb:1}}),s.hasEnterpriseFeatures&&e.jsx(M,{icon:e.jsx(me,{}),label:"Enterprise",color:"warning",sx:{mr:1,mb:1}})]}),e.jsxs(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Organization: ",g.name]}),e.jsxs(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Next renewal: ",s.daysUntilRenewal]}),e.jsxs(l,{sx:{mt:2},children:[e.jsx(b,{variant:"outlined",size:"small",onClick:()=>r("/dashboard/settings"),sx:{mr:1},children:"Account Settings"}),W&&e.jsx(b,{variant:"outlined",size:"small",onClick:()=>r("/dashboard/billing"),children:"Manage Billing"})]})]})})})]}),n&&n.length>0&&e.jsx(S,{children:e.jsxs(E,{children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"Recent Projects"}),e.jsx(L,{children:n.slice(0,5).map((c,p)=>e.jsxs(ge.Fragment,{children:[e.jsxs(h,{button:!0,onClick:()=>r(`/dashboard/projects/${c.id}`),children:[e.jsx(u,{children:e.jsx(U,{})}),e.jsx(m,{primary:c.name,secondary:`Created ${new Date(c.createdAt).toLocaleDateString()}`}),e.jsx(M,{label:c.status||"ACTIVE",size:"small",color:c.status==="ACTIVE"?"success":"default"})]}),p<Math.min(n.length-1,4)&&e.jsx(P,{})]},c.id))}),n.length>5&&e.jsx(l,{sx:{mt:2,textAlign:"center"},children:e.jsxs(b,{variant:"outlined",onClick:()=>r("/dashboard/projects"),children:["View All Projects (",n.length,")"]})})]})}),n&&n.length===0&&e.jsx(S,{children:e.jsxs(E,{sx:{textAlign:"center",py:4},children:[e.jsx(U,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(i,{variant:"h6",gutterBottom:!0,children:"No Projects Yet"}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Get started by creating your first project"}),e.jsx(b,{variant:"contained",onClick:()=>r("/dashboard/projects"),children:"Create Project"})]})})]})};export{Ue as default};
