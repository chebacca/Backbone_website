import{j as e,B as c,C as oe,T as a,d as Y,ai as Q,w as L,x,y as h,aj as ce,z as m,H as q,K as le,a as g,ak as de,al as R,am as xe,G as b,ae as H,an as E,ao as he,t as z,v as S,i as me,q as U,D as k,aa as ue,r as P,p as je,u as pe}from"./mui-DuSXeEGQ.js";import{u as ge,r as j,b as be}from"./vendor-CjD1bmmO.js";import{u as ye}from"./index-CwrsPnRz.js";import{db as T}from"./firebase-g7qJxKvU.js";import{getDoc as K,doc as J,query as X,collection as Z,where as B,orderBy as fe,limit as we,getDocs as _}from"./index.esm-C6E5jVjx.js";import{M}from"./MetricCard-vu4kpPQz.js";import{u as ve,a as Ce}from"./useStreamlinedData-Chl_Qy6d.js";import"./stripe-C4BKHrkR.js";import"./index.esm--uL3Qa3r.js";import"./index.esm-K73FumZQ.js";import"./UnifiedDataService-DIHO4s3D.js";import"./FirestoreCollectionManager-BCRhXiWU.js";const y=t=>{if(!t)return null;if(t instanceof Date)return t;if(t&&typeof t=="object"&&typeof t.toDate=="function")try{return t.toDate()}catch(n){return console.warn("Failed to convert Firestore timestamp:",n),null}if(typeof t=="string")try{return new Date(t)}catch(n){return console.warn("Failed to parse date string:",n),null}if(typeof t=="number")try{return new Date(t)}catch(n){return console.warn("Failed to convert timestamp number:",n),null}return null},Be=()=>{const t=ge(),{user:n,isAuthenticated:$,isLoading:ee}=ye(),{data:f}=ve(),{data:I}=Ce(),[p,te]=j.useState(null),[v,se]=j.useState(null),[o,re]=j.useState([]),[O,ne]=j.useState([]),[ae,V]=j.useState(!0),[ie,N]=j.useState(null);j.useEffect(()=>{if(!$||!n)return;(async()=>{try{V(!0),N(null);const u=n.firebaseUid||n.id,C=await K(J(T,"users",u));if(C.exists()){const r=C.data();te({id:C.id,...r,createdAt:y(r.createdAt)||new Date,updatedAt:y(r.updatedAt)||new Date})}if(n.organizationId){const r=await K(J(T,"organizations",n.organizationId));if(r.exists()){const l=r.data();se({id:r.id,...l,createdAt:y(l.createdAt)||new Date,updatedAt:y(l.updatedAt)||new Date})}}if(n.organizationId)try{const r=X(Z(T,"projects"),B("organizationId","==",n.organizationId),fe("createdAt","desc"),we(10)),l=await _(r);console.log("✅ [DashboardOverview] Projects found:",l.size);const A=l.docs.map(d=>({id:d.id,...d.data(),createdAt:y(d.data().createdAt)||new Date,updatedAt:y(d.data().updatedAt)||new Date}));re(A)}catch(r){throw console.error("❌ [DashboardOverview] Error fetching projects:",r),r}if(n.organizationId)try{const r=X(Z(T,"teamMembers"),B("organizationId","==",n.organizationId),B("status","==","ACTIVE")),l=await _(r);console.log("✅ [DashboardOverview] Team members found:",l.size);const A=l.docs.map(d=>({id:d.id,...d.data(),createdAt:y(d.data().createdAt)||new Date,updatedAt:y(d.data().updatedAt)||new Date}));ne(A)}catch(r){throw console.error("❌ [DashboardOverview] Error fetching team members:",r),r}}catch(u){console.error("Error fetching dashboard data:",u),N(u instanceof Error?u.message:"Failed to fetch dashboard data")}finally{V(!1)}})()},[$,n]);const s=j.useMemo(()=>{if(!p||!v)return{activeLicenses:0,totalLicenses:0,monthlyUsage:0,totalDownloads:0,currentPlan:"Unknown",daysUntilRenewal:"N/A",hasEnterpriseFeatures:!1,projectCount:0,teamMemberCount:0,licenseUtilization:0};const i=(f==null?void 0:f.length)||0,u=(f==null?void 0:f.filter(D=>D.status==="ACTIVE").length)||0,C=i>0?u/i*100:0,r=o.reduce((D,F)=>D+(F.status==="ACTIVE"?100:0),0),l=o.reduce((D,F)=>D+(F.status==="ACTIVE"?50:0),0),A=(I==null?void 0:I.length)||O.length,d=o.length,G=v.tier||"BASIC";return{activeLicenses:u,totalLicenses:i,monthlyUsage:r,totalDownloads:l,currentPlan:G,daysUntilRenewal:"30 days",hasEnterpriseFeatures:G==="ENTERPRISE",projectCount:d,teamMemberCount:A,licenseUtilization:C}},[p,v,o,O,f,I]),w=j.useMemo(()=>{var i;return p?((i=p.role)==null?void 0:i.toLowerCase())||"member":"unknown"},[p]),W=w==="admin"||w==="owner"||w==="superadmin";return ee||ae?e.jsx(c,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(c,{textAlign:"center",children:[e.jsx(oe,{size:60}),e.jsx(a,{variant:"h6",sx:{mt:2},children:"Loading Dashboard Data..."}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Fetching your organization and project information"})]})}):ie?e.jsx(c,{sx:{p:3},children:e.jsxs(Y,{severity:"error",children:[e.jsx(Q,{children:"Unable to Load Dashboard Data"}),e.jsx(a,{variant:"body2",sx:{mb:2},children:"We encountered an issue loading your dashboard information. This could be due to:"}),e.jsxs(L,{dense:!0,children:[e.jsxs(x,{children:[e.jsx(h,{children:e.jsx(ce,{fontSize:"small"})}),e.jsx(m,{primary:"Network connectivity issues"})]}),e.jsxs(x,{children:[e.jsx(h,{children:e.jsx(q,{fontSize:"small"})}),e.jsx(m,{primary:"Authentication token expired"})]}),e.jsxs(x,{children:[e.jsx(h,{children:e.jsx(le,{fontSize:"small"})}),e.jsx(m,{primary:"Firebase service temporarily unavailable"})]})]}),e.jsxs(c,{sx:{mt:2},children:[e.jsx(g,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(g,{variant:"outlined",onClick:()=>t("/dashboard/support"),children:"Contact Support"})]})]})}):!p||!v?e.jsx(c,{sx:{p:3},children:e.jsxs(Y,{severity:"info",children:[e.jsx(Q,{children:"Setting Up Your Dashboard"}),e.jsx(a,{variant:"body2",sx:{mb:2},children:"We're preparing your dashboard. This usually happens when:"}),e.jsxs(L,{dense:!0,children:[e.jsxs(x,{children:[e.jsx(h,{children:e.jsx(de,{fontSize:"small"})}),e.jsx(m,{primary:"Your account is being set up for the first time"})]}),e.jsxs(x,{children:[e.jsx(h,{children:e.jsx(R,{fontSize:"small"})}),e.jsx(m,{primary:"You're being added to an organization"})]}),e.jsxs(x,{children:[e.jsx(h,{children:e.jsx(xe,{fontSize:"small"})}),e.jsx(m,{primary:"Data synchronization is in progress"})]})]}),e.jsxs(c,{sx:{mt:2},children:[e.jsx(g,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Refresh"}),e.jsx(g,{variant:"outlined",onClick:()=>t("/dashboard/team"),children:"Check Team Status"})]})]})}):e.jsxs(c,{sx:{flexGrow:1,p:3},children:[e.jsxs(c,{sx:{mb:4},children:[e.jsxs(a,{variant:"h4",component:"h1",gutterBottom:!0,children:["Welcome back, ",p.name||p.email]}),e.jsxs(a,{variant:"subtitle1",color:"text.secondary",children:[v.name," • ",s.currentPlan," Plan • ",w.charAt(0).toUpperCase()+w.slice(1)]})]}),e.jsxs(b,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(b,{item:!0,xs:12,sm:6,md:3,children:e.jsx(M,{title:"Active Licenses",value:`${s.activeLicenses}/${s.totalLicenses}`,icon:e.jsx(H,{}),color:"primary"})}),e.jsx(b,{item:!0,xs:12,sm:6,md:3,children:e.jsx(M,{title:"Projects",value:s.projectCount.toString(),icon:e.jsx(E,{}),color:"success"})}),e.jsx(b,{item:!0,xs:12,sm:6,md:3,children:e.jsx(M,{title:"Team Members",value:s.teamMemberCount.toString(),icon:e.jsx(R,{}),color:"secondary"})}),e.jsx(b,{item:!0,xs:12,sm:6,md:3,children:e.jsx(M,{title:"Monthly Usage",value:s.monthlyUsage.toLocaleString(),icon:e.jsx(he,{}),color:"warning"})})]}),s.totalLicenses>0&&e.jsx(z,{sx:{mb:4},children:e.jsxs(S,{children:[e.jsx(a,{variant:"h6",sx:{fontWeight:600,mb:2},children:"License Utilization"}),e.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:2,mb:1},children:[e.jsx(me,{variant:"determinate",value:s.licenseUtilization,sx:{flex:1,height:8,borderRadius:4}}),e.jsxs(a,{variant:"body2",sx:{minWidth:60},children:[s.licenseUtilization.toFixed(1),"%"]})]}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:[s.activeLicenses," of ",s.totalLicenses," licenses are currently active"]})]})}),e.jsxs(b,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(b,{item:!0,xs:12,md:6,children:e.jsx(z,{children:e.jsxs(S,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsxs(L,{children:[e.jsxs(x,{button:!0,onClick:()=>t("/dashboard/projects"),children:[e.jsx(h,{children:e.jsx(E,{})}),e.jsx(m,{primary:"Manage Projects",secondary:`${s.projectCount} active projects`}),e.jsx(U,{})]}),e.jsx(k,{}),e.jsxs(x,{button:!0,onClick:()=>t("/dashboard/team"),children:[e.jsx(h,{children:e.jsx(R,{})}),e.jsx(m,{primary:"Team Management",secondary:`${s.teamMemberCount} team members`}),e.jsx(U,{})]}),e.jsx(k,{}),e.jsxs(x,{button:!0,onClick:()=>t("/dashboard/licenses"),children:[e.jsx(h,{children:e.jsx(H,{})}),e.jsx(m,{primary:"License Management",secondary:`${s.activeLicenses} active licenses`}),e.jsx(U,{})]}),W&&e.jsxs(e.Fragment,{children:[e.jsx(k,{}),e.jsxs(x,{button:!0,onClick:()=>t("/dashboard/billing"),children:[e.jsx(h,{children:e.jsx(ue,{})}),e.jsx(m,{primary:"Billing & Subscription",secondary:`${s.currentPlan} plan • Renews ${s.daysUntilRenewal}`}),e.jsx(U,{})]})]})]})]})})}),e.jsx(b,{item:!0,xs:12,md:6,children:e.jsx(z,{children:e.jsxs(S,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Account Status"}),e.jsxs(c,{sx:{mb:2},children:[e.jsx(P,{icon:e.jsx(je,{}),label:`${s.currentPlan} Plan`,color:"primary",sx:{mr:1,mb:1}}),e.jsx(P,{icon:e.jsx(q,{}),label:w.charAt(0).toUpperCase()+w.slice(1),color:"secondary",sx:{mr:1,mb:1}}),s.hasEnterpriseFeatures&&e.jsx(P,{icon:e.jsx(pe,{}),label:"Enterprise",color:"warning",sx:{mr:1,mb:1}})]}),e.jsxs(a,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Organization: ",v.name]}),e.jsxs(a,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Next renewal: ",s.daysUntilRenewal]}),e.jsxs(c,{sx:{mt:2},children:[e.jsx(g,{variant:"outlined",size:"small",onClick:()=>t("/dashboard/settings"),sx:{mr:1},children:"Account Settings"}),W&&e.jsx(g,{variant:"outlined",size:"small",onClick:()=>t("/dashboard/billing"),children:"Manage Billing"})]})]})})})]}),o&&o.length>0&&e.jsx(z,{children:e.jsxs(S,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Recent Projects"}),e.jsx(L,{children:o.slice(0,5).map((i,u)=>e.jsxs(be.Fragment,{children:[e.jsxs(x,{button:!0,onClick:()=>t(`/dashboard/projects/${i.id}`),children:[e.jsx(h,{children:e.jsx(E,{})}),e.jsx(m,{primary:i.name,secondary:`Created ${new Date(i.createdAt).toLocaleDateString()}`}),e.jsx(P,{label:i.status||"ACTIVE",size:"small",color:i.status==="ACTIVE"?"success":"default"})]}),u<Math.min(o.length-1,4)&&e.jsx(k,{})]},i.id))}),o.length>5&&e.jsx(c,{sx:{mt:2,textAlign:"center"},children:e.jsxs(g,{variant:"outlined",onClick:()=>t("/dashboard/projects"),children:["View All Projects (",o.length,")"]})})]})}),o&&o.length===0&&e.jsx(z,{children:e.jsxs(S,{sx:{textAlign:"center",py:4},children:[e.jsx(E,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(a,{variant:"h6",gutterBottom:!0,children:"No Projects Yet"}),e.jsx(a,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Get started by creating your first project"}),e.jsx(g,{variant:"contained",onClick:()=>t("/dashboard/projects"),children:"Create Project"})]})})]})};export{Be as default};
