import{j as e,B as n,C as ae,T as r,d as W,ai as Y,w as U,x as h,y as j,aj as ie,z as u,H as q,K as oe,a as p,ak as ce,al as O,am as de,G as y,t as f,v,ag as k,ae as H,i as le,an as L,ao as xe,q as P,D as T,aa as he,r as F,p as je,u as ue}from"./mui-D_3t3Wff.js";import{u as me,r as m,b as ge}from"./vendor-CjD1bmmO.js";import{u as be}from"./index-C_P8Nkwf.js";import{db as M}from"./firebase-D3WH-wui.js";import{getDoc as K,doc as J,query as X,collection as Z,where as $,orderBy as pe,limit as ye,getDocs as _}from"./index.esm-B4qVkIPL.js";import"./stripe-DQqYxQf-.js";import"./index.esm-DmQE6AXN.js";import"./index.esm-DeaBpi77.js";const w=s=>{if(!s)return null;if(s instanceof Date)return s;if(s&&typeof s=="object"&&typeof s.toDate=="function")try{return s.toDate()}catch(t){return console.warn("Failed to convert Firestore timestamp:",t),null}if(typeof s=="string")try{return new Date(s)}catch(t){return console.warn("Failed to parse date string:",t),null}if(typeof s=="number")try{return new Date(s)}catch(t){return console.warn("Failed to convert timestamp number:",t),null}return null},Ue=()=>{const s=me(),{user:t,isAuthenticated:D,isLoading:z}=be(),[c,ee]=m.useState(null),[g,te]=m.useState(null),[o,re]=m.useState([]),[A,se]=m.useState([]),[I,V]=m.useState(!0),[ne,N]=m.useState(null);m.useEffect(()=>{console.log("ðŸ” [DashboardOverview] State Debug:",{authLoading:z,loading:I,user:t,isAuthenticated:D,currentUser:c,organization:g,projects:o,teamMembers:A})},[z,I,t,D,c,g,o,A]),m.useEffect(()=>{console.log("ðŸ” [DashboardOverview] State Debug:",{authLoading:z,loading:I,user:t,isAuthenticated:D,currentUser:c,organization:g,projects:o,teamMembers:A})},[z,I,t,D,c,g,o,A]),m.useEffect(()=>{if(!D||!t)return;(async()=>{try{V(!0),N(null),console.log("ðŸ” [DashboardOverview] Fetching data for user:",{userId:t.id,firebaseUid:t.firebaseUid,organizationId:t.organizationId,email:t.email});const b=t.firebaseUid||t.id,S=await K(J(M,"users",b));if(S.exists()){const a=S.data();ee({id:S.id,...a,createdAt:w(a.createdAt)||new Date,updatedAt:w(a.updatedAt)||new Date})}if(t.organizationId){const a=await K(J(M,"organizations",t.organizationId));if(a.exists()){const l=a.data();te({id:a.id,...l,createdAt:w(l.createdAt)||new Date,updatedAt:w(l.updatedAt)||new Date})}}if(t.organizationId){console.log("ðŸ” [DashboardOverview] Querying projects for organizationId:",t.organizationId);try{const a=X(Z(M,"projects"),$("organizationId","==",t.organizationId),pe("createdAt","desc"),ye(10)),l=await _(a);console.log("âœ… [DashboardOverview] Projects found:",l.size);const E=l.docs.map(x=>({id:x.id,...x.data(),createdAt:w(x.data().createdAt)||new Date,updatedAt:w(x.data().updatedAt)||new Date}));re(E)}catch(a){throw console.error("âŒ [DashboardOverview] Error fetching projects:",a),a}}if(t.organizationId){console.log("ðŸ” [DashboardOverview] Querying team members for organizationId:",t.organizationId);try{const a=X(Z(M,"teamMembers"),$("organizationId","==",t.organizationId),$("status","==","ACTIVE")),l=await _(a);console.log("âœ… [DashboardOverview] Team members found:",l.size);const E=l.docs.map(x=>({id:x.id,...x.data(),createdAt:w(x.data().createdAt)||new Date,updatedAt:w(x.data().updatedAt)||new Date}));se(E)}catch(a){throw console.error("âŒ [DashboardOverview] Error fetching team members:",a),a}}}catch(b){console.error("Error fetching dashboard data:",b),N(b instanceof Error?b.message:"Failed to fetch dashboard data")}finally{V(!1)}})()},[D,t]);const i=m.useMemo(()=>{if(!c||!g)return{activeLicenses:0,totalLicenses:0,monthlyUsage:0,totalDownloads:0,currentPlan:"Unknown",daysUntilRenewal:"N/A",hasEnterpriseFeatures:!1,projectCount:0,teamMemberCount:0,licenseUtilization:0};const d=c.status==="ACTIVE"?1:0,b=1,S=d/b*100,a=o.reduce((B,R)=>B+(R.status==="ACTIVE"?100:0),0),l=o.reduce((B,R)=>B+(R.status==="ACTIVE"?50:0),0),E=A.length,x=o.length,G=g.tier||"BASIC";return{activeLicenses:d,totalLicenses:b,monthlyUsage:a,totalDownloads:l,currentPlan:G,daysUntilRenewal:"30 days",hasEnterpriseFeatures:G==="ENTERPRISE",projectCount:x,teamMemberCount:E,licenseUtilization:S}},[c,g,o,A]),C=m.useMemo(()=>{var d;return c?((d=c.role)==null?void 0:d.toLowerCase())||"member":"unknown"},[c]),Q=C==="admin"||C==="owner"||C==="superadmin";return z||I?e.jsx(n,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(n,{textAlign:"center",children:[e.jsx(ae,{size:60}),e.jsx(r,{variant:"h6",sx:{mt:2},children:"Loading Dashboard Data..."}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"Fetching your organization and project information"})]})}):ne?e.jsx(n,{sx:{p:3},children:e.jsxs(W,{severity:"error",children:[e.jsx(Y,{children:"Unable to Load Dashboard Data"}),e.jsx(r,{variant:"body2",sx:{mb:2},children:"We encountered an issue loading your dashboard information. This could be due to:"}),e.jsxs(U,{dense:!0,children:[e.jsxs(h,{children:[e.jsx(j,{children:e.jsx(ie,{fontSize:"small"})}),e.jsx(u,{primary:"Network connectivity issues"})]}),e.jsxs(h,{children:[e.jsx(j,{children:e.jsx(q,{fontSize:"small"})}),e.jsx(u,{primary:"Authentication token expired"})]}),e.jsxs(h,{children:[e.jsx(j,{children:e.jsx(oe,{fontSize:"small"})}),e.jsx(u,{primary:"Firebase service temporarily unavailable"})]})]}),e.jsxs(n,{sx:{mt:2},children:[e.jsx(p,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(p,{variant:"outlined",onClick:()=>s("/dashboard/support"),children:"Contact Support"})]})]})}):!c||!g?e.jsx(n,{sx:{p:3},children:e.jsxs(W,{severity:"info",children:[e.jsx(Y,{children:"Setting Up Your Dashboard"}),e.jsx(r,{variant:"body2",sx:{mb:2},children:"We're preparing your dashboard. This usually happens when:"}),e.jsxs(U,{dense:!0,children:[e.jsxs(h,{children:[e.jsx(j,{children:e.jsx(ce,{fontSize:"small"})}),e.jsx(u,{primary:"Your account is being set up for the first time"})]}),e.jsxs(h,{children:[e.jsx(j,{children:e.jsx(O,{fontSize:"small"})}),e.jsx(u,{primary:"You're being added to an organization"})]}),e.jsxs(h,{children:[e.jsx(j,{children:e.jsx(de,{fontSize:"small"})}),e.jsx(u,{primary:"Data synchronization is in progress"})]})]}),e.jsxs(n,{sx:{mt:2},children:[e.jsx(p,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Refresh"}),e.jsx(p,{variant:"outlined",onClick:()=>s("/dashboard/team"),children:"Check Team Status"})]})]})}):e.jsxs(n,{sx:{flexGrow:1,p:3},children:[e.jsxs(n,{sx:{mb:4},children:[e.jsxs(r,{variant:"h4",component:"h1",gutterBottom:!0,children:["Welcome back, ",c.name||c.email]}),e.jsxs(r,{variant:"subtitle1",color:"text.secondary",children:[g.name," â€¢ ",i.currentPlan," Plan â€¢ ",C.charAt(0).toUpperCase()+C.slice(1)]})]}),e.jsxs(y,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(f,{children:e.jsxs(v,{children:[e.jsxs(n,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(n,{children:[e.jsx(r,{color:"textSecondary",gutterBottom:!0,variant:"body2",children:"Active Licenses"}),e.jsx(r,{variant:"h4",children:i.activeLicenses}),e.jsxs(r,{variant:"body2",color:"text.secondary",children:["of ",i.totalLicenses," total"]})]}),e.jsx(k,{sx:{bgcolor:"primary.main"},children:e.jsx(H,{})})]}),i.totalLicenses>0&&e.jsxs(n,{sx:{mt:2},children:[e.jsx(le,{variant:"determinate",value:i.licenseUtilization,sx:{height:8,borderRadius:4}}),e.jsxs(r,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:[i.licenseUtilization.toFixed(1),"% utilization"]})]})]})})}),e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(f,{children:e.jsx(v,{children:e.jsxs(n,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(n,{children:[e.jsx(r,{color:"textSecondary",gutterBottom:!0,variant:"body2",children:"Projects"}),e.jsx(r,{variant:"h4",children:i.projectCount}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"active projects"})]}),e.jsx(k,{sx:{bgcolor:"success.main"},children:e.jsx(L,{})})]})})})}),e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(f,{children:e.jsx(v,{children:e.jsxs(n,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(n,{children:[e.jsx(r,{color:"textSecondary",gutterBottom:!0,variant:"body2",children:"Team Members"}),e.jsx(r,{variant:"h4",children:i.teamMemberCount}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"in organization"})]}),e.jsx(k,{sx:{bgcolor:"info.main"},children:e.jsx(O,{})})]})})})}),e.jsx(y,{item:!0,xs:12,sm:6,md:3,children:e.jsx(f,{children:e.jsx(v,{children:e.jsxs(n,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(n,{children:[e.jsx(r,{color:"textSecondary",gutterBottom:!0,variant:"body2",children:"Monthly Usage"}),e.jsx(r,{variant:"h4",children:i.monthlyUsage.toLocaleString()}),e.jsx(r,{variant:"body2",color:"text.secondary",children:"API calls"})]}),e.jsx(k,{sx:{bgcolor:"warning.main"},children:e.jsx(xe,{})})]})})})})]}),e.jsxs(y,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(y,{item:!0,xs:12,md:6,children:e.jsx(f,{children:e.jsxs(v,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsxs(U,{children:[e.jsxs(h,{button:!0,onClick:()=>s("/dashboard/projects"),children:[e.jsx(j,{children:e.jsx(L,{})}),e.jsx(u,{primary:"Manage Projects",secondary:`${i.projectCount} active projects`}),e.jsx(P,{})]}),e.jsx(T,{}),e.jsxs(h,{button:!0,onClick:()=>s("/dashboard/team"),children:[e.jsx(j,{children:e.jsx(O,{})}),e.jsx(u,{primary:"Team Management",secondary:`${i.teamMemberCount} team members`}),e.jsx(P,{})]}),e.jsx(T,{}),e.jsxs(h,{button:!0,onClick:()=>s("/dashboard/licenses"),children:[e.jsx(j,{children:e.jsx(H,{})}),e.jsx(u,{primary:"License Management",secondary:`${i.activeLicenses} active licenses`}),e.jsx(P,{})]}),Q&&e.jsxs(e.Fragment,{children:[e.jsx(T,{}),e.jsxs(h,{button:!0,onClick:()=>s("/dashboard/billing"),children:[e.jsx(j,{children:e.jsx(he,{})}),e.jsx(u,{primary:"Billing & Subscription",secondary:`${i.currentPlan} plan â€¢ Renews ${i.daysUntilRenewal}`}),e.jsx(P,{})]})]})]})]})})}),e.jsx(y,{item:!0,xs:12,md:6,children:e.jsx(f,{children:e.jsxs(v,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Account Status"}),e.jsxs(n,{sx:{mb:2},children:[e.jsx(F,{icon:e.jsx(je,{}),label:`${i.currentPlan} Plan`,color:"primary",sx:{mr:1,mb:1}}),e.jsx(F,{icon:e.jsx(q,{}),label:C.charAt(0).toUpperCase()+C.slice(1),color:"secondary",sx:{mr:1,mb:1}}),i.hasEnterpriseFeatures&&e.jsx(F,{icon:e.jsx(ue,{}),label:"Enterprise",color:"warning",sx:{mr:1,mb:1}})]}),e.jsxs(r,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Organization: ",g.name]}),e.jsxs(r,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Next renewal: ",i.daysUntilRenewal]}),e.jsxs(n,{sx:{mt:2},children:[e.jsx(p,{variant:"outlined",size:"small",onClick:()=>s("/dashboard/settings"),sx:{mr:1},children:"Account Settings"}),Q&&e.jsx(p,{variant:"outlined",size:"small",onClick:()=>s("/dashboard/billing"),children:"Manage Billing"})]})]})})})]}),o&&o.length>0&&e.jsx(f,{children:e.jsxs(v,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:"Recent Projects"}),e.jsx(U,{children:o.slice(0,5).map((d,b)=>e.jsxs(ge.Fragment,{children:[e.jsxs(h,{button:!0,onClick:()=>s(`/dashboard/projects/${d.id}`),children:[e.jsx(j,{children:e.jsx(L,{})}),e.jsx(u,{primary:d.name,secondary:`Created ${new Date(d.createdAt).toLocaleDateString()}`}),e.jsx(F,{label:d.status||"ACTIVE",size:"small",color:d.status==="ACTIVE"?"success":"default"})]}),b<Math.min(o.length-1,4)&&e.jsx(T,{})]},d.id))}),o.length>5&&e.jsx(n,{sx:{mt:2,textAlign:"center"},children:e.jsxs(p,{variant:"outlined",onClick:()=>s("/dashboard/projects"),children:["View All Projects (",o.length,")"]})})]})}),o&&o.length===0&&e.jsx(f,{children:e.jsxs(v,{sx:{textAlign:"center",py:4},children:[e.jsx(L,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(r,{variant:"h6",gutterBottom:!0,children:"No Projects Yet"}),e.jsx(r,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Get started by creating your first project"}),e.jsx(p,{variant:"contained",onClick:()=>s("/dashboard/projects"),children:"Create Project"})]})})]})};export{Ue as default};
