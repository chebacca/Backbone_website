import{j as e,B as h,C as oe,T as x,d as Y,ai as Q,w as E,x as i,y as c,aj as ie,z as d,H as q,K as ce,a as v,ak as de,al as M,am as le,G as g,ae as H,an as L,t as F,v as R,q as k,D as T,aa as ue,r as me}from"./mui-B7gVSRQz.js";import{u as xe,r as j,b as he}from"./vendor-CjD1bmmO.js";import{u as je}from"./index-C1pMErhC.js";import{d as I}from"./firebase-DInSttCd.js";import{getDoc as O,doc as B,query as K,collection as J,where as $,orderBy as pe,limit as ge,getDocs as X}from"./index.esm-DdZh2hq1.js";import{M as P}from"./MetricCard-DLjlqIaY.js";import{u as be,a as ye}from"./useStreamlinedData-Dh0bfG0w.js";import"./stripe-DZVnxqrk.js";import"./index.esm-Dkmm1Qng.js";import"./index.esm-e-DuI42t.js";import"./UnifiedDataService-DYakHMGi.js";import"./FirestoreCollectionManager-5TRfvcoK.js";const b=t=>{if(!t)return null;if(t instanceof Date)return t;if(t&&typeof t=="object"&&typeof t.toDate=="function")try{return t.toDate()}catch(s){return console.warn("Failed to convert Firestore timestamp:",s),null}if(typeof t=="string")try{return new Date(t)}catch(s){return console.warn("Failed to parse date string:",s),null}if(typeof t=="number")try{return new Date(t)}catch(s){return console.warn("Failed to convert timestamp number:",s),null}return null},Pe=()=>{const t=xe(),{user:s,isAuthenticated:V,isLoading:Z}=je(),{data:y}=be(),{data:S}=ye(),[p,_]=j.useState(null),[C,ee]=j.useState(null),[l,te]=j.useState([]),[N,re]=j.useState([]),[se,G]=j.useState(!0),[ae,W]=j.useState(null);j.useEffect(()=>{if(!V||!s)return;(async()=>{try{G(!0),W(null);const u=s.firebaseUid||s.id,w=s.email;let f=await O(B(I,"users",u));if(!f.exists()&&w&&(console.log("ðŸ” [DashboardOverview] User not found by UID, trying email:",w),f=await O(B(I,"users",w))),f.exists()){const r=f.data();_({id:f.id,...r,createdAt:b(r.createdAt)||new Date,updatedAt:b(r.updatedAt)||new Date}),console.log("âœ… [DashboardOverview] Found user data:",r.email)}else console.warn("âš ï¸ [DashboardOverview] User document not found for UID or email:",u,w);if(s.organizationId){const r=await O(B(I,"organizations",s.organizationId));if(r.exists()){const o=r.data();ee({id:r.id,...o,createdAt:b(o.createdAt)||new Date,updatedAt:b(o.updatedAt)||new Date})}}if(s.organizationId)try{const r=K(J(I,"projects"),$("organizationId","==",s.organizationId),pe("createdAt","desc"),ge(10)),o=await X(r);console.log("âœ… [DashboardOverview] Projects found:",o.size);const D=o.docs.map(m=>({id:m.id,...m.data(),createdAt:b(m.data().createdAt)||new Date,updatedAt:b(m.data().updatedAt)||new Date}));te(D)}catch(r){throw console.error("âŒ [DashboardOverview] Error fetching projects:",r),r}if(s.organizationId)try{const r=K(J(I,"teamMembers"),$("organizationId","==",s.organizationId),$("status","in",["ACTIVE","active"])),o=await X(r);console.log("âœ… [DashboardOverview] Team members found:",o.size);const D=o.docs.map(m=>({id:m.id,...m.data(),createdAt:b(m.data().createdAt)||new Date,updatedAt:b(m.data().updatedAt)||new Date}));re(D)}catch(r){throw console.error("âŒ [DashboardOverview] Error fetching team members:",r),r}}catch(u){console.error("Error fetching dashboard data:",u),W(u instanceof Error?u.message:"Failed to fetch dashboard data")}finally{G(!1)}})()},[V,s]);const a=j.useMemo(()=>{if(!p||!C)return{activeLicenses:0,totalLicenses:0,monthlyUsage:0,totalDownloads:0,currentPlan:"Unknown",daysUntilRenewal:"N/A",hasEnterpriseFeatures:!1,projectCount:0,teamMemberCount:0};const n=(y==null?void 0:y.length)||0,u=(y==null?void 0:y.filter(z=>z.status==="ACTIVE").length)||0,w=l.reduce((z,U)=>z+(U.status==="ACTIVE"?100:0),0),f=l.reduce((z,U)=>z+(U.status==="ACTIVE"?50:0),0),r=(S==null?void 0:S.length)||N.length,o=l.length,D=C.tier||"BASIC";return{activeLicenses:u,totalLicenses:n,monthlyUsage:w,totalDownloads:f,currentPlan:D,daysUntilRenewal:"30 days",hasEnterpriseFeatures:D==="ENTERPRISE",projectCount:o,teamMemberCount:r}},[p,C,l,N,y,S]),A=j.useMemo(()=>{var n;return p?((n=p.role)==null?void 0:n.toLowerCase())||"member":"unknown"},[p]),ne=A==="admin"||A==="owner"||A==="superadmin";return Z||se?e.jsx(h,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(h,{textAlign:"center",children:[e.jsx(oe,{size:60}),e.jsx(x,{variant:"h6",sx:{mt:2},children:"Loading Dashboard Data..."}),e.jsx(x,{variant:"body2",color:"text.secondary",children:"Fetching your organization and project information"})]})}):ae?e.jsx(h,{sx:{p:3},children:e.jsxs(Y,{severity:"error",children:[e.jsx(Q,{children:"Unable to Load Dashboard Data"}),e.jsx(x,{variant:"body2",sx:{mb:2},children:"We encountered an issue loading your dashboard information. This could be due to:"}),e.jsxs(E,{dense:!0,children:[e.jsxs(i,{children:[e.jsx(c,{children:e.jsx(ie,{fontSize:"small"})}),e.jsx(d,{primary:"Network connectivity issues"})]}),e.jsxs(i,{children:[e.jsx(c,{children:e.jsx(q,{fontSize:"small"})}),e.jsx(d,{primary:"Authentication token expired"})]}),e.jsxs(i,{children:[e.jsx(c,{children:e.jsx(ce,{fontSize:"small"})}),e.jsx(d,{primary:"Firebase service temporarily unavailable"})]})]}),e.jsxs(h,{sx:{mt:2},children:[e.jsx(v,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(v,{variant:"outlined",onClick:()=>t("/dashboard/support"),children:"Contact Support"})]})]})}):!p||!C?e.jsx(h,{sx:{p:3},children:e.jsxs(Y,{severity:"info",children:[e.jsx(Q,{children:"Setting Up Your Dashboard"}),e.jsx(x,{variant:"body2",sx:{mb:2},children:"We're preparing your dashboard. This usually happens when:"}),e.jsxs(E,{dense:!0,children:[e.jsxs(i,{children:[e.jsx(c,{children:e.jsx(de,{fontSize:"small"})}),e.jsx(d,{primary:"Your account is being set up for the first time"})]}),e.jsxs(i,{children:[e.jsx(c,{children:e.jsx(M,{fontSize:"small"})}),e.jsx(d,{primary:"You're being added to an organization"})]}),e.jsxs(i,{children:[e.jsx(c,{children:e.jsx(le,{fontSize:"small"})}),e.jsx(d,{primary:"Data synchronization is in progress"})]})]}),e.jsxs(h,{sx:{mt:2},children:[e.jsx(v,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Refresh"}),e.jsx(v,{variant:"outlined",onClick:()=>t("/dashboard/team"),children:"Check Team Status"})]})]})}):e.jsxs(h,{sx:{flexGrow:1,p:3},children:[e.jsxs(h,{sx:{mb:4},children:[e.jsxs(x,{variant:"h4",component:"h1",gutterBottom:!0,children:["Welcome back, ",p.name||p.email]}),e.jsxs(x,{variant:"subtitle1",color:"text.secondary",children:[C.name," â€¢ ",a.currentPlan," Plan â€¢ ",A.charAt(0).toUpperCase()+A.slice(1)]})]}),e.jsxs(g,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(g,{item:!0,xs:12,sm:6,md:3,children:e.jsx(P,{title:"Account Status",value:a.currentPlan,icon:e.jsx(q,{}),color:"primary"})}),e.jsx(g,{item:!0,xs:12,sm:6,md:3,children:e.jsx(P,{title:"Active Licenses",value:`${a.activeLicenses}/${a.totalLicenses}`,icon:e.jsx(H,{}),color:"primary"})}),e.jsx(g,{item:!0,xs:12,sm:6,md:3,children:e.jsx(P,{title:"Projects",value:a.projectCount.toString(),icon:e.jsx(L,{}),color:"success"})}),e.jsx(g,{item:!0,xs:12,sm:6,md:3,children:e.jsx(P,{title:"Team Members",value:a.teamMemberCount.toString(),icon:e.jsx(M,{}),color:"secondary"})})]}),e.jsxs(g,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(g,{item:!0,xs:12,md:6,children:e.jsx(F,{children:e.jsxs(R,{children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsxs(E,{children:[e.jsxs(i,{button:!0,onClick:()=>t("/dashboard/cloud-projects"),children:[e.jsx(c,{children:e.jsx(L,{})}),e.jsx(d,{primary:"Manage Projects",secondary:`${a.projectCount} active projects`}),e.jsx(k,{})]}),e.jsx(T,{}),e.jsxs(i,{button:!0,onClick:()=>t("/dashboard/team"),children:[e.jsx(c,{children:e.jsx(M,{})}),e.jsx(d,{primary:"Team Management",secondary:`${a.teamMemberCount} team members`}),e.jsx(k,{})]}),e.jsx(T,{}),e.jsxs(i,{button:!0,onClick:()=>t("/dashboard/licenses"),children:[e.jsx(c,{children:e.jsx(H,{})}),e.jsx(d,{primary:"License Management",secondary:`${a.activeLicenses} active licenses`}),e.jsx(k,{})]}),ne&&e.jsxs(e.Fragment,{children:[e.jsx(T,{}),e.jsxs(i,{button:!0,onClick:()=>t("/dashboard/billing"),children:[e.jsx(c,{children:e.jsx(ue,{})}),e.jsx(d,{primary:"Billing & Subscription",secondary:`${a.currentPlan} plan â€¢ Renews ${a.daysUntilRenewal}`}),e.jsx(k,{})]})]})]})]})})}),e.jsx(g,{item:!0,xs:12,md:6,children:l&&l.length>0?e.jsx(F,{children:e.jsxs(R,{children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"Recent Projects"}),e.jsx(E,{children:l.slice(0,5).map((n,u)=>e.jsxs(he.Fragment,{children:[e.jsxs(i,{button:!0,onClick:()=>t("/dashboard/cloud-projects"),children:[e.jsx(c,{children:e.jsx(L,{})}),e.jsx(d,{primary:n.name,secondary:`Created ${new Date(n.createdAt).toLocaleDateString()}`}),e.jsx(me,{label:n.status||"ACTIVE",size:"small",color:n.status==="ACTIVE"?"success":"default"})]}),u<Math.min(l.length-1,4)&&e.jsx(T,{})]},n.id))}),l.length>5&&e.jsx(h,{sx:{mt:2,textAlign:"center"},children:e.jsxs(v,{variant:"outlined",onClick:()=>t("/dashboard/cloud-projects"),children:["View All Projects (",l.length,")"]})})]})}):e.jsx(F,{children:e.jsxs(R,{sx:{textAlign:"center",py:4},children:[e.jsx(L,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(x,{variant:"h6",gutterBottom:!0,children:"No Projects Yet"}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Get started by creating your first project"}),e.jsx(v,{variant:"contained",onClick:()=>t("/dashboard/cloud-projects"),children:"Create Project"})]})})})]})]})};export{Pe as default};
