import{j as e,B as l,C as oe,T as a,d as q,ai as H,w as E,x as h,y as m,aj as ce,z as u,H as K,K as le,a as g,ak as de,al as B,am as xe,G as b,ae as J,an as k,ao as he,t as I,v as S,i as me,q as P,D as T,aa as ue,r as M,p as je,u as pe}from"./mui-BO-fjSjW.js";import{u as ge,r as j,b as be}from"./vendor-CjD1bmmO.js";import{u as ye}from"./index-Dsd9s5gZ.js";import{db as U}from"./firebase-So8bl_0i.js";import{getDoc as O,doc as $,query as X,collection as Z,where as V,orderBy as fe,limit as ve,getDocs as _}from"./index.esm-DjGGEXS3.js";import{M as F}from"./MetricCard-Bwv-4yrN.js";import{u as we,a as Ce}from"./useStreamlinedData-DOPhDDPY.js";import"./stripe-BghXmgwV.js";import"./index.esm-BANGvNYi.js";import"./index.esm-CiRfLMBX.js";import"./UnifiedDataService-DcI7MFgz.js";import"./FirestoreCollectionManager-5iJjBElj.js";const y=t=>{if(!t)return null;if(t instanceof Date)return t;if(t&&typeof t=="object"&&typeof t.toDate=="function")try{return t.toDate()}catch(n){return console.warn("Failed to convert Firestore timestamp:",n),null}if(typeof t=="string")try{return new Date(t)}catch(n){return console.warn("Failed to parse date string:",n),null}if(typeof t=="number")try{return new Date(t)}catch(n){return console.warn("Failed to convert timestamp number:",n),null}return null},Be=()=>{const t=ge(),{user:n,isAuthenticated:N,isLoading:ee}=ye(),{data:f}=we(),{data:L}=Ce(),[p,te]=j.useState(null),[C,se]=j.useState(null),[o,re]=j.useState([]),[W,ne]=j.useState([]),[ae,G]=j.useState(!0),[ie,Y]=j.useState(null);j.useEffect(()=>{if(!N||!n)return;(async()=>{try{G(!0),Y(null);const d=n.firebaseUid||n.id,D=n.email;let w=await O($(U,"users",d));if(!w.exists()&&D&&(console.log("ðŸ” [DashboardOverview] User not found by UID, trying email:",D),w=await O($(U,"users",D))),w.exists()){const s=w.data();te({id:w.id,...s,createdAt:y(s.createdAt)||new Date,updatedAt:y(s.updatedAt)||new Date}),console.log("âœ… [DashboardOverview] Found user data:",s.email)}else console.warn("âš ï¸ [DashboardOverview] User document not found for UID or email:",d,D);if(n.organizationId){const s=await O($(U,"organizations",n.organizationId));if(s.exists()){const x=s.data();se({id:s.id,...x,createdAt:y(x.createdAt)||new Date,updatedAt:y(x.updatedAt)||new Date})}}if(n.organizationId)try{const s=X(Z(U,"projects"),V("organizationId","==",n.organizationId),fe("createdAt","desc"),ve(10)),x=await _(s);console.log("âœ… [DashboardOverview] Projects found:",x.size);const A=x.docs.map(c=>({id:c.id,...c.data(),createdAt:y(c.data().createdAt)||new Date,updatedAt:y(c.data().updatedAt)||new Date}));re(A)}catch(s){throw console.error("âŒ [DashboardOverview] Error fetching projects:",s),s}if(n.organizationId)try{const s=X(Z(U,"teamMembers"),V("organizationId","==",n.organizationId),V("status","in",["ACTIVE","active"])),x=await _(s);console.log("âœ… [DashboardOverview] Team members found:",x.size);const A=x.docs.map(c=>({id:c.id,...c.data(),createdAt:y(c.data().createdAt)||new Date,updatedAt:y(c.data().updatedAt)||new Date}));ne(A)}catch(s){throw console.error("âŒ [DashboardOverview] Error fetching team members:",s),s}}catch(d){console.error("Error fetching dashboard data:",d),Y(d instanceof Error?d.message:"Failed to fetch dashboard data")}finally{G(!1)}})()},[N,n]);const r=j.useMemo(()=>{if(!p||!C)return{activeLicenses:0,totalLicenses:0,monthlyUsage:0,totalDownloads:0,currentPlan:"Unknown",daysUntilRenewal:"N/A",hasEnterpriseFeatures:!1,projectCount:0,teamMemberCount:0,licenseUtilization:0};const i=(f==null?void 0:f.length)||0,d=(f==null?void 0:f.filter(z=>z.status==="ACTIVE").length)||0,D=i>0?d/i*100:0,w=o.reduce((z,R)=>z+(R.status==="ACTIVE"?100:0),0),s=o.reduce((z,R)=>z+(R.status==="ACTIVE"?50:0),0),x=(L==null?void 0:L.length)||W.length,A=o.length,c=C.tier||"BASIC";return{activeLicenses:d,totalLicenses:i,monthlyUsage:w,totalDownloads:s,currentPlan:c,daysUntilRenewal:"30 days",hasEnterpriseFeatures:c==="ENTERPRISE",projectCount:A,teamMemberCount:x,licenseUtilization:D}},[p,C,o,W,f,L]),v=j.useMemo(()=>{var i;return p?((i=p.role)==null?void 0:i.toLowerCase())||"member":"unknown"},[p]),Q=v==="admin"||v==="owner"||v==="superadmin";return ee||ae?e.jsx(l,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(l,{textAlign:"center",children:[e.jsx(oe,{size:60}),e.jsx(a,{variant:"h6",sx:{mt:2},children:"Loading Dashboard Data..."}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Fetching your organization and project information"})]})}):ie?e.jsx(l,{sx:{p:3},children:e.jsxs(q,{severity:"error",children:[e.jsx(H,{children:"Unable to Load Dashboard Data"}),e.jsx(a,{variant:"body2",sx:{mb:2},children:"We encountered an issue loading your dashboard information. This could be due to:"}),e.jsxs(E,{dense:!0,children:[e.jsxs(h,{children:[e.jsx(m,{children:e.jsx(ce,{fontSize:"small"})}),e.jsx(u,{primary:"Network connectivity issues"})]}),e.jsxs(h,{children:[e.jsx(m,{children:e.jsx(K,{fontSize:"small"})}),e.jsx(u,{primary:"Authentication token expired"})]}),e.jsxs(h,{children:[e.jsx(m,{children:e.jsx(le,{fontSize:"small"})}),e.jsx(u,{primary:"Firebase service temporarily unavailable"})]})]}),e.jsxs(l,{sx:{mt:2},children:[e.jsx(g,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Retry"}),e.jsx(g,{variant:"outlined",onClick:()=>t("/dashboard/support"),children:"Contact Support"})]})]})}):!p||!C?e.jsx(l,{sx:{p:3},children:e.jsxs(q,{severity:"info",children:[e.jsx(H,{children:"Setting Up Your Dashboard"}),e.jsx(a,{variant:"body2",sx:{mb:2},children:"We're preparing your dashboard. This usually happens when:"}),e.jsxs(E,{dense:!0,children:[e.jsxs(h,{children:[e.jsx(m,{children:e.jsx(de,{fontSize:"small"})}),e.jsx(u,{primary:"Your account is being set up for the first time"})]}),e.jsxs(h,{children:[e.jsx(m,{children:e.jsx(B,{fontSize:"small"})}),e.jsx(u,{primary:"You're being added to an organization"})]}),e.jsxs(h,{children:[e.jsx(m,{children:e.jsx(xe,{fontSize:"small"})}),e.jsx(u,{primary:"Data synchronization is in progress"})]})]}),e.jsxs(l,{sx:{mt:2},children:[e.jsx(g,{variant:"contained",onClick:()=>window.location.reload(),sx:{mr:2},children:"Refresh"}),e.jsx(g,{variant:"outlined",onClick:()=>t("/dashboard/team"),children:"Check Team Status"})]})]})}):e.jsxs(l,{sx:{flexGrow:1,p:3},children:[e.jsxs(l,{sx:{mb:4},children:[e.jsxs(a,{variant:"h4",component:"h1",gutterBottom:!0,children:["Welcome back, ",p.name||p.email]}),e.jsxs(a,{variant:"subtitle1",color:"text.secondary",children:[C.name," â€¢ ",r.currentPlan," Plan â€¢ ",v.charAt(0).toUpperCase()+v.slice(1)]})]}),e.jsxs(b,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(b,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Active Licenses",value:`${r.activeLicenses}/${r.totalLicenses}`,icon:e.jsx(J,{}),color:"primary"})}),e.jsx(b,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Projects",value:r.projectCount.toString(),icon:e.jsx(k,{}),color:"success"})}),e.jsx(b,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Team Members",value:r.teamMemberCount.toString(),icon:e.jsx(B,{}),color:"secondary"})}),e.jsx(b,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Monthly Usage",value:r.monthlyUsage.toLocaleString(),icon:e.jsx(he,{}),color:"warning"})})]}),r.totalLicenses>0&&e.jsx(I,{sx:{mb:4},children:e.jsxs(S,{children:[e.jsx(a,{variant:"h6",sx:{fontWeight:600,mb:2},children:"License Utilization"}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2,mb:1},children:[e.jsx(me,{variant:"determinate",value:r.licenseUtilization,sx:{flex:1,height:8,borderRadius:4}}),e.jsxs(a,{variant:"body2",sx:{minWidth:60},children:[r.licenseUtilization.toFixed(1),"%"]})]}),e.jsxs(a,{variant:"body2",color:"text.secondary",children:[r.activeLicenses," of ",r.totalLicenses," licenses are currently active"]})]})}),e.jsxs(b,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(b,{item:!0,xs:12,md:6,children:e.jsx(I,{children:e.jsxs(S,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsxs(E,{children:[e.jsxs(h,{button:!0,onClick:()=>t("/dashboard/projects"),children:[e.jsx(m,{children:e.jsx(k,{})}),e.jsx(u,{primary:"Manage Projects",secondary:`${r.projectCount} active projects`}),e.jsx(P,{})]}),e.jsx(T,{}),e.jsxs(h,{button:!0,onClick:()=>t("/dashboard/team"),children:[e.jsx(m,{children:e.jsx(B,{})}),e.jsx(u,{primary:"Team Management",secondary:`${r.teamMemberCount} team members`}),e.jsx(P,{})]}),e.jsx(T,{}),e.jsxs(h,{button:!0,onClick:()=>t("/dashboard/licenses"),children:[e.jsx(m,{children:e.jsx(J,{})}),e.jsx(u,{primary:"License Management",secondary:`${r.activeLicenses} active licenses`}),e.jsx(P,{})]}),Q&&e.jsxs(e.Fragment,{children:[e.jsx(T,{}),e.jsxs(h,{button:!0,onClick:()=>t("/dashboard/billing"),children:[e.jsx(m,{children:e.jsx(ue,{})}),e.jsx(u,{primary:"Billing & Subscription",secondary:`${r.currentPlan} plan â€¢ Renews ${r.daysUntilRenewal}`}),e.jsx(P,{})]})]})]})]})})}),e.jsx(b,{item:!0,xs:12,md:6,children:e.jsx(I,{children:e.jsxs(S,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Account Status"}),e.jsxs(l,{sx:{mb:2},children:[e.jsx(M,{icon:e.jsx(je,{}),label:`${r.currentPlan} Plan`,color:"primary",sx:{mr:1,mb:1}}),e.jsx(M,{icon:e.jsx(K,{}),label:v.charAt(0).toUpperCase()+v.slice(1),color:"secondary",sx:{mr:1,mb:1}}),r.hasEnterpriseFeatures&&e.jsx(M,{icon:e.jsx(pe,{}),label:"Enterprise",color:"warning",sx:{mr:1,mb:1}})]}),e.jsxs(a,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Organization: ",C.name]}),e.jsxs(a,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Next renewal: ",r.daysUntilRenewal]}),e.jsxs(l,{sx:{mt:2},children:[e.jsx(g,{variant:"outlined",size:"small",onClick:()=>t("/dashboard/settings"),sx:{mr:1},children:"Account Settings"}),Q&&e.jsx(g,{variant:"outlined",size:"small",onClick:()=>t("/dashboard/billing"),children:"Manage Billing"})]})]})})})]}),o&&o.length>0&&e.jsx(I,{children:e.jsxs(S,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,children:"Recent Projects"}),e.jsx(E,{children:o.slice(0,5).map((i,d)=>e.jsxs(be.Fragment,{children:[e.jsxs(h,{button:!0,onClick:()=>t(`/dashboard/projects/${i.id}`),children:[e.jsx(m,{children:e.jsx(k,{})}),e.jsx(u,{primary:i.name,secondary:`Created ${new Date(i.createdAt).toLocaleDateString()}`}),e.jsx(M,{label:i.status||"ACTIVE",size:"small",color:i.status==="ACTIVE"?"success":"default"})]}),d<Math.min(o.length-1,4)&&e.jsx(T,{})]},i.id))}),o.length>5&&e.jsx(l,{sx:{mt:2,textAlign:"center"},children:e.jsxs(g,{variant:"outlined",onClick:()=>t("/dashboard/projects"),children:["View All Projects (",o.length,")"]})})]})}),o&&o.length===0&&e.jsx(I,{children:e.jsxs(S,{sx:{textAlign:"center",py:4},children:[e.jsx(k,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(a,{variant:"h6",gutterBottom:!0,children:"No Projects Yet"}),e.jsx(a,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Get started by creating your first project"}),e.jsx(g,{variant:"contained",onClick:()=>t("/dashboard/projects"),children:"Create Project"})]})})]})};export{Be as default};
