const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-BZZnh-v6.js","assets/index-D9z1s0Yx.js","assets/mui-DWTWYqgO.js","assets/vendor-CjD1bmmO.js","assets/stripe-TYTTXgaF.js","assets/index-CBai7h7s.css","assets/index.esm-DmQE6AXN.js","assets/index.esm-B4qVkIPL.js","assets/index.esm-DeaBpi77.js"])))=>i.map(i=>d[i]);
var I=Object.defineProperty;var O=(E,e,o)=>e in E?I(E,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):E[e]=o;var b=(E,e,o)=>O(E,typeof e!="symbol"?e+"":e,o);import{_ as F}from"./index-D9z1s0Yx.js";import{collection as L,query as g,limit as p,getDocs as C,doc as w,Timestamp as _,addDoc as $,updateDoc as v,deleteDoc as P,getDoc as G,where as y,orderBy as R,writeBatch as k,onSnapshot as q}from"./index.esm-B4qVkIPL.js";import{db as M}from"./firebase-BZZnh-v6.js";import"./mui-DWTWYqgO.js";import"./vendor-CjD1bmmO.js";import"./stripe-TYTTXgaF.js";import"./index.esm-DmQE6AXN.js";import"./index.esm-DeaBpi77.js";const f={USERS:"users",USER_PROFILES:"userProfiles",USER_SETTINGS:"userSettings",USER_SETTINGS_LEGACY:"user_settingss",USER_TIME_CARDS:"userTimeCards",USER_TIME_CARDS_LEGACY:"user_time_cards",ORGANIZATIONS:"organizations",ORG_MEMBERS:"orgMembers",ORG_MEMBERS_LEGACY:"org_members",TEAM_MEMBERS:"teamMembers",TEAM_MEMBERS_LEGACY:"team_members",PROJECTS:"projects",PROJECT_TEAM_MEMBERS:"projectTeamMembers",PROJECT_TEAM_MEMBERS_LEGACY:"project_team_members",PROJECT_PARTICIPANTS:"projectParticipants",PROJECT_PARTICIPANTS_LEGACY:"project_participants",DATASETS:"datasets",LICENSES:"licenses",SUBSCRIPTIONS:"subscriptions",PAYMENTS:"payments",INVOICES:"invoices",INVOICE_PAYMENTS:"invoice_payments",ACTIVITIES:"activities",AUDIT_LOG:"audit_log",AUDIT_LOGS:"auditLogs",SESSIONS:"sessions",USAGE_ANALYTICS:"usage_analytics",SYSTEM_SETTINGS:"systemSettings",SDK_VERSIONS:"sdkVersions",WEBHOOK_EVENTS:"webhookEvents",WEBHOOK_EVENTS_ALT:"webhook_events",NOTIFICATIONS:"notifications",PRIVACY_CONSENTS:"privacy_consents",LICENSE_DELIVERY_LOGS:"license_delivery_logs",WORKFLOW_DIAGRAMS:"workflowDiagrams",WORKFLOW_DIAGRAMS_LEGACY:"workflow_diagrams"},T={orgMembers:["orgMembers","org_members"],teamMembers:["teamMembers","team_members"],projectTeamMembers:["projectTeamMembers","project_team_members"],projectParticipants:["projectParticipants","project_participants"],userSettings:["userSettings","user_settingss"],userTimeCards:["userTimeCards","user_time_cards"],workflowDiagrams:["workflowDiagrams","workflow_diagrams"],auditLogs:["auditLogs","audit_log"],webhookEvents:["webhookEvents","webhook_events"],usageAnalytics:["usageAnalytics","usage_analytics"],privacyConsents:["privacyConsents","privacy_consents"],licenseDeliveryLogs:["licenseDeliveryLogs","license_delivery_logs"]},m=class m{static getInstance(){return m.instance||(m.instance=new m),m.instance}isWebOnlyMode(){return!0}getCollection(e){return L(M,e)}async getCollectionWithFallback(e){const t=T[e]||[e];for(let n=0;n<t.length;n++){const d=t[n],c=n>0;try{const s=this.getCollection(d),u=g(s,p(1));return await C(u),console.log(`‚úÖ [FirestoreCollectionManager] Using ${c?"legacy":"primary"} collection: '${d}'`),{collection:s,collectionName:d,isLegacy:c}}catch{console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Collection '${d}' not accessible, trying next...`);continue}}const r=this.getCollection(t[0]);return console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] No accessible collections found, using primary: '${t[0]}'`),{collection:r,collectionName:t[0],isLegacy:!1}}getDocument(e,o){return w(M,e,o)}async initializeCollections(){console.log("üîß [FirestoreCollectionManager] Initializing Firestore collections...");try{const{auth:e}=await F(async()=>{const{auth:t}=await import("./firebase-BZZnh-v6.js");return{auth:t}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));if(!e.currentUser&&this.isWebOnlyMode()){console.warn("‚ö†Ô∏è [FirestoreCollectionManager] No authenticated user - some operations may fail");return}const o=[f.USERS,f.ORGANIZATIONS,f.ORG_MEMBERS,f.PROJECTS,f.LICENSES,f.TEAM_MEMBERS,f.PROJECT_TEAM_MEMBERS];for(const t of o)try{const r=this.getCollection(t),n=g(r,p(1));await C(n),console.log(`‚úÖ [FirestoreCollectionManager] Collection '${t}' is accessible`)}catch(r){console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Collection '${t}' may not be accessible:`,r)}console.log("‚úÖ [FirestoreCollectionManager] Collection initialization completed")}catch(e){console.error("‚ùå [FirestoreCollectionManager] Failed to initialize collections:",e)}}cleanDocumentData(e){if(typeof e!="object"||e===null)return e;if(Array.isArray(e))return e.map(t=>this.cleanDocumentData(t));const o={};for(const[t,r]of Object.entries(e))r!=null&&(o[t]=this.cleanDocumentData(r));return o}async createDocument(e,o){try{const t=this.getCollection(e),r=_.now(),n={...o,createdAt:o.createdAt||r,updatedAt:o.updatedAt||r},d=this.cleanDocumentData(n),c=await $(t,d);return console.log(`‚úÖ [FirestoreCollectionManager] Created document in '${e}':`,c.id),c.id}catch(t){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to create document in '${e}':`,t),t}}async updateDocument(e,o,t){try{const r=this.getDocument(e,o),n={...t,updatedAt:t.updatedAt||_.now()},d=this.cleanDocumentData(n);await v(r,d),console.log(`‚úÖ [FirestoreCollectionManager] Updated document in '${e}':`,o)}catch(r){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to update document in '${e}':`,r),r}}async deleteDocument(e,o){try{const t=this.getDocument(e,o);await P(t),console.log(`‚úÖ [FirestoreCollectionManager] Deleted document from '${e}':`,o)}catch(t){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to delete document from '${e}':`,t),t}}async getDocumentById(e,o){try{const t=this.getDocument(e,o),r=await G(t);return r.exists()?{id:r.id,...r.data()}:null}catch(t){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to get document from '${e}':`,t),t}}async queryDocuments(e,o=[],t,r="desc",n){var d;try{const c=this.getCollection(e);let s=g(c);for(const a of o)s=g(s,y(a.field,a.operator,a.value));t&&(s=g(s,R(t,r))),n&&(s=g(s,p(n)));const u=await C(s),i=[];return u.forEach(a=>{i.push({id:a.id,...a.data()})}),i}catch(c){if((c==null?void 0:c.code)==="failed-precondition"&&((d=c==null?void 0:c.message)!=null&&d.includes("index"))){console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Index missing for '${e}', trying simpler query...`);try{const s=this.getCollection(e);let u=g(s);for(const l of o)u=g(u,y(l.field,l.operator,l.value));n&&(u=g(u,p(n)));const i=await C(u),a=[];return i.forEach(l=>{a.push({id:l.id,...l.data()})}),t&&a.length>0&&a.sort((l,D)=>{const S=l[t],h=D[t];return r==="desc"?h>S?1:h<S?-1:0:S>h?1:S<h?-1:0}),console.log(`‚úÖ [FirestoreCollectionManager] Fallback query successful for '${e}': ${a.length} documents`),a}catch(s){throw console.error(`‚ùå [FirestoreCollectionManager] Fallback query also failed for '${e}':`,s),s}}throw console.error(`‚ùå [FirestoreCollectionManager] Failed to query documents from '${e}':`,c),c}}async queryDocumentsWithFallback(e,o=[],t,r="desc",n){const c=T[e]||[e];let s=null;for(let u=0;u<c.length;u++){const i=c[u],a=u>0;try{const l=await this.queryDocuments(i,o,t,r,n);return console.log(`‚úÖ [FirestoreCollectionManager] Successfully queried ${a?"legacy":"primary"} collection '${i}': ${l.length} documents`),{documents:l,collectionUsed:i,isLegacy:a}}catch(l){console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Failed to query '${i}', trying next...`,l),s=l;continue}}throw console.error(`‚ùå [FirestoreCollectionManager] All collection queries failed for '${e}'`),s||new Error(`No accessible collections found for '${e}'`)}async batchOperations(e){try{const o=k(M),t=_.now();for(const r of e)switch(r.type){case"create":if(r.data){const n=w(this.getCollection(r.collection));o.set(n,{...r.data,createdAt:r.data.createdAt||t,updatedAt:r.data.updatedAt||t})}break;case"update":if(r.docId&&r.data){const n=this.getDocument(r.collection,r.docId);o.update(n,{...r.data,updatedAt:r.data.updatedAt||t})}break;case"delete":if(r.docId){const n=this.getDocument(r.collection,r.docId);o.delete(n)}break}await o.commit(),console.log("‚úÖ [FirestoreCollectionManager] Completed batch operations:",e.length)}catch(o){throw console.error("‚ùå [FirestoreCollectionManager] Failed to execute batch operations:",o),o}}subscribeToCollection(e,o,t=[],r,n="desc",d){try{const c=this.getCollection(e);let s=g(c);for(const i of t)s=g(s,y(i.field,i.operator,i.value));r&&(s=g(s,R(r,n))),d&&(s=g(s,p(d)));const u=q(s,i=>{const a=[];i.forEach(l=>{a.push({id:l.id,...l.data()})}),o(a)},i=>{console.error(`‚ùå [FirestoreCollectionManager] Subscription error for '${e}':`,i)});return console.log(`‚úÖ [FirestoreCollectionManager] Set up subscription for '${e}'`),u}catch(c){return console.error(`‚ùå [FirestoreCollectionManager] Failed to set up subscription for '${e}':`,c),()=>{}}}async validateCollectionAccess(e){try{const o=this.getCollection(e),t=g(o,p(1));return await C(t),!0}catch(o){return console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] No access to collection '${e}':`,o),!1}}async getCollectionStats(e){try{if(!await this.validateCollectionAccess(e))return{accessible:!1};const t=await this.queryDocuments(e,[],"updatedAt","desc",100);return{accessible:!0,documentCount:t.length,lastUpdated:t.length>0&&t[0].updatedAt?new Date(t[0].updatedAt.toDate?t[0].updatedAt.toDate():t[0].updatedAt):void 0}}catch(o){return console.error(`‚ùå [FirestoreCollectionManager] Failed to get stats for '${e}':`,o),{accessible:!1}}}};b(m,"instance");let A=m;const J=A.getInstance();export{f as COLLECTIONS,T as COLLECTION_MAPPINGS,A as FirestoreCollectionManager,A as default,J as firestoreCollectionManager};
