const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-CybK3V4y.js","assets/index-CsLZqnnj.js","assets/mui-Cr9U6iW2.js","assets/vendor-CjD1bmmO.js","assets/stripe-ggaMUove.js","assets/index-CBai7h7s.css","assets/index.esm-DmQE6AXN.js","assets/index.esm-B4qVkIPL.js","assets/index.esm-DeaBpi77.js"])))=>i.map(i=>d[i]);
var T=Object.defineProperty;var w=(p,e,o)=>e in p?T(p,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):p[e]=o;var h=(p,e,o)=>w(p,typeof e!="symbol"?e+"":e,o);import{_ as D}from"./index-CsLZqnnj.js";import{collection as I,query as u,limit as C,getDocs as S,doc as M,Timestamp as f,addDoc as O,updateDoc as F,deleteDoc as L,getDoc as v,where as A,orderBy as b,writeBatch as $,onSnapshot as P}from"./index.esm-B4qVkIPL.js";import{db as _}from"./firebase-CybK3V4y.js";import"./mui-Cr9U6iW2.js";import"./vendor-CjD1bmmO.js";import"./stripe-ggaMUove.js";import"./index.esm-DmQE6AXN.js";import"./index.esm-DeaBpi77.js";const g={USERS:"users",USER_PROFILES:"userProfiles",USER_SETTINGS:"userSettings",USER_SETTINGS_LEGACY:"user_settingss",USER_TIME_CARDS:"userTimeCards",USER_TIME_CARDS_LEGACY:"user_time_cards",ORGANIZATIONS:"organizations",ORG_MEMBERS:"orgMembers",ORG_MEMBERS_LEGACY:"org_members",TEAM_MEMBERS:"teamMembers",TEAM_MEMBERS_LEGACY:"team_members",PROJECTS:"projects",PROJECT_TEAM_MEMBERS:"projectTeamMembers",PROJECT_TEAM_MEMBERS_LEGACY:"project_team_members",PROJECT_PARTICIPANTS:"projectParticipants",PROJECT_PARTICIPANTS_LEGACY:"project_participants",DATASETS:"datasets",LICENSES:"licenses",SUBSCRIPTIONS:"subscriptions",PAYMENTS:"payments",INVOICES:"invoices",INVOICE_PAYMENTS:"invoice_payments",ACTIVITIES:"activities",AUDIT_LOG:"audit_log",AUDIT_LOGS:"auditLogs",SESSIONS:"sessions",USAGE_ANALYTICS:"usage_analytics",SYSTEM_SETTINGS:"systemSettings",SDK_VERSIONS:"sdkVersions",WEBHOOK_EVENTS:"webhookEvents",WEBHOOK_EVENTS_ALT:"webhook_events",NOTIFICATIONS:"notifications",PRIVACY_CONSENTS:"privacy_consents",LICENSE_DELIVERY_LOGS:"license_delivery_logs",WORKFLOW_DIAGRAMS:"workflowDiagrams",WORKFLOW_DIAGRAMS_LEGACY:"workflow_diagrams"},R={orgMembers:["orgMembers","org_members"],teamMembers:["teamMembers","team_members"],projectTeamMembers:["projectTeamMembers","project_team_members"],projectParticipants:["projectParticipants","project_participants"],userSettings:["userSettings","user_settingss"],userTimeCards:["userTimeCards","user_time_cards"],workflowDiagrams:["workflowDiagrams","workflow_diagrams"],auditLogs:["auditLogs","audit_log"],webhookEvents:["webhookEvents","webhook_events"],usageAnalytics:["usageAnalytics","usage_analytics"],privacyConsents:["privacyConsents","privacy_consents"],licenseDeliveryLogs:["licenseDeliveryLogs","license_delivery_logs"]},m=class m{static getInstance(){return m.instance||(m.instance=new m),m.instance}isWebOnlyMode(){return!0}getCollection(e){return I(_,e)}async getCollectionWithFallback(e){const t=R[e]||[e];for(let s=0;s<t.length;s++){const a=t[s],n=s>0;try{const i=this.getCollection(a),l=u(i,C(1));return await S(l),console.log(`‚úÖ [FirestoreCollectionManager] Using ${n?"legacy":"primary"} collection: '${a}'`),{collection:i,collectionName:a,isLegacy:n}}catch{console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Collection '${a}' not accessible, trying next...`);continue}}const r=this.getCollection(t[0]);return console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] No accessible collections found, using primary: '${t[0]}'`),{collection:r,collectionName:t[0],isLegacy:!1}}getDocument(e,o){return M(_,e,o)}async initializeCollections(){console.log("üîß [FirestoreCollectionManager] Initializing Firestore collections...");try{const{auth:e}=await D(async()=>{const{auth:t}=await import("./firebase-CybK3V4y.js");return{auth:t}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));if(!e.currentUser&&this.isWebOnlyMode()){console.warn("‚ö†Ô∏è [FirestoreCollectionManager] No authenticated user - some operations may fail");return}const o=[g.USERS,g.ORGANIZATIONS,g.ORG_MEMBERS,g.PROJECTS,g.LICENSES,g.TEAM_MEMBERS,g.PROJECT_TEAM_MEMBERS];for(const t of o)try{const r=this.getCollection(t),s=u(r,C(1));await S(s),console.log(`‚úÖ [FirestoreCollectionManager] Collection '${t}' is accessible`)}catch(r){console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Collection '${t}' may not be accessible:`,r)}console.log("‚úÖ [FirestoreCollectionManager] Collection initialization completed")}catch(e){console.error("‚ùå [FirestoreCollectionManager] Failed to initialize collections:",e)}}cleanDocumentData(e){if(typeof e!="object"||e===null)return e;if(Array.isArray(e))return e.map(t=>this.cleanDocumentData(t));const o={};for(const[t,r]of Object.entries(e))r!=null&&(o[t]=this.cleanDocumentData(r));return o}async createDocument(e,o){try{const t=this.getCollection(e),r=f.now(),s={...o,createdAt:o.createdAt||r,updatedAt:o.updatedAt||r},a=this.cleanDocumentData(s),n=await O(t,a);return console.log(`‚úÖ [FirestoreCollectionManager] Created document in '${e}':`,n.id),n.id}catch(t){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to create document in '${e}':`,t),t}}async updateDocument(e,o,t){try{const r=this.getDocument(e,o),s={...t,updatedAt:t.updatedAt||f.now()},a=this.cleanDocumentData(s);await F(r,a),console.log(`‚úÖ [FirestoreCollectionManager] Updated document in '${e}':`,o)}catch(r){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to update document in '${e}':`,r),r}}async deleteDocument(e,o){try{const t=this.getDocument(e,o);await L(t),console.log(`‚úÖ [FirestoreCollectionManager] Deleted document from '${e}':`,o)}catch(t){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to delete document from '${e}':`,t),t}}async getDocumentById(e,o){try{const t=this.getDocument(e,o),r=await v(t);return r.exists()?{id:r.id,...r.data()}:null}catch(t){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to get document from '${e}':`,t),t}}async queryDocuments(e,o=[],t,r="desc",s){try{const a=this.getCollection(e);let n=u(a);for(const c of o)n=u(n,A(c.field,c.operator,c.value));t&&(n=u(n,b(t,r))),s&&(n=u(n,C(s)));const i=await S(n),l=[];return i.forEach(c=>{l.push({id:c.id,...c.data()})}),l}catch(a){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to query documents from '${e}':`,a),a}}async queryDocumentsWithFallback(e,o=[],t,r="desc",s){const n=R[e]||[e];let i=null;for(let l=0;l<n.length;l++){const c=n[l],E=l>0;try{const d=await this.queryDocuments(c,o,t,r,s);return console.log(`‚úÖ [FirestoreCollectionManager] Successfully queried ${E?"legacy":"primary"} collection '${c}': ${d.length} documents`),{documents:d,collectionUsed:c,isLegacy:E}}catch(d){console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Failed to query '${c}', trying next...`,d),i=d;continue}}throw console.error(`‚ùå [FirestoreCollectionManager] All collection queries failed for '${e}'`),i||new Error(`No accessible collections found for '${e}'`)}async batchOperations(e){try{const o=$(_),t=f.now();for(const r of e)switch(r.type){case"create":if(r.data){const s=M(this.getCollection(r.collection));o.set(s,{...r.data,createdAt:r.data.createdAt||t,updatedAt:r.data.updatedAt||t})}break;case"update":if(r.docId&&r.data){const s=this.getDocument(r.collection,r.docId);o.update(s,{...r.data,updatedAt:r.data.updatedAt||t})}break;case"delete":if(r.docId){const s=this.getDocument(r.collection,r.docId);o.delete(s)}break}await o.commit(),console.log("‚úÖ [FirestoreCollectionManager] Completed batch operations:",e.length)}catch(o){throw console.error("‚ùå [FirestoreCollectionManager] Failed to execute batch operations:",o),o}}subscribeToCollection(e,o,t=[],r,s="desc",a){try{const n=this.getCollection(e);let i=u(n);for(const c of t)i=u(i,A(c.field,c.operator,c.value));r&&(i=u(i,b(r,s))),a&&(i=u(i,C(a)));const l=P(i,c=>{const E=[];c.forEach(d=>{E.push({id:d.id,...d.data()})}),o(E)},c=>{console.error(`‚ùå [FirestoreCollectionManager] Subscription error for '${e}':`,c)});return console.log(`‚úÖ [FirestoreCollectionManager] Set up subscription for '${e}'`),l}catch(n){return console.error(`‚ùå [FirestoreCollectionManager] Failed to set up subscription for '${e}':`,n),()=>{}}}async validateCollectionAccess(e){try{const o=this.getCollection(e),t=u(o,C(1));return await S(t),!0}catch(o){return console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] No access to collection '${e}':`,o),!1}}async getCollectionStats(e){try{if(!await this.validateCollectionAccess(e))return{accessible:!1};const t=await this.queryDocuments(e,[],"updatedAt","desc",100);return{accessible:!0,documentCount:t.length,lastUpdated:t.length>0&&t[0].updatedAt?new Date(t[0].updatedAt.toDate?t[0].updatedAt.toDate():t[0].updatedAt):void 0}}catch(o){return console.error(`‚ùå [FirestoreCollectionManager] Failed to get stats for '${e}':`,o),{accessible:!1}}}};h(m,"instance");let y=m;const W=y.getInstance();export{g as COLLECTIONS,R as COLLECTION_MAPPINGS,y as FirestoreCollectionManager,y as default,W as firestoreCollectionManager};
