const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-CbWLKc5U.js","assets/index-DFn9BWkZ.js","assets/mui-SoXCytG7.js","assets/vendor-CjD1bmmO.js","assets/stripe-CJ03RTEk.js","assets/index-CBai7h7s.css","assets/index.esm-BANGvNYi.js","assets/index.esm-9jaBBmwp.js","assets/index.esm-CiRfLMBX.js"])))=>i.map(i=>d[i]);
var w=Object.defineProperty;var b=(m,e,o)=>e in m?w(m,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):m[e]=o;var R=(m,e,o)=>b(m,typeof e!="symbol"?e+"":e,o);import{_ as L}from"./index-DFn9BWkZ.js";import{collection as P,query as u,limit as _,getDocs as A,doc as y,Timestamp as C,addDoc as N,updateDoc as F,deleteDoc as v,getDoc as k,where as I,orderBy as h,writeBatch as G,onSnapshot as $}from"./index.esm-9jaBBmwp.js";import{db as f}from"./firebase-CbWLKc5U.js";import"./mui-SoXCytG7.js";import"./vendor-CjD1bmmO.js";import"./stripe-CJ03RTEk.js";import"./index.esm-BANGvNYi.js";import"./index.esm-CiRfLMBX.js";const d={USERS:"users",USER_PROFILES:"userProfiles",USER_SETTINGS:"userSettings",USER_SETTINGS_LEGACY:"user_settingss",USER_TIME_CARDS:"userTimeCards",USER_TIME_CARDS_LEGACY:"user_time_cards",ORGANIZATIONS:"organizations",ORG_MEMBERS:"orgMembers",ORG_MEMBERS_LEGACY:"org_members",TEAM_MEMBERS:"teamMembers",TEAM_MEMBERS_LEGACY:"team_members",PROJECTS:"projects",PROJECT_TEAM_MEMBERS:"projectTeamMembers",PROJECT_TEAM_MEMBERS_LEGACY:"project_team_members",PROJECT_PARTICIPANTS:"projectParticipants",PROJECT_PARTICIPANTS_LEGACY:"project_participants",DATASETS:"datasets",LICENSES:"licenses",SUBSCRIPTIONS:"subscriptions",PAYMENTS:"payments",INVOICES:"invoices",INVOICE_PAYMENTS:"invoice_payments",ACTIVITIES:"activities",AUDIT_LOG:"audit_log",AUDIT_LOGS:"auditLogs",SESSIONS:"sessions",USAGE_ANALYTICS:"usage_analytics",SYSTEM_SETTINGS:"systemSettings",SDK_VERSIONS:"sdkVersions",WEBHOOK_EVENTS:"webhookEvents",WEBHOOK_EVENTS_ALT:"webhook_events",NOTIFICATIONS:"notifications",PRIVACY_CONSENTS:"privacy_consents",LICENSE_DELIVERY_LOGS:"license_delivery_logs",WORKFLOW_DIAGRAMS:"workflowDiagrams",WORKFLOW_DIAGRAMS_LEGACY:"workflow_diagrams",NETWORK_DELIVERY_BIBLES:"networkDeliveryBibles",DELIVERABLES:"deliverables",NETWORK_DELIVERY_CHATS:"networkDeliveryChats",DELIVERY_SPECS:"deliverySpecs",DELIVERY_TEMPLATES:"deliveryTemplates",DELIVERY_TRACKING:"deliveryTracking",SESSION_WORKFLOWS:"sessionWorkflows",SESSION_ASSIGNMENTS:"sessionAssignments",SESSION_PARTICIPANTS:"sessionParticipants",WORKFLOW_TEMPLATES:"workflowTemplates",WORKFLOW_INSTANCES:"workflowInstances",WORKFLOW_STEPS:"workflowSteps",WORKFLOW_ASSIGNMENTS:"workflowAssignments",SESSION_PHASE_TRANSITIONS:"sessionPhaseTransitions",SESSION_REVIEWS:"sessionReviews",SESSION_QC:"sessionQc",SESSION_TASKS:"sessionTasks",DEMO_SESSIONS:"demoSessions",INVENTORY_ITEMS:"inventoryItems",INVENTORY:"inventory",NETWORK_IP_ASSIGNMENTS:"networkIPAssignments",NETWORK_IP_RANGES:"networkIPRanges",NETWORKS:"networks",INVENTORY_HISTORY:"inventoryHistory",SETUP_PROFILES:"setupProfiles",SCHEMAS:"schemas",SCHEMA_FIELDS:"schemaFields",MAP_LAYOUTS:"mapLayouts",MAP_LOCATIONS:"mapLocations",INVENTORY_MAPS:"inventoryMaps",MAP_DATA:"mapData",TIMECARD_ENTRIES:"timecard_entries",USER_TIMECARDS:"user_timecards",TIMECARD_APPROVALS:"timecard_approvals",TIMECARD_TEMPLATES:"timecard_templates",MEDIA_FILES:"mediaFiles",POST_PRODUCTION_TASKS:"postProductionTasks",STAGES:"stages",NOTES:"notes",REPORTS:"reports",CALL_SHEETS:"callSheets",AI_AGENTS:"aiAgents",MESSAGES:"messages",CHATS:"chats",MESSAGE_SESSIONS:"messageSessions",PBM_PROJECTS:"pbmProjects",PBM_SCHEDULES:"pbmSchedules",PBM_PAYSCALES:"pbmPayscales",PBM_DAILY_STATUS:"pbmDailyStatus"},O={orgMembers:["orgMembers","org_members"],teamMembers:["teamMembers","team_members"],projectTeamMembers:["projectTeamMembers","project_team_members"],projectParticipants:["projectParticipants","project_participants"],userSettings:["userSettings","user_settingss"],userTimeCards:["userTimeCards","user_time_cards"],workflowDiagrams:["workflowDiagrams","workflow_diagrams"],auditLogs:["auditLogs","audit_log"],webhookEvents:["webhookEvents","webhook_events"],usageAnalytics:["usageAnalytics","usage_analytics"],privacyConsents:["privacyConsents","privacy_consents"],licenseDeliveryLogs:["licenseDeliveryLogs","license_delivery_logs"]},g=class g{static getInstance(){return g.instance||(g.instance=new g),g.instance}isWebOnlyMode(){return!0}getCollection(e){return P(f,e)}async getCollectionWithFallback(e){const t=O[e]||[e];for(let n=0;n<t.length;n++){const E=t[n],c=n>0;try{const r=this.getCollection(E),S=u(r,_(1));return await A(S),console.log(`‚úÖ [FirestoreCollectionManager] Using ${c?"legacy":"primary"} collection: '${E}'`),{collection:r,collectionName:E,isLegacy:c}}catch{console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Collection '${E}' not accessible, trying next...`);continue}}const s=this.getCollection(t[0]);return console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] No accessible collections found, using primary: '${t[0]}'`),{collection:s,collectionName:t[0],isLegacy:!1}}getDocument(e,o){return y(f,e,o)}async initializeCollections(){console.log("üîß [FirestoreCollectionManager] Initializing Firestore collections...");try{const{auth:e}=await L(async()=>{const{auth:t}=await import("./firebase-CbWLKc5U.js");return{auth:t}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));if(!e.currentUser&&this.isWebOnlyMode()){console.warn("‚ö†Ô∏è [FirestoreCollectionManager] No authenticated user - some operations may fail");return}const o=[d.USERS,d.ORGANIZATIONS,d.ORG_MEMBERS,d.PROJECTS,d.LICENSES,d.TEAM_MEMBERS,d.PROJECT_TEAM_MEMBERS];for(const t of o)try{const s=this.getCollection(t),n=u(s,_(1));await A(n),console.log(`‚úÖ [FirestoreCollectionManager] Collection '${t}' is accessible`)}catch(s){console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Collection '${t}' may not be accessible:`,s)}console.log("‚úÖ [FirestoreCollectionManager] Collection initialization completed")}catch(e){console.error("‚ùå [FirestoreCollectionManager] Failed to initialize collections:",e)}}cleanDocumentData(e){if(typeof e!="object"||e===null)return e;if(Array.isArray(e))return e.map(t=>this.cleanDocumentData(t));const o={};for(const[t,s]of Object.entries(e))s!=null&&(o[t]=this.cleanDocumentData(s));return o}async createDocument(e,o){try{const t=this.getCollection(e),s=C.now(),n={...o,createdAt:o.createdAt||s,updatedAt:o.updatedAt||s},E=this.cleanDocumentData(n),c=await N(t,E);return console.log(`‚úÖ [FirestoreCollectionManager] Created document in '${e}':`,c.id),c.id}catch(t){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to create document in '${e}':`,t),t}}async updateDocument(e,o,t){try{const s=this.getDocument(e,o),n={...t,updatedAt:t.updatedAt||C.now()},E=this.cleanDocumentData(n);await F(s,E),console.log(`‚úÖ [FirestoreCollectionManager] Updated document in '${e}':`,o)}catch(s){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to update document in '${e}':`,s),s}}async deleteDocument(e,o){try{const t=this.getDocument(e,o);await v(t),console.log(`‚úÖ [FirestoreCollectionManager] Deleted document from '${e}':`,o)}catch(t){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to delete document from '${e}':`,t),t}}async getDocumentById(e,o){try{const t=this.getDocument(e,o),s=await k(t);return s.exists()?{id:s.id,...s.data()}:null}catch(t){throw console.error(`‚ùå [FirestoreCollectionManager] Failed to get document from '${e}':`,t),t}}async queryDocuments(e,o=[],t,s="desc",n){var E;try{const c=this.getCollection(e);let r=u(c);for(const a of o)r=u(r,I(a.field,a.operator,a.value));t&&(r=u(r,h(t,s))),n&&(r=u(r,_(n)));const S=await A(r),i=[];return S.forEach(a=>{i.push({id:a.id,...a.data()})}),i}catch(c){if((c==null?void 0:c.code)==="failed-precondition"&&((E=c==null?void 0:c.message)!=null&&E.includes("index"))){console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Index missing for '${e}', trying simpler query...`);try{const r=this.getCollection(e);let S=u(r);for(const l of o)S=u(S,I(l.field,l.operator,l.value));n&&(S=u(S,_(n)));const i=await A(S),a=[];return i.forEach(l=>{a.push({id:l.id,...l.data()})}),t&&a.length>0&&a.sort((l,D)=>{const p=l[t],T=D[t];return s==="desc"?T>p?1:T<p?-1:0:p>T?1:p<T?-1:0}),console.log(`‚úÖ [FirestoreCollectionManager] Fallback query successful for '${e}': ${a.length} documents`),a}catch(r){throw console.error(`‚ùå [FirestoreCollectionManager] Fallback query also failed for '${e}':`,r),r}}throw console.error(`‚ùå [FirestoreCollectionManager] Failed to query documents from '${e}':`,c),c}}async queryDocumentsWithFallback(e,o=[],t,s="desc",n){const c=O[e]||[e];let r=null;for(let S=0;S<c.length;S++){const i=c[S],a=S>0;try{const l=await this.queryDocuments(i,o,t,s,n);return console.log(`‚úÖ [FirestoreCollectionManager] Successfully queried ${a?"legacy":"primary"} collection '${i}': ${l.length} documents`),{documents:l,collectionUsed:i,isLegacy:a}}catch(l){console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] Failed to query '${i}', trying next...`,l),r=l;continue}}throw console.error(`‚ùå [FirestoreCollectionManager] All collection queries failed for '${e}'`),r||new Error(`No accessible collections found for '${e}'`)}async batchOperations(e){try{const o=G(f),t=C.now();for(const s of e)switch(s.type){case"create":if(s.data){const n=y(this.getCollection(s.collection));o.set(n,{...s.data,createdAt:s.data.createdAt||t,updatedAt:s.data.updatedAt||t})}break;case"update":if(s.docId&&s.data){const n=this.getDocument(s.collection,s.docId);o.update(n,{...s.data,updatedAt:s.data.updatedAt||t})}break;case"delete":if(s.docId){const n=this.getDocument(s.collection,s.docId);o.delete(n)}break}await o.commit(),console.log("‚úÖ [FirestoreCollectionManager] Completed batch operations:",e.length)}catch(o){throw console.error("‚ùå [FirestoreCollectionManager] Failed to execute batch operations:",o),o}}subscribeToCollection(e,o,t=[],s,n="desc",E){try{const c=this.getCollection(e);let r=u(c);for(const i of t)r=u(r,I(i.field,i.operator,i.value));s&&(r=u(r,h(s,n))),E&&(r=u(r,_(E)));const S=$(r,i=>{const a=[];i.forEach(l=>{a.push({id:l.id,...l.data()})}),o(a)},i=>{console.error(`‚ùå [FirestoreCollectionManager] Subscription error for '${e}':`,i)});return console.log(`‚úÖ [FirestoreCollectionManager] Set up subscription for '${e}'`),S}catch(c){return console.error(`‚ùå [FirestoreCollectionManager] Failed to set up subscription for '${e}':`,c),()=>{}}}async validateCollectionAccess(e){try{const o=this.getCollection(e),t=u(o,_(1));return await A(t),!0}catch(o){return console.warn(`‚ö†Ô∏è [FirestoreCollectionManager] No access to collection '${e}':`,o),!1}}async getCollectionStats(e){try{if(!await this.validateCollectionAccess(e))return{accessible:!1};const t=await this.queryDocuments(e,[],"updatedAt","desc",100);return{accessible:!0,documentCount:t.length,lastUpdated:t.length>0&&t[0].updatedAt?new Date(t[0].updatedAt.toDate?t[0].updatedAt.toDate():t[0].updatedAt):void 0}}catch(o){return console.error(`‚ùå [FirestoreCollectionManager] Failed to get stats for '${e}':`,o),{accessible:!1}}}};R(g,"instance");let M=g;const J=M.getInstance();export{d as COLLECTIONS,O as COLLECTION_MAPPINGS,M as FirestoreCollectionManager,M as default,J as firestoreCollectionManager};
