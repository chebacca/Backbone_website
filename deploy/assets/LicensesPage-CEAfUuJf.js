const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-oXISLbBI.js","assets/index-iHbYk_XX.js","assets/mui-CbJLuC6G.js","assets/vendor-CjD1bmmO.js","assets/stripe-iaBWsbMy.js","assets/index-CBai7h7s.css","assets/index.esm-B6Q1BJpE.js","assets/index.esm-D6OvRmrs.js","assets/index.esm-Cicvjgiv.js"])))=>i.map(i=>d[i]);
import{u as ge,c as he,e as xe,_ as me}from"./index-iHbYk_XX.js";import{j as e,B as x,T as m,a as I,ai as fe,G as C,aj as je,ae as pe,ak as be,al as Le,c as G,e as H,am as we,an as ye,ao as ve,ap as Ae,aq as Te,ar as K,as as l,at as Se,ag as Ie,r as X,i as Ce,g as Pe,au as Ee,a4 as ke,a5 as w,y,av as Fe,aw as De,ax as Me,ay as Ue,az as $e,aA as ze,af as Ne,aB as Be,aC as We,aD as Re,aE as Ve,p as Q,aF as J,o as Oe}from"./mui-CbJLuC6G.js";import{r as u}from"./vendor-CjD1bmmO.js";import{u as _e}from"./notistack.esm-Ca-E78ev.js";import{M as U}from"./MetricCard-DEDCS3oR.js";import{firestoreLicenseService as g}from"./FirestoreLicenseService-CCFfpH9O.js";import{query as qe,collection as Ge,where as He,limit as Ke,getDocs as Xe}from"./index.esm-D6OvRmrs.js";import"./stripe-iaBWsbMy.js";import"./index.esm-Cicvjgiv.js";import"./index.esm-B6Q1BJpE.js";const Qe=o=>{switch(o){case"ACTIVE":return"success";case"SUSPENDED":return"warning";case"EXPIRED":return"error";case"PENDING":return"info";default:return"default"}},Je=o=>{switch(o){case"ACTIVE":return e.jsx(Q,{});case"SUSPENDED":return e.jsx(J,{});case"EXPIRED":return e.jsx(Oe,{});case"PENDING":return e.jsx(J,{});default:return e.jsx(Q,{})}},Ye=o=>{switch(o){case"BASIC":return"default";case"PRO":return"success";case"ENTERPRISE":return"secondary";default:return"default"}},Ze=o=>o==="BASIC"?"outlined":"filled",us=()=>{const{enqueueSnackbar:o}=_e(),{user:t,getTempCredentials:Y}=ge(),[es,N]=u.useState(!1),[h,B]=u.useState([]),[W,R]=u.useState(null),[r,V]=u.useState(null),[Z,P]=u.useState(!1),[j,O]=u.useState(""),[E,ee]=u.useState(""),[p,se]=u.useState(!1),k=()=>!0;u.useEffect(()=>{let s=!0;return(async()=>{try{N(!0);const F=String((t==null?void 0:t.role)||"").toUpperCase()==="SUPERADMIN";let A=[];if(k()){console.log("ðŸ” [LicensesPage] WebOnly mode - fetching licenses from Firestore");const i=await g.isFirebaseAuthAuthenticated(),f=await g.getCurrentFirebaseUser();console.log(`ðŸ” [LicensesPage] Firebase Auth status: ${i?"Authenticated":"Not authenticated"}`),f&&console.log(`ðŸ” [LicensesPage] Firebase Auth user: ${f.uid} (${f.email})`);const a=Y();if(!i&&(t!=null&&t.email)){console.log("ðŸ”„ [LicensesPage] Not authenticated with Firebase Auth, attempting to create/sign in user...");try{const d=`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;await g.createFirebaseAuthUser(t.email,d)?(console.log("âœ… [LicensesPage] Successfully authenticated with Firebase Auth"),a&&(a.password=d)):console.warn("âš ï¸ [LicensesPage] Failed to authenticate with Firebase Auth")}catch(d){console.warn("âš ï¸ [LicensesPage] Error during Firebase Auth setup:",d)}}if(F)A=await g.getAllLicenses(200,a==null?void 0:a.email,a==null?void 0:a.password);else{const d=[];if(t!=null&&t.id)try{const n=await g.getMyLicenses(t.id,a==null?void 0:a.email,a==null?void 0:a.password);d.push(...n),console.log(`âœ… [LicensesPage] Found ${n.length} licenses by backend userId`)}catch(n){console.warn("âš ï¸ [LicensesPage] Failed to fetch licenses by backend userId:",n)}if(d.length===0&&(f!=null&&f.uid))try{const n=await g.getLicensesByFirebaseUid(f.uid);d.push(...n),console.log(`âœ… [LicensesPage] Found ${n.length} licenses by Firebase Auth UID`)}catch(n){console.warn("âš ï¸ [LicensesPage] Failed to fetch licenses by Firebase Auth UID:",n)}if(t!=null&&t.email)try{const n=await g.getLicensesByEmail(t.email);d.push(...n),console.log(`âœ… [LicensesPage] Found ${n.length} licenses by email`)}catch(n){console.warn("âš ï¸ [LicensesPage] Failed to fetch licenses by email:",n)}if(t!=null&&t.organizationId)try{const n=await g.getOrganizationLicenses(t.organizationId,a==null?void 0:a.email,a==null?void 0:a.password);d.push(...n),console.log(`âœ… [LicensesPage] Found ${n.length} organization licenses`)}catch(n){console.warn("âš ï¸ [LicensesPage] Failed to fetch organization licenses:",n)}if(A=d.filter((n,D,M)=>D===M.findIndex(b=>b.id===n.id)),console.log(`âœ… [LicensesPage] Total unique licenses found: ${A.length}`),A.length===0)try{console.log("ðŸ”„ [LicensesPage] No licenses found with individual queries, trying fallback method...");const n=await g.getAllAccessibleLicenses(a==null?void 0:a.email,a==null?void 0:a.password);A=n,console.log(`âœ… [LicensesPage] Fallback method found ${n.length} licenses`)}catch(n){console.warn("âš ï¸ [LicensesPage] Fallback method also failed:",n)}}}const de=await Promise.all(A.map(async(i,f)=>{var D,M;let a=null;if(k()&&(i.assignedToUserId||i.userId)){const b=i.assignedToUserId||i.userId;b&&(a=await g.getUserInfo(b))}const d=!!(i.assignedToEmail||i.assignedToUserId);let S="";if(d&&(!(a!=null&&a.name)||(a==null?void 0:a.name)==="Unknown User")&&i.assignedToEmail)try{const{db:b}=await me(async()=>{const{db:L}=await import("./firebase-oXISLbBI.js");return{db:L}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])),ue=qe(Ge(b,"teamMembers"),He("email","==",i.assignedToEmail),Ke(1)),q=await Xe(ue);if(!q.empty){const L=q.docs[0].data();L.name?S=L.name:(L.firstName||L.lastName)&&(S=`${L.firstName||""} ${L.lastName||""}`.trim())}}catch(b){console.warn("âš ï¸ [LicensesPage] Failed to fetch team member info:",b)}const n=S||(a==null?void 0:a.name)||((D=i.user)==null?void 0:D.name)||"Unknown User";return{id:i.id,key:i.key||i.id,name:d&&n!=="Unknown User"?`${n}'s License`:`License ${f+1}`,tier:String(i.tier||i.type||"BASIC").toUpperCase(),status:String(i.status||"ACTIVE").toUpperCase(),assignedTo:d?{name:n,email:(a==null?void 0:a.email)||((M=i.user)==null?void 0:M.email)||i.assignedToEmail||""}:void 0,activatedAt:i.activatedAt||i.createdAt||void 0,expiresAt:i.expiresAt||i.currentPeriodEnd||new Date(Date.now()+365*24*3600*1e3).toISOString(),lastUsed:i.updatedAt||i.activatedAt||i.createdAt||void 0,deviceCount:i.activationCount??0,maxDevices:i.maxActivations??5,usage:{apiCalls:0,dataTransfer:0}}}));if(!s)return;B(de)}catch(c){if(!s)return;o((c==null?void 0:c.message)||"Failed to load licenses",{variant:"error"}),B([])}finally{s&&N(!1)}})(),()=>{s=!1}},[t==null?void 0:t.role,o]);const ae=(s,c)=>{R(s.currentTarget),V(c)},v=()=>{R(null),V(null)},ne=s=>{navigator.clipboard.writeText(s),o("License key copied to clipboard",{variant:"success"}),v()},ie=async()=>{if(r&&j)try{if(h.find(c=>{var F;return((F=c.assignedTo)==null?void 0:F.email)===j&&c.id!==r.id})){o(`User ${j} already has a license assigned. Please unassign it first.`,{variant:"error"});return}k()&&g?await g.assignLicense(r.id,j):await he.post(`${xe.licenses.assign(r.id)}`,{email:j}),o(`License assigned to ${j}`,{variant:"success"}),P(!1),O(""),v(),setTimeout(()=>{window.location.reload()},1e3)}catch(s){o(s.message||"Failed to assign license",{variant:"error"})}},te=()=>{r&&(o("License suspended",{variant:"warning"}),v())},oe=()=>{r&&(o("License activated",{variant:"success"}),v())},re=async()=>{if(r&&r.assignedTo)try{k()&&g&&(await g.unassignLicense(r.id),o(`License unassigned from ${r.assignedTo.email}`,{variant:"success"}),v(),setTimeout(()=>{window.location.reload()},1e3))}catch(s){o(s.message||"Failed to unassign license",{variant:"error"})}},ce=h.filter(s=>p?!0:s.assignedTo).filter(s=>{var c;return s.name.toLowerCase().includes(E.toLowerCase())||s.key.toLowerCase().includes(E.toLowerCase())||(((c=s.assignedTo)==null?void 0:c.email)||"").toLowerCase().includes(E.toLowerCase())}),_=u.useMemo(()=>h.filter(s=>s.status==="ACTIVE").length,[h]),T=u.useMemo(()=>h.filter(s=>!!s.assignedTo).length,[h]),$=u.useMemo(()=>h.filter(s=>s.status==="ACTIVE"&&!s.assignedTo).length,[h]),z=u.useMemo(()=>p?h.length:h.filter(s=>!!s.assignedTo).length,[h,p]),le=u.useMemo(()=>{const s=h.filter(c=>c.status==="ACTIVE").length;return s<=0?0:Math.round(T/s*100)},[h,T]);return u.useEffect(()=>{console.log(`[LicensesPage] Metrics updated: Total=${z}, Assigned=${T}, Available=${$}, Active=${_}`)},[z,T,$,_]),e.jsxs(x,{children:[e.jsx(x,{children:e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4},children:[e.jsxs(x,{children:[e.jsx(m,{variant:"h4",sx:{fontWeight:700,mb:1},children:"License Management"}),e.jsx(m,{variant:"h6",color:"text.secondary",sx:{mb:4},children:"Manage and monitor your BackboneLogic, Inc. licenses"})]}),e.jsx(I,{variant:"contained",startIcon:e.jsx(fe,{}),sx:{background:"linear-gradient(135deg, #00d4ff 0%, #667eea 100%)",color:"#000",fontWeight:600},children:"Add License"})]})}),e.jsxs(C,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(C,{item:!0,xs:12,sm:6,md:3,children:e.jsx(U,{title:"Assigned Licenses",value:T,icon:e.jsx(je,{}),color:"primary",tooltip:"Number of licenses assigned to team members"})}),e.jsx(C,{item:!0,xs:12,sm:6,md:3,children:e.jsx(U,{title:"Available Licenses",value:$,icon:e.jsx(pe,{}),color:"success",tooltip:"Number of active licenses that are not assigned to anyone"})}),e.jsx(C,{item:!0,xs:12,sm:6,md:3,children:e.jsx(U,{title:"Utilization Rate",value:`${le}%`,icon:e.jsx(be,{}),color:"secondary",tooltip:"Percentage of active licenses that are assigned"})}),e.jsx(C,{item:!0,xs:12,sm:6,md:3,children:e.jsx(U,{title:p?"Total Licenses":"Total Assigned",value:z,icon:e.jsx(Le,{}),color:"warning",tooltip:p?"Total number of licenses":"Total number of assigned licenses"})})]}),e.jsx(x,{children:e.jsx(G,{sx:{p:3,mb:3,background:"linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255,255,255,0.1)"},children:e.jsxs(x,{sx:{display:"flex",gap:2,alignItems:"center"},children:[e.jsx(H,{placeholder:"Search licenses...",value:E,onChange:s=>ee(s.target.value),size:"small",sx:{flex:1},InputProps:{startAdornment:e.jsx(we,{sx:{color:"text.secondary",mr:1}})}}),e.jsx(I,{variant:p?"contained":"outlined",onClick:()=>se(!p),size:"small",sx:{whiteSpace:"nowrap"},children:p?"Hide Unassigned":"Show Unassigned"}),e.jsx(I,{variant:"outlined",startIcon:e.jsx(ye,{}),sx:{whiteSpace:"nowrap"},children:"Filters"})]})})}),e.jsx(x,{children:e.jsx(ve,{component:G,sx:{background:"linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255,255,255,0.1)"},children:e.jsxs(Ae,{children:[e.jsx(Te,{children:e.jsxs(K,{children:[e.jsx(l,{sx:{fontWeight:600},children:"License"}),e.jsx(l,{sx:{fontWeight:600},children:"Assigned To"}),e.jsx(l,{sx:{fontWeight:600},children:"Status"}),e.jsx(l,{sx:{fontWeight:600},children:"Tier"}),e.jsx(l,{sx:{fontWeight:600},children:"Devices"}),e.jsx(l,{sx:{fontWeight:600},children:"Usage"}),e.jsx(l,{sx:{fontWeight:600},children:"Expires"}),e.jsx(l,{sx:{fontWeight:600},children:"Actions"})]})}),e.jsx(Se,{children:ce.map(s=>e.jsxs(K,{hover:!0,children:[e.jsx(l,{children:e.jsxs(x,{children:[e.jsx(m,{variant:"body2",sx:{fontWeight:500},children:s.name}),e.jsx(m,{variant:"caption",color:"text.secondary",sx:{fontFamily:"monospace"},children:s.key})]})}),e.jsx(l,{children:s.assignedTo?e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ie,{sx:{width:32,height:32,fontSize:"0.875rem"},children:s.assignedTo.name[0]}),e.jsxs(x,{children:[e.jsx(m,{variant:"body2",sx:{fontWeight:500},children:s.assignedTo.name}),e.jsx(m,{variant:"caption",color:"text.secondary",children:s.assignedTo.email})]})]}):e.jsx(m,{variant:"body2",color:"text.secondary",children:"Unassigned"})}),e.jsx(l,{children:e.jsx(X,{icon:Je(s.status),label:s.status,color:Qe(s.status),size:"small",sx:{fontWeight:500}})}),e.jsx(l,{children:e.jsx(X,{label:s.tier,color:Ye(s.tier),size:"small",variant:Ze(s.tier)})}),e.jsx(l,{children:e.jsxs(x,{children:[e.jsxs(m,{variant:"body2",children:[s.deviceCount,"/",s.maxDevices]}),e.jsx(Ce,{variant:"determinate",value:s.deviceCount/s.maxDevices*100,sx:{width:80,height:4,borderRadius:2,backgroundColor:"rgba(255,255,255,0.1)","& .MuiLinearProgress-bar":{borderRadius:2}}})]})}),e.jsx(l,{children:e.jsxs(x,{children:[e.jsxs(m,{variant:"body2",children:[s.usage.apiCalls.toLocaleString()," calls"]}),e.jsxs(m,{variant:"caption",color:"text.secondary",children:[s.usage.dataTransfer," GB"]})]})}),e.jsx(l,{children:e.jsx(m,{variant:"body2",children:new Date(s.expiresAt).toLocaleDateString()})}),e.jsx(l,{children:e.jsx(Pe,{onClick:c=>ae(c,s),size:"small",children:e.jsx(Ee,{})})})]},s.id))})]})})}),e.jsxs(ke,{anchorEl:W,open:!!W,onClose:v,PaperProps:{sx:{backgroundColor:"background.paper",border:"1px solid rgba(255, 255, 255, 0.1)"}},children:[e.jsxs(w,{onClick:()=>r&&ne(r.key),children:[e.jsx(y,{children:e.jsx(Fe,{fontSize:"small"})}),"Copy License Key"]}),r!=null&&r.assignedTo?e.jsxs(w,{onClick:re,children:[e.jsx(y,{children:e.jsx(De,{fontSize:"small"})}),"Unassign License"]}):e.jsxs(w,{onClick:()=>P(!0),children:[e.jsx(y,{children:e.jsx(Me,{fontSize:"small"})}),"Assign License"]}),e.jsxs(w,{onClick:()=>{},children:[e.jsx(y,{children:e.jsx(Ue,{fontSize:"small"})}),"Edit License"]}),(r==null?void 0:r.status)==="ACTIVE"?e.jsxs(w,{onClick:te,children:[e.jsx(y,{children:e.jsx($e,{fontSize:"small"})}),"Suspend License"]}):e.jsxs(w,{onClick:oe,children:[e.jsx(y,{children:e.jsx(ze,{fontSize:"small"})}),"Activate License"]}),e.jsxs(w,{onClick:()=>{},children:[e.jsx(y,{children:e.jsx(Ne,{fontSize:"small"})}),"Download Details"]})]}),e.jsxs(Be,{open:Z,onClose:()=>P(!1),PaperProps:{sx:{backgroundColor:"background.paper",border:"1px solid rgba(255, 255, 255, 0.1)"}},children:[e.jsx(We,{children:"Assign License"}),e.jsx(Re,{children:e.jsx(H,{autoFocus:!0,margin:"dense",label:"Email Address",type:"email",fullWidth:!0,variant:"outlined",value:j,onChange:s=>O(s.target.value),sx:{mt:2}})}),e.jsxs(Ve,{children:[e.jsx(I,{onClick:()=>P(!1),children:"Cancel"}),e.jsx(I,{onClick:ie,variant:"contained",disabled:!j,children:"Assign"})]})]})]})};export{us as default};
