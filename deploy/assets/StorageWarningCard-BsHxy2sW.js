import{j as e,z as D,J as E,a as u,aL as G,T as n,m as k,I as R,bo as M,ab as Q,a1 as q,A as $,aE as Y,aS as _,bj as H,d as y,bp as J,aj as z,bq as V,S as K,D as X,k as Z,l as ee,n as ae,v as te}from"./mui-CWufCee_.js";import{r as l}from"./vendor-OeuszDaU.js";import{c as b,e as re,u as se}from"./index-mGe2W2rA.js";const P={warning:.85,critical:.95,emergency:.98},T={free:{tier:"free",maxCollaborators:2,allowedStorageBackends:["firestore"],maxStorageQuota:1,storageWarningEnabled:!0,additionalStorageAvailable:!1,features:{cloudStorage:!0,localStorage:!1,encryption:!1,backup:!1,analytics:!1,customSchemas:!1}},pro:{tier:"pro",maxCollaborators:10,allowedStorageBackends:["firestore","gcs","s3"],maxStorageQuota:50,storageWarningEnabled:!0,additionalStorageAvailable:!0,additionalStoragePrice:.1,features:{cloudStorage:!0,localStorage:!0,encryption:!0,backup:!0,analytics:!0,customSchemas:!0}},enterprise:{tier:"enterprise",maxCollaborators:-1,allowedStorageBackends:["firestore","gcs","s3","aws","azure","local"],maxStorageQuota:-1,storageWarningEnabled:!1,additionalStorageAvailable:!0,additionalStoragePrice:.08,features:{cloudStorage:!0,localStorage:!0,encryption:!0,backup:!0,analytics:!0,customSchemas:!0}},"on-premises":{tier:"on-premises",maxCollaborators:-1,allowedStorageBackends:["local","private-cloud"],maxStorageQuota:-1,storageWarningEnabled:!1,additionalStorageAvailable:!1,features:{cloudStorage:!1,localStorage:!0,encryption:!0,backup:!0,analytics:!0,customSchemas:!0}}};class j{static async getStorageUsage(t){var s,o,a,c;try{const[m,w]=await Promise.all([b.get(re.subscriptions.mySubscriptions()),b.get("storage/usage")]),f=((o=(s=m.data)==null?void 0:s.data)==null?void 0:o.subscriptions)||[],p=f.find(v=>v.status==="ACTIVE")||f[0],h=((a=p==null?void 0:p.tier)==null?void 0:a.toLowerCase())||"free",x=T[h],d=(((c=w.data)==null?void 0:c.data)||{used:0,breakdown:{}}).used/(1024*1024*1024),i=x.maxStorageQuota;let g=0,S="none";return i>0&&(g=d/i*100,g>=P.emergency*100?S="emergency":g>=P.critical*100?S="critical":g>=P.warning*100&&(S="warning")),{used:Math.round(d*100)/100,limit:i,percentage:Math.round(g*100)/100,tier:h,warningLevel:S,canPurchaseAdditional:x.additionalStorageAvailable||!1,additionalStoragePrice:x.additionalStoragePrice}}catch(m){return console.error("Failed to fetch storage usage:",m),{used:0,limit:1,percentage:0,tier:"free",warningLevel:"none",canPurchaseAdditional:!1}}}static async getStorageBreakdown(){var t;try{const o=((t=(await b.get("storage/breakdown")).data)==null?void 0:t.data)||{};return{firestore:o.firestore||0,gcs:o.gcs||0,s3:o.s3||0,azure:o.azure||0,local:o.local||0,total:o.total||0}}catch(s){return console.error("Failed to fetch storage breakdown:",s),{firestore:0,gcs:0,s3:0,azure:0,local:0,total:0}}}static generateStorageAlerts(t){const s=[];if(t.warningLevel==="none"||t.limit===-1)return s;const o={id:`storage-${t.warningLevel}-${Date.now()}`,timestamp:new Date,canUpgrade:t.tier!=="enterprise",canPurchaseStorage:t.canPurchaseAdditional};switch(t.warningLevel){case"warning":s.push({...o,type:"warning",title:"Storage Usage Warning",message:`You're using ${t.percentage}% of your ${t.limit}GB storage limit. Consider upgrading your plan or purchasing additional storage.`,actionRequired:!1});break;case"critical":s.push({...o,type:"critical",title:"Critical Storage Usage",message:`You're using ${t.percentage}% of your ${t.limit}GB storage limit. Your account may be restricted soon. Please upgrade or purchase additional storage immediately.`,actionRequired:!0});break;case"emergency":s.push({...o,type:"emergency",title:"Storage Limit Almost Reached",message:`URGENT: You're using ${t.percentage}% of your ${t.limit}GB storage limit. New uploads will be blocked soon. Upgrade your plan or purchase additional storage now.`,actionRequired:!0});break}return s}static getUpgradeRecommendations(t){const s=[];return t.tier==="free"?s.push({tier:"pro",storageLimit:50,price:"$29/month",recommended:t.used>.8},{tier:"enterprise",storageLimit:-1,price:"Contact Sales",recommended:t.used>40}):t.tier==="pro"&&s.push({tier:"enterprise",storageLimit:-1,price:"Contact Sales",recommended:t.percentage>80}),s}static calculateAdditionalStorageCost(t,s){const o=T[s];return!o.additionalStorageAvailable||!o.additionalStoragePrice?0:t*o.additionalStoragePrice}static async purchaseAdditionalStorage(t){var s,o,a;try{return{success:!0,paymentUrl:(s=(await b.post("storage/purchase",{additionalGB:t})).data)==null?void 0:s.paymentUrl}}catch(c){return{success:!1,error:((a=(o=c.response)==null?void 0:o.data)==null?void 0:a.message)||"Failed to initiate storage purchase"}}}}const le=({onUpgrade:L,onPurchaseStorage:t,compact:s=!1})=>{const{user:o}=se(),[a,c]=l.useState(null),[m,w]=l.useState([]),[f,p]=l.useState(!0),[h,x]=l.useState(!1),[B,d]=l.useState(!1),[i,g]=l.useState(10),[S,v]=l.useState(new Set);l.useEffect(()=>{I();const r=setInterval(I,5*60*1e3);return()=>clearInterval(r)},[o]);const I=async()=>{try{p(!0);const r=await j.getStorageUsage();c(r);const A=j.generateStorageAlerts(r);w(A)}catch(r){console.error("Failed to fetch storage data:",r)}finally{p(!1)}},F=r=>{v(A=>new Set([...A,r]))},W=async()=>{if(t)t(i);else try{const r=await j.purchaseAdditionalStorage(i);r.success&&r.paymentUrl&&window.open(r.paymentUrl,"_blank")}catch(r){console.error("Failed to purchase storage:",r)}d(!1)},U=r=>{switch(r){case"emergency":return"error";case"critical":return"error";case"warning":return"warning";default:return"primary"}},N=r=>{switch(r){case"emergency":return"error";case"critical":return"error";case"warning":return"warning";default:return"info"}};if(f||!a)return e.jsx(D,{children:e.jsx(E,{children:e.jsxs(u,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(G,{}),e.jsx(n,{variant:"h6",children:"Loading storage usage..."})]})})});if(a.limit===-1&&m.length===0)return null;const O=m.filter(r=>!S.has(r.id)),C=a.additionalStoragePrice?j.calculateAdditionalStorageCost(i,a.tier):0;return e.jsxs(e.Fragment,{children:[e.jsx(D,{sx:{mb:2},children:e.jsxs(E,{children:[e.jsxs(u,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,children:[e.jsxs(u,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(G,{color:a.warningLevel!=="none"?"warning":"primary"}),e.jsx(n,{variant:"h6",children:"Cloud Storage Usage"}),a.warningLevel!=="none"&&e.jsx(k,{label:a.warningLevel.toUpperCase(),color:U(a.warningLevel),size:"small"})]}),e.jsx(R,{onClick:()=>x(!h),size:"small",children:h?e.jsx(M,{}):e.jsx(Q,{})})]}),e.jsxs(u,{mb:2,children:[e.jsxs(u,{display:"flex",justifyContent:"space-between",mb:1,children:[e.jsxs(n,{variant:"body2",color:"textSecondary",children:[a.used,"GB used"]}),e.jsx(n,{variant:"body2",color:"textSecondary",children:a.limit===-1?"Unlimited":`${a.limit}GB limit`})]}),a.limit>0&&e.jsx(q,{variant:"determinate",value:Math.min(a.percentage,100),color:U(a.warningLevel),sx:{height:8,borderRadius:4}}),a.limit>0&&e.jsxs(n,{variant:"caption",color:"textSecondary",sx:{mt:.5,display:"block"},children:[a.percentage,"% used"]})]}),O.map(r=>e.jsxs($,{severity:N(r.type),sx:{mb:1},action:e.jsx(R,{size:"small",onClick:()=>F(r.id),children:e.jsx(_,{fontSize:"small"})}),children:[e.jsx(Y,{children:r.title}),r.message]},r.id)),(a.warningLevel!=="none"||!s)&&e.jsx(u,{mt:2,children:e.jsxs(H,{variant:"outlined",size:"small",fullWidth:!0,children:[a.tier!=="enterprise"&&e.jsx(y,{startIcon:e.jsx(J,{}),onClick:L,color:"primary",children:"Upgrade Plan"}),a.canPurchaseAdditional&&e.jsx(y,{startIcon:e.jsx(z,{}),onClick:()=>d(!0),color:"secondary",children:"Buy Storage"})]})}),e.jsx(V,{in:h,children:e.jsxs(u,{mt:2,pt:2,borderTop:1,borderColor:"divider",children:[e.jsxs(n,{variant:"subtitle2",gutterBottom:!0,children:["Current Plan: ",a.tier.toUpperCase()]}),a.additionalStoragePrice&&e.jsxs(n,{variant:"body2",color:"textSecondary",children:["Additional storage: $",a.additionalStoragePrice,"/GB/month"]}),e.jsxs(K,{direction:"row",spacing:1,mt:1,children:[e.jsx(k,{label:`${a.tier} tier`,size:"small"}),a.canPurchaseAdditional&&e.jsx(k,{label:"Storage expansion available",size:"small",color:"primary"})]})]})})]})}),e.jsxs(X,{open:B,onClose:()=>d(!1),children:[e.jsx(Z,{children:"Purchase Additional Storage"}),e.jsxs(ee,{children:[e.jsxs(n,{variant:"body2",color:"textSecondary",sx:{mb:2},children:["Add more cloud storage to your ",a.tier," plan."]}),e.jsx(ae,{label:"Additional Storage (GB)",type:"number",value:i,onChange:r=>g(Math.max(1,parseInt(r.target.value)||1)),fullWidth:!0,sx:{mb:2},inputProps:{min:1,max:1e3}}),C>0&&e.jsx($,{severity:"info",children:e.jsxs(n,{variant:"body2",children:["Cost: $",C.toFixed(2),"/month for ",i,"GB"]})})]}),e.jsxs(te,{children:[e.jsx(y,{onClick:()=>d(!1),children:"Cancel"}),e.jsxs(y,{onClick:W,variant:"contained",startIcon:e.jsx(z,{}),children:["Purchase $",C.toFixed(2),"/month"]})]})]})]})};export{le as S};
