import{j as e,z as B,J as I,a as g,aL as U,T as l,m as C,I as D,bp as M,ab as Q,a1 as q,A as E,aE as Y,aS as _,bk as H,d as y,bq as J,aj as G,br as V,S as K,D as X,k as Z,l as ee,n as ae,v as te}from"./mui-Ilj8o9AZ.js";import{r as d}from"./vendor-OeuszDaU.js";import{c as $,e as re,u as se}from"./index-tsOIn16f.js";const A={warning:.85,critical:.95,emergency:.98},z={free:{tier:"free",maxCollaborators:2,allowedStorageBackends:["firestore"],maxStorageQuota:1,storageWarningEnabled:!0,additionalStorageAvailable:!1,features:{cloudStorage:!0,localStorage:!1,encryption:!1,backup:!1,analytics:!1,customSchemas:!1}},pro:{tier:"pro",maxCollaborators:10,allowedStorageBackends:["firestore","gcs","s3"],maxStorageQuota:50,storageWarningEnabled:!0,additionalStorageAvailable:!0,additionalStoragePrice:.1,features:{cloudStorage:!0,localStorage:!0,encryption:!0,backup:!0,analytics:!0,customSchemas:!0}},enterprise:{tier:"enterprise",maxCollaborators:-1,allowedStorageBackends:["firestore","gcs","s3","aws","azure","local"],maxStorageQuota:-1,storageWarningEnabled:!1,additionalStorageAvailable:!0,additionalStoragePrice:.08,features:{cloudStorage:!0,localStorage:!0,encryption:!0,backup:!0,analytics:!0,customSchemas:!0}},"on-premises":{tier:"on-premises",maxCollaborators:-1,allowedStorageBackends:["local","private-cloud"],maxStorageQuota:-1,storageWarningEnabled:!1,additionalStorageAvailable:!1,features:{cloudStorage:!1,localStorage:!0,encryption:!0,backup:!0,analytics:!0,customSchemas:!0}}};class b{static async getStorageUsage(a){var s,o,t;try{const[c]=await Promise.all([$.get(re.subscriptions.mySubscriptions())]),m=((o=(s=c.data)==null?void 0:s.data)==null?void 0:o.subscriptions)||[],p=m.find(j=>j.status==="ACTIVE")||m[0],S=((t=p==null?void 0:p.tier)==null?void 0:t.toLowerCase())||"free",u=z[S],f={used:.5,breakdown:{}}.used,h=u.maxStorageQuota;let i=0,n="none";return h>0&&(i=f/h*100,i>=A.emergency*100?n="emergency":i>=A.critical*100?n="critical":i>=A.warning*100&&(n="warning")),{used:Math.round(f*100)/100,limit:h,percentage:Math.round(i*100)/100,tier:S,warningLevel:n,canPurchaseAdditional:u.additionalStorageAvailable||!1,additionalStoragePrice:u.additionalStoragePrice}}catch(c){return console.error("Failed to fetch storage usage:",c),{used:0,limit:1,percentage:0,tier:"free",warningLevel:"none",canPurchaseAdditional:!1}}}static async getStorageBreakdown(){try{const a={firestore:.3,gcs:.1,s3:.05,azure:.02,local:.03,total:.5};return{firestore:a.firestore,gcs:a.gcs,s3:a.s3,azure:a.azure,local:a.local,total:a.total}}catch(a){return console.error("Failed to fetch storage breakdown:",a),{firestore:0,gcs:0,s3:0,azure:0,local:0,total:0}}}static generateStorageAlerts(a){const s=[];if(a.warningLevel==="none"||a.limit===-1)return s;const o={id:`storage-${a.warningLevel}-${Date.now()}`,timestamp:new Date,canUpgrade:a.tier!=="enterprise",canPurchaseStorage:a.canPurchaseAdditional};switch(a.warningLevel){case"warning":s.push({...o,type:"warning",title:"Storage Usage Warning",message:`You're using ${a.percentage}% of your ${a.limit}GB storage limit. Consider upgrading your plan or purchasing additional storage.`,actionRequired:!1});break;case"critical":s.push({...o,type:"critical",title:"Critical Storage Usage",message:`You're using ${a.percentage}% of your ${a.limit}GB storage limit. Your account may be restricted soon. Please upgrade or purchase additional storage immediately.`,actionRequired:!0});break;case"emergency":s.push({...o,type:"emergency",title:"Storage Limit Almost Reached",message:`URGENT: You're using ${a.percentage}% of your ${a.limit}GB storage limit. New uploads will be blocked soon. Upgrade your plan or purchase additional storage now.`,actionRequired:!0});break}return s}static getUpgradeRecommendations(a){const s=[];return a.tier==="free"?s.push({tier:"pro",storageLimit:50,price:"$29/month",recommended:a.used>.8},{tier:"enterprise",storageLimit:-1,price:"Contact Sales",recommended:a.used>40}):a.tier==="pro"&&s.push({tier:"enterprise",storageLimit:-1,price:"Contact Sales",recommended:a.percentage>80}),s}static calculateAdditionalStorageCost(a,s){const o=z[s];return!o.additionalStorageAvailable||!o.additionalStoragePrice?0:a*o.additionalStoragePrice}static async purchaseAdditionalStorage(a){var s,o,t;try{return{success:!0,paymentUrl:(s=(await $.post("storage/purchase",{additionalGB:a})).data)==null?void 0:s.paymentUrl}}catch(c){return{success:!1,error:((t=(o=c.response)==null?void 0:o.data)==null?void 0:t.message)||"Failed to initiate storage purchase"}}}}const le=({onUpgrade:k,onPurchaseStorage:a,compact:s=!1})=>{const{user:o}=se(),[t,c]=d.useState(null),[m,p]=d.useState([]),[S,u]=d.useState(!0),[x,f]=d.useState(!1),[h,i]=d.useState(!1),[n,j]=d.useState(10),[R,T]=d.useState(new Set);d.useEffect(()=>{P();const r=setInterval(P,5*60*1e3);return()=>clearInterval(r)},[o]);const P=async()=>{try{u(!0);const r=await b.getStorageUsage();c(r);const v=b.generateStorageAlerts(r);p(v)}catch(r){console.error("Failed to fetch storage data:",r)}finally{u(!1)}},F=r=>{T(v=>new Set([...v,r]))},W=async()=>{if(a)a(n);else try{const r=await b.purchaseAdditionalStorage(n);r.success&&r.paymentUrl&&window.open(r.paymentUrl,"_blank")}catch(r){console.error("Failed to purchase storage:",r)}i(!1)},L=r=>{switch(r){case"emergency":return"error";case"critical":return"error";case"warning":return"warning";default:return"primary"}},N=r=>{switch(r){case"emergency":return"error";case"critical":return"error";case"warning":return"warning";default:return"info"}};if(S||!t)return e.jsx(B,{children:e.jsx(I,{children:e.jsxs(g,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(U,{}),e.jsx(l,{variant:"h6",children:"Loading storage usage..."})]})})});if(t.limit===-1&&m.length===0)return null;const O=m.filter(r=>!R.has(r.id)),w=t.additionalStoragePrice?b.calculateAdditionalStorageCost(n,t.tier):0;return e.jsxs(e.Fragment,{children:[e.jsx(B,{sx:{mb:2},children:e.jsxs(I,{children:[e.jsxs(g,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,children:[e.jsxs(g,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(U,{color:t.warningLevel!=="none"?"warning":"primary"}),e.jsx(l,{variant:"h6",children:"Cloud Storage Usage"}),t.warningLevel!=="none"&&e.jsx(C,{label:t.warningLevel.toUpperCase(),color:L(t.warningLevel),size:"small"})]}),e.jsx(D,{onClick:()=>f(!x),size:"small",children:x?e.jsx(M,{}):e.jsx(Q,{})})]}),e.jsxs(g,{mb:2,children:[e.jsxs(g,{display:"flex",justifyContent:"space-between",mb:1,children:[e.jsxs(l,{variant:"body2",color:"textSecondary",children:[t.used,"GB used"]}),e.jsx(l,{variant:"body2",color:"textSecondary",children:t.limit===-1?"Unlimited":`${t.limit}GB limit`})]}),t.limit>0&&e.jsx(q,{variant:"determinate",value:Math.min(t.percentage,100),color:L(t.warningLevel),sx:{height:8,borderRadius:4}}),t.limit>0&&e.jsxs(l,{variant:"caption",color:"textSecondary",sx:{mt:.5,display:"block"},children:[t.percentage,"% used"]})]}),O.map(r=>e.jsxs(E,{severity:N(r.type),sx:{mb:1},action:e.jsx(D,{size:"small",onClick:()=>F(r.id),children:e.jsx(_,{fontSize:"small"})}),children:[e.jsx(Y,{children:r.title}),r.message]},r.id)),(t.warningLevel!=="none"||!s)&&e.jsx(g,{mt:2,children:e.jsxs(H,{variant:"outlined",size:"small",fullWidth:!0,children:[t.tier!=="enterprise"&&e.jsx(y,{startIcon:e.jsx(J,{}),onClick:k,color:"primary",children:"Upgrade Plan"}),t.canPurchaseAdditional&&e.jsx(y,{startIcon:e.jsx(G,{}),onClick:()=>i(!0),color:"secondary",children:"Buy Storage"})]})}),e.jsx(V,{in:x,children:e.jsxs(g,{mt:2,pt:2,borderTop:1,borderColor:"divider",children:[e.jsxs(l,{variant:"subtitle2",gutterBottom:!0,children:["Current Plan: ",t.tier.toUpperCase()]}),t.additionalStoragePrice&&e.jsxs(l,{variant:"body2",color:"textSecondary",children:["Additional storage: $",t.additionalStoragePrice,"/GB/month"]}),e.jsxs(K,{direction:"row",spacing:1,mt:1,children:[e.jsx(C,{label:`${t.tier} tier`,size:"small"}),t.canPurchaseAdditional&&e.jsx(C,{label:"Storage expansion available",size:"small",color:"primary"})]})]})})]})}),e.jsxs(X,{open:h,onClose:()=>i(!1),children:[e.jsx(Z,{children:"Purchase Additional Storage"}),e.jsxs(ee,{children:[e.jsxs(l,{variant:"body2",color:"textSecondary",sx:{mb:2},children:["Add more cloud storage to your ",t.tier," plan."]}),e.jsx(ae,{label:"Additional Storage (GB)",type:"number",value:n,onChange:r=>j(Math.max(1,parseInt(r.target.value)||1)),fullWidth:!0,sx:{mb:2},inputProps:{min:1,max:1e3}}),w>0&&e.jsx(E,{severity:"info",children:e.jsxs(l,{variant:"body2",children:["Cost: $",w.toFixed(2),"/month for ",n,"GB"]})})]}),e.jsxs(te,{children:[e.jsx(y,{onClick:()=>i(!1),children:"Cancel"}),e.jsxs(y,{onClick:W,variant:"contained",startIcon:e.jsx(G,{}),children:["Purchase $",w.toFixed(2),"/month"]})]})]})]})};export{le as S};
