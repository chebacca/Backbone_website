import{j as e,B as t,C as Pe,T as n,d as b,ai as z,w as Fe,x as ae,y as w,aj as Oe,z as ne,H as Be,a as m,aG as Ge,G as I,W as me,p as he,am as xe,u as te,t as $e,v as qe,aq as He,ar as Ue,as as Ke,at as ie,au as r,av as Ve,ag as _e,r as re,aX as Xe,g as Ye,aw as Je,ax as Qe,ap as Ze,ay as P,az as F,aB as O,e as L,aC as le,aD as oe,aE as ce,a5 as h,aF as B,n as es,aI as de,aH as G,a4 as ss,E as as,D as ns,aK as ts}from"./mui-CbRkNlUa.js";import{r as d,b as is}from"./vendor-CjD1bmmO.js";import{u as rs}from"./notistack.esm-Ca-E78ev.js";import{u as ls,a as os,c as cs,b as ds,j as ms,k as hs,l as xs,f as us,g as gs}from"./useStreamlinedData-Bdd22RXn.js";import{M as A}from"./MetricCard-BXzBKT3M.js";import"./UnifiedDataService-ZHK2Xm4H.js";import"./index-CPsV862a.js";import"./stripe-DmMyeq9m.js";import"./index.esm-DonjM_pP.js";import"./index.esm-D7ujsXeY.js";const js=i=>{switch(i){case"owner":return"error";case"admin":return"primary";case"manager":return"secondary";case"member":return"info";case"viewer":return"default";default:return"default"}},vs=i=>{switch(i){case"active":return"success";case"pending":return"warning";case"suspended":return"error";case"removed":return"default";default:return"default"}},fs=i=>{switch(i){case"active":return e.jsx(he,{});case"pending":return e.jsx(xe,{});case"suspended":return e.jsx(ts,{});case"removed":return e.jsx(G,{});default:return e.jsx(me,{})}},Ss=()=>{var se;const{enqueueSnackbar:i}=rs(),{data:l,loading:ue,error:ge}=ls(),{data:M,loading:je,error:ve}=os(),{data:v,loading:fe,error:be,refetch:T}=cs(),{data:g,loading:pe,error:ye,refetch:N}=ds(),Ce=ms(),we=hs();xs();const Ie=us();gs();const[Le,p]=d.useState(!1),[Me,D]=d.useState(!1),[Te,S]=d.useState(!1),[y,$]=d.useState(""),[q,H]=d.useState("member"),[U,K]=d.useState(""),[a,E]=d.useState(null),[V,_]=d.useState(null),[W,X]=d.useState(""),[R,Y]=d.useState(""),[J,Q]=d.useState("member"),[Z,ee]=d.useState(""),De=ue||je||fe||pe,Se=ge||ve||be||ye;is.useEffect(()=>{const s=async()=>{console.log("🔄 [TeamPage] License refresh event detected, refetching data..."),await Promise.all([N(),T()])};return window.addEventListener("licenses:refresh",s),()=>{window.removeEventListener("licenses:refresh",s)}},[N,T]);const o=d.useMemo(()=>{if(!l||!M||!v||!g)return{members:[],stats:{totalMembers:0,activeMembers:0,pendingInvites:0,availableLicenses:0,totalLicenses:0,assignedLicenses:0}};const s=v.filter(c=>c.status==="active").length,u=v.filter(c=>c.status==="pending").length,j=g.length,x=g.filter(c=>c.assignedTo).length,f=g.filter(c=>c.status==="PENDING"&&!c.assignedTo).length;console.log("📊 [TeamPage] License stats:",{totalLicenses:j,assignedLicenses:x,availableLicenses:f});const C={totalMembers:v.length,activeMembers:s,pendingInvites:u,availableLicenses:f,totalLicenses:j,assignedLicenses:x};return{members:v,stats:C}},[l,M,v,g]),Ee=(s,u)=>{E(u),_(s.currentTarget)},k=()=>{_(null),E(null)},ke=async()=>{var s,u,j;if(!y.trim()){i("Please enter an email address",{variant:"error"});return}if(o.stats.availableLicenses<=0){i("No available licenses. Please generate more licenses first.",{variant:"error"});return}try{const x={firstName:y.split("@")[0],lastName:"",email:y,role:q,status:"pending",organization:{id:((s=l==null?void 0:l.organization)==null?void 0:s.id)||"",name:((u=l==null?void 0:l.organization)==null?void 0:u.name)||"",tier:((j=l==null?void 0:l.organization)==null?void 0:j.tier)||"BASIC"},department:U||void 0,assignedProjects:[]},f=await Ce.mutate(x),C=g==null?void 0:g.find(c=>c.status==="PENDING"&&!c.assignedTo);if(C&&f)try{await Ie.mutate({licenseId:C.id,userId:f}),console.log("✅ [TeamPage] Auto-assigned license",C.id,"to new member",f)}catch(c){console.warn("⚠️ [TeamPage] Failed to auto-assign license:",c)}i(`Invitation sent to ${y} with license auto-assigned`,{variant:"success"}),$(""),H("member"),K(""),p(!1),await Promise.all([T(),N()])}catch(x){i((x==null?void 0:x.message)||"Failed to send invitation",{variant:"error"})}},Ae=()=>{a&&(X(a.firstName||""),Y(a.lastName||""),Q(a.role||"member"),ee(a.department||""),D(!0),k())},Ne=()=>{a&&(S(!0),k())},We=async()=>{if(a)try{i(`${a.firstName} ${a.lastName} has been removed from the team`,{variant:"success"}),S(!1),E(null)}catch(s){i((s==null?void 0:s.message)||"Failed to remove team member",{variant:"error"})}},Re=()=>{a&&(i(`Invitation resent to ${a.email}`,{variant:"success"}),k())},ze=async()=>{if(a)try{await we.mutate({memberId:a.id,updates:{firstName:W,lastName:R,role:J,department:Z}}),i(`Team member ${W} ${R} updated successfully`,{variant:"success"}),D(!1),E(null),T()}catch(s){i((s==null?void 0:s.message)||"Failed to update team member",{variant:"error"})}};return De?e.jsx(t,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(t,{textAlign:"center",children:[e.jsx(Pe,{size:60}),e.jsx(n,{variant:"h6",sx:{mt:2},children:"Loading Team Data..."}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Fetching your team members and organization details"})]})}):Se?e.jsx(t,{sx:{p:3},children:e.jsxs(b,{severity:"error",children:[e.jsx(z,{children:"Unable to Load Team Data"}),e.jsx(n,{variant:"body2",sx:{mb:2},children:"We encountered an issue loading your team information. This could be due to:"}),e.jsxs(Fe,{dense:!0,children:[e.jsxs(ae,{children:[e.jsx(w,{children:e.jsx(Oe,{fontSize:"small"})}),e.jsx(ne,{primary:"Network connectivity issues"})]}),e.jsxs(ae,{children:[e.jsx(w,{children:e.jsx(Be,{fontSize:"small"})}),e.jsx(ne,{primary:"Authentication token expired"})]})]}),e.jsx(t,{sx:{mt:2},children:e.jsx(m,{variant:"contained",onClick:()=>window.location.reload(),children:"Retry"})})]})}):!l||!M?e.jsx(t,{sx:{p:3},children:e.jsxs(b,{severity:"info",children:[e.jsx(z,{children:"Setting Up Team Management"}),e.jsx(n,{variant:"body2",children:"We're preparing your team management dashboard. This may take a moment for new accounts."})]})}):e.jsxs(t,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4},children:[e.jsxs(t,{children:[e.jsx(n,{variant:"h4",sx:{fontWeight:700,mb:1},children:"Team Management"}),e.jsxs(n,{variant:"body1",color:"text.secondary",children:["Manage your ",((se=M.organization)==null?void 0:se.name)||"Organization"," team members and permissions"]})]}),e.jsx(m,{variant:"contained",startIcon:e.jsx(Ge,{}),onClick:()=>p(!0),disabled:o.stats.availableLicenses<=0,sx:{background:"linear-gradient(135deg, #00d4ff 0%, #667eea 100%)",color:"#000",fontWeight:600},children:"Invite Member"})]}),e.jsxs(I,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(I,{item:!0,xs:12,sm:6,md:3,children:e.jsx(A,{title:"Total Members",value:o.stats.totalMembers,icon:e.jsx(me,{}),color:"primary"})}),e.jsx(I,{item:!0,xs:12,sm:6,md:3,children:e.jsx(A,{title:"Active Members",value:o.stats.activeMembers,icon:e.jsx(he,{}),color:"success"})}),e.jsx(I,{item:!0,xs:12,sm:6,md:3,children:e.jsx(A,{title:"Pending Invites",value:o.stats.pendingInvites,icon:e.jsx(xe,{}),color:"warning"})}),e.jsx(I,{item:!0,xs:12,sm:6,md:3,children:e.jsx(A,{title:"Available Licenses",value:`${o.stats.availableLicenses}/${o.stats.totalLicenses}`,icon:e.jsx(te,{}),color:"primary"})})]}),o.stats.availableLicenses<=0&&e.jsxs(b,{severity:"warning",sx:{mb:4},children:[e.jsx(z,{children:"No Available Licenses"}),e.jsx(n,{variant:"body2",sx:{mb:2},children:"You need to generate more licenses to invite new team members. Go to the Licenses page to create additional licenses."}),e.jsxs(t,{sx:{display:"flex",gap:2},children:[e.jsx(m,{variant:"contained",size:"small",onClick:()=>window.open("/dashboard/licenses","_blank"),children:"Generate Licenses"}),e.jsx(m,{variant:"outlined",size:"small",onClick:()=>window.open("/dashboard/billing","_blank"),children:"Upgrade Plan"})]})]}),e.jsx($e,{children:e.jsxs(qe,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(n,{variant:"h6",sx:{fontWeight:600},children:["Team Members (",o.members.length,")"]}),e.jsx(m,{variant:"outlined",startIcon:e.jsx(te,{}),onClick:()=>window.open("/dashboard/licenses","_blank"),children:"Manage Licenses"})]}),e.jsx(He,{children:e.jsxs(Ue,{children:[e.jsx(Ke,{children:e.jsxs(ie,{children:[e.jsx(r,{sx:{fontWeight:600},children:"Member"}),e.jsx(r,{sx:{fontWeight:600},children:"Role"}),e.jsx(r,{sx:{fontWeight:600},children:"Status"}),e.jsx(r,{sx:{fontWeight:600},children:"Department"}),e.jsx(r,{sx:{fontWeight:600},children:"License"}),e.jsx(r,{sx:{fontWeight:600},children:"Last Active"}),e.jsx(r,{sx:{fontWeight:600},children:"Actions"})]})}),e.jsx(Ve,{children:o.members.map(s=>{var u,j;return e.jsxs(ie,{hover:!0,children:[e.jsx(r,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsxs(_e,{src:s.avatar,sx:{width:40,height:40},children:[s.firstName.charAt(0),s.lastName.charAt(0)]}),e.jsxs(t,{children:[e.jsxs(n,{variant:"body1",sx:{fontWeight:500},children:[s.firstName," ",s.lastName]}),e.jsx(n,{variant:"body2",color:"text.secondary",children:s.email})]})]})}),e.jsx(r,{children:e.jsx(re,{label:s.role.toUpperCase(),color:js(s.role),size:"small",icon:s.role==="admin"?e.jsx(Xe,{}):void 0})}),e.jsx(r,{children:e.jsx(re,{icon:fs(s.status),label:s.status.toUpperCase(),color:vs(s.status),size:"small"})}),e.jsx(r,{children:e.jsx(n,{variant:"body2",children:s.department||"Unassigned"})}),e.jsx(r,{children:e.jsxs(t,{children:[e.jsx(n,{variant:"body2",sx:{fontWeight:500},children:((u=s.licenseAssignment)==null?void 0:u.licenseType)||"None"}),((j=s.licenseAssignment)==null?void 0:j.licenseKey)&&e.jsxs(n,{variant:"caption",color:"text.secondary",sx:{fontFamily:"monospace"},children:[s.licenseAssignment.licenseKey.substring(0,12),"..."]})]})}),e.jsx(r,{children:e.jsx(n,{variant:"body2",color:"text.secondary",children:s.lastActive?new Date(s.lastActive).toLocaleDateString():"Never"})}),e.jsx(r,{children:e.jsx(Ye,{size:"small",onClick:x=>Ee(x,s),disabled:s.role==="owner"&&s.id===l.id,children:e.jsx(Je,{})})})]},s.id)})})]})})]})}),e.jsx(Qe,{color:"primary",sx:{position:"fixed",bottom:16,right:16,display:{xs:"flex",md:"none"}},onClick:()=>p(!0),disabled:o.stats.availableLicenses<=0,children:e.jsx(Ze,{})}),e.jsxs(P,{open:Le,onClose:()=>p(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(F,{children:"Invite Team Member"}),e.jsx(O,{children:e.jsxs(t,{sx:{display:"flex",flexDirection:"column",gap:3,mt:2},children:[e.jsx(L,{fullWidth:!0,label:"Email Address",type:"email",value:y,onChange:s=>$(s.target.value),placeholder:"colleague@company.com"}),e.jsxs(le,{fullWidth:!0,children:[e.jsx(oe,{children:"Role"}),e.jsxs(ce,{value:q,label:"Role",onChange:s=>H(s.target.value),children:[e.jsx(h,{value:"viewer",children:"Viewer - Read-only access"}),e.jsx(h,{value:"member",children:"Member - Standard access"}),e.jsx(h,{value:"manager",children:"Manager - Team management"}),e.jsx(h,{value:"admin",children:"Admin - Full access"})]})]}),e.jsx(L,{fullWidth:!0,label:"Department (Optional)",value:U,onChange:s=>K(s.target.value),placeholder:"Engineering, Design, Marketing..."}),e.jsxs(b,{severity:"info",children:[e.jsx(n,{variant:"body2",children:"The invited member will receive an email with instructions to join your organization. An available license will be automatically assigned to them upon invitation."}),e.jsxs(n,{variant:"body2",sx:{mt:1,fontWeight:500},children:["Available licenses: ",o.stats.availableLicenses," of ",o.stats.totalLicenses]})]})]})}),e.jsxs(B,{children:[e.jsx(m,{onClick:()=>p(!1),children:"Cancel"}),e.jsx(m,{onClick:ke,variant:"contained",startIcon:e.jsx(es,{}),children:"Send Invitation"})]})]}),e.jsxs(P,{open:Me,onClose:()=>D(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(F,{children:"Edit Team Member"}),e.jsx(O,{children:a&&e.jsxs(t,{sx:{display:"flex",flexDirection:"column",gap:3,mt:2},children:[e.jsx(L,{fullWidth:!0,label:"First Name",value:W,onChange:s=>X(s.target.value),required:!0}),e.jsx(L,{fullWidth:!0,label:"Last Name",value:R,onChange:s=>Y(s.target.value),required:!0}),e.jsxs(le,{fullWidth:!0,children:[e.jsx(oe,{children:"Role"}),e.jsxs(ce,{value:J,label:"Role",onChange:s=>Q(s.target.value),children:[e.jsx(h,{value:"viewer",children:"Viewer - Read-only access"}),e.jsx(h,{value:"member",children:"Member - Standard access"}),e.jsx(h,{value:"manager",children:"Manager - Team management"}),e.jsx(h,{value:"admin",children:"Admin - Full access"})]})]}),e.jsx(L,{fullWidth:!0,label:"Department",value:Z,onChange:s=>ee(s.target.value),placeholder:"Engineering, Design, Marketing..."}),e.jsx(b,{severity:"info",children:e.jsx(n,{variant:"body2",children:"Role changes will immediately affect the member's permissions and access levels. Department information helps with organization and project assignments."})})]})}),e.jsxs(B,{children:[e.jsx(m,{onClick:()=>D(!1),children:"Cancel"}),e.jsx(m,{onClick:ze,variant:"contained",startIcon:e.jsx(de,{}),children:"Save Changes"})]})]}),e.jsxs(P,{open:Te,onClose:()=>S(!1),maxWidth:"sm",children:[e.jsx(F,{children:"Remove Team Member"}),e.jsx(O,{children:a&&e.jsxs(t,{children:[e.jsxs(n,{variant:"body1",sx:{mb:2},children:["Are you sure you want to remove ",e.jsxs("strong",{children:[a.firstName," ",a.lastName]})," from your team?"]}),e.jsx(b,{severity:"warning",children:e.jsx(n,{variant:"body2",children:"This action cannot be undone. The member will lose access to all projects and resources. Their license will be freed up for reassignment."})})]})}),e.jsxs(B,{children:[e.jsx(m,{onClick:()=>S(!1),children:"Cancel"}),e.jsx(m,{onClick:We,variant:"contained",color:"error",startIcon:e.jsx(G,{}),children:"Remove Member"})]})]}),e.jsxs(ss,{anchorEl:V,open:!!V,onClose:k,children:[e.jsxs(h,{onClick:Ae,children:[e.jsx(w,{children:e.jsx(de,{})}),"Edit Member"]}),(a==null?void 0:a.status)==="pending"&&e.jsxs(h,{onClick:Re,children:[e.jsx(w,{children:e.jsx(as,{})}),"Resend Invite"]}),e.jsx(ns,{}),e.jsxs(h,{onClick:Ne,sx:{color:"error.main"},children:[e.jsx(w,{children:e.jsx(G,{sx:{color:"error.main"}})}),"Remove Member"]})]})]})};export{Ss as default};
