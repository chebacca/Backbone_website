import{j as e,B as t,C as ss,T as a,d as b,ai as q,w as as,x as ve,y as L,aj as ts,z as pe,H as be,a as h,aG as U,G as M,W as Se,p as We,am as Ne,u as fe,t as ns,v as is,aq as rs,ar as ls,as as os,at as ye,au as c,av as cs,ag as ds,r as we,aX as ms,g as Ce,aw as hs,ax as xs,ap as us,ay as H,az as K,aB as V,aY as gs,e as u,I as Ie,aZ as js,a_ as vs,aC as Te,aD as Le,aE as Me,a5 as x,F as ps,s as bs,R as fs,aF as _,aI as Pe,aH as J,a4 as ys,E as ws,D as Cs,aK as Is}from"./mui-J9lwJP4Y.js";import{r,b as De}from"./vendor-CjD1bmmO.js";import{u as Ts}from"./notistack.esm-Ca-E78ev.js";import{u as Ls,a as Ms,c as Ps,b as Ds,j as Ss,k as Ws,l as Ns,f as As,g as ks}from"./useStreamlinedData-CWmfHkhZ.js";import{M as F}from"./MetricCard-DbOWV6sj.js";import"./UnifiedDataService-COKE1Sia.js";import"./index-CkfsxqDi.js";import"./stripe-KZkmP4lu.js";import"./index.esm-B4qVkIPL.js";import"./index.esm-DmQE6AXN.js";const Es=i=>{switch(i){case"owner":return"error";case"admin":return"primary";case"manager":return"secondary";case"member":return"info";case"viewer":return"default";default:return"default"}},Rs=i=>{switch(i){case"active":return"success";case"pending":return"warning";case"suspended":return"error";case"removed":return"default";default:return"default"}},Fs=i=>{switch(i){case"active":return e.jsx(We,{});case"pending":return e.jsx(Ne,{});case"suspended":return e.jsx(Is,{});case"removed":return e.jsx(J,{});default:return e.jsx(Se,{})}},Y=()=>{const l="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";let P="";for(let D=0;D<12;D++)P+=l.charAt(Math.floor(Math.random()*l.length));return P},_s=()=>{var je;const{enqueueSnackbar:i}=Ts(),{data:l,loading:P,error:D}=Ls(),{data:S,loading:Ae,error:ke}=Ms(),{data:f,loading:Ee,error:Re,refetch:W}=Ps(),{data:j,loading:Fe,error:ze,refetch:z}=Ds(),Oe=Ss(),Be=Ws();Ns();const $e=As();ks();const[Ge,w]=r.useState(!1),[qe,N]=r.useState(!1),[Ue,A]=r.useState(!1),[O,X]=r.useState(""),[C,Z]=r.useState(""),[I,Q]=r.useState(""),[ee,se]=r.useState("member"),[ae,te]=r.useState(""),[ne,ie]=r.useState(""),[re,le]=r.useState(""),[B,k]=r.useState(""),[y,He]=r.useState(!0),[n,E]=r.useState(null),[oe,ce]=r.useState(null),[$,de]=r.useState(""),[G,me]=r.useState(""),[he,xe]=r.useState("member"),[ue,ge]=r.useState(""),Ke=P||Ae||Ee||Fe,Ve=D||ke||Re||ze;De.useEffect(()=>{y&&k(Y())},[y]),De.useEffect(()=>{const s=async()=>{console.log("ðŸ”„ [TeamPage] License refresh event detected, refetching data..."),await Promise.all([z(),W()])};return window.addEventListener("licenses:refresh",s),()=>{window.removeEventListener("licenses:refresh",s)}},[z,W]);const o=r.useMemo(()=>{if(!l||!S||!f||!j)return{members:[],stats:{totalMembers:0,activeMembers:0,pendingInvites:0,availableLicenses:0,totalLicenses:0,assignedLicenses:0}};const s=f.filter(d=>d.status==="active").length,g=f.filter(d=>d.status==="pending").length,v=j.length,m=j.filter(d=>d.assignedTo).length,p=j.filter(d=>d.status==="PENDING"&&!d.assignedTo).length;console.log("ðŸ“Š [TeamPage] License stats:",{totalLicenses:v,assignedLicenses:m,availableLicenses:p});const T={totalMembers:f.length,activeMembers:s,pendingInvites:g,availableLicenses:p,totalLicenses:v,assignedLicenses:m};return{members:f,stats:T}},[l,S,f,j]),_e=(s,g)=>{E(g),ce(s.currentTarget)},R=()=>{ce(null),E(null)},Ye=async()=>{var s,g,v;if(!O.trim()){i("Please enter an email address",{variant:"error"});return}if(!C.trim()){i("Please enter a first name",{variant:"error"});return}if(!I.trim()){i("Please enter a last name",{variant:"error"});return}if(!B.trim()){i("Please provide a temporary password",{variant:"error"});return}if(o.stats.availableLicenses<=0){i("No available licenses. Please generate more licenses first.",{variant:"error"});return}try{console.log("ðŸ‘¤ [TeamPage] Creating full user with Firebase authentication...");const m={firstName:C.trim(),lastName:I.trim(),email:O.trim().toLowerCase(),role:ee,status:"pending",organization:{id:((s=l==null?void 0:l.organization)==null?void 0:s.id)||"",name:((g=l==null?void 0:l.organization)==null?void 0:g.name)||"",tier:((v=l==null?void 0:l.organization)==null?void 0:v.tier)||"BASIC"},department:ae.trim()||void 0,assignedProjects:[],avatar:`https://ui-avatars.com/api/?name=${encodeURIComponent(C+" "+I)}&background=667eea&color=fff`},p=await Oe.mutate({...m,temporaryPassword:B,position:ne.trim()||void 0,phone:re.trim()||void 0});console.log("âœ… [TeamPage] Team member created with ID:",p);const T=j==null?void 0:j.find(d=>d.status==="PENDING"&&!d.assignedTo);if(T&&p)try{await $e.mutate({licenseId:T.id,userId:p}),console.log("âœ… [TeamPage] Auto-assigned license",T.id,"to new member",p)}catch(d){console.warn("âš ï¸ [TeamPage] Failed to auto-assign license:",d)}i(`Team member ${C} ${I} created successfully with license assigned. They can now login with their email and temporary password.`,{variant:"success"}),X(""),Z(""),Q(""),se("member"),te(""),ie(""),le(""),k(Y()),w(!1),await Promise.all([W(),z()])}catch(m){console.error("âŒ [TeamPage] Failed to create team member:",m),i((m==null?void 0:m.message)||"Failed to create team member",{variant:"error"})}},Je=()=>{n&&(de(n.firstName||""),me(n.lastName||""),xe(n.role||"member"),ge(n.department||""),N(!0),R())},Xe=()=>{n&&(A(!0),R())},Ze=async()=>{if(n)try{i(`${n.firstName} ${n.lastName} has been removed from the team`,{variant:"success"}),A(!1),E(null)}catch(s){i((s==null?void 0:s.message)||"Failed to remove team member",{variant:"error"})}},Qe=()=>{n&&(i(`Invitation resent to ${n.email}`,{variant:"success"}),R())},es=async()=>{if(n)try{await Be.mutate({memberId:n.id,updates:{firstName:$,lastName:G,role:he,department:ue}}),i(`Team member ${$} ${G} updated successfully`,{variant:"success"}),N(!1),E(null),W()}catch(s){i((s==null?void 0:s.message)||"Failed to update team member",{variant:"error"})}};return Ke?e.jsx(t,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsxs(t,{textAlign:"center",children:[e.jsx(ss,{size:60}),e.jsx(a,{variant:"h6",sx:{mt:2},children:"Loading Team Data..."}),e.jsx(a,{variant:"body2",color:"text.secondary",children:"Fetching your team members and organization details"})]})}):Ve?e.jsx(t,{sx:{p:3},children:e.jsxs(b,{severity:"error",children:[e.jsx(q,{children:"Unable to Load Team Data"}),e.jsx(a,{variant:"body2",sx:{mb:2},children:"We encountered an issue loading your team information. This could be due to:"}),e.jsxs(as,{dense:!0,children:[e.jsxs(ve,{children:[e.jsx(L,{children:e.jsx(ts,{fontSize:"small"})}),e.jsx(pe,{primary:"Network connectivity issues"})]}),e.jsxs(ve,{children:[e.jsx(L,{children:e.jsx(be,{fontSize:"small"})}),e.jsx(pe,{primary:"Authentication token expired"})]})]}),e.jsx(t,{sx:{mt:2},children:e.jsx(h,{variant:"contained",onClick:()=>window.location.reload(),children:"Retry"})})]})}):!l||!S?e.jsx(t,{sx:{p:3},children:e.jsxs(b,{severity:"info",children:[e.jsx(q,{children:"Setting Up Team Management"}),e.jsx(a,{variant:"body2",children:"We're preparing your team management dashboard. This may take a moment for new accounts."})]})}):e.jsxs(t,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4},children:[e.jsxs(t,{children:[e.jsx(a,{variant:"h4",sx:{fontWeight:700,mb:1},children:"Team Management"}),e.jsxs(a,{variant:"body1",color:"text.secondary",children:["Manage your ",((je=S.organization)==null?void 0:je.name)||"Organization"," team members and permissions"]})]}),e.jsx(h,{variant:"contained",startIcon:e.jsx(U,{}),onClick:()=>w(!0),disabled:o.stats.availableLicenses<=0,sx:{background:"linear-gradient(135deg, #00d4ff 0%, #667eea 100%)",color:"#000",fontWeight:600},children:"Invite Member"})]}),e.jsxs(M,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Total Members",value:o.stats.totalMembers,icon:e.jsx(Se,{}),color:"primary"})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Active Members",value:o.stats.activeMembers,icon:e.jsx(We,{}),color:"success"})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Pending Invites",value:o.stats.pendingInvites,icon:e.jsx(Ne,{}),color:"warning"})}),e.jsx(M,{item:!0,xs:12,sm:6,md:3,children:e.jsx(F,{title:"Available Licenses",value:`${o.stats.availableLicenses}/${o.stats.totalLicenses}`,icon:e.jsx(fe,{}),color:"primary"})})]}),o.stats.availableLicenses<=0&&e.jsxs(b,{severity:"warning",sx:{mb:4},children:[e.jsx(q,{children:"No Available Licenses"}),e.jsx(a,{variant:"body2",sx:{mb:2},children:"You need to generate more licenses to invite new team members. Go to the Licenses page to create additional licenses."}),e.jsxs(t,{sx:{display:"flex",gap:2},children:[e.jsx(h,{variant:"contained",size:"small",onClick:()=>window.open("/dashboard/licenses","_blank"),children:"Generate Licenses"}),e.jsx(h,{variant:"outlined",size:"small",onClick:()=>window.open("/dashboard/billing","_blank"),children:"Upgrade Plan"})]})]}),e.jsx(ns,{children:e.jsxs(is,{children:[e.jsxs(t,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(a,{variant:"h6",sx:{fontWeight:600},children:["Team Members (",o.members.length,")"]}),e.jsx(h,{variant:"outlined",startIcon:e.jsx(fe,{}),onClick:()=>window.open("/dashboard/licenses","_blank"),children:"Manage Licenses"})]}),e.jsx(rs,{children:e.jsxs(ls,{children:[e.jsx(os,{children:e.jsxs(ye,{children:[e.jsx(c,{sx:{fontWeight:600},children:"Member"}),e.jsx(c,{sx:{fontWeight:600},children:"Role"}),e.jsx(c,{sx:{fontWeight:600},children:"Status"}),e.jsx(c,{sx:{fontWeight:600},children:"Department"}),e.jsx(c,{sx:{fontWeight:600},children:"License"}),e.jsx(c,{sx:{fontWeight:600},children:"Last Active"}),e.jsx(c,{sx:{fontWeight:600},children:"Actions"})]})}),e.jsx(cs,{children:o.members.map(s=>{var g,v;return e.jsxs(ye,{hover:!0,children:[e.jsx(c,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsxs(ds,{src:s.avatar,sx:{width:40,height:40},children:[s.firstName.charAt(0),s.lastName.charAt(0)]}),e.jsxs(t,{children:[e.jsxs(a,{variant:"body1",sx:{fontWeight:500},children:[s.firstName," ",s.lastName]}),e.jsx(a,{variant:"body2",color:"text.secondary",children:s.email})]})]})}),e.jsx(c,{children:e.jsx(we,{label:s.role.toUpperCase(),color:Es(s.role),size:"small",icon:s.role==="admin"?e.jsx(ms,{}):void 0})}),e.jsx(c,{children:e.jsx(we,{icon:Fs(s.status),label:s.status.toUpperCase(),color:Rs(s.status),size:"small"})}),e.jsx(c,{children:e.jsx(a,{variant:"body2",children:s.department||"Unassigned"})}),e.jsx(c,{children:e.jsxs(t,{children:[e.jsx(a,{variant:"body2",sx:{fontWeight:500},children:((g=s.licenseAssignment)==null?void 0:g.licenseType)||"None"}),((v=s.licenseAssignment)==null?void 0:v.licenseKey)&&e.jsxs(a,{variant:"caption",color:"text.secondary",sx:{fontFamily:"monospace"},children:[s.licenseAssignment.licenseKey.substring(0,12),"..."]})]})}),e.jsx(c,{children:e.jsx(a,{variant:"body2",color:"text.secondary",children:s.lastActive?new Date(s.lastActive).toLocaleDateString():"Never"})}),e.jsx(c,{children:e.jsx(Ce,{size:"small",onClick:m=>_e(m,s),disabled:s.role==="owner"&&s.id===l.id,children:e.jsx(hs,{})})})]},s.id)})})]})})]})}),e.jsx(xs,{color:"primary",sx:{position:"fixed",bottom:16,right:16,display:{xs:"flex",md:"none"}},onClick:()=>w(!0),disabled:o.stats.availableLicenses<=0,children:e.jsx(us,{})}),e.jsxs(H,{open:Ge,onClose:()=>w(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(K,{children:e.jsxs(t,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(U,{}),"Create New Team Member"]})}),e.jsx(V,{children:e.jsxs(t,{sx:{display:"flex",flexDirection:"column",gap:3,mt:2},children:[e.jsxs(t,{children:[e.jsxs(a,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(gs,{})," Personal Information"]}),e.jsxs(t,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(u,{fullWidth:!0,label:"First Name",value:C,onChange:s=>Z(s.target.value),placeholder:"John",required:!0}),e.jsx(u,{fullWidth:!0,label:"Last Name",value:I,onChange:s=>Q(s.target.value),placeholder:"Doe",required:!0})]}),e.jsx(u,{fullWidth:!0,label:"Email Address",type:"email",value:O,onChange:s=>X(s.target.value),placeholder:"john.doe@company.com",required:!0,sx:{mb:2}}),e.jsx(u,{fullWidth:!0,label:"Phone Number (Optional)",value:re,onChange:s=>le(s.target.value),placeholder:"+1 (555) 123-4567",InputProps:{startAdornment:e.jsx(Ie,{position:"start",children:e.jsx(js,{})})}})]}),e.jsxs(t,{children:[e.jsxs(a,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(vs,{})," Role & Department"]}),e.jsxs(t,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(Te,{fullWidth:!0,children:[e.jsx(Le,{children:"Role"}),e.jsxs(Me,{value:ee,label:"Role",onChange:s=>se(s.target.value),children:[e.jsx(x,{value:"viewer",children:e.jsxs(t,{children:[e.jsx(a,{variant:"body2",sx:{fontWeight:500},children:"Viewer"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Read-only access to projects"})]})}),e.jsx(x,{value:"member",children:e.jsxs(t,{children:[e.jsx(a,{variant:"body2",sx:{fontWeight:500},children:"Member"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Standard project access"})]})}),e.jsx(x,{value:"manager",children:e.jsxs(t,{children:[e.jsx(a,{variant:"body2",sx:{fontWeight:500},children:"Manager"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Team management capabilities"})]})}),e.jsx(x,{value:"admin",children:e.jsxs(t,{children:[e.jsx(a,{variant:"body2",sx:{fontWeight:500},children:"Admin"}),e.jsx(a,{variant:"caption",color:"text.secondary",children:"Full organizational access"})]})})]})]}),e.jsx(u,{fullWidth:!0,label:"Department",value:ae,onChange:s=>te(s.target.value),placeholder:"Engineering, Design, Marketing..."})]}),e.jsx(u,{fullWidth:!0,label:"Position/Title (Optional)",value:ne,onChange:s=>ie(s.target.value),placeholder:"Senior Developer, Product Manager..."})]}),e.jsxs(t,{children:[e.jsxs(a,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(be,{})," Authentication"]}),e.jsx(ps,{control:e.jsx(bs,{checked:y,onChange:s=>He(s.target.checked)}),label:"Auto-generate secure password",sx:{mb:2}}),e.jsx(u,{fullWidth:!0,label:"Temporary Password",type:"password",value:B,onChange:s=>k(s.target.value),disabled:y,required:!0,InputProps:{endAdornment:e.jsx(Ie,{position:"end",children:e.jsx(Ce,{onClick:()=>k(Y()),disabled:!y,children:e.jsx(fs,{})})})},helperText:y?"Password will be auto-generated":"User will need this password to login initially"})]}),e.jsxs(b,{severity:"info",children:[e.jsx(a,{variant:"body2",sx:{fontWeight:500,mb:1},children:"ðŸŽ« License Assignment"}),e.jsx(a,{variant:"body2",children:"This team member will be created as a full Firebase authenticated user and automatically assigned an available license. They can login immediately with their email and temporary password."}),e.jsxs(a,{variant:"body2",sx:{mt:1,fontWeight:500},children:["Available licenses: ",o.stats.availableLicenses," of ",o.stats.totalLicenses]})]}),o.stats.availableLicenses<=0&&e.jsx(b,{severity:"warning",children:e.jsx(a,{variant:"body2",children:"No licenses available! Please generate more licenses before creating team members."})})]})}),e.jsxs(_,{children:[e.jsx(h,{onClick:()=>w(!1),children:"Cancel"}),e.jsx(h,{onClick:Ye,variant:"contained",startIcon:e.jsx(U,{}),disabled:o.stats.availableLicenses<=0,children:"Create Team Member"})]})]}),e.jsxs(H,{open:qe,onClose:()=>N(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(K,{children:"Edit Team Member"}),e.jsx(V,{children:n&&e.jsxs(t,{sx:{display:"flex",flexDirection:"column",gap:3,mt:2},children:[e.jsx(u,{fullWidth:!0,label:"First Name",value:$,onChange:s=>de(s.target.value),required:!0}),e.jsx(u,{fullWidth:!0,label:"Last Name",value:G,onChange:s=>me(s.target.value),required:!0}),e.jsxs(Te,{fullWidth:!0,children:[e.jsx(Le,{children:"Role"}),e.jsxs(Me,{value:he,label:"Role",onChange:s=>xe(s.target.value),children:[e.jsx(x,{value:"viewer",children:"Viewer - Read-only access"}),e.jsx(x,{value:"member",children:"Member - Standard access"}),e.jsx(x,{value:"manager",children:"Manager - Team management"}),e.jsx(x,{value:"admin",children:"Admin - Full access"})]})]}),e.jsx(u,{fullWidth:!0,label:"Department",value:ue,onChange:s=>ge(s.target.value),placeholder:"Engineering, Design, Marketing..."}),e.jsx(b,{severity:"info",children:e.jsx(a,{variant:"body2",children:"Role changes will immediately affect the member's permissions and access levels. Department information helps with organization and project assignments."})})]})}),e.jsxs(_,{children:[e.jsx(h,{onClick:()=>N(!1),children:"Cancel"}),e.jsx(h,{onClick:es,variant:"contained",startIcon:e.jsx(Pe,{}),children:"Save Changes"})]})]}),e.jsxs(H,{open:Ue,onClose:()=>A(!1),maxWidth:"sm",children:[e.jsx(K,{children:"Remove Team Member"}),e.jsx(V,{children:n&&e.jsxs(t,{children:[e.jsxs(a,{variant:"body1",sx:{mb:2},children:["Are you sure you want to remove ",e.jsxs("strong",{children:[n.firstName," ",n.lastName]})," from your team?"]}),e.jsx(b,{severity:"warning",children:e.jsx(a,{variant:"body2",children:"This action cannot be undone. The member will lose access to all projects and resources. Their license will be freed up for reassignment."})})]})}),e.jsxs(_,{children:[e.jsx(h,{onClick:()=>A(!1),children:"Cancel"}),e.jsx(h,{onClick:Ze,variant:"contained",color:"error",startIcon:e.jsx(J,{}),children:"Remove Member"})]})]}),e.jsxs(ys,{anchorEl:oe,open:!!oe,onClose:R,children:[e.jsxs(x,{onClick:Je,children:[e.jsx(L,{children:e.jsx(Pe,{})}),"Edit Member"]}),(n==null?void 0:n.status)==="pending"&&e.jsxs(x,{onClick:Qe,children:[e.jsx(L,{children:e.jsx(ws,{})}),"Resend Invite"]}),e.jsx(Cs,{}),e.jsxs(x,{onClick:Xe,sx:{color:"error.main"},children:[e.jsx(L,{children:e.jsx(J,{sx:{color:"error.main"}})}),"Remove Member"]})]})]})};export{_s as default};
