import{j as e,a as m,T as c,d as B,b3 as Re,G as x,k as _,l as H,at as $,o as We,n as Y,ax as ye,m as Ve,H as ze,aC as Fe,c as Be,aD as $e,aE as Le,aF as xe,aG as p,aH as Ue,h as ue,b4 as Ge,b5 as _e,b6 as He,I as K,aI as qe,b7 as Qe,az as Xe,aj as Je,a4 as A,X as q,aL as Ke,w as Ye,b8 as Se,b2 as Ze,aN as ge,aO as he,aP as pe,u as N,aS as et,aT as tt,aU as at,aQ as be,t as st,v as je,x as fe,y as ve}from"./mui-BGhK1avx.js";import{r as u}from"./vendor-OeuszDaU.js";import{u as nt}from"./notistack.esm-CcFOI6Un.js";import{u as rt,c as C,e as P}from"./index-Bf_00eOP.js";import"./stripe-B34TymDN.js";const it=d=>{switch(d){case"admin":return"secondary";case"owner":return"secondary";case"manager":return"info";case"member":return"success";case"viewer":return"default";default:return"default"}},ot=d=>{switch(d){case"active":return"success";case"pending":return"warning";case"suspended":return"error";case"removed":return"default";default:return"default"}},lt=d=>{switch(d){case"active":return e.jsx(Y,{});case"pending":return e.jsx(ye,{});case"suspended":return e.jsx(Se,{});default:return e.jsx(Y,{})}},ht=()=>{const{enqueueSnackbar:d}=nt(),{user:Q}=rt(),[we,T]=u.useState([]),[S,O]=u.useState({totalMembers:0,activeMembers:0,pendingInvites:0,availableSeats:0,totalSeats:0}),[M,Z]=u.useState(null),[dt,ee]=u.useState(""),D=(t,{includeTime:a=!1}={})=>{try{if(!t){const i=new Date;return a?i.toISOString():i.toISOString().slice(0,10)}if(typeof t=="string"||typeof t=="number"){const i=new Date(t);if(!Number.isNaN(i.getTime()))return a?i.toISOString():i.toISOString().slice(0,10)}if(typeof t=="object"){const i=t._seconds,s=t._nanoseconds??0;if(typeof i=="number"){const o=i*1e3+Math.floor(s/1e6),j=new Date(o);return a?j.toISOString():j.toISOString().slice(0,10)}}}catch{}const b=new Date;return a?b.toISOString():b.toISOString().slice(0,10)};u.useEffect(()=>{let t=!0;return(async()=>{var a,b,i,s,o,j;try{const h=await C.get(P.organizations.my()),f=((b=(a=h==null?void 0:h.data)==null?void 0:a.data)==null?void 0:b.owned)??[],v=((s=(i=h==null?void 0:h.data)==null?void 0:i.data)==null?void 0:s.memberOf)??[],y=f[0]||v[0]||null;if(!y){t&&(Z(null),ee(""),T([]),O({totalMembers:0,activeMembers:0,pendingInvites:0,availableSeats:0,totalSeats:0}));return}const w=y.members||[],r=w.filter(l=>l.status==="INVITED").length,n=w.filter(l=>l.status==="ACTIVE").length,G=(((j=(o=(await C.get(P.subscriptions.mySubscriptions())).data)==null?void 0:o.data)==null?void 0:j.subscriptions)??[]).filter(l=>l.organizationId===y.id&&l.status==="ACTIVE").reduce((l,F)=>l+(F.seats||0),0),Te=Math.max(0,G-(n+r)),ce=(Array.isArray(w)?w:[]).filter(l=>l&&l.status!=="REMOVED").map(l=>{const F=String(l.email||"user@example.com"),me=F.split("@")[0]||"User",Oe={OWNER:"owner",ENTERPRISE_ADMIN:"admin",MANAGER:"manager",MEMBER:"member"},ke={INVITED:"pending",ACTIVE:"active",REMOVED:"removed"};return{id:String(l.id||`${F}-${Math.random().toString(36).slice(2)}`),firstName:me.charAt(0).toUpperCase()+me.slice(1),lastName:"",email:F,role:Oe[String(l.role)]||"member",status:ke[String(l.status)]||"active",joinedAt:D(l.joinedAt),lastActive:D(l.updatedAt||l.joinedAt||new Date,{includeTime:!0})}});if(!t)return;Z(y.id),ee(y.name||"Organization"),T(ce),O({totalMembers:ce.length,activeMembers:n,pendingInvites:r,availableSeats:Te,totalSeats:G})}catch(h){if(!t)return;console.error("[TeamPage] Failed to load team data:",h),T([]),O({totalMembers:0,activeMembers:0,pendingInvites:0,availableSeats:0,totalSeats:0})}})(),()=>{t=!1}},[Q==null?void 0:Q.email]);const[te,ae]=u.useState(null),[g,se]=u.useState(null),[Me,k]=u.useState(!1),[Ie,L]=u.useState(!1),[X,ne]=u.useState(!1),[re,ie]=u.useState(!1),[oe,le]=u.useState(!1),[R,J]=u.useState({newPassword:"",confirmPassword:""}),[I,W]=u.useState({email:"",role:"member",department:"",message:""}),Ee=(t,a)=>{ae(t.currentTarget),se(a)},V=()=>{ae(null),se(null)},Ae=async()=>{var t,a,b,i;if(M)try{const s={admin:"ENTERPRISE_ADMIN",owner:"ENTERPRISE_ADMIN",manager:"MANAGER",member:"MEMBER",viewer:"MEMBER"};await C.post(P.organizations.invite(M),{email:I.email,role:s[I.role]||"MEMBER"}),d(`Invitation sent to ${I.email}`,{variant:"success"}),k(!1),W({email:"",role:"member",department:"",message:""});const o=await C.get(P.organizations.my()),j=((a=(t=o==null?void 0:o.data)==null?void 0:t.data)==null?void 0:a.owned)??[],h=((i=(b=o==null?void 0:o.data)==null?void 0:b.data)==null?void 0:i.memberOf)??[],f=[...j,...h].find(v=>v.id===M)||j[0]||h[0];if(f){const v=f.members||[],y=(Array.isArray(v)?v:[]).filter(n=>n&&n.status!=="REMOVED").map(n=>{const E=String(n.email||"user@example.com"),z=E.split("@")[0]||"User",U={OWNER:"owner",ENTERPRISE_ADMIN:"admin",MANAGER:"manager",MEMBER:"member"},G={INVITED:"pending",ACTIVE:"active",REMOVED:"removed"};return{id:String(n.id||`${E}-${Math.random().toString(36).slice(2)}`),firstName:z.charAt(0).toUpperCase()+z.slice(1),lastName:"",email:E,role:U[String(n.role)]||"member",status:G[String(n.status)]||"active",joinedAt:D(n.joinedAt),lastActive:D(n.updatedAt||n.joinedAt||new Date,{includeTime:!0})}}),w=v.filter(n=>n.status==="INVITED").length,r=v.filter(n=>n.status==="ACTIVE").length;T(y),O(n=>({...n,totalMembers:y.length,pendingInvites:w,activeMembers:r,availableSeats:Math.max(0,n.totalSeats-(r+w))}))}}catch(s){console.error("[TeamPage] Invite failed:",s),d((s==null?void 0:s.message)||"Failed to send invitation",{variant:"error"})}},Ce=()=>{g&&d(`Invitation resent to ${g.email}`,{variant:"success"}),V()},Pe=()=>{J({newPassword:"",confirmPassword:""}),ie(!1),le(!1),L(!0)},De=async()=>{var i,s;if(!g)return;const t=g.email,{newPassword:a,confirmPassword:b}=R;if(!a||a.length<8){d("Password must be at least 8 characters.",{variant:"warning"});return}if(a!==b){d("Passwords do not match.",{variant:"warning"});return}try{if(ne(!0),!M){d("Organization context not found.",{variant:"error"});return}await C.put(P.organizations.setMemberPassword(M,g.id),{password:a}),d(`Password set for ${t}`,{variant:"success"}),L(!1)}catch(o){const j=((s=(i=o==null?void 0:o.response)==null?void 0:i.data)==null?void 0:s.message)||(o==null?void 0:o.message)||"Failed to set password";d(j,{variant:"error"})}finally{ne(!1)}},Ne=async()=>{var t,a,b,i;if(!(!g||!M))try{await C.post(P.organizations.removeMember(M,g.id)),d(`${g.email} removed from team`,{variant:"warning"});const s=await C.get(P.organizations.my()),o=((a=(t=s==null?void 0:s.data)==null?void 0:t.data)==null?void 0:a.owned)??[],j=((i=(b=s==null?void 0:s.data)==null?void 0:b.data)==null?void 0:i.memberOf)??[],h=[...o,...j].find(f=>f.id===M)||o[0]||j[0];if(h){const f=h.members||[],v=(Array.isArray(f)?f:[]).filter(r=>r&&r.status!=="REMOVED").map(r=>{const n=String(r.email||"user@example.com"),E=n.split("@")[0]||"User",z={OWNER:"owner",ENTERPRISE_ADMIN:"admin",MANAGER:"manager",MEMBER:"member"},U={INVITED:"pending",ACTIVE:"active",REMOVED:"removed"};return{id:String(r.id||`${n}-${Math.random().toString(36).slice(2)}`),firstName:E.charAt(0).toUpperCase()+E.slice(1),lastName:"",email:n,role:z[String(r.role)]||"member",status:U[String(r.status)]||"active",joinedAt:D(r.joinedAt),lastActive:D(r.updatedAt||r.joinedAt||new Date,{includeTime:!0})}}),y=f.filter(r=>r.status==="INVITED").length,w=f.filter(r=>r.status==="ACTIVE").length;T(v),O(r=>({...r,totalMembers:v.length,pendingInvites:y,activeMembers:w,availableSeats:Math.max(0,r.totalSeats-(w+y))}))}}catch(s){console.error("[TeamPage] Remove member failed:",s),d((s==null?void 0:s.message)||"Failed to remove member",{variant:"error"})}finally{V()}},de=u.useMemo(()=>S.totalSeats<=0?0:(S.totalSeats-S.availableSeats)/S.totalSeats*100,[S.totalSeats,S.availableSeats]);return e.jsxs(m,{children:[e.jsx(m,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.6},children:e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4},children:[e.jsxs(m,{children:[e.jsx(c,{variant:"h4",sx:{fontWeight:700,mb:1},children:"Team Management"}),e.jsx(c,{variant:"body1",color:"text.secondary",children:"Manage your team members, roles, and license assignments"})]}),e.jsx(B,{variant:"contained",startIcon:e.jsx(Re,{}),onClick:()=>k(!0),sx:{background:"linear-gradient(135deg, #00d4ff 0%, #667eea 100%)",color:"#000",fontWeight:600},children:"Invite Member"})]})}),e.jsxs(x,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(x,{item:!0,xs:12,sm:6,md:3,children:e.jsx(m,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.1},children:e.jsx(_,{sx:{background:"linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%)",border:"1px solid rgba(0, 212, 255, 0.2)"},children:e.jsxs(H,{children:[e.jsx(m,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:e.jsx($,{sx:{bgcolor:"primary.main"},children:e.jsx(We,{})})}),e.jsx(c,{variant:"h3",sx:{fontWeight:700,color:"primary.main"},children:S.totalMembers}),e.jsx(c,{variant:"body2",color:"text.secondary",children:"Total Members"})]})})})}),e.jsx(x,{item:!0,xs:12,sm:6,md:3,children:e.jsx(m,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.2},children:e.jsx(_,{sx:{background:"linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%)",border:"1px solid rgba(76, 175, 80, 0.2)"},children:e.jsxs(H,{children:[e.jsx(m,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:e.jsx($,{sx:{bgcolor:"success.main"},children:e.jsx(Y,{})})}),e.jsx(c,{variant:"h3",sx:{fontWeight:700,color:"success.main"},children:S.activeMembers}),e.jsx(c,{variant:"body2",color:"text.secondary",children:"Active Members"})]})})})}),e.jsx(x,{item:!0,xs:12,sm:6,md:3,children:e.jsx(m,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.3},children:e.jsx(_,{sx:{background:"linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(255, 152, 0, 0.05) 100%)",border:"1px solid rgba(255, 152, 0, 0.2)"},children:e.jsxs(H,{children:[e.jsx(m,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:e.jsx($,{sx:{bgcolor:"warning.main"},children:e.jsx(ye,{})})}),e.jsx(c,{variant:"h3",sx:{fontWeight:700,color:"warning.main"},children:S.pendingInvites}),e.jsx(c,{variant:"body2",color:"text.secondary",children:"Pending Invites"})]})})})}),e.jsx(x,{item:!0,xs:12,sm:6,md:3,children:e.jsx(m,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.4},children:e.jsx(_,{sx:{background:"linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%)",border:"1px solid rgba(255,255,255,0.1)"},children:e.jsxs(H,{children:[e.jsx(m,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:e.jsx($,{sx:{bgcolor:"secondary.main"},children:e.jsx(Ve,{})})}),e.jsx(c,{variant:"h3",sx:{fontWeight:700},children:S.availableSeats}),e.jsx(c,{variant:"body2",color:"text.secondary",children:"Available Seats"}),e.jsx(ze,{variant:"determinate",value:de,sx:{mt:1,height:4,borderRadius:2,backgroundColor:"rgba(255,255,255,0.1)","& .MuiLinearProgress-bar":{borderRadius:2,background:de>80?"linear-gradient(90deg, #ff9800 0%, #f44336 100%)":"linear-gradient(90deg, #00d4ff 0%, #667eea 100%)"}}})]})})})})]}),e.jsx(m,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6,delay:.5},children:e.jsx(Fe,{component:Be,sx:{background:"linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255,255,255,0.1)"},children:e.jsxs($e,{children:[e.jsx(Le,{children:e.jsxs(xe,{children:[e.jsx(p,{sx:{fontWeight:600},children:"Member"}),e.jsx(p,{sx:{fontWeight:600},children:"Role"}),e.jsx(p,{sx:{fontWeight:600},children:"Department"}),e.jsx(p,{sx:{fontWeight:600},children:"Status"}),e.jsx(p,{sx:{fontWeight:600},children:"License"}),e.jsx(p,{sx:{fontWeight:600},children:"Last Active"}),e.jsx(p,{sx:{fontWeight:600},children:"Actions"})]})}),e.jsx(Ue,{children:we.map(t=>e.jsxs(xe,{hover:!0,children:[e.jsx(p,{children:e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsxs($,{sx:{width:40,height:40},children:[t.firstName[0],t.lastName[0]]}),e.jsxs(m,{children:[e.jsxs(c,{variant:"body2",sx:{fontWeight:500},children:[t.firstName," ",t.lastName]}),e.jsx(c,{variant:"caption",color:"text.secondary",children:t.email})]})]})}),e.jsx(p,{children:e.jsx(ue,{icon:t.role==="admin"?e.jsx(Ge,{}):e.jsx(_e,{}),label:t.role.toUpperCase(),color:it(t.role),size:"small",variant:"outlined"})}),e.jsx(p,{children:e.jsx(c,{variant:"body2",children:t.department||"Not assigned"})}),e.jsx(p,{children:e.jsx(ue,{icon:lt(t.status),label:t.status.toUpperCase(),color:ot(t.status),size:"small"})}),e.jsx(p,{children:t.licenseAssigned?e.jsx(He,{title:t.licenseAssigned,children:e.jsx(c,{variant:"body2",sx:{fontFamily:"monospace",maxWidth:120,overflow:"hidden",textOverflow:"ellipsis"},children:t.licenseAssigned})}):e.jsx(c,{variant:"body2",color:"text.secondary",children:"No license"})}),e.jsx(p,{children:e.jsx(c,{variant:"body2",children:t.lastActive?new Date(t.lastActive).toLocaleDateString():"Never"})}),e.jsx(p,{children:e.jsx(K,{onClick:a=>Ee(a,t),size:"small",children:e.jsx(qe,{})})})]},t.id))})]})})}),e.jsx(Qe,{color:"primary",sx:{position:"fixed",bottom:24,right:24,background:"linear-gradient(135deg, #00d4ff 0%, #667eea 100%)",color:"#000"},onClick:()=>k(!0),children:e.jsx(Xe,{})}),e.jsxs(Je,{anchorEl:te,open:!!te,onClose:V,PaperProps:{sx:{backgroundColor:"background.paper",border:"1px solid rgba(255, 255, 255, 0.1)"}},children:[e.jsxs(A,{onClick:()=>{V(),Pe()},children:[e.jsx(q,{children:e.jsx(Ke,{fontSize:"small"})}),"Edit Member"]}),(g==null?void 0:g.status)==="pending"&&e.jsxs(A,{onClick:Ce,children:[e.jsx(q,{children:e.jsx(Ye,{fontSize:"small"})}),"Resend Invite"]}),e.jsxs(A,{onClick:V,children:[e.jsx(q,{children:e.jsx(Se,{fontSize:"small"})}),"Suspend Member"]}),e.jsxs(A,{onClick:Ne,sx:{color:"error.main"},children:[e.jsx(q,{children:e.jsx(Ze,{fontSize:"small",sx:{color:"error.main"}})}),"Remove Member"]})]}),e.jsxs(ge,{open:Me,onClose:()=>k(!1),maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{backgroundColor:"background.paper",border:"1px solid rgba(255, 255, 255, 0.1)"}},children:[e.jsx(he,{children:"Invite Team Member"}),e.jsx(pe,{children:e.jsxs(x,{container:!0,spacing:3,sx:{mt:1},children:[e.jsx(x,{item:!0,xs:12,children:e.jsx(N,{fullWidth:!0,label:"Email Address",type:"email",value:I.email,onChange:t=>W(a=>({...a,email:t.target.value}))})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsxs(et,{fullWidth:!0,children:[e.jsx(tt,{children:"Role"}),e.jsxs(at,{value:I.role,label:"Role",onChange:t=>W(a=>({...a,role:t.target.value})),inputProps:{"aria-label":"Select team member role",title:"Select the role for this team member"},children:[e.jsx(A,{value:"viewer",children:"Viewer"}),e.jsx(A,{value:"member",children:"Member"}),e.jsx(A,{value:"admin",children:"Admin"})]})]})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(N,{fullWidth:!0,label:"Department",value:I.department,onChange:t=>W(a=>({...a,department:t.target.value}))})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(N,{fullWidth:!0,label:"Welcome Message (Optional)",multiline:!0,rows:3,value:I.message,onChange:t=>W(a=>({...a,message:t.target.value}))})})]})}),e.jsxs(be,{children:[e.jsx(B,{onClick:()=>k(!1),children:"Cancel"}),e.jsx(B,{onClick:Ae,variant:"contained",disabled:!I.email,children:"Send Invitation"})]})]}),e.jsxs(ge,{open:Ie,onClose:()=>L(!1),maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{backgroundColor:"background.paper",border:"1px solid rgba(255, 255, 255, 0.1)"}},children:[e.jsx(he,{children:"Edit Member"}),e.jsx(pe,{children:e.jsxs(x,{container:!0,spacing:3,sx:{mt:1},children:[e.jsx(x,{item:!0,xs:12,children:e.jsx(N,{fullWidth:!0,label:"Email",value:(g==null?void 0:g.email)||"",disabled:!0})}),e.jsx(x,{item:!0,xs:12,children:e.jsx(st,{severity:"info",children:"Set a temporary password for this user to log into Backbone. They can change it later."})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(N,{fullWidth:!0,label:"New Password",type:re?"text":"password",value:R.newPassword,onChange:t=>J(a=>({...a,newPassword:t.target.value})),inputProps:{minLength:8},helperText:"Minimum 8 characters",InputProps:{endAdornment:e.jsx(je,{position:"end",children:e.jsx(K,{onClick:()=>ie(t=>!t),edge:"end","aria-label":"toggle password visibility",children:re?e.jsx(fe,{}):e.jsx(ve,{})})})}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(N,{fullWidth:!0,label:"Confirm Password",type:oe?"text":"password",value:R.confirmPassword,onChange:t=>J(a=>({...a,confirmPassword:t.target.value})),InputProps:{endAdornment:e.jsx(je,{position:"end",children:e.jsx(K,{onClick:()=>le(t=>!t),edge:"end","aria-label":"toggle password visibility",children:oe?e.jsx(fe,{}):e.jsx(ve,{})})})}})})]})}),e.jsxs(be,{children:[e.jsx(B,{onClick:()=>L(!1),disabled:X,children:"Cancel"}),e.jsx(B,{onClick:De,variant:"contained",disabled:X||!R.newPassword||!R.confirmPassword,children:X?"Saving…":"Save Password"})]})]})]})};export{ht as default};
