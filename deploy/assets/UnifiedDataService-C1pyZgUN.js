const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-BAcWDerH.js","assets/index-ChDbFW_u.js","assets/mui-BO-fjSjW.js","assets/vendor-CjD1bmmO.js","assets/stripe-BghXmgwV.js","assets/index-CBai7h7s.css","assets/index.esm-DFeBm_6f.js","assets/index.esm-DPts1Tj8.js","assets/index.esm-zGMEL0w1.js"])))=>i.map(i=>d[i]);
var $=Object.defineProperty;var k=(M,e,t)=>e in M?$(M,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):M[e]=t;var T=(M,e,t)=>k(M,typeof e!="symbol"?e+"":e,t);import{_ as O}from"./index-ChDbFW_u.js";import{getDoc as C,doc as f,query as A,collection as D,where as b,getDocs as v,updateDoc as U,addDoc as N,setDoc as x,arrayUnion as I,arrayRemove as R,limit as z,orderBy as F}from"./index.esm-DPts1Tj8.js";import{COLLECTIONS as E,firestoreCollectionManager as B}from"./FirestoreCollectionManager-CrKS2x9a.js";import"./mui-BO-fjSjW.js";import"./vendor-CjD1bmmO.js";import"./stripe-BghXmgwV.js";import"./index.esm-DFeBm_6f.js";import"./firebase-BAcWDerH.js";import"./index.esm-zGMEL0w1.js";const P=class P{constructor(){T(this,"cache",new Map);T(this,"CACHE_TTL",5*60*1e3);T(this,"db",null);T(this,"auth",null);this.initializeFirebase()}getApiBaseUrl(){return console.log("[UnifiedDataService] PRODUCTION MODE: Using Firebase Functions API endpoint"),"https://us-central1-backbone-logic.cloudfunctions.net/api"}async initializeFirebase(){try{console.log("üîß [UnifiedDataService] Initializing Firebase...");const{db:e,auth:t}=await O(async()=>{const{db:n,auth:a}=await import("./firebase-BAcWDerH.js");return{db:n,auth:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));this.db=e,this.auth=t,console.log("‚úÖ [UnifiedDataService] Firebase initialized successfully")}catch(e){throw console.error("‚ùå [UnifiedDataService] Failed to initialize Firebase:",e),e}}async waitForAuthReady(){var e;return this.auth||await this.initializeFirebase(),(e=this.auth)!=null&&e.currentUser?!0:new Promise(t=>{const n=setTimeout(()=>{t(!1)},5e3),a=this.auth.onAuthStateChanged(c=>{clearTimeout(n),a(),t(!!c)})})}async getAuthToken(){var e;if(!((e=this.auth)!=null&&e.currentUser))throw new Error("No authenticated user found");try{const t=await this.auth.currentUser.getIdToken();if(!t)throw new Error("Failed to get ID token from Firebase Auth");return t}catch(t){throw console.error("‚ùå [UnifiedDataService] Error getting auth token:",t),new Error("Failed to get authentication token")}}mapUserDocument(e){var n,a,c;const t=e.data();return{id:e.id,email:t.email||"",name:t.name||t.firstName+" "+t.lastName||"Unknown User",userType:t.userType||"TEAM_MEMBER",role:t.role||"member",organization:{id:t.organizationId||t.orgId||"default-org",name:t.organizationName||"Unknown Organization",tier:t.tier||"BASIC",isOwner:t.isOwner||t.role==="OWNER"||!1},license:{type:t.licenseType||t.tier||"BASIC",status:t.status||"ACTIVE",permissions:t.permissions||[],canCreateProjects:t.tier==="ENTERPRISE"||t.tier==="PROFESSIONAL",canManageTeam:t.role==="admin"||t.role==="owner"||t.role==="OWNER"},teamMemberData:t.userType==="TEAM_MEMBER"?{managedBy:t.managedBy||"",department:t.department||"",assignedProjects:t.assignedProjects||[]}:void 0,status:t.status||"ACTIVE",createdAt:((n=t.createdAt)==null?void 0:n.toDate())||new Date,updatedAt:((a=t.updatedAt)==null?void 0:a.toDate())||new Date,lastLoginAt:(c=t.lastLoginAt)==null?void 0:c.toDate()}}async getCurrentUser(){var a;const e="current-user",t=this.getFromCache(e);if(t)return t;if(!await this.waitForAuthReady())return console.log("üîç [UnifiedDataService] Firebase Auth not ready after waiting"),null;if(!((a=this.auth)!=null&&a.currentUser))return console.log("üîç [UnifiedDataService] No Firebase Auth user found after auth ready"),null;try{const c=this.auth.currentUser.email,s=this.auth.currentUser.uid;console.log("üîç [UnifiedDataService] Looking for user:",c,"UID:",s);let o=await C(f(this.db,"users",s));if(o.exists()){console.log("‚úÖ [UnifiedDataService] Found user in users collection");const r=this.mapUserDocument(o);return this.setCache(e,r),r}try{const r=A(D(this.db,"users"),b("email","==",c)),d=await v(r);if(!d.empty){console.log("‚úÖ [UnifiedDataService] Found user by email in users collection");const l=this.mapUserDocument(d.docs[0]);return this.setCache(e,l),l}}catch(r){console.warn("‚ö†Ô∏è [UnifiedDataService] Error querying users by email:",r)}try{const r=A(D(this.db,"orgMembers"),b("email","==",c)),d=await v(r);if(!d.empty){console.log("‚úÖ [UnifiedDataService] Found user in orgMembers collection");const l=this.mapUserDocument(d.docs[0]);return this.setCache(e,l),l}}catch(r){console.warn("‚ö†Ô∏è [UnifiedDataService] Error querying orgMembers:",r)}return console.log("‚ùå [UnifiedDataService] User not found in any collection"),null}catch(c){return console.error("‚ùå [UnifiedDataService] Error fetching current user:",c),null}}async getUsersByOrganization(e){const t=`org-users-${e}`,n=this.getFromCache(t);if(n)return n;try{console.log("üîç [UnifiedDataService] Fetching users for organization:",e),this.db||await this.initializeFirebase();let a=[];try{console.log("üîç [UnifiedDataService] Trying users collection...");const s=A(D(this.db,"users"),b("organizationId","==",e)),o=await v(s);console.log("üìä [UnifiedDataService] Found",o.docs.length,"users in users collection"),a=a.concat(o.docs.map(r=>this.mapUserDocument(r)))}catch(s){console.warn("‚ö†Ô∏è [UnifiedDataService] Error querying users collection:",s)}try{console.log("üîç [UnifiedDataService] Trying orgMembers collection...");const s=A(D(this.db,"orgMembers"),b("organizationId","==",e)),o=await v(s);console.log("üìä [UnifiedDataService] Found",o.docs.length,"users in orgMembers collection"),a=a.concat(o.docs.map(r=>this.mapUserDocument(r)))}catch(s){console.warn("‚ö†Ô∏è [UnifiedDataService] Error querying orgMembers collection:",s)}try{console.log("üîç [UnifiedDataService] Trying orgMembers with orgId field...");const s=A(D(this.db,"orgMembers"),b("orgId","==",e)),o=await v(s);console.log("üìä [UnifiedDataService] Found",o.docs.length,"users in orgMembers with orgId"),a=a.concat(o.docs.map(r=>this.mapUserDocument(r)))}catch(s){console.warn("‚ö†Ô∏è [UnifiedDataService] Error querying orgMembers with orgId:",s)}const c=a.filter((s,o,r)=>o===r.findIndex(d=>d.email===s.email));return this.setCache(t,c),console.log("‚úÖ [UnifiedDataService] Successfully fetched",c.length,"unique users for organization:",e),c}catch(a){return console.error("‚ùå [UnifiedDataService] Error fetching organization users:",a),a instanceof Error&&(console.error("Error details:",a.message),console.error("Error stack:",a.stack)),[]}}async updateUser(e,t){try{const n={...t,updatedAt:new Date};await U(f(this.db,"users",e),n),this.clearCacheByPattern("current-user"),this.clearCacheByPattern("org-users-"),this.clearCacheByPattern("org-context-")}catch(n){throw console.error("Error updating user:",n),n}}safeToDate(e){return e?e instanceof Date?e:typeof e.toDate=="function"?e.toDate():typeof e=="string"?new Date(e):typeof e=="number"?new Date(e):new Date:new Date}async getProjectsForUser(){const e=await this.getCurrentUser();if(!e)return[];const t=`user-projects-${e.id}`,n=this.getFromCache(t);if(n)return n;try{const a=A(D(this.db,"projects"),b("organizationId","==",e.organization.id)),s=(await v(a)).docs.map(o=>{const r=o.data();return console.log("üîç [UnifiedDataService] Processing project data:",{id:o.id,data:r}),{...r,id:o.id,createdAt:this.safeToDate(r.createdAt),updatedAt:this.safeToDate(r.updatedAt),lastAccessedAt:this.safeToDate(r.lastAccessedAt)}});return this.setCache(t,s),s}catch(a){return console.error("Error fetching user projects:",a),[]}}async createProject(e){try{if(!await this.getCurrentUser())throw new Error("No authenticated user");const n={...e,createdAt:new Date,updatedAt:new Date,lastAccessedAt:new Date},a=await N(D(this.db,"projects"),n);return this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("org-projects-"),this.clearCacheByPattern("org-context-"),a.id}catch(t){throw console.error("Error creating project:",t),t}}async updateProject(e,t){try{const n={...t,updatedAt:new Date};await U(f(this.db,"projects",e),n),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-")}catch(n){throw console.error("Error updating project:",n),n}}async addTeamMemberToProject(e,t,n){try{const a=await C(f(this.db,"users",t));if(!a.exists())throw new Error("User not found");const c=a.data(),s=await this.getCurrentUser(),o={userId:c.id||"",email:c.email||"",name:c.name||"Unknown User",role:n||"MEMBER",assignedAt:new Date,assignedBy:(s==null?void 0:s.email)||"system"},r=Object.fromEntries(Object.entries(o).filter(([p,m])=>m!=null));console.log("üîç [UnifiedDataService] Team assignment data:",{original:o,validated:r,projectId:e,userId:t});const d=await C(f(this.db,"projects",e));if(!d.exists())throw new Error("Project not found");const l=d.data(),h=l.teamAssignments||[];console.log("üîç [UnifiedDataService] Project data:",{projectId:e,hasTeamAssignments:!!l.teamAssignments,existingCount:h.length}),await x(f(this.db,"projects",e),{teamAssignments:I(r),updatedAt:new Date},{merge:!0}),await U(f(this.db,"users",t),{"teamMemberData.assignedProjects":I(e),updatedAt:new Date}),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-")}catch(a){throw console.error("Error adding team member to project:",a),a}}async removeTeamMemberFromProject(e,t){try{const n=await C(f(this.db,"projects",e));if(!n.exists())throw new Error("Project not found");const c=n.data().teamAssignments.find(s=>s.userId===t);c&&(await U(f(this.db,"projects",e),{teamAssignments:R(c),updatedAt:new Date}),await U(f(this.db,"users",t),{"teamMemberData.assignedProjects":R(e),updatedAt:new Date}),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-"))}catch(n){throw console.error("Error removing team member from project:",n),n}}async getOrganizationContext(){var a,c,s,o,r,d;(!this.auth||!this.db)&&await this.initializeFirebase();const e=await this.getCurrentUser();if(!e)throw new Error("No authenticated user");const t=`org-context-${e.organization.id}`,n=this.getFromCache(t);if(n)return n;try{const l=await C(f(this.db,"organizations",e.organization.id));if(!l.exists())throw new Error(`Organization ${e.organization.id} not found`);const h=l.data(),p={...h,id:e.organization.id,createdAt:((a=h.createdAt)==null?void 0:a.toDate())||new Date,updatedAt:((c=h.updatedAt)==null?void 0:c.toDate())||new Date},m=A(D(this.db,"subscriptions"),b("organizationId","==",e.organization.id),b("status","==","ACTIVE"),z(1)),y=await v(m);let g=null;if(!y.empty){const u=y.docs[0].data();g={...u,id:y.docs[0].id,createdAt:((s=u.createdAt)==null?void 0:s.toDate())||new Date,updatedAt:((o=u.updatedAt)==null?void 0:o.toDate())||new Date,currentPeriodStart:((r=u.currentPeriodStart)==null?void 0:r.toDate())||new Date,currentPeriodEnd:((d=u.currentPeriodEnd)==null?void 0:d.toDate())||new Date}}let w=[];try{w=await this.getUsersByOrganization(e.organization.id)}catch(u){throw console.error("Failed to get organization members:",u),u}const i={organization:p,subscription:g,members:w};return this.setCache(t,i,10*60*1e3),i}catch(l){throw console.error("Error fetching organization context:",l),l}}async getLicensesForOrganization(){(!this.auth||!this.db)&&await this.initializeFirebase();const e=await this.getCurrentUser();if(!e)return console.log("üîç [UnifiedDataService] No user found for license query"),[];console.log("üîç [UnifiedDataService] Fetching licenses for organization:",e.organization.id);const t=`org-licenses-${e.organization.id}`,n=this.getFromCache(t);if(n)return console.log("üìã [UnifiedDataService] Returning cached licenses:",n.length),n;try{const a=A(D(this.db,"licenses"),b("organizationId","==",e.organization.id),F("createdAt","desc")),c=await v(a);console.log("üìä [UnifiedDataService] Found",c.docs.length,"license documents");const s=c.docs.map(o=>{var d,l,h,p,m,y,g,w;const r=o.data();return{id:o.id,key:r.key||"",name:r.name||`License ${o.id}`,tier:r.tier||"BASIC",status:r.status||"PENDING",organization:r.organization?{id:r.organization.id,name:r.organization.name,tier:r.organization.tier}:{id:r.organizationId||"",name:r.organizationName||"Unknown Organization",tier:r.tier||"BASIC"},assignedTo:r.assignedTo?{userId:r.assignedTo.userId,name:r.assignedTo.name||r.assignedToName||"Unknown User",email:r.assignedTo.email||r.assignedToEmail||"",assignedAt:((d=r.assignedTo.assignedAt)==null?void 0:d.toDate())||((l=r.activatedAt)==null?void 0:l.toDate())||new Date}:r.assignedToUserId?{userId:r.assignedToUserId,name:r.assignedToName||r.assignedToEmail||"Unknown User",email:r.assignedToEmail||"",assignedAt:((h=r.activatedAt)==null?void 0:h.toDate())||new Date}:void 0,usage:r.usage?{apiCalls:r.usage.apiCalls||0,dataTransfer:r.usage.dataTransfer||0,deviceCount:r.usage.deviceCount||1,maxDevices:r.usage.maxDevices||(r.tier==="ENTERPRISE"?10:r.tier==="PROFESSIONAL"?5:2)}:{apiCalls:r.usageCount||0,dataTransfer:0,deviceCount:1,maxDevices:r.tier==="ENTERPRISE"?10:r.tier==="PROFESSIONAL"?5:2},activatedAt:(p=r.activatedAt)==null?void 0:p.toDate(),expiresAt:((m=r.expiresAt)==null?void 0:m.toDate())||new Date,lastUsed:(y=r.lastUsed)==null?void 0:y.toDate(),createdAt:((g=r.createdAt)==null?void 0:g.toDate())||new Date,updatedAt:((w=r.updatedAt)==null?void 0:w.toDate())||new Date}});return console.log("‚úÖ [UnifiedDataService] Processed",s.length,"licenses for organization"),this.setCache(t,s),s}catch(a){return console.error("Error fetching organization licenses:",a),[]}}async createLicense(e){var t,n,a,c,s;try{if(!await this.getCurrentUser())throw new Error("No authenticated user");const r={key:e.key,name:e.name,tier:e.tier,status:e.status,organizationId:e.organization.id,organizationName:e.organization.name,usageCount:((t=e.usage)==null?void 0:t.apiCalls)||0,userId:((n=e.assignedTo)==null?void 0:n.userId)||null,userName:((a=e.assignedTo)==null?void 0:a.name)||null,userEmail:((c=e.assignedTo)==null?void 0:c.email)||null,activatedAt:((s=e.assignedTo)==null?void 0:s.assignedAt)||null,expiresAt:e.expiresAt,lastUsed:null,createdAt:new Date,updatedAt:new Date,organization:e.organization,usage:e.usage};console.log("üé´ [UnifiedDataService] Creating license with Firestore data:",r);const d=await N(D(this.db,"licenses"),r);return this.clearCacheByPattern("org-licenses-"),this.clearCacheByPattern("user-"),this.clearCacheByPattern("organization-"),console.log("üßπ [UnifiedDataService] Cleared license-related caches"),console.log("‚úÖ [UnifiedDataService] License created with ID:",d.id),setTimeout(()=>{this.forceRefreshLicenses().catch(console.error)},100),d.id}catch(o){throw console.error("‚ùå [UnifiedDataService] Error creating license:",o),o}}async updateLicense(e,t){try{const n={...t,updatedAt:new Date};await U(f(this.db,"licenses",e),n),this.clearCacheByPattern("org-licenses-")}catch(n){throw console.error("Error updating license:",n),n}}async assignLicense(e,t){try{console.log("üé´ [UnifiedDataService] Assigning license",e,"to user",t);const n=await C(f(this.db,"users",t));if(!n.exists())throw new Error("User not found");const a=n.data(),c=await C(f(this.db,"licenses",e));if(!c.exists())throw new Error("License not found");const s=c.data();console.log("üîç [UnifiedDataService] User data:",{id:t,email:a.email,name:a.name}),console.log("üîç [UnifiedDataService] License data:",{id:e,key:s.key,tier:s.tier}),await U(f(this.db,"licenses",e),{assignedTo:{userId:t,name:a.name||a.firstName+" "+a.lastName||a.email,email:a.email,assignedAt:new Date},status:"ACTIVE",updatedAt:new Date}),await U(f(this.db,"users",t),{licenseAssignment:{licenseId:e,licenseKey:s.key,licenseType:s.tier,assignedAt:new Date},updatedAt:new Date});try{const o=A(D(this.db,E.TEAM_MEMBERS),b("userId","==",t),z(1)),r=await v(o);if(!r.empty){const d=r.docs[0];await U(d.ref,{licenseAssignment:{licenseId:e,licenseKey:s.key,licenseType:s.tier,assignedAt:new Date},updatedAt:new Date}),console.log("‚úÖ [UnifiedDataService] Updated teamMembers collection with license assignment")}}catch(o){console.warn("‚ö†Ô∏è [UnifiedDataService] Failed to update teamMembers collection:",o)}try{const o=A(D(this.db,E.ORG_MEMBERS),b("userId","==",t),z(1)),r=await v(o);if(!r.empty){const d=r.docs[0];await U(d.ref,{licenseAssignment:{licenseId:e,licenseKey:s.key,licenseType:s.tier,assignedAt:new Date},updatedAt:new Date}),console.log("‚úÖ [UnifiedDataService] Updated orgMembers collection with license assignment")}}catch(o){console.warn("‚ö†Ô∏è [UnifiedDataService] Failed to update orgMembers collection:",o)}console.log("‚úÖ [UnifiedDataService] License assignment completed - all collections updated"),this.clearCacheByPattern("org-licenses-"),this.clearCacheByPattern("org-team-members-"),this.clearCacheByPattern("org-users-")}catch(n){throw console.error("‚ùå [UnifiedDataService] Error assigning license:",n),n}}async unassignLicense(e){var t;try{console.log("üé´ [UnifiedDataService] Unassigning license",e);const n=await C(f(this.db,"licenses",e));if(!n.exists())throw new Error("License not found");const c=(t=n.data().assignedTo)==null?void 0:t.userId;if(await U(f(this.db,"licenses",e),{assignedTo:null,status:"PENDING",updatedAt:new Date}),c&&(await U(f(this.db,"users",c),{licenseAssignment:null,updatedAt:new Date}),console.log("‚úÖ [UnifiedDataService] Removed license assignment from user record",c)),c)try{const s=A(D(this.db,E.TEAM_MEMBERS),b("userId","==",c),z(1)),o=await v(s);if(!o.empty){const r=o.docs[0];await U(r.ref,{licenseAssignment:null,updatedAt:new Date}),console.log("‚úÖ [UnifiedDataService] Removed license assignment from teamMembers collection")}}catch(s){console.warn("‚ö†Ô∏è [UnifiedDataService] Failed to update teamMembers collection:",s)}if(c)try{const s=A(D(this.db,E.ORG_MEMBERS),b("userId","==",c),z(1)),o=await v(s);if(!o.empty){const r=o.docs[0];await U(r.ref,{licenseAssignment:null,updatedAt:new Date}),console.log("‚úÖ [UnifiedDataService] Removed license assignment from orgMembers collection")}}catch(s){console.warn("‚ö†Ô∏è [UnifiedDataService] Failed to update orgMembers collection:",s)}console.log("‚úÖ [UnifiedDataService] License unassignment completed - license returned to org pool"),this.clearCacheByPattern("org-licenses-"),this.clearCacheByPattern("org-team-members-"),this.clearCacheByPattern("org-users-")}catch(n){throw console.error("‚ùå [UnifiedDataService] Error unassigning license:",n),n}}async getTeamMembersForOrganization(){var a,c,s,o,r,d,l,h,p;const e=await this.getCurrentUser();if(!e)return[];const t=`org-team-members-${e.organization.id}`,n=this.getFromCache(t);if(n)return n;try{console.log("üîç [UnifiedDataService] Fetching team members for organization:",e.organization.id);const m=new Map;console.log("üîç [UnifiedDataService] Trying users collection...");try{const g=await B.queryDocumentsWithFallback("users",[{field:"organizationId",operator:"==",value:e.organization.id}],"createdAt","desc");console.log(`üìä [UnifiedDataService] Found ${g.documents.length} users in users collection`);for(const w of g.documents){const i=w;if(i.id===e.id)continue;const u={id:i.id,firstName:i.firstName||((a=i.name)==null?void 0:a.split(" ")[0])||i.email.split("@")[0],lastName:i.lastName||((c=i.name)==null?void 0:c.split(" ")[1])||"",email:i.email,role:i.role||"member",status:i.status==="active"?"active":"pending",organization:{id:i.organizationId||e.organization.id,name:e.organization.name,tier:e.organization.tier},licenseAssignment:i.licenseAssignment?{licenseId:i.licenseAssignment.licenseId,licenseKey:i.licenseAssignment.licenseKey,licenseType:i.licenseAssignment.licenseType,assignedAt:i.licenseAssignment.assignedAt}:void 0,department:i.department||"General",assignedProjects:i.assignedProjects||[],avatar:i.avatar,joinedAt:i.createdAt||new Date,lastActive:i.lastActive,invitedBy:i.invitedBy||e.id,createdAt:i.createdAt||new Date,updatedAt:i.updatedAt||new Date};m.set(i.email,u)}}catch(g){console.warn("‚ö†Ô∏è [UnifiedDataService] Users collection query failed:",g)}console.log("üîç [UnifiedDataService] Trying teamMembers collection...");try{const g=await B.queryDocumentsWithFallback("teamMembers",[{field:"organizationId",operator:"==",value:e.organization.id}],"createdAt","desc");console.log(`üìä [UnifiedDataService] Found ${g.documents.length} team members in teamMembers collection`);for(const w of g.documents){const i=w;if(i.status==="removed"||i.status==="suspended")continue;const u={id:i.id,firstName:i.firstName||((s=i.name)==null?void 0:s.split(" ")[0])||i.email.split("@")[0],lastName:i.lastName||((o=i.name)==null?void 0:o.split(" ")[1])||"",email:i.email,role:i.role||"member",status:i.status||"active",organization:{id:i.organizationId||e.organization.id,name:e.organization.name,tier:e.organization.tier},licenseAssignment:i.licenseAssignment?{licenseId:i.licenseAssignment.licenseId,licenseKey:i.licenseAssignment.licenseKey,licenseType:i.licenseAssignment.licenseType,assignedAt:i.licenseAssignment.assignedAt}:void 0,department:i.department||"General",assignedProjects:i.assignedProjects||[],avatar:i.avatar,joinedAt:i.joinedAt||i.createdAt||new Date,lastActive:i.lastActive,invitedBy:i.invitedBy||e.id,createdAt:i.createdAt||new Date,updatedAt:i.updatedAt||new Date},S=m.get(i.email);S?(S.role=i.role||S.role,S.status=i.status||S.status,S.department=i.department||S.department,S.licenseAssignment=i.licenseAssignment||S.licenseAssignment,m.set(i.email,S)):m.set(i.email,u)}}catch(g){console.warn("‚ö†Ô∏è [UnifiedDataService] TeamMembers collection query failed:",g)}console.log("üîç [UnifiedDataService] Trying orgMembers collection...");try{const g=await B.queryDocumentsWithFallback("orgMembers",[{field:"orgId",operator:"==",value:e.organization.id}],"createdAt","desc");console.log(`üìä [UnifiedDataService] Found ${g.documents.length} org members in orgMembers collection`);for(const w of g.documents){const i=w;if(i.status==="removed"||i.status==="suspended")continue;const u=m.get(i.email);if(u)u.role=i.role||u.role,u.status=i.status||u.status,u.department=i.department||u.department,u.joinedAt=i.joinedAt||u.joinedAt,m.set(i.email,u);else{const S={id:i.userId,firstName:i.firstName||((r=i.name)==null?void 0:r.split(" ")[0])||((d=i.email)==null?void 0:d.split("@")[0])||"Unknown",lastName:i.lastName||((l=i.name)==null?void 0:l.split(" ")[1])||"",email:i.email||i.userEmail||"",role:i.role||"member",status:i.status||"active",organization:{id:i.orgId||e.organization.id,name:e.organization.name,tier:e.organization.tier},licenseAssignment:void 0,department:i.department||"General",assignedProjects:[],avatar:i.avatar,joinedAt:i.joinedAt||i.createdAt||new Date,lastActive:i.lastActive,invitedBy:i.invitedBy||e.id,createdAt:i.createdAt||new Date,updatedAt:i.updatedAt||new Date};m.set(i.email||i.userEmail||"",S)}}}catch(g){console.warn("‚ö†Ô∏è [UnifiedDataService] OrgMembers collection query failed:",g)}console.log("üîç [UnifiedDataService] Trying org_members collection...");try{const g=await B.queryDocumentsWithFallback("org_members",[{field:"orgId",operator:"==",value:e.organization.id}],"createdAt","desc");console.log(`üìä [UnifiedDataService] Found ${g.documents.length} org members in org_members collection`);for(const w of g.documents){const i=w;if(i.status==="removed"||i.status==="suspended")continue;const u=i.email||i.userEmail||"";if(u&&!m.has(u)){const S={id:i.userId,firstName:i.firstName||((h=i.name)==null?void 0:h.split(" ")[0])||u.split("@")[0]||"Unknown",lastName:i.lastName||((p=i.name)==null?void 0:p.split(" ")[1])||"",email:u,role:i.role||"member",status:i.status||"active",organization:{id:i.orgId||e.organization.id,name:e.organization.name,tier:e.organization.tier},licenseAssignment:void 0,department:i.department||"General",assignedProjects:[],avatar:i.avatar,joinedAt:i.joinedAt||i.createdAt||new Date,lastActive:i.lastActive,invitedBy:i.invitedBy||e.id,createdAt:i.createdAt||new Date,updatedAt:i.updatedAt||new Date};m.set(u,S)}}}catch(g){console.warn("‚ö†Ô∏è [UnifiedDataService] org_members collection query failed:",g)}const y=Array.from(m.values());return console.log(`‚úÖ [UnifiedDataService] Successfully fetched ${y.length} unique team members for organization: ${e.organization.id}`),this.setCache(t,y),y}catch(m){return console.error("‚ùå [UnifiedDataService] Failed to fetch team members:",m),[]}}async inviteTeamMember(e){var t;console.log("üöÄ [UnifiedDataService] Creating team member via backend API:",e.email);try{if(!await this.getCurrentUser())throw new Error("No authenticated user");const a={email:e.email,firstName:e.firstName,lastName:e.lastName,department:e.department||"",licenseType:"PROFESSIONAL",organizationId:e.organization.id,sendWelcomeEmail:!0,temporaryPassword:e.temporaryPassword||this.generateSecurePassword()};console.log("üì§ [UnifiedDataService] Sending team member creation request to backend API...");const c=await((t=this.auth.currentUser)==null?void 0:t.getIdToken()),o=await(await fetch(`${this.getApiBaseUrl()}/team-members/create`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(a)})).json();if(!o.success)throw new Error(o.error||"Failed to create team member");const r=o.data.teamMember;return console.log("‚úÖ [UnifiedDataService] Team member created successfully via backend API:",r.id),this.clearCacheByPattern("org-team-members-"),this.clearCacheByPattern("org-users-"),this.clearCacheByPattern("org-members-"),this.clearCacheByPattern("user-profiles-"),r.id}catch(n){throw console.error("‚ùå [UnifiedDataService] Error creating team member via backend API:",n),n}}async ensureTeamMemberProjectReadiness(e){const t={success:!0,collectionsCreated:[],collectionsFound:[],errors:[]};try{console.log("üîç [UnifiedDataService] Checking team member project readiness for userId:",e);const n=await C(f(this.db,E.USERS,e));if(!n.exists())return t.errors.push("User record not found"),t.success=!1,t;const a=n.data();console.log("üìã [UnifiedDataService] Found user data:",a);const c=[{name:"teamMembers",collection:E.TEAM_MEMBERS,createData:()=>({userId:e,email:a.email,firstName:a.firstName,lastName:a.lastName,name:`${a.firstName} ${a.lastName}`,role:a.role||"member",status:a.status||"active",organizationId:a.organizationId,orgId:a.organizationId,department:a.department||"",isActive:!0,firebaseUid:a.firebaseUid||"",createdAt:new Date,updatedAt:new Date})},{name:"orgMembers",collection:E.ORG_MEMBERS,createData:()=>({organizationId:a.organizationId,orgId:a.organizationId,userId:e,email:a.email,name:`${a.firstName} ${a.lastName}`,firstName:a.firstName,lastName:a.lastName,role:a.role||"member",status:a.status||"active",seatReserved:!0,department:a.department||"",invitedByUserId:"system",invitedAt:new Date,joinedAt:new Date,createdAt:new Date,updatedAt:new Date})},{name:"userProfiles",collection:E.USER_PROFILES,createData:()=>({userId:e,email:a.email,firstName:a.firstName,lastName:a.lastName,displayName:`${a.firstName} ${a.lastName}`,avatar:a.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(a.firstName+" "+a.lastName)}&background=667eea&color=fff`,department:a.department||"",position:"",phone:"",organizationId:a.organizationId,role:a.role||"member",status:a.status||"active",bio:"",preferences:{},createdAt:new Date,updatedAt:new Date})}];for(const s of c)try{const o=A(D(this.db,s.collection),b("userId","==",e),z(1));if((await v(o)).empty){console.log(`üìù [UnifiedDataService] Creating missing ${s.name} record for user ${e}`);const d=await N(D(this.db,s.collection),s.createData());t.collectionsCreated.push(`${s.name} (${d.id})`),console.log(`‚úÖ [UnifiedDataService] Created ${s.name} record: ${d.id}`)}else t.collectionsFound.push(s.name),console.log(`‚úÖ [UnifiedDataService] Found existing ${s.name} record`)}catch(o){const r=`Failed to check/create ${s.name}: ${o.message}`;t.errors.push(r),console.error(`‚ùå [UnifiedDataService] ${r}`,o)}return console.log("üìä [UnifiedDataService] Team member project readiness check complete:",t),t}catch(n){return console.error("‚ùå [UnifiedDataService] Failed to ensure team member project readiness:",n),t.errors.push(`General error: ${n.message}`),t.success=!1,t}}generateSecurePassword(){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";let n="";for(let a=0;a<12;a++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}async updateTeamMember(e,t){try{const n={...t,updatedAt:new Date};await U(f(this.db,"users",e),n),this.clearCacheByPattern("org-team-members-"),this.clearCacheByPattern("org-users-")}catch(n){throw console.error("Error updating team member:",n),n}}async changeTeamMemberPassword(e,t){try{console.log("üîê [UnifiedDataService] Changing password for member:",e);const n=await fetch(`/api/team-members/${e}/reset-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await this.getAuthToken()}`},body:JSON.stringify({newPassword:t})});if(!n.ok){const a=await n.json().catch(()=>({}));throw new Error(a.message||`Failed to change password: ${n.status}`)}console.log("‚úÖ [UnifiedDataService] Password changed successfully")}catch(n){throw console.error("‚ùå [UnifiedDataService] Error changing password:",n),n}}async removeTeamMember(e,t){try{console.log("üë§ [UnifiedDataService] Starting comprehensive team member removal:",e);const n=await C(f(this.db,"users",e));if(!n.exists()&&!(await C(f(this.db,"teamMembers",e))).exists())throw new Error("Team member not found");const a=n.exists()?n.data():null,c=t||(a==null?void 0:a.organizationId);if(!c)throw new Error("Organization ID is required for team member removal");console.log("üîç [UnifiedDataService] Team member organization:",c);const s=await this.getAuthToken(),o=await fetch(`${window.location.origin}/api/team-members/remove-completely`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({teamMemberId:e,organizationId:c})});if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const r=await o.json();console.log("‚úÖ [UnifiedDataService] Team member removal completed:",{cleanedCollections:r.cleanedCollections,licenseRestored:r.licenseRestored,firebaseUserDeleted:r.firebaseUserDeleted}),this.clearCacheByPattern("org-team-members-"),this.clearCacheByPattern("org-users-"),this.clearCacheByPattern("org-licenses-"),this.clearCacheByPattern("org-members-"),this.clearCacheByPattern("project-team-members-"),console.log("‚úÖ [UnifiedDataService] Team member completely removed with full cleanup")}catch(n){throw console.error("‚ùå [UnifiedDataService] Error removing team member:",n),n}}async assignLicenseToTeamMember(e,t,n,a){try{await U(f(this.db,"users",e),{licenseAssignment:{licenseId:t,licenseKey:n,licenseType:a,assignedAt:new Date},updatedAt:new Date}),this.clearCacheByPattern("org-team-members-"),this.clearCacheByPattern("org-licenses-")}catch(c){throw console.error("Error assigning license to team member:",c),c}}async getDatasetsForUser(){const e=await this.getCurrentUser();if(!e)return[];const t=`user-datasets-${e.id}`,n=this.getFromCache(t);if(n)return n;try{const a=A(D(this.db,"datasets"),b("owner.organizationId","==",e.organization.id),b("status","==","ACTIVE"),F("updatedAt","desc")),s=(await v(a)).docs.map(o=>{var d,l;const r=o.data();return{...r,id:o.id,createdAt:((d=r.createdAt)==null?void 0:d.toDate())||new Date,updatedAt:((l=r.updatedAt)==null?void 0:l.toDate())||new Date}});return this.setCache(t,s),s}catch(a){return console.error("Error fetching user datasets:",a),[]}}getFromCache(e){const t=this.cache.get(e);return t?Date.now()>t.timestamp+t.ttl?(this.cache.delete(e),null):t.data:null}setCache(e,t,n=this.CACHE_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:n})}clearCacheByPattern(e){for(const t of this.cache.keys())t.includes(e)&&this.cache.delete(t)}clearAllCache(){this.cache.clear(),console.log("üßπ [UnifiedDataService] All cache cleared")}async forceRefreshLicenses(){console.log("üîÑ [UnifiedDataService] Force refreshing license data..."),this.clearCacheByPattern("org-licenses-"),this.clearCacheByPattern("user-"),this.clearCacheByPattern("organization-"),await this.getLicensesForOrganization(),console.log("‚úÖ [UnifiedDataService] License data force refreshed")}clearUserCache(e){e?(this.clearCacheByPattern("current-user"),this.clearCacheByPattern(`org-users-${e}`),this.clearCacheByPattern("org-context"),this.clearCacheByPattern("org-licenses")):this.clearAllCache()}async getCollectionName(e){const t=E[e];try{const n=A(D(this.db,t),z(1));return await v(n),console.log(`‚úÖ [UnifiedDataService] Using primary collection: ${t}`),t}catch{const a=`${e}_LEGACY`;if(E[a]){const c=E[a];try{const s=A(D(this.db,c),z(1));return await v(s),console.log(`‚ö†Ô∏è [UnifiedDataService] Falling back to legacy collection: ${c}`),c}catch{console.warn(`‚ö†Ô∏è [UnifiedDataService] Both primary and legacy collections failed for ${e}`)}}return console.warn(`‚ö†Ô∏è [UnifiedDataService] Using primary collection name despite access issues: ${t}`),t}}async purchaseLicenses(e){try{if(!await this.getCurrentUser())throw new Error("No authenticated user");console.log("üõí [UnifiedDataService] Starting license purchase:",e);const n=await this.getAuthToken(),a=await fetch(`${this.getApiBaseUrl()}/licenses/purchase`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(e)});if(!a.ok){const s=await a.json();throw new Error(s.error||"Purchase failed")}const c=await a.json();if(!c.success)throw new Error(c.error||"Purchase failed");return console.log("‚úÖ [UnifiedDataService] License purchase completed:",c.data),this.clearCacheByPattern("org-licenses-"),this.clearCacheByPattern("user-"),this.clearCacheByPattern("organization-"),this.clearCacheByPattern("subscription-"),this.clearCacheByPattern("invoice-"),setTimeout(()=>{this.forceRefreshLicenses()},1e3),c.data}catch(t){throw console.error("‚ùå [UnifiedDataService] Error purchasing licenses:",t),new Error(`Failed to purchase licenses: ${t.message}`)}}async getInvoicesForOrganization(){var e;try{const t=await this.getCurrentUser();if(!((e=t==null?void 0:t.organization)!=null&&e.id))return console.log("üîç [UnifiedDataService] No organization context for invoices"),[];const n=`org-invoices-${t.organization.id}`,a=this.getFromCache(n);if(a&&Array.isArray(a))return console.log("üìã [UnifiedDataService] Returning cached invoices"),a;console.log("üìã [UnifiedDataService] Fetching invoices for organization:",t.organization.id);const c=A(D(this.db,"invoices"),b("organizationId","==",t.organization.id),F("createdAt","desc")),o=(await v(c)).docs.map(r=>{var d,l,h,p,m,y,g,w;return{id:r.id,...r.data(),createdAt:((l=(d=r.data().createdAt)==null?void 0:d.toDate)==null?void 0:l.call(d))||new Date(r.data().createdAt),updatedAt:((p=(h=r.data().updatedAt)==null?void 0:h.toDate)==null?void 0:p.call(h))||new Date(r.data().updatedAt),paidAt:((y=(m=r.data().paidAt)==null?void 0:m.toDate)==null?void 0:y.call(m))||(r.data().paidAt?new Date(r.data().paidAt):null),dueDate:((w=(g=r.data().dueDate)==null?void 0:g.toDate)==null?void 0:w.call(g))||new Date(r.data().dueDate)}});return this.setCache(n,o),console.log(`‚úÖ [UnifiedDataService] Found ${o.length} invoices`),o}catch(t){return console.error("‚ùå [UnifiedDataService] Error fetching invoices:",t),[]}}async getPaymentsForOrganization(){var e;try{const t=await this.getCurrentUser();if(!((e=t==null?void 0:t.organization)!=null&&e.id))return console.log("üîç [UnifiedDataService] No organization context for payments"),[];const n=`org-payments-${t.organization.id}`,a=this.getFromCache(n);if(a&&Array.isArray(a))return console.log("üí∞ [UnifiedDataService] Returning cached payments"),a;console.log("üí∞ [UnifiedDataService] Fetching payments for organization:",t.organization.id);const c=A(D(this.db,"payments"),b("organizationId","==",t.organization.id),F("createdAt","desc")),o=(await v(c)).docs.map(r=>{var d,l,h,p,m,y;return{id:r.id,...r.data(),createdAt:((l=(d=r.data().createdAt)==null?void 0:d.toDate)==null?void 0:l.call(d))||new Date(r.data().createdAt),updatedAt:((p=(h=r.data().updatedAt)==null?void 0:h.toDate)==null?void 0:p.call(h))||new Date(r.data().updatedAt),processedAt:((y=(m=r.data().processedAt)==null?void 0:m.toDate)==null?void 0:y.call(m))||(r.data().processedAt?new Date(r.data().processedAt):null)}});return this.setCache(n,o),console.log(`‚úÖ [UnifiedDataService] Found ${o.length} payments`),o}catch(t){return console.error("‚ùå [UnifiedDataService] Error fetching payments:",t),[]}}async getSubscriptionForOrganization(){var e,t,n,a,c,s,o,r,d,l,h;try{const p=await this.getCurrentUser();if(!((e=p==null?void 0:p.organization)!=null&&e.id))return console.log("üîç [UnifiedDataService] No organization context for subscription"),null;const m=`org-subscription-${p.organization.id}`,y=this.getFromCache(m);if(y)return console.log("üìã [UnifiedDataService] Returning cached subscription"),y;console.log("üìã [UnifiedDataService] Fetching subscription for organization:",p.organization.id);const g=A(D(this.db,"subscriptions"),b("organizationId","==",p.organization.id),F("createdAt","desc"),z(1)),w=await v(g);if(w.empty)return console.log("üìã [UnifiedDataService] No subscription found"),null;const i=w.docs[0],u={id:i.id,...i.data(),createdAt:((n=(t=i.data().createdAt)==null?void 0:t.toDate)==null?void 0:n.call(t))||new Date(i.data().createdAt),updatedAt:((c=(a=i.data().updatedAt)==null?void 0:a.toDate)==null?void 0:c.call(a))||new Date(i.data().updatedAt),currentPeriodStart:((o=(s=i.data().currentPeriodStart)==null?void 0:s.toDate)==null?void 0:o.call(s))||new Date(i.data().currentPeriodStart),currentPeriodEnd:((d=(r=i.data().currentPeriodEnd)==null?void 0:r.toDate)==null?void 0:d.call(r))||new Date(i.data().currentPeriodEnd),activatedAt:((h=(l=i.data().activatedAt)==null?void 0:l.toDate)==null?void 0:h.call(l))||(i.data().activatedAt?new Date(i.data().activatedAt):null)};return this.setCache(m,u),console.log("‚úÖ [UnifiedDataService] Found subscription:",u.id),u}catch(p){return console.error("‚ùå [UnifiedDataService] Error fetching subscription:",p),null}}static getInstance(){return P.instance||(P.instance=new P),P.instance}};T(P,"instance");let j=P;const Y=j.getInstance();export{Y as default,Y as unifiedDataService};
