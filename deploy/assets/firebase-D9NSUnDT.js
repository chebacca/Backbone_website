const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index.esm-zGMEL0w1.js","assets/index.esm-DFeBm_6f.js","assets/FirestoreCollectionManager-CHbpsnH6.js","assets/index-Tqq4GLGg.js","assets/mui-BO-fjSjW.js","assets/vendor-CjD1bmmO.js","assets/stripe-BghXmgwV.js","assets/index-CBai7h7s.css","assets/index.esm-DPts1Tj8.js"])))=>i.map(i=>d[i]);
import{_ as E}from"./index-Tqq4GLGg.js";import{r as P,i as T,g as I,S as O,D as U,_ as x,a as k,b as L,c as V,d as q,e as Q,f as B,h as G,F as K}from"./index.esm-DFeBm_6f.js";import{getFirestore as M,query as F,collection as w,where as m,getDocs as y,getDoc as _,doc as A,orderBy as $,addDoc as W,deleteDoc as Y}from"./index.esm-DPts1Tj8.js";import{getAuth as N}from"./index.esm-zGMEL0w1.js";import"./mui-BO-fjSjW.js";import"./vendor-CjD1bmmO.js";import"./stripe-BghXmgwV.js";var J="firebase",X="12.1.0";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */P(J,X,"app");const Z=Object.freeze(Object.defineProperty({__proto__:null,FirebaseError:K,SDK_VERSION:O,_DEFAULT_ENTRY_NAME:U,_addComponent:x,_apps:k,_components:L,_getProvider:V,_isFirebaseServerApp:q,_registerComponent:Q,_serverApps:B,getApp:G,getApps:I,initializeApp:T,registerVersion:P},Symbol.toStringTag,{value:"Module"})),S={},H=()=>typeof window<"u"&&window.FIREBASE_CONFIG?window.FIREBASE_CONFIG:{apiKey:(S==null?void 0:S.VITE_FIREBASE_API_KEY)||"AIzaSyDFnIzSYCdPsDDdvP1lympVxEeUn0AQhWs",authDomain:"backbone-logic.firebaseapp.com",projectId:"backbone-logic",databaseURL:"https://backbone-logic-default-rtdb.firebaseio.com",storageBucket:"backbone-logic.firebasestorage.app",messagingSenderId:"749245129278",appId:"1:749245129278:web:dfa5647101ea160a3b276f",measurementId:"G-8SZRDQ4XVR"},R=H();let n;if(typeof window<"u"&&window.firebaseApp)console.log("üî• [Firebase] Using globally initialized Firebase app"),n=window.firebaseApp;else{const e=I();if(e.length>0)n=e[0],console.log("üî• [Firebase] Using existing Firebase app:",n.name),typeof window<"u"&&(window.firebaseApp=n);else try{n=T(R),console.log("üî• [Firebase] App initialized successfully"),typeof window<"u"&&(window.firebaseApp=n)}catch(t){console.error("‚ùå [Firebase] Failed to initialize app:",t);const r=I();r.length>0&&(n=r[0],console.log("üî• [Firebase] Using fallback existing app:",n.name))}}async function ee(){if(n)return n;if(typeof window<"u"&&window.firebaseApp)return n=window.firebaseApp,console.log("‚úÖ [Firebase] Found global app instance"),n;try{const{getApps:e}=await E(async()=>{const{getApps:r}=await Promise.resolve().then(()=>Z);return{getApps:r}},void 0),t=e();if(t.length>0)return n=t[0],console.log("‚úÖ [Firebase] Using existing app instance"),typeof window<"u"&&(window.firebaseApp=n),n}catch(e){console.warn("‚ö†Ô∏è [Firebase] Failed to get existing apps:",e)}try{return n=T(R,"fallback"),console.log("‚úÖ [Firebase] Created fallback app instance"),typeof window<"u"&&(window.firebaseApp=n),n}catch(e){throw console.error("‚ùå [Firebase] Failed to create fallback app:",e),new Error("Failed to initialize Firebase app")}}const d=n?M(n):M(),f=n?N(n):N();f&&E(async()=>{const{setPersistence:e,browserLocalPersistence:t}=await import("./index.esm-zGMEL0w1.js");return{setPersistence:e,browserLocalPersistence:t}},__vite__mapDeps([0,1])).then(({setPersistence:e,browserLocalPersistence:t})=>{e(f,t).catch(r=>{console.warn("‚ö†Ô∏è [Firebase] Failed to set auth persistence:",r)})}).catch(e=>{console.warn("‚ö†Ô∏è [Firebase] Failed to import auth persistence:",e)});async function me(){const e=await ee();return{app:e,db:M(e),auth:N(e)}}function te(){if(!(typeof window>"u"))try{console.log("‚ÑπÔ∏è [Firebase] Skipping client-side CSP override - relying on Firebase hosting CSP");const e=document.querySelector('meta[http-equiv="Content-Security-Policy"]');e&&(e.remove(),console.log("üßπ [Firebase] Removed conflicting client-side CSP meta tag"))}catch(e){console.warn("‚ö†Ô∏è [Firebase] Failed to clean up CSP:",e)}}te();typeof window<"u"&&(window.FIREBASE_IGNORE_UNDEFINED_PROPERTIES=!0);console.log("üåê [Firebase] Licensing website mode: production (web-only) - no emulators");const de=()=>!0;let v=!1;const pe=async()=>{if(!v)try{const{firestoreCollectionManager:e}=await E(async()=>{const{firestoreCollectionManager:t}=await import("./FirestoreCollectionManager-CHbpsnH6.js");return{firestoreCollectionManager:t}},__vite__mapDeps([2,3,4,5,6,7,8,1,0]));await e.initializeCollections(),v=!0,console.log("‚úÖ [Firebase] Collection manager initialized")}catch(e){console.error("‚ùå [Firebase] Failed to initialize collection manager:",e)}},ue=()=>f.currentUser!==null,be=()=>f.currentUser,re=e=>{var t;return((t=f.currentUser)==null?void 0:t.email)===e},ge=async e=>{var t,r;try{const{doc:c,getDoc:a,query:p,collection:i,where:l,getDocs:b}=await E(async()=>{const{doc:g,getDoc:h,query:D,collection:C,where:j,getDocs:z}=await import("./index.esm-DPts1Tj8.js");return{doc:g,getDoc:h,query:D,collection:C,where:j,getDocs:z}},__vite__mapDeps([8,1]));let u=await a(c(d,"users",e.uid)),o=null,s=null;if(u.exists())o=u.data(),s=u.id,console.log("‚úÖ [Firebase] Found user by Firebase UID:",o.email);else{const g=p(i(d,"users"),l("email","==",e.email)),h=await b(g);h.empty||(o=h.docs[0].data(),s=h.docs[0].id,console.log("‚úÖ [Firebase] Found user by email:",o.email))}return o&&s?{id:s,email:o.email,name:o.name||o.displayName||e.displayName||o.email.split("@")[0],role:o.role||"USER",organizationId:o.organizationId,isTeamMember:o.isTeamMember,memberRole:o.memberRole,memberStatus:o.memberStatus,firebaseUid:e.uid,subscription:o.subscription,licenses:o.licenses,teamMemberData:o.teamMemberData}:{id:e.uid,email:e.email||"",name:e.displayName||((t=e.email)==null?void 0:t.split("@")[0])||"User",role:"USER",firebaseUid:e.uid}}catch(c){return console.warn("‚ö†Ô∏è [Firebase] Failed to load user from Firestore:",c),{id:e.uid,email:e.email||"",name:e.displayName||((r=e.email)==null?void 0:r.split("@")[0])||"User",role:"USER",firebaseUid:e.uid}}},fe=async e=>{try{if(console.log("üîë [Firebase] Attempting to restore Firebase Auth session for:",e),re(e))return console.log("‚úÖ [Firebase] User already authenticated with correct email"),!0;if(f.currentUser&&f.currentUser.email!==e){console.log("üîÑ [Firebase] Different user authenticated, signing out first");const{signOut:t}=await E(async()=>{const{signOut:r}=await import("./index.esm-zGMEL0w1.js");return{signOut:r}},__vite__mapDeps([0,1]));await t(f)}try{const t=localStorage.getItem("temp_credentials");if(t){const r=JSON.parse(t);if(r.email===e&&r.password){console.log("üîë [Firebase] Attempting to restore Firebase Auth session with stored credentials");const{signInWithEmailAndPassword:c}=await E(async()=>{const{signInWithEmailAndPassword:a}=await import("./index.esm-zGMEL0w1.js");return{signInWithEmailAndPassword:a}},__vite__mapDeps([0,1]));return await c(f,e,r.password),console.log("‚úÖ [Firebase] Firebase Auth session restored successfully"),!0}}}catch(t){console.warn("‚ö†Ô∏è [Firebase] Could not restore session with stored credentials:",t)}return console.log("‚ÑπÔ∏è [Firebase] No stored credentials available for session restoration"),!1}catch(t){return console.warn("‚ö†Ô∏è [Firebase] Error during session restoration:",t),!1}};class we{static async getOrganizationsForUser(t){try{console.log("üîç [Firebase] Getting organizations for user:",t);const r=F(w(d,"organizations"),m("ownerUserId","==",t)),c=await y(r),a=F(w(d,"org_members"),m("userId","==",t),m("status","==","ACTIVE")),p=await y(a),i=new Set,l=[];c.forEach(b=>{const u={id:b.id,...b.data()};l.push(u),i.add(b.id)});for(const b of p.docs){const o=b.data().orgId;if(!i.has(o)){const s=await _(A(d,"organizations",o));if(s.exists()){const g={id:s.id,...s.data()};l.push(g),i.add(o)}}}return console.log("‚úÖ [Firebase] Found organizations:",l.length),l}catch(r){return console.error("‚ùå [Firebase] Error getting organizations:",r),[]}}static async getOrgMembers(t){try{console.log("üîç [Firebase] Getting org members for:",t);const r=F(w(d,"org_members"),m("orgId","==",t),m("status","==","ACTIVE"),$("createdAt","desc")),c=await y(r),a=[];return c.forEach(p=>{const i=p.data();let l=i.name;l||(i.firstName&&i.lastName?l=`${i.firstName} ${i.lastName}`:i.firstName?l=i.firstName:i.lastName?l=i.lastName:i.email?l=i.email.split("@")[0].replace(/[._-]/g," ").split(" ").map(s=>s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()).join(" "):l="Unknown User");const b={id:p.id,...i,name:l};a.push(b)}),console.log("‚úÖ [Firebase] Found org members:",a.length),a}catch(r){return console.error("‚ùå [Firebase] Error getting org members:",r),[]}}static async getProjectTeamMembers(t){try{console.log("üîç [Firebase] Getting project team members for:",t);const r=F(w(d,"projectTeamMembers"),m("projectId","==",t),m("isActive","==",!0)),c=await y(r),a=[];for(const p of c.docs){const i=p.data();let l;try{const u=await _(A(d,"org_members",i.teamMemberId));if(u.exists()){const o=u.data();let s=o.name;s||(o.firstName&&o.lastName?s=`${o.firstName} ${o.lastName}`:o.firstName?s=o.firstName:o.lastName?s=o.lastName:o.email?s=o.email.split("@")[0].replace(/[._-]/g," ").split(" ").map(D=>D.charAt(0).toUpperCase()+D.slice(1).toLowerCase()).join(" "):s="Unknown User"),l={id:u.id,...o,name:s}}}catch(u){console.warn("Failed to get team member details:",u)}const b={id:p.id,...i,teamMember:l};a.push(b)}return console.log("‚úÖ [Firebase] Found project team members:",a.length),a}catch(r){return console.error("‚ùå [Firebase] Error getting project team members:",r),[]}}static async addTeamMemberToProject(t,r,c="DO_ER"){try{console.log("üîç [Firebase] Adding team member to project:",{projectId:t,teamMemberId:r,role:c});let a=!1,p=null;try{const s=await _(A(d,"teamMembers",r));s.exists()&&(a=!0,p=s.data(),console.log("‚úÖ [Firebase] Found team member in teamMembers collection"))}catch{console.log("üîç [Firebase] Team member not found in teamMembers, checking other collections...")}if(!a)try{const s=await _(A(d,"users",r));s.exists()&&(a=!0,p=s.data(),console.log("‚úÖ [Firebase] Found team member in users collection"))}catch{console.log("üîç [Firebase] Team member not found in users collection...")}if(!a)try{const s=await _(A(d,"orgMembers",r));s.exists()&&(a=!0,p=s.data(),console.log("‚úÖ [Firebase] Found team member in orgMembers collection"))}catch{console.log("üîç [Firebase] Team member not found in orgMembers collection...")}if(!a)throw new Error(`Team member not found in any collection: ${r}`);const i=F(w(d,"projectTeamMembers"),m("projectId","==",t),m("teamMemberId","==",r),m("isActive","==",!0));if(!(await y(i)).empty)throw new Error("Team member is already assigned to this project");if(c==="ADMIN"){const s=F(w(d,"projectTeamMembers"),m("projectId","==",t),m("role","==","ADMIN"),m("isActive","==",!0));if(!(await y(s)).empty)throw new Error("Only one Admin is allowed per project. Please remove the existing Admin first.")}const b={projectId:t,teamMemberId:r,role:c,assignedAt:new Date,assignedBy:"current_user",isActive:!0},u=Object.fromEntries(Object.entries(b).filter(([s,g])=>g!=null)),o=await W(w(d,"projectTeamMembers"),u);return console.log("‚úÖ [Firebase] Team member added successfully:",o.id),{id:o.id,...b}}catch(a){throw console.error("‚ùå [Firebase] Error adding team member:",a),a}}static async removeTeamMemberFromProject(t,r){try{console.log("üîç [Firebase] Removing team member from project:",{projectId:t,teamMemberId:r});const c=F(w(d,"projectTeamMembers"),m("projectId","==",t),m("teamMemberId","==",r),m("isActive","==",!0)),a=await y(c);for(const p of a.docs)await Y(A(d,"projectTeamMembers",p.id));console.log("‚úÖ [Firebase] Team member removed successfully")}catch(c){throw console.error("‚ùå [Firebase] Error removing team member:",c),c}}}export{we as FirebaseTeamMemberService,n as app,f as auth,d as db,we as default,f as firebaseAuth,d as firestore,te as fixCSPIssues,be as getCurrentFirebaseUser,me as getInitializedServices,pe as initializeFirebaseCollections,re as isEmailAuthenticated,ue as isUserAuthenticated,de as isWebOnlyMode,ge as loadUserFromFirestore,fe as tryRestoreFirebaseSession};
