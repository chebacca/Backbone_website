import{j as e,B as o,d as k,T as l,bM as re,H as F,aB as V,g as H,R as $,C as ee,aG as ie,aH as G,ac as ne,_ as T,a0 as q,G as I,t as v,v as A,aM as ae,o as B,r as y,i as oe,bN as W,p as Y,w as K,x as J,y as M,z as Q,D as X}from"./mui-CCWxH8Vb.js";import{r as d,b as Z,u as le}from"./vendor-CjD1bmmO.js";import{u as ce}from"./index-D_5tSDXr.js";import{getAuth as de}from"./index.esm-e-DuI42t.js";import"./index.esm-Dkmm1Qng.js";import"./stripe-vGaGA8Al.js";const he=({userRole:j,organizationId:r})=>{const[b,w]=d.useState(0),[i,_]=d.useState(null),[f,S]=d.useState([]),[D,z]=d.useState([]),[U,C]=d.useState(!0),[O,E]=d.useState(new Date),g=d.useCallback(()=>j==="DEV_ADMIN"||j==="ORG_ADMIN",[j]),u=j==="DEV_ADMIN",x=j==="ORG_ADMIN",L=d.useCallback(async()=>{try{if(C(!0),u){const[s,n]=await Promise.all([fetch("/api/security/metrics?source=dashboard_app").then(a=>a.json()).catch(()=>null),fetch("/api/security/metrics?source=licensing_website").then(a=>a.json()).catch(()=>null)]),c={totalUsers:((s==null?void 0:s.totalUsers)||0)+((n==null?void 0:n.totalUsers)||0),activeUsers:((s==null?void 0:s.activeUsers)||0)+((n==null?void 0:n.activeUsers)||0),securityAlerts:((s==null?void 0:s.securityAlerts)||0)+((n==null?void 0:n.securityAlerts)||0),criticalAlerts:((s==null?void 0:s.criticalAlerts)||0)+((n==null?void 0:n.criticalAlerts)||0),resolvedAlerts:((s==null?void 0:s.resolvedAlerts)||0)+((n==null?void 0:n.resolvedAlerts)||0),threatLevel:"medium",lastUpdated:new Date};_(c)}else if(x&&r){const s=await fetch(`/api/security/metrics?source=licensing_website&organizationId=${r}`).then(n=>n.json()).catch(()=>null);_(s||{totalUsers:0,activeUsers:0,securityAlerts:0,criticalAlerts:0,resolvedAlerts:0,threatLevel:"low",lastUpdated:new Date})}}catch(s){console.error("Error loading security metrics:",s)}finally{C(!1)}},[u,x,r]),R=d.useCallback(async()=>{try{if(u){const[s,n]=await Promise.all([fetch("/api/security/alerts?source=dashboard_app").then(a=>a.json()).catch(()=>[]),fetch("/api/security/alerts?source=licensing_website").then(a=>a.json()).catch(()=>[])]),c=[...s,...n].map(a=>({...a,timestamp:new Date(a.timestamp)})).sort((a,P)=>P.timestamp.getTime()-a.timestamp.getTime());S(c)}else if(x&&r){const n=(await fetch(`/api/security/alerts?source=licensing_website&organizationId=${r}`).then(c=>c.json()).catch(()=>[])).map(c=>({...c,timestamp:new Date(c.timestamp)})).sort((c,a)=>a.timestamp.getTime()-c.timestamp.getTime());S(n)}}catch(s){console.error("Error loading security alerts:",s)}},[u,x,r]),m=d.useCallback(async()=>{try{if(u){const[s,n]=await Promise.all([fetch("/api/security/users?source=dashboard_app").then(a=>a.json()).catch(()=>[]),fetch("/api/security/users?source=licensing_website").then(a=>a.json()).catch(()=>[])]),c=[...s,...n].map(a=>({...a,userId:`user_${a.userId.slice(-4)}`,lastActivity:new Date(a.lastActivity),lastLogin:new Date(a.lastLogin)})).sort((a,P)=>P.lastActivity.getTime()-a.lastActivity.getTime());z(c)}else if(x&&r){const n=(await fetch(`/api/security/users?source=licensing_website&organizationId=${r}`).then(c=>c.json()).catch(()=>[])).map(c=>({...c,lastActivity:new Date(c.lastActivity),lastLogin:new Date(c.lastLogin)})).sort((c,a)=>a.lastActivity.getTime()-c.lastActivity.getTime());z(n)}}catch(s){console.error("Error loading user overviews:",s)}},[u,x,r]),h=d.useCallback(async()=>{E(new Date),await Promise.all([L(),R(),m()])},[L,R,m]);d.useEffect(()=>{g()&&h()},[g,h]),d.useEffect(()=>{if(!g())return;const s=setInterval(h,3e4);return()=>clearInterval(s)},[g,h]);const t=s=>{switch(s){case"critical":return"error";case"high":return"warning";case"medium":return"info";case"low":return"success";default:return"default"}},p=s=>{switch(s){case"critical":return"#d32f2f";case"high":return"#f57c00";case"medium":return"#fbc02d";case"low":return"#388e3c";default:return"#757575"}},N=()=>{var s;return e.jsxs(I,{container:!0,spacing:3,children:[e.jsx(I,{item:!0,xs:12,sm:6,md:3,children:e.jsx(v,{children:e.jsx(A,{children:e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(o,{children:[e.jsx(l,{color:"textSecondary",gutterBottom:!0,children:"Total Users"}),e.jsx(l,{variant:"h4",children:(i==null?void 0:i.totalUsers)||0})]}),e.jsx(q,{color:"primary",sx:{fontSize:40}})]})})})}),e.jsx(I,{item:!0,xs:12,sm:6,md:3,children:e.jsx(v,{children:e.jsx(A,{children:e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(o,{children:[e.jsx(l,{color:"textSecondary",gutterBottom:!0,children:"Active Users"}),e.jsx(l,{variant:"h4",color:"success.main",children:(i==null?void 0:i.activeUsers)||0})]}),e.jsx(ae,{color:"success",sx:{fontSize:40}})]})})})}),e.jsx(I,{item:!0,xs:12,sm:6,md:3,children:e.jsx(v,{children:e.jsx(A,{children:e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(o,{children:[e.jsx(l,{color:"textSecondary",gutterBottom:!0,children:"Security Alerts"}),e.jsx(l,{variant:"h4",color:"warning.main",children:(i==null?void 0:i.securityAlerts)||0})]}),e.jsx(T,{color:"warning",sx:{fontSize:40}})]})})})}),e.jsx(I,{item:!0,xs:12,sm:6,md:3,children:e.jsx(v,{children:e.jsx(A,{children:e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(o,{children:[e.jsx(l,{color:"textSecondary",gutterBottom:!0,children:"Critical Alerts"}),e.jsx(l,{variant:"h4",color:"error.main",children:(i==null?void 0:i.criticalAlerts)||0})]}),e.jsx(B,{color:"error",sx:{fontSize:40}})]})})})}),e.jsx(I,{item:!0,xs:12,children:e.jsx(v,{children:e.jsxs(A,{children:[e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,children:[e.jsx(l,{variant:"h6",children:"Overall Threat Level"}),e.jsx(y,{label:((s=i==null?void 0:i.threatLevel)==null?void 0:s.toUpperCase())||"UNKNOWN",color:t((i==null?void 0:i.threatLevel)||"low"),size:"large"})]}),e.jsx(oe,{variant:"determinate",value:(i==null?void 0:i.threatLevel)==="critical"?100:(i==null?void 0:i.threatLevel)==="high"?75:(i==null?void 0:i.threatLevel)==="medium"?50:25,sx:{height:8,borderRadius:4,backgroundColor:"rgba(0,0,0,0.1)","& .MuiLinearProgress-bar":{backgroundColor:p((i==null?void 0:i.threatLevel)||"low")}}})]})})})]})},se=()=>e.jsxs(v,{children:[e.jsx(W,{title:"Security Alerts",action:e.jsx(V,{title:"Refresh Alerts",children:e.jsx(H,{onClick:h,children:e.jsx($,{})})})}),e.jsx(A,{children:f.length===0?e.jsx(k,{severity:"success",icon:e.jsx(Y,{}),children:"No security alerts at this time"}):e.jsx(K,{children:f.slice(0,20).map((s,n)=>e.jsxs(Z.Fragment,{children:[e.jsxs(J,{children:[e.jsx(M,{children:s.severity==="critical"?e.jsx(B,{color:"error"}):s.severity==="high"?e.jsx(T,{color:"warning"}):e.jsx(F,{color:"info"})}),e.jsx(Q,{primary:e.jsxs(o,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(l,{variant:"subtitle1",children:s.description}),e.jsx(y,{label:s.severity.toUpperCase(),color:t(s.severity),size:"small"}),e.jsx(y,{label:s.source.replace("_"," ").toUpperCase(),variant:"outlined",size:"small"})]}),secondary:e.jsxs(o,{children:[e.jsx(l,{variant:"body2",color:"textSecondary",children:s.timestamp.toLocaleString()}),e.jsxs(l,{variant:"body2",color:"textSecondary",children:["User: ",s.userContext.isAnonymized?"***":s.userContext.userId," | Role: ",s.userContext.userRole," | Org: ",s.userContext.organizationId]})]})}),e.jsx(o,{children:s.resolved?e.jsx(y,{label:"Resolved",color:"success",size:"small"}):e.jsx(y,{label:"Active",color:"warning",size:"small"})})]}),n<f.length-1&&e.jsx(X,{})]},s.id))})})]}),te=()=>e.jsxs(v,{children:[e.jsx(W,{title:"User Security Overview",subheader:"Anonymized user security status across all platforms"}),e.jsx(A,{children:D.length===0?e.jsx(k,{severity:"info",children:"No user data available"}):e.jsx(K,{children:D.slice(0,50).map((s,n)=>e.jsxs(Z.Fragment,{children:[e.jsxs(J,{children:[e.jsx(M,{children:s.threatLevel==="critical"?e.jsx(B,{color:"error"}):s.threatLevel==="high"?e.jsx(T,{color:"warning"}):s.threatLevel==="medium"?e.jsx(F,{color:"info"}):e.jsx(Y,{color:"success"})}),e.jsx(Q,{primary:e.jsxs(o,{display:"flex",alignItems:"center",gap:1,children:[e.jsxs(l,{variant:"subtitle1",children:["User ",s.userId]}),e.jsx(y,{label:s.threatLevel.toUpperCase(),color:t(s.threatLevel),size:"small"}),s.isOnline&&e.jsx(y,{label:"Online",color:"success",size:"small"}),s.suspiciousActivity&&e.jsx(y,{label:"Suspicious",color:"warning",size:"small"})]}),secondary:e.jsxs(o,{children:[e.jsxs(l,{variant:"body2",color:"textSecondary",children:["Role: ",s.userRole," | Org: ",s.organizationId," | Devices: ",s.deviceCount," | Alerts: ",s.activeAlerts]}),e.jsxs(l,{variant:"body2",color:"textSecondary",children:["Last Activity: ",s.lastActivity.toLocaleString()," | Last Login: ",s.lastLogin.toLocaleString()]})]})})]}),n<D.length-1&&e.jsx(X,{})]},s.userId))})})]});return g()?e.jsxs(o,{p:3,children:[e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:3,children:[e.jsxs(o,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(F,{color:"primary",sx:{fontSize:40}}),e.jsxs(o,{children:[e.jsx(l,{variant:"h4",component:"h1",children:u?"Master Security Dashboard":"Organization Security Dashboard"}),e.jsx(l,{variant:"subtitle1",color:"textSecondary",children:u?"Cross-Platform Security Monitoring & Threat Detection":"Organization Security Monitoring & Team Member Management"})]})]}),e.jsxs(o,{display:"flex",alignItems:"center",gap:2,children:[e.jsxs(l,{variant:"body2",color:"textSecondary",children:["Last updated: ",O.toLocaleString()]}),e.jsx(V,{title:"Refresh All Data",children:e.jsx(H,{onClick:h,disabled:U,children:e.jsx($,{})})})]})]}),U&&e.jsx(o,{display:"flex",justifyContent:"center",mb:3,children:e.jsx(ee,{})}),e.jsx(o,{mb:3,children:e.jsxs(ie,{value:b,onChange:(s,n)=>w(n),children:[e.jsx(G,{label:"Overview",icon:e.jsx(ne,{})}),e.jsx(G,{label:"Security Alerts",icon:e.jsx(T,{})}),e.jsx(G,{label:"User Overview",icon:e.jsx(q,{})})]})}),b===0&&N(),b===1&&se(),b===2&&te()]}):e.jsx(o,{p:3,children:e.jsxs(k,{severity:"error",icon:e.jsx(re,{}),children:[e.jsx(l,{variant:"h6",children:"Access Denied"}),e.jsx(l,{children:"You do not have the required permissions to access the Security Dashboard. This dashboard is restricted to DEV ADMIN and Organization Admin users only."})]})})},pe=()=>{const j=le(),{user:r,loading:b}=ce(),[w,i]=d.useState("USER"),[_,f]=d.useState(),[S,D]=d.useState(!0);return d.useEffect(()=>{(async()=>{var U,C,O,E,g,u,x,L;if(!r){D(!1);return}try{const m=de().currentUser;if(console.log("SecurityDashboard - Firebase Auth user:",m),console.log("SecurityDashboard - Firebase Auth user email:",m==null?void 0:m.email),m){const t=(await m.getIdTokenResult()).claims;console.log("SecurityDashboard - Firebase Auth claims:",t);const p=(t==null?void 0:t.role)==="DEV_ADMIN"||(t==null?void 0:t.role)==="SuperAdmin"||(t==null?void 0:t.role)==="SUPERADMIN"||(t==null?void 0:t.isDevAdmin)===!0||((U=t==null?void 0:t.permissions)==null?void 0:U.includes("security:master_access"))||((C=t==null?void 0:t.permissions)==null?void 0:C.includes("admin:master_security")),N=(t==null?void 0:t.role)==="ADMIN"||(t==null?void 0:t.role)==="ORG_ADMIN"||(t==null?void 0:t.role)==="SuperAdmin"||(t==null?void 0:t.role)==="SUPERADMIN"||(t==null?void 0:t.isOrgAdmin)===!0||((O=t==null?void 0:t.permissions)==null?void 0:O.includes("admin:organization"))||((E=t==null?void 0:t.permissions)==null?void 0:E.includes("admin:team_members"));console.log("SecurityDashboard - Firebase Auth isDevAdmin:",p),console.log("SecurityDashboard - Firebase Auth isOrgAdmin:",N),p?(console.log("SecurityDashboard - Setting role to DEV_ADMIN (Firebase Auth)"),i("DEV_ADMIN")):N?(console.log("SecurityDashboard - Setting role to ORG_ADMIN (Firebase Auth)"),i("ORG_ADMIN"),f((t==null?void 0:t.organizationId)||(r==null?void 0:r.organizationId))):(console.log("SecurityDashboard - Setting role to USER (Firebase Auth)"),i("USER"))}else{console.log("SecurityDashboard - No Firebase Auth user, using fallback role detection"),console.log("SecurityDashboard - User object:",r),console.log("SecurityDashboard - User properties:",Object.keys(r||{}));const h=(r==null?void 0:r.role)||(r==null?void 0:r.userRole)||(r==null?void 0:r.user_type),t=h==="DEV_ADMIN"||h==="SuperAdmin"||h==="SUPERADMIN"||(r==null?void 0:r.isDevAdmin)===!0||((g=r==null?void 0:r.permissions)==null?void 0:g.includes("security:master_access"))||((u=r==null?void 0:r.permissions)==null?void 0:u.includes("admin:master_security")),p=h==="ADMIN"||h==="ORG_ADMIN"||h==="SuperAdmin"||h==="SUPERADMIN"||(r==null?void 0:r.isOrgAdmin)===!0||((x=r==null?void 0:r.permissions)==null?void 0:x.includes("admin:organization"))||((L=r==null?void 0:r.permissions)==null?void 0:L.includes("admin:team_members"));console.log("SecurityDashboard - Fallback isDevAdmin:",t),console.log("SecurityDashboard - Fallback isOrgAdmin:",p),t?(console.log("SecurityDashboard - Setting role to DEV_ADMIN (fallback)"),i("DEV_ADMIN")):p?(console.log("SecurityDashboard - Setting role to ORG_ADMIN (fallback)"),i("ORG_ADMIN"),f(r==null?void 0:r.organizationId)):(console.log("SecurityDashboard - Setting role to USER (fallback)"),i("USER"))}}catch(R){console.error("Error checking user permissions:",R),i("USER")}finally{D(!1)}})()},[r]),d.useEffect(()=>{!S&&w==="USER"&&(console.log("SecurityDashboard - Redirecting non-admin user to dashboard"),j("/dashboard"))},[w,S,j]),b||S?e.jsxs(o,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",flexDirection:"column",gap:2,children:[e.jsx(ee,{size:60}),e.jsx(l,{variant:"h6",color:"textSecondary",children:"Loading Security Dashboard..."})]}):r?e.jsx(he,{userRole:w,organizationId:_}):e.jsx(o,{p:3,children:e.jsxs(k,{severity:"error",children:[e.jsx(l,{variant:"h6",children:"Authentication Required"}),e.jsx(l,{children:"You must be logged in to access the Security Dashboard."})]})})};export{pe as default};
