import{j as e,B as o,d as N,T as l,bM as re,H as z,aB as B,g as V,R as F,C as Z,aG as ie,aH as P,ac as ne,_ as E,a0 as H,G as S,t as p,v,aM as ae,o as G,r as g,i as oe,bN as $,p as q,w as W,x as Y,y as K,z as J,D as Q}from"./mui-CCWxH8Vb.js";import{r as d,b as X,u as le}from"./vendor-CjD1bmmO.js";import{u as ce}from"./index-DUsOwf0X.js";import"./stripe-vGaGA8Al.js";const de=({userRole:y,organizationId:i})=>{const[f,C]=d.useState(0),[r,L]=d.useState(null),[A,R]=d.useState([]),[b,T]=d.useState([]),[D,I]=d.useState(!0),[_,O]=d.useState(new Date),j=d.useCallback(()=>y==="DEV_ADMIN"||y==="ORG_ADMIN",[y]),u=y==="DEV_ADMIN",m=y==="ORG_ADMIN",w=d.useCallback(async()=>{try{if(I(!0),u){const[s,n]=await Promise.all([fetch("/api/security/metrics?source=dashboard_app").then(a=>a.json()).catch(()=>null),fetch("/api/security/metrics?source=licensing_website").then(a=>a.json()).catch(()=>null)]),c={totalUsers:((s==null?void 0:s.totalUsers)||0)+((n==null?void 0:n.totalUsers)||0),activeUsers:((s==null?void 0:s.activeUsers)||0)+((n==null?void 0:n.activeUsers)||0),securityAlerts:((s==null?void 0:s.securityAlerts)||0)+((n==null?void 0:n.securityAlerts)||0),criticalAlerts:((s==null?void 0:s.criticalAlerts)||0)+((n==null?void 0:n.criticalAlerts)||0),resolvedAlerts:((s==null?void 0:s.resolvedAlerts)||0)+((n==null?void 0:n.resolvedAlerts)||0),threatLevel:"medium",lastUpdated:new Date};L(c)}else if(m&&i){const s=await fetch(`/api/security/metrics?source=licensing_website&organizationId=${i}`).then(n=>n.json()).catch(()=>null);L(s||{totalUsers:0,activeUsers:0,securityAlerts:0,criticalAlerts:0,resolvedAlerts:0,threatLevel:"low",lastUpdated:new Date})}}catch(s){console.error("Error loading security metrics:",s)}finally{I(!1)}},[u,m,i]),h=d.useCallback(async()=>{try{if(u){const[s,n]=await Promise.all([fetch("/api/security/alerts?source=dashboard_app").then(a=>a.json()).catch(()=>[]),fetch("/api/security/alerts?source=licensing_website").then(a=>a.json()).catch(()=>[])]),c=[...s,...n].map(a=>({...a,timestamp:new Date(a.timestamp)})).sort((a,k)=>k.timestamp.getTime()-a.timestamp.getTime());R(c)}else if(m&&i){const n=(await fetch(`/api/security/alerts?source=licensing_website&organizationId=${i}`).then(c=>c.json()).catch(()=>[])).map(c=>({...c,timestamp:new Date(c.timestamp)})).sort((c,a)=>a.timestamp.getTime()-c.timestamp.getTime());R(n)}}catch(s){console.error("Error loading security alerts:",s)}},[u,m,i]),t=d.useCallback(async()=>{try{if(u){const[s,n]=await Promise.all([fetch("/api/security/users?source=dashboard_app").then(a=>a.json()).catch(()=>[]),fetch("/api/security/users?source=licensing_website").then(a=>a.json()).catch(()=>[])]),c=[...s,...n].map(a=>({...a,userId:`user_${a.userId.slice(-4)}`,lastActivity:new Date(a.lastActivity),lastLogin:new Date(a.lastLogin)})).sort((a,k)=>k.lastActivity.getTime()-a.lastActivity.getTime());T(c)}else if(m&&i){const n=(await fetch(`/api/security/users?source=licensing_website&organizationId=${i}`).then(c=>c.json()).catch(()=>[])).map(c=>({...c,lastActivity:new Date(c.lastActivity),lastLogin:new Date(c.lastLogin)})).sort((c,a)=>a.lastActivity.getTime()-c.lastActivity.getTime());T(n)}}catch(s){console.error("Error loading user overviews:",s)}},[u,m,i]),x=d.useCallback(async()=>{O(new Date),await Promise.all([w(),h(),t()])},[w,h,t]);d.useEffect(()=>{j()&&x()},[j,x]),d.useEffect(()=>{if(!j())return;const s=setInterval(x,3e4);return()=>clearInterval(s)},[j,x]);const U=s=>{switch(s){case"critical":return"error";case"high":return"warning";case"medium":return"info";case"low":return"success";default:return"default"}},M=s=>{switch(s){case"critical":return"#d32f2f";case"high":return"#f57c00";case"medium":return"#fbc02d";case"low":return"#388e3c";default:return"#757575"}},ee=()=>{var s;return e.jsxs(S,{container:!0,spacing:3,children:[e.jsx(S,{item:!0,xs:12,sm:6,md:3,children:e.jsx(p,{children:e.jsx(v,{children:e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(o,{children:[e.jsx(l,{color:"textSecondary",gutterBottom:!0,children:"Total Users"}),e.jsx(l,{variant:"h4",children:(r==null?void 0:r.totalUsers)||0})]}),e.jsx(H,{color:"primary",sx:{fontSize:40}})]})})})}),e.jsx(S,{item:!0,xs:12,sm:6,md:3,children:e.jsx(p,{children:e.jsx(v,{children:e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(o,{children:[e.jsx(l,{color:"textSecondary",gutterBottom:!0,children:"Active Users"}),e.jsx(l,{variant:"h4",color:"success.main",children:(r==null?void 0:r.activeUsers)||0})]}),e.jsx(ae,{color:"success",sx:{fontSize:40}})]})})})}),e.jsx(S,{item:!0,xs:12,sm:6,md:3,children:e.jsx(p,{children:e.jsx(v,{children:e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(o,{children:[e.jsx(l,{color:"textSecondary",gutterBottom:!0,children:"Security Alerts"}),e.jsx(l,{variant:"h4",color:"warning.main",children:(r==null?void 0:r.securityAlerts)||0})]}),e.jsx(E,{color:"warning",sx:{fontSize:40}})]})})})}),e.jsx(S,{item:!0,xs:12,sm:6,md:3,children:e.jsx(p,{children:e.jsx(v,{children:e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(o,{children:[e.jsx(l,{color:"textSecondary",gutterBottom:!0,children:"Critical Alerts"}),e.jsx(l,{variant:"h4",color:"error.main",children:(r==null?void 0:r.criticalAlerts)||0})]}),e.jsx(G,{color:"error",sx:{fontSize:40}})]})})})}),e.jsx(S,{item:!0,xs:12,children:e.jsx(p,{children:e.jsxs(v,{children:[e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,children:[e.jsx(l,{variant:"h6",children:"Overall Threat Level"}),e.jsx(g,{label:((s=r==null?void 0:r.threatLevel)==null?void 0:s.toUpperCase())||"UNKNOWN",color:U((r==null?void 0:r.threatLevel)||"low"),size:"large"})]}),e.jsx(oe,{variant:"determinate",value:(r==null?void 0:r.threatLevel)==="critical"?100:(r==null?void 0:r.threatLevel)==="high"?75:(r==null?void 0:r.threatLevel)==="medium"?50:25,sx:{height:8,borderRadius:4,backgroundColor:"rgba(0,0,0,0.1)","& .MuiLinearProgress-bar":{backgroundColor:M((r==null?void 0:r.threatLevel)||"low")}}})]})})})]})},se=()=>e.jsxs(p,{children:[e.jsx($,{title:"Security Alerts",action:e.jsx(B,{title:"Refresh Alerts",children:e.jsx(V,{onClick:x,children:e.jsx(F,{})})})}),e.jsx(v,{children:A.length===0?e.jsx(N,{severity:"success",icon:e.jsx(q,{}),children:"No security alerts at this time"}):e.jsx(W,{children:A.slice(0,20).map((s,n)=>e.jsxs(X.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(K,{children:s.severity==="critical"?e.jsx(G,{color:"error"}):s.severity==="high"?e.jsx(E,{color:"warning"}):e.jsx(z,{color:"info"})}),e.jsx(J,{primary:e.jsxs(o,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(l,{variant:"subtitle1",children:s.description}),e.jsx(g,{label:s.severity.toUpperCase(),color:U(s.severity),size:"small"}),e.jsx(g,{label:s.source.replace("_"," ").toUpperCase(),variant:"outlined",size:"small"})]}),secondary:e.jsxs(o,{children:[e.jsx(l,{variant:"body2",color:"textSecondary",children:s.timestamp.toLocaleString()}),e.jsxs(l,{variant:"body2",color:"textSecondary",children:["User: ",s.userContext.isAnonymized?"***":s.userContext.userId," | Role: ",s.userContext.userRole," | Org: ",s.userContext.organizationId]})]})}),e.jsx(o,{children:s.resolved?e.jsx(g,{label:"Resolved",color:"success",size:"small"}):e.jsx(g,{label:"Active",color:"warning",size:"small"})})]}),n<A.length-1&&e.jsx(Q,{})]},s.id))})})]}),te=()=>e.jsxs(p,{children:[e.jsx($,{title:"User Security Overview",subheader:"Anonymized user security status across all platforms"}),e.jsx(v,{children:b.length===0?e.jsx(N,{severity:"info",children:"No user data available"}):e.jsx(W,{children:b.slice(0,50).map((s,n)=>e.jsxs(X.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(K,{children:s.threatLevel==="critical"?e.jsx(G,{color:"error"}):s.threatLevel==="high"?e.jsx(E,{color:"warning"}):s.threatLevel==="medium"?e.jsx(z,{color:"info"}):e.jsx(q,{color:"success"})}),e.jsx(J,{primary:e.jsxs(o,{display:"flex",alignItems:"center",gap:1,children:[e.jsxs(l,{variant:"subtitle1",children:["User ",s.userId]}),e.jsx(g,{label:s.threatLevel.toUpperCase(),color:U(s.threatLevel),size:"small"}),s.isOnline&&e.jsx(g,{label:"Online",color:"success",size:"small"}),s.suspiciousActivity&&e.jsx(g,{label:"Suspicious",color:"warning",size:"small"})]}),secondary:e.jsxs(o,{children:[e.jsxs(l,{variant:"body2",color:"textSecondary",children:["Role: ",s.userRole," | Org: ",s.organizationId," | Devices: ",s.deviceCount," | Alerts: ",s.activeAlerts]}),e.jsxs(l,{variant:"body2",color:"textSecondary",children:["Last Activity: ",s.lastActivity.toLocaleString()," | Last Login: ",s.lastLogin.toLocaleString()]})]})})]}),n<b.length-1&&e.jsx(Q,{})]},s.userId))})})]});return j()?e.jsxs(o,{p:3,children:[e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:3,children:[e.jsxs(o,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(z,{color:"primary",sx:{fontSize:40}}),e.jsxs(o,{children:[e.jsx(l,{variant:"h4",component:"h1",children:u?"Master Security Dashboard":"Organization Security Dashboard"}),e.jsx(l,{variant:"subtitle1",color:"textSecondary",children:u?"Cross-Platform Security Monitoring & Threat Detection":"Organization Security Monitoring & Team Member Management"})]})]}),e.jsxs(o,{display:"flex",alignItems:"center",gap:2,children:[e.jsxs(l,{variant:"body2",color:"textSecondary",children:["Last updated: ",_.toLocaleString()]}),e.jsx(B,{title:"Refresh All Data",children:e.jsx(V,{onClick:x,disabled:D,children:e.jsx(F,{})})})]})]}),D&&e.jsx(o,{display:"flex",justifyContent:"center",mb:3,children:e.jsx(Z,{})}),e.jsx(o,{mb:3,children:e.jsxs(ie,{value:f,onChange:(s,n)=>C(n),children:[e.jsx(P,{label:"Overview",icon:e.jsx(ne,{})}),e.jsx(P,{label:"Security Alerts",icon:e.jsx(E,{})}),e.jsx(P,{label:"User Overview",icon:e.jsx(H,{})})]})}),f===0&&ee(),f===1&&se(),f===2&&te()]}):e.jsx(o,{p:3,children:e.jsxs(N,{severity:"error",icon:e.jsx(re,{}),children:[e.jsx(l,{variant:"h6",children:"Access Denied"}),e.jsx(l,{children:"You do not have the required permissions to access the Security Dashboard. This dashboard is restricted to DEV ADMIN and Organization Admin users only."})]})})},je=()=>{const y=le(),{user:i,loading:f}=ce(),[C,r]=d.useState("USER"),[L,A]=d.useState(),[R,b]=d.useState(!0);return d.useEffect(()=>{(async()=>{var D,I,_,O,j,u,m,w;if(!i){b(!1);return}try{if(console.log("SecurityDashboard - User object:",i),console.log("SecurityDashboard - User email:",i.email),console.log("SecurityDashboard - User type:",typeof i),console.log("SecurityDashboard - User has getIdTokenResult:",typeof i.getIdTokenResult),typeof i.getIdTokenResult=="function"){const t=(await i.getIdTokenResult()).claims;console.log("SecurityDashboard - User claims:",t);const x=(t==null?void 0:t.role)==="DEV_ADMIN"||(t==null?void 0:t.role)==="SuperAdmin"||(t==null?void 0:t.role)==="SUPERADMIN"||(t==null?void 0:t.isDevAdmin)===!0||((D=t==null?void 0:t.permissions)==null?void 0:D.includes("security:master_access"))||((I=t==null?void 0:t.permissions)==null?void 0:I.includes("admin:master_security")),U=(t==null?void 0:t.role)==="ADMIN"||(t==null?void 0:t.role)==="ORG_ADMIN"||(t==null?void 0:t.role)==="SuperAdmin"||(t==null?void 0:t.role)==="SUPERADMIN"||(t==null?void 0:t.isOrgAdmin)===!0||((_=t==null?void 0:t.permissions)==null?void 0:_.includes("admin:organization"))||((O=t==null?void 0:t.permissions)==null?void 0:O.includes("admin:team_members"));x?r("DEV_ADMIN"):U?(r("ORG_ADMIN"),A((t==null?void 0:t.organizationId)||i.organizationId)):r("USER")}else{console.log("SecurityDashboard - Using fallback role detection"),console.log("SecurityDashboard - User properties:",Object.keys(i));const h=i.role||i.userRole||i.user_type,t=h==="DEV_ADMIN"||h==="SuperAdmin"||h==="SUPERADMIN"||i.isDevAdmin===!0||((j=i.permissions)==null?void 0:j.includes("security:master_access"))||((u=i.permissions)==null?void 0:u.includes("admin:master_security")),x=h==="ADMIN"||h==="ORG_ADMIN"||h==="SuperAdmin"||h==="SUPERADMIN"||i.isOrgAdmin===!0||((m=i.permissions)==null?void 0:m.includes("admin:organization"))||((w=i.permissions)==null?void 0:w.includes("admin:team_members"));console.log("SecurityDashboard - Fallback isDevAdmin:",t),console.log("SecurityDashboard - Fallback isOrgAdmin:",x),t?(console.log("SecurityDashboard - Setting role to DEV_ADMIN (fallback)"),r("DEV_ADMIN")):x?(console.log("SecurityDashboard - Setting role to ORG_ADMIN (fallback)"),r("ORG_ADMIN"),A(i.organizationId)):(console.log("SecurityDashboard - Setting role to USER (fallback)"),r("USER"))}if(C==="USER"){y("/dashboard");return}}catch(h){console.error("Error checking user permissions:",h),r("USER")}finally{b(!1)}})()},[i]),f||R?e.jsxs(o,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",flexDirection:"column",gap:2,children:[e.jsx(Z,{size:60}),e.jsx(l,{variant:"h6",color:"textSecondary",children:"Loading Security Dashboard..."})]}):i?e.jsx(de,{userRole:C,organizationId:L}):e.jsx(o,{p:3,children:e.jsxs(N,{severity:"error",children:[e.jsx(l,{variant:"h6",children:"Authentication Required"}),e.jsx(l,{children:"You must be logged in to access the Security Dashboard."})]})})};export{je as default};
