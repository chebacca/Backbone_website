import{j as e,B as a,d as T,T as o,bM as re,H as E,aB as G,g as V,R as H,C as Z,aG as ie,aH as k,ac as ne,_ as O,a0 as $,G as f,t as m,v as g,aM as ae,o as N,r as u,i as oe,bN as q,p as F,w as W,x as Y,y as K,z as J,D as Q}from"./mui-CCWxH8Vb.js";import{r as c,b as X,u as le}from"./vendor-CjD1bmmO.js";import{u as ce}from"./index-CTTTYNKs.js";import"./stripe-vGaGA8Al.js";const de=({userRole:j,organizationId:d})=>{const[v,w]=c.useState(0),[r,D]=c.useState(null),[A,I]=c.useState([]),[y,R]=c.useState([]),[b,S]=c.useState(!0),[C,L]=c.useState(new Date),h=c.useCallback(()=>j==="DEV_ADMIN"||j==="ORG_ADMIN",[j]),t=j==="DEV_ADMIN",x=j==="ORG_ADMIN",U=c.useCallback(async()=>{try{if(S(!0),t){const[s,i]=await Promise.all([fetch("/api/security/metrics?source=dashboard_app").then(n=>n.json()).catch(()=>null),fetch("/api/security/metrics?source=licensing_website").then(n=>n.json()).catch(()=>null)]),l={totalUsers:((s==null?void 0:s.totalUsers)||0)+((i==null?void 0:i.totalUsers)||0),activeUsers:((s==null?void 0:s.activeUsers)||0)+((i==null?void 0:i.activeUsers)||0),securityAlerts:((s==null?void 0:s.securityAlerts)||0)+((i==null?void 0:i.securityAlerts)||0),criticalAlerts:((s==null?void 0:s.criticalAlerts)||0)+((i==null?void 0:i.criticalAlerts)||0),resolvedAlerts:((s==null?void 0:s.resolvedAlerts)||0)+((i==null?void 0:i.resolvedAlerts)||0),threatLevel:"medium",lastUpdated:new Date};D(l)}else if(x&&d){const s=await fetch(`/api/security/metrics?source=licensing_website&organizationId=${d}`).then(i=>i.json()).catch(()=>null);D(s||{totalUsers:0,activeUsers:0,securityAlerts:0,criticalAlerts:0,resolvedAlerts:0,threatLevel:"low",lastUpdated:new Date})}}catch(s){console.error("Error loading security metrics:",s)}finally{S(!1)}},[t,x,d]),P=c.useCallback(async()=>{try{if(t){const[s,i]=await Promise.all([fetch("/api/security/alerts?source=dashboard_app").then(n=>n.json()).catch(()=>[]),fetch("/api/security/alerts?source=licensing_website").then(n=>n.json()).catch(()=>[])]),l=[...s,...i].map(n=>({...n,timestamp:new Date(n.timestamp)})).sort((n,z)=>z.timestamp.getTime()-n.timestamp.getTime());I(l)}else if(x&&d){const i=(await fetch(`/api/security/alerts?source=licensing_website&organizationId=${d}`).then(l=>l.json()).catch(()=>[])).map(l=>({...l,timestamp:new Date(l.timestamp)})).sort((l,n)=>n.timestamp.getTime()-l.timestamp.getTime());I(i)}}catch(s){console.error("Error loading security alerts:",s)}},[t,x,d]),B=c.useCallback(async()=>{try{if(t){const[s,i]=await Promise.all([fetch("/api/security/users?source=dashboard_app").then(n=>n.json()).catch(()=>[]),fetch("/api/security/users?source=licensing_website").then(n=>n.json()).catch(()=>[])]),l=[...s,...i].map(n=>({...n,userId:`user_${n.userId.slice(-4)}`,lastActivity:new Date(n.lastActivity),lastLogin:new Date(n.lastLogin)})).sort((n,z)=>z.lastActivity.getTime()-n.lastActivity.getTime());R(l)}else if(x&&d){const i=(await fetch(`/api/security/users?source=licensing_website&organizationId=${d}`).then(l=>l.json()).catch(()=>[])).map(l=>({...l,lastActivity:new Date(l.lastActivity),lastLogin:new Date(l.lastLogin)})).sort((l,n)=>n.lastActivity.getTime()-l.lastActivity.getTime());R(i)}}catch(s){console.error("Error loading user overviews:",s)}},[t,x,d]),p=c.useCallback(async()=>{L(new Date),await Promise.all([U(),P(),B()])},[U,P,B]);c.useEffect(()=>{h()&&p()},[h,p]),c.useEffect(()=>{if(!h())return;const s=setInterval(p,3e4);return()=>clearInterval(s)},[h,p]);const _=s=>{switch(s){case"critical":return"error";case"high":return"warning";case"medium":return"info";case"low":return"success";default:return"default"}},M=s=>{switch(s){case"critical":return"#d32f2f";case"high":return"#f57c00";case"medium":return"#fbc02d";case"low":return"#388e3c";default:return"#757575"}},ee=()=>{var s;return e.jsxs(f,{container:!0,spacing:3,children:[e.jsx(f,{item:!0,xs:12,sm:6,md:3,children:e.jsx(m,{children:e.jsx(g,{children:e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(a,{children:[e.jsx(o,{color:"textSecondary",gutterBottom:!0,children:"Total Users"}),e.jsx(o,{variant:"h4",children:(r==null?void 0:r.totalUsers)||0})]}),e.jsx($,{color:"primary",sx:{fontSize:40}})]})})})}),e.jsx(f,{item:!0,xs:12,sm:6,md:3,children:e.jsx(m,{children:e.jsx(g,{children:e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(a,{children:[e.jsx(o,{color:"textSecondary",gutterBottom:!0,children:"Active Users"}),e.jsx(o,{variant:"h4",color:"success.main",children:(r==null?void 0:r.activeUsers)||0})]}),e.jsx(ae,{color:"success",sx:{fontSize:40}})]})})})}),e.jsx(f,{item:!0,xs:12,sm:6,md:3,children:e.jsx(m,{children:e.jsx(g,{children:e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(a,{children:[e.jsx(o,{color:"textSecondary",gutterBottom:!0,children:"Security Alerts"}),e.jsx(o,{variant:"h4",color:"warning.main",children:(r==null?void 0:r.securityAlerts)||0})]}),e.jsx(O,{color:"warning",sx:{fontSize:40}})]})})})}),e.jsx(f,{item:!0,xs:12,sm:6,md:3,children:e.jsx(m,{children:e.jsx(g,{children:e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(a,{children:[e.jsx(o,{color:"textSecondary",gutterBottom:!0,children:"Critical Alerts"}),e.jsx(o,{variant:"h4",color:"error.main",children:(r==null?void 0:r.criticalAlerts)||0})]}),e.jsx(N,{color:"error",sx:{fontSize:40}})]})})})}),e.jsx(f,{item:!0,xs:12,children:e.jsx(m,{children:e.jsxs(g,{children:[e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,children:[e.jsx(o,{variant:"h6",children:"Overall Threat Level"}),e.jsx(u,{label:((s=r==null?void 0:r.threatLevel)==null?void 0:s.toUpperCase())||"UNKNOWN",color:_((r==null?void 0:r.threatLevel)||"low"),size:"large"})]}),e.jsx(oe,{variant:"determinate",value:(r==null?void 0:r.threatLevel)==="critical"?100:(r==null?void 0:r.threatLevel)==="high"?75:(r==null?void 0:r.threatLevel)==="medium"?50:25,sx:{height:8,borderRadius:4,backgroundColor:"rgba(0,0,0,0.1)","& .MuiLinearProgress-bar":{backgroundColor:M((r==null?void 0:r.threatLevel)||"low")}}})]})})})]})},se=()=>e.jsxs(m,{children:[e.jsx(q,{title:"Security Alerts",action:e.jsx(G,{title:"Refresh Alerts",children:e.jsx(V,{onClick:p,children:e.jsx(H,{})})})}),e.jsx(g,{children:A.length===0?e.jsx(T,{severity:"success",icon:e.jsx(F,{}),children:"No security alerts at this time"}):e.jsx(W,{children:A.slice(0,20).map((s,i)=>e.jsxs(X.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(K,{children:s.severity==="critical"?e.jsx(N,{color:"error"}):s.severity==="high"?e.jsx(O,{color:"warning"}):e.jsx(E,{color:"info"})}),e.jsx(J,{primary:e.jsxs(a,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(o,{variant:"subtitle1",children:s.description}),e.jsx(u,{label:s.severity.toUpperCase(),color:_(s.severity),size:"small"}),e.jsx(u,{label:s.source.replace("_"," ").toUpperCase(),variant:"outlined",size:"small"})]}),secondary:e.jsxs(a,{children:[e.jsx(o,{variant:"body2",color:"textSecondary",children:s.timestamp.toLocaleString()}),e.jsxs(o,{variant:"body2",color:"textSecondary",children:["User: ",s.userContext.isAnonymized?"***":s.userContext.userId," | Role: ",s.userContext.userRole," | Org: ",s.userContext.organizationId]})]})}),e.jsx(a,{children:s.resolved?e.jsx(u,{label:"Resolved",color:"success",size:"small"}):e.jsx(u,{label:"Active",color:"warning",size:"small"})})]}),i<A.length-1&&e.jsx(Q,{})]},s.id))})})]}),te=()=>e.jsxs(m,{children:[e.jsx(q,{title:"User Security Overview",subheader:"Anonymized user security status across all platforms"}),e.jsx(g,{children:y.length===0?e.jsx(T,{severity:"info",children:"No user data available"}):e.jsx(W,{children:y.slice(0,50).map((s,i)=>e.jsxs(X.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(K,{children:s.threatLevel==="critical"?e.jsx(N,{color:"error"}):s.threatLevel==="high"?e.jsx(O,{color:"warning"}):s.threatLevel==="medium"?e.jsx(E,{color:"info"}):e.jsx(F,{color:"success"})}),e.jsx(J,{primary:e.jsxs(a,{display:"flex",alignItems:"center",gap:1,children:[e.jsxs(o,{variant:"subtitle1",children:["User ",s.userId]}),e.jsx(u,{label:s.threatLevel.toUpperCase(),color:_(s.threatLevel),size:"small"}),s.isOnline&&e.jsx(u,{label:"Online",color:"success",size:"small"}),s.suspiciousActivity&&e.jsx(u,{label:"Suspicious",color:"warning",size:"small"})]}),secondary:e.jsxs(a,{children:[e.jsxs(o,{variant:"body2",color:"textSecondary",children:["Role: ",s.userRole," | Org: ",s.organizationId," | Devices: ",s.deviceCount," | Alerts: ",s.activeAlerts]}),e.jsxs(o,{variant:"body2",color:"textSecondary",children:["Last Activity: ",s.lastActivity.toLocaleString()," | Last Login: ",s.lastLogin.toLocaleString()]})]})})]}),i<y.length-1&&e.jsx(Q,{})]},s.userId))})})]});return h()?e.jsxs(a,{p:3,children:[e.jsxs(a,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:3,children:[e.jsxs(a,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(E,{color:"primary",sx:{fontSize:40}}),e.jsxs(a,{children:[e.jsx(o,{variant:"h4",component:"h1",children:t?"Master Security Dashboard":"Organization Security Dashboard"}),e.jsx(o,{variant:"subtitle1",color:"textSecondary",children:t?"Cross-Platform Security Monitoring & Threat Detection":"Organization Security Monitoring & Team Member Management"})]})]}),e.jsxs(a,{display:"flex",alignItems:"center",gap:2,children:[e.jsxs(o,{variant:"body2",color:"textSecondary",children:["Last updated: ",C.toLocaleString()]}),e.jsx(G,{title:"Refresh All Data",children:e.jsx(V,{onClick:p,disabled:b,children:e.jsx(H,{})})})]})]}),b&&e.jsx(a,{display:"flex",justifyContent:"center",mb:3,children:e.jsx(Z,{})}),e.jsx(a,{mb:3,children:e.jsxs(ie,{value:v,onChange:(s,i)=>w(i),children:[e.jsx(k,{label:"Overview",icon:e.jsx(ne,{})}),e.jsx(k,{label:"Security Alerts",icon:e.jsx(O,{})}),e.jsx(k,{label:"User Overview",icon:e.jsx($,{})})]})}),v===0&&ee(),v===1&&se(),v===2&&te()]}):e.jsx(a,{p:3,children:e.jsxs(T,{severity:"error",icon:e.jsx(re,{}),children:[e.jsx(o,{variant:"h6",children:"Access Denied"}),e.jsx(o,{children:"You do not have the required permissions to access the Security Dashboard. This dashboard is restricted to DEV ADMIN and Organization Admin users only."})]})})},me=()=>{const j=le(),{user:d,loading:v}=ce(),[w,r]=c.useState("USER"),[D,A]=c.useState(),[I,y]=c.useState(!0);return c.useEffect(()=>{(async()=>{var b,S,C,L;if(!d){y(!1);return}try{const t=(await d.getIdTokenResult()).claims,x=(t==null?void 0:t.role)==="DEV_ADMIN"||(t==null?void 0:t.role)==="SuperAdmin"||(t==null?void 0:t.isDevAdmin)===!0||((b=t==null?void 0:t.permissions)==null?void 0:b.includes("security:master_access"))||((S=t==null?void 0:t.permissions)==null?void 0:S.includes("admin:master_security")),U=(t==null?void 0:t.role)==="ADMIN"||(t==null?void 0:t.role)==="ORG_ADMIN"||(t==null?void 0:t.isOrgAdmin)===!0||((C=t==null?void 0:t.permissions)==null?void 0:C.includes("admin:organization"))||((L=t==null?void 0:t.permissions)==null?void 0:L.includes("admin:team_members"));if(x?r("DEV_ADMIN"):U?(r("ORG_ADMIN"),A((t==null?void 0:t.organizationId)||d.organizationId)):r("USER"),w==="USER"){j("/dashboard");return}}catch(h){console.error("Error checking user permissions:",h),r("USER")}finally{y(!1)}})()},[d]),v||I?e.jsxs(a,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",flexDirection:"column",gap:2,children:[e.jsx(Z,{size:60}),e.jsx(o,{variant:"h6",color:"textSecondary",children:"Loading Security Dashboard..."})]}):d?e.jsx(de,{userRole:w,organizationId:D}):e.jsx(a,{p:3,children:e.jsxs(T,{severity:"error",children:[e.jsx(o,{variant:"h6",children:"Authentication Required"}),e.jsx(o,{children:"You must be logged in to access the Security Dashboard."})]})})};export{me as default};
