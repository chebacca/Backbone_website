const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-upeJyhkk.js","assets/index-DiHjxWyy.js","assets/mui-BEXhTKQE.js","assets/vendor-CjD1bmmO.js","assets/stripe-BgsnbYLP.js","assets/index-CBai7h7s.css","assets/index.esm-D7ujsXeY.js","assets/index.esm-DonjM_pP.js","assets/index.esm-D2YDx4vs.js"])))=>i.map(i=>d[i]);
var v=Object.defineProperty;var O=(i,e,a)=>e in i?v(i,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[e]=a;var C=(i,e,a)=>O(i,typeof e!="symbol"?e+"":e,a);import{r as u}from"./vendor-CjD1bmmO.js";import{_ as N}from"./index-DiHjxWyy.js";import{getDoc as T,doc as m,query as z,collection as y,where as A,getDocs as P,updateDoc as f,addDoc as S,arrayUnion as F,arrayRemove as I,limit as k,orderBy as U}from"./index.esm-DonjM_pP.js";const D=class D{constructor(){C(this,"cache",new Map);C(this,"CACHE_TTL",5*60*1e3);C(this,"db",null);C(this,"auth",null);this.initializeFirebase()}async initializeFirebase(){try{console.log("🔧 [UnifiedDataService] Initializing Firebase...");const{db:e,auth:a}=await N(async()=>{const{db:t,auth:n}=await import("./firebase-upeJyhkk.js");return{db:t,auth:n}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));this.db=e,this.auth=a,console.log("✅ [UnifiedDataService] Firebase initialized successfully")}catch(e){throw console.error("❌ [UnifiedDataService] Failed to initialize Firebase:",e),e}}async getCurrentUser(){var t,n,c,s;const e="current-user",a=this.getFromCache(e);if(a)return a;if((!this.auth||!this.db)&&await this.initializeFirebase(),!((t=this.auth)!=null&&t.currentUser))return console.log("🔍 [UnifiedDataService] No Firebase Auth user found"),null;try{const o=await T(m(this.db,"users",this.auth.currentUser.uid));if(!o.exists())return console.error("User document not found"),null;const r=o.data();let d=null;if(r.organizationId){const w=await T(m(this.db,"organizations",r.organizationId));w.exists()&&(d=w.data())}const l={id:r.organizationId||"default-org",name:(d==null?void 0:d.name)||r.organizationName||"Default Organization",tier:(d==null?void 0:d.tier)||r.tier||"BASIC",isOwner:r.userType==="ACCOUNT_OWNER"||r.role==="OWNER"},h={id:r.id||this.auth.currentUser.uid,email:r.email||"",name:r.name||r.firstName+" "+r.lastName||"Unknown User",userType:r.userType||"TEAM_MEMBER",role:r.role||"member",organization:l,license:{type:r.licenseType||r.tier||"BASIC",status:r.status||"ACTIVE",permissions:r.permissions||[],canCreateProjects:r.tier==="ENTERPRISE"||r.tier==="PROFESSIONAL",canManageTeam:r.role==="admin"||r.role==="owner"},teamMemberData:r.userType==="TEAM_MEMBER"?{managedBy:r.managedBy||"",department:r.department||"",assignedProjects:r.assignedProjects||[]}:void 0,status:r.status||"ACTIVE",createdAt:((n=r.createdAt)==null?void 0:n.toDate())||new Date,updatedAt:((c=r.updatedAt)==null?void 0:c.toDate())||new Date,lastLoginAt:(s=r.lastLoginAt)==null?void 0:s.toDate()};return this.setCache(e,h),h}catch(o){return console.error("Error fetching current user:",o),null}}async getUsersByOrganization(e){const a=`org-users-${e}`,t=this.getFromCache(a);if(t)return t;try{const n=z(y(this.db,"users"),A("organizationId","==",e)),s=(await P(n)).docs.map(o=>{var d,l,h;const r=o.data();return{id:o.id,email:r.email||"",name:r.name||r.firstName+" "+r.lastName||"Unknown User",userType:r.userType||"TEAM_MEMBER",role:r.role||"member",organization:{id:r.organizationId||"",name:r.organizationName||"Unknown Organization",tier:r.tier||"BASIC",isOwner:r.isOwner||!1},license:{type:r.licenseType||r.tier||"BASIC",status:r.status||"ACTIVE",permissions:r.permissions||[],canCreateProjects:r.tier==="ENTERPRISE"||r.tier==="PROFESSIONAL",canManageTeam:r.role==="admin"||r.role==="owner"},teamMemberData:r.userType==="TEAM_MEMBER"?{managedBy:r.managedBy||"",department:r.department||"",assignedProjects:r.assignedProjects||[]}:void 0,status:r.status||"ACTIVE",createdAt:((d=r.createdAt)==null?void 0:d.toDate())||new Date,updatedAt:((l=r.updatedAt)==null?void 0:l.toDate())||new Date,lastLoginAt:(h=r.lastLoginAt)==null?void 0:h.toDate()}});return this.setCache(a,s),s}catch(n){return console.error("Error fetching organization users:",n),[]}}async updateUser(e,a){try{const t={...a,updatedAt:new Date};await f(m(this.db,"users",e),t),this.clearCacheByPattern("current-user"),this.clearCacheByPattern("org-users-"),this.clearCacheByPattern("org-context-")}catch(t){throw console.error("Error updating user:",t),t}}async getProjectsForUser(){const e=await this.getCurrentUser();if(!e)return[];const a=`user-projects-${e.id}`,t=this.getFromCache(a);if(t)return t;try{const n=z(y(this.db,"projects"),A("organizationId","==",e.organization.id)),s=(await P(n)).docs.map(o=>{var d,l,h;const r=o.data();return{...r,id:o.id,createdAt:((d=r.createdAt)==null?void 0:d.toDate())||new Date,updatedAt:((l=r.updatedAt)==null?void 0:l.toDate())||new Date,lastAccessedAt:((h=r.lastAccessedAt)==null?void 0:h.toDate())||new Date}});return this.setCache(a,s),s}catch(n){return console.error("Error fetching user projects:",n),[]}}async createProject(e){try{if(!await this.getCurrentUser())throw new Error("No authenticated user");const t={...e,createdAt:new Date,updatedAt:new Date,lastAccessedAt:new Date},n=await S(y(this.db,"projects"),t);return this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("org-projects-"),this.clearCacheByPattern("org-context-"),n.id}catch(a){throw console.error("Error creating project:",a),a}}async updateProject(e,a){try{const t={...a,updatedAt:new Date};await f(m(this.db,"projects",e),t),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-")}catch(t){throw console.error("Error updating project:",t),t}}async addTeamMemberToProject(e,a,t){try{const n=await T(m(this.db,"users",a));if(!n.exists())throw new Error("User not found");const c=n.data(),s=await this.getCurrentUser(),o={userId:c.id,email:c.email,name:c.name,role:t,assignedAt:new Date,assignedBy:(s==null?void 0:s.email)||"system"};await f(m(this.db,"projects",e),{teamAssignments:F(o),updatedAt:new Date}),await f(m(this.db,"users",a),{"teamMemberData.assignedProjects":F(e),updatedAt:new Date}),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-")}catch(n){throw console.error("Error adding team member to project:",n),n}}async removeTeamMemberFromProject(e,a){try{const t=await T(m(this.db,"projects",e));if(!t.exists())throw new Error("Project not found");const c=t.data().teamAssignments.find(s=>s.userId===a);c&&(await f(m(this.db,"projects",e),{teamAssignments:I(c),updatedAt:new Date}),await f(m(this.db,"users",a),{"teamMemberData.assignedProjects":I(e),updatedAt:new Date}),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-"))}catch(t){throw console.error("Error removing team member from project:",t),t}}async getOrganizationContext(){var n,c,s,o,r,d;(!this.auth||!this.db)&&await this.initializeFirebase();const e=await this.getCurrentUser();if(!e)throw new Error("No authenticated user");const a=`org-context-${e.organization.id}`,t=this.getFromCache(a);if(t)return t;try{const l=await T(m(this.db,"organizations",e.organization.id));if(!l.exists())throw new Error(`Organization ${e.organization.id} not found`);const h=l.data(),w={...h,id:e.organization.id,createdAt:((n=h.createdAt)==null?void 0:n.toDate())||new Date,updatedAt:((c=h.updatedAt)==null?void 0:c.toDate())||new Date},b=z(y(this.db,"subscriptions"),A("organizationId","==",e.organization.id),A("status","==","ACTIVE"),k(1)),E=await P(b);let M=null;if(!E.empty){const p=E.docs[0].data();M={...p,id:E.docs[0].id,createdAt:((s=p.createdAt)==null?void 0:s.toDate())||new Date,updatedAt:((o=p.updatedAt)==null?void 0:o.toDate())||new Date,currentPeriodStart:((r=p.currentPeriodStart)==null?void 0:r.toDate())||new Date,currentPeriodEnd:((d=p.currentPeriodEnd)==null?void 0:d.toDate())||new Date}}let B=[];try{B=await this.getUsersByOrganization(e.organization.id)}catch(p){throw console.error("Failed to get organization members:",p),p}const L={organization:w,subscription:M,members:B};return this.setCache(a,L,10*60*1e3),L}catch(l){throw console.error("Error fetching organization context:",l),l}}async getLicensesForOrganization(){(!this.auth||!this.db)&&await this.initializeFirebase();const e=await this.getCurrentUser();if(!e)return console.log("🔍 [UnifiedDataService] No user found for license query"),[];const a=`org-licenses-${e.organization.id}`,t=this.getFromCache(a);if(t)return t;try{const n=z(y(this.db,"licenses"),A("organizationId","==",e.organization.id),U("createdAt","desc")),s=(await P(n)).docs.map(o=>{var d,l,h,w,b,E;const r=o.data();return{id:o.id,key:r.key||"",name:r.name||`License ${o.id}`,tier:r.tier||"BASIC",status:r.status||"PENDING",organization:{id:r.organizationId||"",name:r.organizationName||"Unknown Organization",tier:r.tier||"BASIC"},assignedTo:r.userId?{userId:r.userId,name:r.userName||r.userEmail||"Unknown User",email:r.userEmail||"",assignedAt:((d=r.activatedAt)==null?void 0:d.toDate())||new Date}:void 0,usage:{apiCalls:r.usageCount||0,dataTransfer:0,deviceCount:1,maxDevices:r.tier==="ENTERPRISE"?10:r.tier==="PROFESSIONAL"?5:2},activatedAt:(l=r.activatedAt)==null?void 0:l.toDate(),expiresAt:((h=r.expiresAt)==null?void 0:h.toDate())||new Date,lastUsed:(w=r.lastUsed)==null?void 0:w.toDate(),createdAt:((b=r.createdAt)==null?void 0:b.toDate())||new Date,updatedAt:((E=r.updatedAt)==null?void 0:E.toDate())||new Date}});return this.setCache(a,s),s}catch(n){return console.error("Error fetching organization licenses:",n),[]}}async createLicense(e){try{if(!await this.getCurrentUser())throw new Error("No authenticated user");const t={...e,createdAt:new Date,updatedAt:new Date},n=await S(y(this.db,"licenses"),t);return this.clearCacheByPattern("org-licenses-"),n.id}catch(a){throw console.error("Error creating license:",a),a}}async updateLicense(e,a){try{const t={...a,updatedAt:new Date};await f(m(this.db,"licenses",e),t),this.clearCacheByPattern("org-licenses-")}catch(t){throw console.error("Error updating license:",t),t}}async assignLicense(e,a){try{const t=await T(m(this.db,"users",a));if(!t.exists())throw new Error("User not found");const n=t.data();await f(m(this.db,"licenses",e),{assignedTo:{userId:a,name:n.name||n.email,email:n.email,assignedAt:new Date},status:"ACTIVE",updatedAt:new Date}),this.clearCacheByPattern("org-licenses-")}catch(t){throw console.error("Error assigning license:",t),t}}async unassignLicense(e){try{await f(m(this.db,"licenses",e),{assignedTo:null,updatedAt:new Date}),this.clearCacheByPattern("org-licenses-")}catch(a){throw console.error("Error unassigning license:",a),a}}async getTeamMembersForOrganization(){const e=await this.getCurrentUser();if(!e)return[];const a=`org-team-members-${e.organization.id}`,t=this.getFromCache(a);if(t)return t;try{const n=z(y(this.db,"teamMembers"),A("organizationId","==",e.organization.id),U("createdAt","desc")),s=(await P(n)).docs.map(o=>{var d,l,h,w,b;const r=o.data();return{...r,id:o.id,createdAt:((d=r.createdAt)==null?void 0:d.toDate())||new Date,updatedAt:((l=r.updatedAt)==null?void 0:l.toDate())||new Date,joinedAt:((h=r.joinedAt)==null?void 0:h.toDate())||new Date,lastActive:(w=r.lastActive)==null?void 0:w.toDate(),licenseAssignment:r.licenseAssignment?{...r.licenseAssignment,assignedAt:((b=r.licenseAssignment.assignedAt)==null?void 0:b.toDate())||new Date}:void 0}});return this.setCache(a,s),s}catch(n){return console.error("Error fetching team members:",n),[]}}async inviteTeamMember(e){try{const a=await this.getCurrentUser();if(!a)throw new Error("No authenticated user");const t={...e,status:"pending",invitedBy:a.email,joinedAt:new Date,createdAt:new Date,updatedAt:new Date},n=await S(y(this.db,"team_members"),t);return this.clearCacheByPattern("org-team-members-"),this.clearCacheByPattern("org-users-"),n.id}catch(a){throw console.error("Error inviting team member:",a),a}}async updateTeamMember(e,a){try{const t={...a,updatedAt:new Date};await f(m(this.db,"team_members",e),t),this.clearCacheByPattern("org-team-members-"),this.clearCacheByPattern("org-users-")}catch(t){throw console.error("Error updating team member:",t),t}}async removeTeamMember(e){try{await f(m(this.db,"team_members",e),{status:"removed",updatedAt:new Date}),this.clearCacheByPattern("org-team-members-"),this.clearCacheByPattern("org-users-")}catch(a){throw console.error("Error removing team member:",a),a}}async assignLicenseToTeamMember(e,a,t,n){try{await f(m(this.db,"team_members",e),{licenseAssignment:{licenseId:a,licenseKey:t,licenseType:n,assignedAt:new Date},updatedAt:new Date}),this.clearCacheByPattern("org-team-members-"),this.clearCacheByPattern("org-licenses-")}catch(c){throw console.error("Error assigning license to team member:",c),c}}async getDatasetsForUser(){const e=await this.getCurrentUser();if(!e)return[];const a=`user-datasets-${e.id}`,t=this.getFromCache(a);if(t)return t;try{const n=z(y(this.db,"datasets"),A("owner.organizationId","==",e.organization.id),A("status","==","ACTIVE"),U("updatedAt","desc")),s=(await P(n)).docs.map(o=>{var d,l;const r=o.data();return{...r,id:o.id,createdAt:((d=r.createdAt)==null?void 0:d.toDate())||new Date,updatedAt:((l=r.updatedAt)==null?void 0:l.toDate())||new Date}});return this.setCache(a,s),s}catch(n){return console.error("Error fetching user datasets:",n),[]}}getFromCache(e){const a=this.cache.get(e);return a?Date.now()>a.timestamp+a.ttl?(this.cache.delete(e),null):a.data:null}setCache(e,a,t=this.CACHE_TTL){this.cache.set(e,{data:a,timestamp:Date.now(),ttl:t})}clearCacheByPattern(e){for(const a of this.cache.keys())a.includes(e)&&this.cache.delete(a)}clearAllCache(){this.cache.clear()}static getInstance(){return D.instance||(D.instance=new D),D.instance}};C(D,"instance");let j=D;const g=j.getInstance();function R(){const[i,e]=u.useState(null),[a,t]=u.useState(!0),[n,c]=u.useState(null),s=u.useCallback(async()=>{try{t(!0),c(null);const o=await g.getCurrentUser();e(o)}catch(o){c(o instanceof Error?o.message:"Failed to fetch user")}finally{t(!1)}},[]);return u.useEffect(()=>{s()},[s]),{data:i,loading:a,error:n,refetch:s}}function K(){const[i,e]=u.useState(!1),[a,t]=u.useState(null);return{mutate:u.useCallback(async({userId:c,updates:s})=>{try{e(!0),t(null),await g.updateUser(c,s)}catch(o){throw t(o instanceof Error?o.message:"Failed to update user"),o}finally{e(!1)}},[]),loading:i,error:a}}function Q(){const[i,e]=u.useState([]),[a,t]=u.useState(!0),[n,c]=u.useState(null),s=u.useCallback(async()=>{try{t(!0),c(null);const o=await g.getProjectsForUser();e(o)}catch(o){c(o instanceof Error?o.message:"Failed to fetch projects")}finally{t(!1)}},[]);return u.useEffect(()=>{s()},[s]),{data:i,loading:a,error:n,refetch:s}}function W(){const[i,e]=u.useState(null),[a,t]=u.useState(!0),[n,c]=u.useState(null),s=u.useCallback(async()=>{try{t(!0),c(null);const o=await g.getOrganizationContext();e(o)}catch(o){c(o instanceof Error?o.message:"Failed to fetch organization context")}finally{t(!1)}},[]);return u.useEffect(()=>{s()},[s]),{data:i,loading:a,error:n,refetch:s}}function q(){const[i,e]=u.useState([]),[a,t]=u.useState(!0),[n,c]=u.useState(null),s=u.useCallback(async()=>{try{t(!0),c(null);const o=await g.getLicensesForOrganization();e(o)}catch(o){c(o instanceof Error?o.message:"Failed to fetch licenses")}finally{t(!1)}},[]);return u.useEffect(()=>{s()},[s]),{data:i,loading:a,error:n,refetch:s}}function H(){const[i,e]=u.useState(!1),[a,t]=u.useState(null);return{mutate:u.useCallback(async c=>{try{return e(!0),t(null),await g.createLicense(c)}catch(s){throw t(s instanceof Error?s.message:"Failed to create license"),s}finally{e(!1)}},[]),loading:i,error:a}}function G(){const[i,e]=u.useState(!1),[a,t]=u.useState(null);return{mutate:u.useCallback(async({licenseId:c,updates:s})=>{try{e(!0),t(null),await g.updateLicense(c,s)}catch(o){throw t(o instanceof Error?o.message:"Failed to update license"),o}finally{e(!1)}},[]),loading:i,error:a}}function J(){const[i,e]=u.useState(!1),[a,t]=u.useState(null);return{mutate:u.useCallback(async({licenseId:c,userId:s})=>{try{e(!0),t(null),await g.assignLicense(c,s)}catch(o){throw t(o instanceof Error?o.message:"Failed to assign license"),o}finally{e(!1)}},[]),loading:i,error:a}}function X(){const[i,e]=u.useState(!1),[a,t]=u.useState(null);return{mutate:u.useCallback(async({licenseId:c})=>{try{e(!0),t(null),await g.unassignLicense(c)}catch(s){throw t(s instanceof Error?s.message:"Failed to unassign license"),s}finally{e(!1)}},[]),loading:i,error:a}}function Y(){const[i,e]=u.useState([]),[a,t]=u.useState(!0),[n,c]=u.useState(null),s=u.useCallback(async()=>{try{t(!0),c(null);const o=await g.getTeamMembersForOrganization();e(o)}catch(o){c(o instanceof Error?o.message:"Failed to fetch team members")}finally{t(!1)}},[]);return u.useEffect(()=>{s()},[s]),{data:i,loading:a,error:n,refetch:s}}function Z(){const[i,e]=u.useState(!1),[a,t]=u.useState(null);return{mutate:u.useCallback(async c=>{try{return e(!0),t(null),await g.inviteTeamMember(c)}catch(s){throw t(s instanceof Error?s.message:"Failed to invite team member"),s}finally{e(!1)}},[]),loading:i,error:a}}function ee(){const[i,e]=u.useState(!1),[a,t]=u.useState(null);return{mutate:u.useCallback(async({memberId:c,updates:s})=>{try{e(!0),t(null),await g.updateTeamMember(c,s)}catch(o){throw t(o instanceof Error?o.message:"Failed to update team member"),o}finally{e(!1)}},[]),loading:i,error:a}}function te(){const[i,e]=u.useState(!1),[a,t]=u.useState(null);return{mutate:u.useCallback(async({memberId:c})=>{try{e(!0),t(null),await g.removeTeamMember(c)}catch(s){throw t(s instanceof Error?s.message:"Failed to remove team member"),s}finally{e(!1)}},[]),loading:i,error:a}}function ae(){const[i,e]=u.useState(!1),[a,t]=u.useState(null);return{mutate:u.useCallback(async({memberId:c,licenseId:s,licenseKey:o,licenseType:r})=>{try{e(!0),t(null),await g.assignLicenseToTeamMember(c,s,o,r)}catch(d){throw t(d instanceof Error?d.message:"Failed to assign license to team member"),d}finally{e(!1)}},[]),loading:i,error:a}}function re(){var e,a,t;const{data:i}=R();return{canCreateProjects:((e=i==null?void 0:i.license)==null?void 0:e.canCreateProjects)||!1,canManageTeam:((a=i==null?void 0:i.license)==null?void 0:a.canManageTeam)||!1,isAccountOwner:(i==null?void 0:i.userType)==="ACCOUNT_OWNER",isTeamMember:(i==null?void 0:i.userType)==="TEAM_MEMBER",isAdmin:(i==null?void 0:i.userType)==="ADMIN",organizationTier:((t=i==null?void 0:i.organization)==null?void 0:t.tier)||"BASIC"}}function se(i,e){return u.useCallback((t,n)=>{const c=[...i];return e(t(i)),()=>{e(n?n(c):c)}},[i,e])}export{W as a,q as b,H as c,G as d,J as e,X as f,Q as g,re as h,Y as i,Z as j,ee as k,te as l,ae as m,K as n,se as o,R as u};
