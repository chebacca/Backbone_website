const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-CCqgXVpX.js","assets/index-CCSAaLdG.js","assets/mui-BDWO4bKb.js","assets/vendor-CjD1bmmO.js","assets/stripe-CpfM3ZZO.js","assets/index-CBai7h7s.css","assets/index.esm-COtph9ny.js","assets/index.esm-ClhtutUx.js","assets/index.esm-DOG5cvVU.js"])))=>i.map(i=>d[i]);
var I=Object.defineProperty;var B=(s,t,e)=>t in s?I(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var A=(s,t,e)=>B(s,typeof t!="symbol"?t+"":t,e);import{r as d}from"./vendor-CjD1bmmO.js";import{_ as F}from"./index-CCSAaLdG.js";import{getDoc as C,doc as g,query as f,collection as E,where as p,orderBy as D,getDocs as b,updateDoc as y,addDoc as M,arrayUnion as O,arrayRemove as x,limit as _}from"./index.esm-ClhtutUx.js";const m=class m{constructor(){A(this,"cache",new Map);A(this,"CACHE_TTL",5*60*1e3);A(this,"db",null);A(this,"auth",null);this.initializeFirebase()}async initializeFirebase(){try{const{db:t,auth:e}=await F(async()=>{const{db:a,auth:r}=await import("./firebase-CCqgXVpX.js");return{db:a,auth:r}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));this.db=t,this.auth=e}catch(t){console.error("Failed to initialize Firebase:",t)}}async getCurrentUser(){var a,r,c,o,n,u;const t="current-user",e=this.getFromCache(t);if(e)return e;if(!((a=this.auth)!=null&&a.currentUser))return null;try{const l=await C(g(this.db,"users",this.auth.currentUser.uid));let i;l.exists()?(i=l.data(),i.organization=i.organization||{id:i.organizationId||"example-corp-org",name:"Example Corp",tier:"ENTERPRISE",isOwner:i.userType==="ACCOUNT_OWNER"},i.license=i.license||{type:((c=i.organization)==null?void 0:c.tier)||"ENTERPRISE",status:"ACTIVE",permissions:["CREATE_PROJECTS","MANAGE_TEAM"],canCreateProjects:!0,canManageTeam:i.userType==="ACCOUNT_OWNER"}):(console.warn("User document not found, creating fallback data"),i={id:this.auth.currentUser.uid,email:this.auth.currentUser.email||"",name:this.auth.currentUser.displayName||((r=this.auth.currentUser.email)==null?void 0:r.split("@")[0])||"User",userType:"ACCOUNT_OWNER",role:"OWNER",organizationId:"example-corp-org",organization:{id:"example-corp-org",name:"Example Corp",tier:"ENTERPRISE",isOwner:!0},license:{type:"ENTERPRISE",status:"ACTIVE",permissions:["CREATE_PROJECTS","MANAGE_TEAM"],canCreateProjects:!0,canManageTeam:!0},preferences:{},createdAt:new Date,updatedAt:new Date});const h={...i,createdAt:((o=i.createdAt)==null?void 0:o.toDate())||new Date,updatedAt:((n=i.updatedAt)==null?void 0:n.toDate())||new Date,lastLoginAt:(u=i.lastLoginAt)==null?void 0:u.toDate()};return this.setCache(t,h),h}catch(l){return console.error("Error fetching current user:",l),null}}async getUsersByOrganization(t){const e=`org-users-${t}`,a=this.getFromCache(e);if(a)return a;try{const r=f(E(this.db,"users"),p("organization.id","==",t),p("status","==","ACTIVE"),D("name")),o=(await b(r)).docs.map(n=>{var l,i,h;const u=n.data();return{...u,id:n.id,createdAt:((l=u.createdAt)==null?void 0:l.toDate())||new Date,updatedAt:((i=u.updatedAt)==null?void 0:i.toDate())||new Date,lastLoginAt:(h=u.lastLoginAt)==null?void 0:h.toDate()}});return this.setCache(e,o),o}catch(r){return console.error("Error fetching organization users:",r),[]}}async updateUser(t,e){try{const a={...e,updatedAt:new Date};await y(g(this.db,"users",t),a),this.clearCacheByPattern("current-user"),this.clearCacheByPattern("org-users-"),this.clearCacheByPattern("org-context-")}catch(a){throw console.error("Error updating user:",a),a}}async getProjectsForUser(){const t=await this.getCurrentUser();if(!t)return[];const e=`user-projects-${t.id}`,a=this.getFromCache(e);if(a)return a;try{let r;t.userType==="ACCOUNT_OWNER"?r=f(E(this.db,"projects"),p("organization.id","==",t.organization.id),p("status","!=","DELETED"),D("status"),D("lastAccessedAt","desc")):r=f(E(this.db,"projects"),p("teamAssignments","array-contains-any",[{userId:t.id}]),p("status","!=","DELETED"),D("lastAccessedAt","desc"));const o=(await b(r)).docs.map(n=>{var l,i,h;const u=n.data();return{...u,id:n.id,createdAt:((l=u.createdAt)==null?void 0:l.toDate())||new Date,updatedAt:((i=u.updatedAt)==null?void 0:i.toDate())||new Date,lastAccessedAt:((h=u.lastAccessedAt)==null?void 0:h.toDate())||new Date}});return this.setCache(e,o),o}catch(r){return console.error("Error fetching user projects:",r),[]}}async createProject(t){try{if(!await this.getCurrentUser())throw new Error("No authenticated user");const a={...t,createdAt:new Date,updatedAt:new Date,lastAccessedAt:new Date},r=await M(E(this.db,"projects"),a);return this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("org-projects-"),this.clearCacheByPattern("org-context-"),r.id}catch(e){throw console.error("Error creating project:",e),e}}async updateProject(t,e){try{const a={...e,updatedAt:new Date};await y(g(this.db,"projects",t),a),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-")}catch(a){throw console.error("Error updating project:",a),a}}async addTeamMemberToProject(t,e,a){try{const r=await C(g(this.db,"users",e));if(!r.exists())throw new Error("User not found");const c=r.data(),o=await this.getCurrentUser(),n={userId:c.id,email:c.email,name:c.name,role:a,assignedAt:new Date,assignedBy:(o==null?void 0:o.email)||"system"};await y(g(this.db,"projects",t),{teamAssignments:O(n),updatedAt:new Date}),await y(g(this.db,"users",e),{"teamMemberData.assignedProjects":O(t),updatedAt:new Date}),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-")}catch(r){throw console.error("Error adding team member to project:",r),r}}async removeTeamMemberFromProject(t,e){try{const a=await C(g(this.db,"projects",t));if(!a.exists())throw new Error("Project not found");const c=a.data().teamAssignments.find(o=>o.userId===e);c&&(await y(g(this.db,"projects",t),{teamAssignments:x(c),updatedAt:new Date}),await y(g(this.db,"users",e),{"teamMemberData.assignedProjects":x(t),updatedAt:new Date}),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-"))}catch(a){throw console.error("Error removing team member from project:",a),a}}async getOrganizationContext(){var r,c,o,n,u,l;const t=await this.getCurrentUser();if(!t)throw new Error("No authenticated user");const e=`org-context-${t.organization.id}`,a=this.getFromCache(e);if(a)return a;try{const i=await C(g(this.db,"organizations",t.organization.id));let h;i.exists()?h=i.data():(console.warn("Organization not found, creating fallback data"),h={id:t.organization.id,name:t.organization.name||"Example Corp",tier:t.organization.tier||"ENTERPRISE",description:"Enterprise organization",settings:{},createdAt:new Date,updatedAt:new Date});const R={...h,id:t.organization.id,createdAt:((r=h.createdAt)==null?void 0:r.toDate())||new Date,updatedAt:((c=h.updatedAt)==null?void 0:c.toDate())||new Date},N=f(E(this.db,"subscriptions"),p("organizationId","==",t.organization.id),p("status","==","ACTIVE"),_(1)),T=await b(N);let j=null;if(T.empty)console.warn("No subscription found, creating fallback subscription"),j={id:`fallback-${t.organization.id}`,organizationId:t.organization.id,status:"ACTIVE",plan:{tier:R.tier||"ENTERPRISE",seats:10,pricePerSeat:1980,billingCycle:"monthly"},payment:{stripeSubscriptionId:"fallback_sub",stripeCustomerId:"fallback_cust",method:"card",lastFour:"4242",nextPaymentDate:new Date(Date.now()+30*24*60*60*1e3).toISOString()},currentPeriodStart:new Date,currentPeriodEnd:new Date(Date.now()+30*24*60*60*1e3),createdAt:new Date,updatedAt:new Date};else{const w=T.docs[0].data();j={...w,id:T.docs[0].id,createdAt:((o=w.createdAt)==null?void 0:o.toDate())||new Date,updatedAt:((n=w.updatedAt)==null?void 0:n.toDate())||new Date,currentPeriodStart:((u=w.currentPeriodStart)==null?void 0:u.toDate())||new Date,currentPeriodEnd:((l=w.currentPeriodEnd)==null?void 0:l.toDate())||new Date}}let z=[];try{z=await this.getUsersByOrganization(t.organization.id)}catch{console.warn("Failed to get organization members, using current user as fallback"),z=[t]}const S={organization:R,subscription:j,members:z};return this.setCache(e,S,10*60*1e3),S}catch(i){throw console.error("Error fetching organization context:",i),i}}async getDatasetsForUser(){const t=await this.getCurrentUser();if(!t)return[];const e=`user-datasets-${t.id}`,a=this.getFromCache(e);if(a)return a;try{const r=f(E(this.db,"datasets"),p("owner.organizationId","==",t.organization.id),p("status","==","ACTIVE"),D("updatedAt","desc")),o=(await b(r)).docs.map(n=>{var l,i;const u=n.data();return{...u,id:n.id,createdAt:((l=u.createdAt)==null?void 0:l.toDate())||new Date,updatedAt:((i=u.updatedAt)==null?void 0:i.toDate())||new Date}});return this.setCache(e,o),o}catch(r){return console.error("Error fetching user datasets:",r),[]}}getFromCache(t){const e=this.cache.get(t);return e?Date.now()>e.timestamp+e.ttl?(this.cache.delete(t),null):e.data:null}setCache(t,e,a=this.CACHE_TTL){this.cache.set(t,{data:e,timestamp:Date.now(),ttl:a})}clearCacheByPattern(t){for(const e of this.cache.keys())e.includes(t)&&this.cache.delete(e)}clearAllCache(){this.cache.clear()}static getInstance(){return m.instance||(m.instance=new m),m.instance}};A(m,"instance");let U=m;const P=U.getInstance();function k(){const[s,t]=d.useState(null),[e,a]=d.useState(!0),[r,c]=d.useState(null),o=d.useCallback(async()=>{try{a(!0),c(null);const n=await P.getCurrentUser();t(n)}catch(n){c(n instanceof Error?n.message:"Failed to fetch user")}finally{a(!1)}},[]);return d.useEffect(()=>{o()},[o]),{data:s,loading:e,error:r,refetch:o}}function $(){const[s,t]=d.useState(!1),[e,a]=d.useState(null);return{mutate:d.useCallback(async({userId:c,updates:o})=>{try{t(!0),a(null),await P.updateUser(c,o)}catch(n){throw a(n instanceof Error?n.message:"Failed to update user"),n}finally{t(!1)}},[]),loading:s,error:e}}function v(){const[s,t]=d.useState([]),[e,a]=d.useState(!0),[r,c]=d.useState(null),o=d.useCallback(async()=>{try{a(!0),c(null);const n=await P.getProjectsForUser();t(n)}catch(n){c(n instanceof Error?n.message:"Failed to fetch projects")}finally{a(!1)}},[]);return d.useEffect(()=>{o()},[o]),{data:s,loading:e,error:r,refetch:o}}function Q(){const[s,t]=d.useState(null),[e,a]=d.useState(!0),[r,c]=d.useState(null),o=d.useCallback(async()=>{try{a(!0),c(null);const n=await P.getOrganizationContext();t(n)}catch(n){c(n instanceof Error?n.message:"Failed to fetch organization context")}finally{a(!1)}},[]);return d.useEffect(()=>{o()},[o]),{data:s,loading:e,error:r,refetch:o}}function G(){var t,e,a;const{data:s}=k();return{canCreateProjects:((t=s==null?void 0:s.license)==null?void 0:t.canCreateProjects)||!1,canManageTeam:((e=s==null?void 0:s.license)==null?void 0:e.canManageTeam)||!1,isAccountOwner:(s==null?void 0:s.userType)==="ACCOUNT_OWNER",isTeamMember:(s==null?void 0:s.userType)==="TEAM_MEMBER",isAdmin:(s==null?void 0:s.userType)==="ADMIN",organizationTier:((a=s==null?void 0:s.organization)==null?void 0:a.tier)||"BASIC"}}function H(s,t){return d.useCallback((a,r)=>{const c=[...s];return t(a(s)),()=>{t(r?r(c):c)}},[s,t])}export{Q as a,v as b,G as c,$ as d,H as e,k as u};
