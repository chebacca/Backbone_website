const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-D7EOsKdG.js","assets/index-Dbxqq8rg.js","assets/mui-BDWO4bKb.js","assets/vendor-CjD1bmmO.js","assets/stripe-CpfM3ZZO.js","assets/index-CBai7h7s.css","assets/index.esm-COtph9ny.js","assets/index.esm-ClhtutUx.js","assets/index.esm-DOG5cvVU.js"])))=>i.map(i=>d[i]);
var O=Object.defineProperty;var M=(n,t,e)=>t in n?O(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var w=(n,t,e)=>M(n,typeof t!="symbol"?t+"":t,e);import{r as u}from"./vendor-CjD1bmmO.js";import{_}from"./index-Dbxqq8rg.js";import{getDoc as E,doc as l,query as D,collection as f,where as g,orderBy as C,getDocs as b,updateDoc as y,addDoc as I,arrayUnion as B,arrayRemove as x,limit as N}from"./index.esm-ClhtutUx.js";const m=class m{constructor(){w(this,"cache",new Map);w(this,"CACHE_TTL",5*60*1e3);w(this,"db",null);w(this,"auth",null);this.initializeFirebase()}async initializeFirebase(){try{const{db:t,auth:e}=await _(async()=>{const{db:r,auth:a}=await import("./firebase-D7EOsKdG.js");return{db:r,auth:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));this.db=t,this.auth=e}catch(t){console.error("Failed to initialize Firebase:",t)}}async getCurrentUser(){var r,a,c,o;const t="current-user",e=this.getFromCache(t);if(e)return e;if(!((r=this.auth)!=null&&r.currentUser))return null;try{const s=await E(l(this.db,"users",this.auth.currentUser.uid));if(!s.exists())return null;const i=s.data(),h={...i,createdAt:((a=i.createdAt)==null?void 0:a.toDate())||new Date,updatedAt:((c=i.updatedAt)==null?void 0:c.toDate())||new Date,lastLoginAt:(o=i.lastLoginAt)==null?void 0:o.toDate()};return this.setCache(t,h),h}catch(s){return console.error("Error fetching current user:",s),null}}async getUsersByOrganization(t){const e=`org-users-${t}`,r=this.getFromCache(e);if(r)return r;try{const a=D(f(this.db,"users"),g("organization.id","==",t),g("status","==","ACTIVE"),C("name")),o=(await b(a)).docs.map(s=>{var h,d,p;const i=s.data();return{...i,id:s.id,createdAt:((h=i.createdAt)==null?void 0:h.toDate())||new Date,updatedAt:((d=i.updatedAt)==null?void 0:d.toDate())||new Date,lastLoginAt:(p=i.lastLoginAt)==null?void 0:p.toDate()}});return this.setCache(e,o),o}catch(a){return console.error("Error fetching organization users:",a),[]}}async updateUser(t,e){try{const r={...e,updatedAt:new Date};await y(l(this.db,"users",t),r),this.clearCacheByPattern("current-user"),this.clearCacheByPattern("org-users-"),this.clearCacheByPattern("org-context-")}catch(r){throw console.error("Error updating user:",r),r}}async getProjectsForUser(){const t=await this.getCurrentUser();if(!t)return[];const e=`user-projects-${t.id}`,r=this.getFromCache(e);if(r)return r;try{let a;t.userType==="ACCOUNT_OWNER"?a=D(f(this.db,"projects"),g("organization.id","==",t.organization.id),g("status","!=","DELETED"),C("status"),C("lastAccessedAt","desc")):a=D(f(this.db,"projects"),g("teamAssignments","array-contains-any",[{userId:t.id}]),g("status","!=","DELETED"),C("lastAccessedAt","desc"));const o=(await b(a)).docs.map(s=>{var h,d,p;const i=s.data();return{...i,id:s.id,createdAt:((h=i.createdAt)==null?void 0:h.toDate())||new Date,updatedAt:((d=i.updatedAt)==null?void 0:d.toDate())||new Date,lastAccessedAt:((p=i.lastAccessedAt)==null?void 0:p.toDate())||new Date}});return this.setCache(e,o),o}catch(a){return console.error("Error fetching user projects:",a),[]}}async createProject(t){try{if(!await this.getCurrentUser())throw new Error("No authenticated user");const r={...t,createdAt:new Date,updatedAt:new Date,lastAccessedAt:new Date},a=await I(f(this.db,"projects"),r);return this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("org-projects-"),this.clearCacheByPattern("org-context-"),a.id}catch(e){throw console.error("Error creating project:",e),e}}async updateProject(t,e){try{const r={...e,updatedAt:new Date};await y(l(this.db,"projects",t),r),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-")}catch(r){throw console.error("Error updating project:",r),r}}async addTeamMemberToProject(t,e,r){try{const a=await E(l(this.db,"users",e));if(!a.exists())throw new Error("User not found");const c=a.data(),o=await this.getCurrentUser(),s={userId:c.id,email:c.email,name:c.name,role:r,assignedAt:new Date,assignedBy:(o==null?void 0:o.email)||"system"};await y(l(this.db,"projects",t),{teamAssignments:B(s),updatedAt:new Date}),await y(l(this.db,"users",e),{"teamMemberData.assignedProjects":B(t),updatedAt:new Date}),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-")}catch(a){throw console.error("Error adding team member to project:",a),a}}async removeTeamMemberFromProject(t,e){try{const r=await E(l(this.db,"projects",t));if(!r.exists())throw new Error("Project not found");const c=r.data().teamAssignments.find(o=>o.userId===e);c&&(await y(l(this.db,"projects",t),{teamAssignments:x(c),updatedAt:new Date}),await y(l(this.db,"users",e),{"teamMemberData.assignedProjects":x(t),updatedAt:new Date}),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-"))}catch(r){throw console.error("Error removing team member from project:",r),r}}async getOrganizationContext(){var a,c,o,s,i,h;const t=await this.getCurrentUser();if(!t)throw new Error("No authenticated user");const e=`org-context-${t.organization.id}`,r=this.getFromCache(e);if(r)return r;try{const d=await E(l(this.db,"organizations",t.organization.id));if(!d.exists())throw new Error("Organization not found");const p=d.data(),F={...p,id:d.id,createdAt:((a=p.createdAt)==null?void 0:a.toDate())||new Date,updatedAt:((c=p.updatedAt)==null?void 0:c.toDate())||new Date},S=D(f(this.db,"subscriptions"),g("organizationId","==",t.organization.id),g("status","==","ACTIVE"),N(1)),P=await b(S);let z=null;if(!P.empty){const A=P.docs[0].data();z={...A,id:P.docs[0].id,createdAt:((o=A.createdAt)==null?void 0:o.toDate())||new Date,updatedAt:((s=A.updatedAt)==null?void 0:s.toDate())||new Date,currentPeriodStart:((i=A.currentPeriodStart)==null?void 0:i.toDate())||new Date,currentPeriodEnd:((h=A.currentPeriodEnd)==null?void 0:h.toDate())||new Date}}const L=await this.getUsersByOrganization(t.organization.id),T={organization:F,subscription:z,members:L};return this.setCache(e,T,10*60*1e3),T}catch(d){throw console.error("Error fetching organization context:",d),d}}async getDatasetsForUser(){const t=await this.getCurrentUser();if(!t)return[];const e=`user-datasets-${t.id}`,r=this.getFromCache(e);if(r)return r;try{const a=D(f(this.db,"datasets"),g("owner.organizationId","==",t.organization.id),g("status","==","ACTIVE"),C("updatedAt","desc")),o=(await b(a)).docs.map(s=>{var h,d;const i=s.data();return{...i,id:s.id,createdAt:((h=i.createdAt)==null?void 0:h.toDate())||new Date,updatedAt:((d=i.updatedAt)==null?void 0:d.toDate())||new Date}});return this.setCache(e,o),o}catch(a){return console.error("Error fetching user datasets:",a),[]}}getFromCache(t){const e=this.cache.get(t);return e?Date.now()>e.timestamp+e.ttl?(this.cache.delete(t),null):e.data:null}setCache(t,e,r=this.CACHE_TTL){this.cache.set(t,{data:e,timestamp:Date.now(),ttl:r})}clearCacheByPattern(t){for(const e of this.cache.keys())e.includes(t)&&this.cache.delete(e)}clearAllCache(){this.cache.clear()}static getInstance(){return m.instance||(m.instance=new m),m.instance}};w(m,"instance");let U=m;const j=U.getInstance();function R(){const[n,t]=u.useState(null),[e,r]=u.useState(!0),[a,c]=u.useState(null),o=u.useCallback(async()=>{try{r(!0),c(null);const s=await j.getCurrentUser();t(s)}catch(s){c(s instanceof Error?s.message:"Failed to fetch user")}finally{r(!1)}},[]);return u.useEffect(()=>{o()},[o]),{data:n,loading:e,error:a,refetch:o}}function V(){const[n,t]=u.useState(!1),[e,r]=u.useState(null);return{mutate:u.useCallback(async({userId:c,updates:o})=>{try{t(!0),r(null),await j.updateUser(c,o)}catch(s){throw r(s instanceof Error?s.message:"Failed to update user"),s}finally{t(!1)}},[]),loading:n,error:e}}function $(){const[n,t]=u.useState([]),[e,r]=u.useState(!0),[a,c]=u.useState(null),o=u.useCallback(async()=>{try{r(!0),c(null);const s=await j.getProjectsForUser();t(s)}catch(s){c(s instanceof Error?s.message:"Failed to fetch projects")}finally{r(!1)}},[]);return u.useEffect(()=>{o()},[o]),{data:n,loading:e,error:a,refetch:o}}function H(){const[n,t]=u.useState(null),[e,r]=u.useState(!0),[a,c]=u.useState(null),o=u.useCallback(async()=>{try{r(!0),c(null);const s=await j.getOrganizationContext();t(s)}catch(s){c(s instanceof Error?s.message:"Failed to fetch organization context")}finally{r(!1)}},[]);return u.useEffect(()=>{o()},[o]),{data:n,loading:e,error:a,refetch:o}}function W(){var t,e,r;const{data:n}=R();return{canCreateProjects:((t=n==null?void 0:n.license)==null?void 0:t.canCreateProjects)||!1,canManageTeam:((e=n==null?void 0:n.license)==null?void 0:e.canManageTeam)||!1,isAccountOwner:(n==null?void 0:n.userType)==="ACCOUNT_OWNER",isTeamMember:(n==null?void 0:n.userType)==="TEAM_MEMBER",isAdmin:(n==null?void 0:n.userType)==="ADMIN",organizationTier:((r=n==null?void 0:n.organization)==null?void 0:r.tier)||"BASIC"}}function q(n,t){return u.useCallback((r,a)=>{const c=[...n];return t(r(n)),()=>{t(a?a(c):c)}},[n,t])}export{H as a,$ as b,W as c,V as d,q as e,R as u};
