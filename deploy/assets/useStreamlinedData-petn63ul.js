const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-BlW4Tg-0.js","assets/index-MWASw4oL.js","assets/mui-CwmAuw8Y.js","assets/vendor-CjD1bmmO.js","assets/stripe-N9VLlH2J.js","assets/index-CBai7h7s.css","assets/index.esm-D7ujsXeY.js","assets/index.esm-DonjM_pP.js","assets/index.esm-D2YDx4vs.js"])))=>i.map(i=>d[i]);
var S=Object.defineProperty;var M=(n,t,e)=>t in n?S(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var w=(n,t,e)=>M(n,typeof t!="symbol"?t+"":t,e);import{r as d}from"./vendor-CjD1bmmO.js";import{_ as L}from"./index-MWASw4oL.js";import{getDoc as A,doc as g,query as C,collection as D,where as f,getDocs as b,updateDoc as y,addDoc as I,arrayUnion as B,arrayRemove as x,limit as N,orderBy as R}from"./index.esm-DonjM_pP.js";const m=class m{constructor(){w(this,"cache",new Map);w(this,"CACHE_TTL",5*60*1e3);w(this,"db",null);w(this,"auth",null);this.initializeFirebase()}async initializeFirebase(){try{const{db:t,auth:e}=await L(async()=>{const{db:r,auth:a}=await import("./firebase-BlW4Tg-0.js");return{db:r,auth:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));this.db=t,this.auth=e}catch(t){console.error("Failed to initialize Firebase:",t)}}async getCurrentUser(){var r,a,c,o;const t="current-user",e=this.getFromCache(t);if(e)return e;if(!((r=this.auth)!=null&&r.currentUser))return null;try{const s=await A(g(this.db,"users",this.auth.currentUser.uid));if(!s.exists())return console.error("User document not found"),null;const i=s.data();let u=null;if(i.organizationId){const l=await A(g(this.db,"organizations",i.organizationId));l.exists()&&(u=l.data())}i.organization={id:i.organizationId||"default-org",name:(u==null?void 0:u.name)||i.organizationName||"Default Organization",tier:(u==null?void 0:u.tier)||i.tier||"BASIC",isOwner:i.userType==="ACCOUNT_OWNER"||i.role==="OWNER"};const h={...i,createdAt:((a=i.createdAt)==null?void 0:a.toDate())||new Date,updatedAt:((c=i.updatedAt)==null?void 0:c.toDate())||new Date,lastLoginAt:(o=i.lastLoginAt)==null?void 0:o.toDate()};return this.setCache(t,h),h}catch(s){return console.error("Error fetching current user:",s),null}}async getUsersByOrganization(t){const e=`org-users-${t}`,r=this.getFromCache(e);if(r)return r;try{const a=C(D(this.db,"users"),f("organization.id","==",t)),o=(await b(a)).docs.map(s=>{var u,h,l;const i=s.data();return{...i,id:s.id,createdAt:((u=i.createdAt)==null?void 0:u.toDate())||new Date,updatedAt:((h=i.updatedAt)==null?void 0:h.toDate())||new Date,lastLoginAt:(l=i.lastLoginAt)==null?void 0:l.toDate()}});return this.setCache(e,o),o}catch(a){return console.error("Error fetching organization users:",a),[]}}async updateUser(t,e){try{const r={...e,updatedAt:new Date};await y(g(this.db,"users",t),r),this.clearCacheByPattern("current-user"),this.clearCacheByPattern("org-users-"),this.clearCacheByPattern("org-context-")}catch(r){throw console.error("Error updating user:",r),r}}async getProjectsForUser(){const t=await this.getCurrentUser();if(!t)return[];const e=`user-projects-${t.id}`,r=this.getFromCache(e);if(r)return r;try{const a=C(D(this.db,"projects"),f("organization.id","==",t.organization.id)),o=(await b(a)).docs.map(s=>{var u,h,l;const i=s.data();return{...i,id:s.id,createdAt:((u=i.createdAt)==null?void 0:u.toDate())||new Date,updatedAt:((h=i.updatedAt)==null?void 0:h.toDate())||new Date,lastAccessedAt:((l=i.lastAccessedAt)==null?void 0:l.toDate())||new Date}});return this.setCache(e,o),o}catch(a){return console.error("Error fetching user projects:",a),[]}}async createProject(t){try{if(!await this.getCurrentUser())throw new Error("No authenticated user");const r={...t,createdAt:new Date,updatedAt:new Date,lastAccessedAt:new Date},a=await I(D(this.db,"projects"),r);return this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("org-projects-"),this.clearCacheByPattern("org-context-"),a.id}catch(e){throw console.error("Error creating project:",e),e}}async updateProject(t,e){try{const r={...e,updatedAt:new Date};await y(g(this.db,"projects",t),r),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-")}catch(r){throw console.error("Error updating project:",r),r}}async addTeamMemberToProject(t,e,r){try{const a=await A(g(this.db,"users",e));if(!a.exists())throw new Error("User not found");const c=a.data(),o=await this.getCurrentUser(),s={userId:c.id,email:c.email,name:c.name,role:r,assignedAt:new Date,assignedBy:(o==null?void 0:o.email)||"system"};await y(g(this.db,"projects",t),{teamAssignments:B(s),updatedAt:new Date}),await y(g(this.db,"users",e),{"teamMemberData.assignedProjects":B(t),updatedAt:new Date}),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-")}catch(a){throw console.error("Error adding team member to project:",a),a}}async removeTeamMemberFromProject(t,e){try{const r=await A(g(this.db,"projects",t));if(!r.exists())throw new Error("Project not found");const c=r.data().teamAssignments.find(o=>o.userId===e);c&&(await y(g(this.db,"projects",t),{teamAssignments:x(c),updatedAt:new Date}),await y(g(this.db,"users",e),{"teamMemberData.assignedProjects":x(t),updatedAt:new Date}),this.clearCacheByPattern("user-projects-"),this.clearCacheByPattern("project-"))}catch(r){throw console.error("Error removing team member from project:",r),r}}async getOrganizationContext(){var a,c,o,s,i,u;const t=await this.getCurrentUser();if(!t)throw new Error("No authenticated user");const e=`org-context-${t.organization.id}`,r=this.getFromCache(e);if(r)return r;try{const h=await A(g(this.db,"organizations",t.organization.id));if(!h.exists())throw new Error(`Organization ${t.organization.id} not found`);const l=h.data(),F={...l,id:t.organization.id,createdAt:((a=l.createdAt)==null?void 0:a.toDate())||new Date,updatedAt:((c=l.updatedAt)==null?void 0:c.toDate())||new Date},O=C(D(this.db,"subscriptions"),f("organizationId","==",t.organization.id),f("status","==","ACTIVE"),N(1)),j=await b(O);let P=null;if(!j.empty){const p=j.docs[0].data();P={...p,id:j.docs[0].id,createdAt:((o=p.createdAt)==null?void 0:o.toDate())||new Date,updatedAt:((s=p.updatedAt)==null?void 0:s.toDate())||new Date,currentPeriodStart:((i=p.currentPeriodStart)==null?void 0:i.toDate())||new Date,currentPeriodEnd:((u=p.currentPeriodEnd)==null?void 0:u.toDate())||new Date}}let U=[];try{U=await this.getUsersByOrganization(t.organization.id)}catch(p){throw console.error("Failed to get organization members:",p),p}const T={organization:F,subscription:P,members:U};return this.setCache(e,T,10*60*1e3),T}catch(h){throw console.error("Error fetching organization context:",h),h}}async getDatasetsForUser(){const t=await this.getCurrentUser();if(!t)return[];const e=`user-datasets-${t.id}`,r=this.getFromCache(e);if(r)return r;try{const a=C(D(this.db,"datasets"),f("owner.organizationId","==",t.organization.id),f("status","==","ACTIVE"),R("updatedAt","desc")),o=(await b(a)).docs.map(s=>{var u,h;const i=s.data();return{...i,id:s.id,createdAt:((u=i.createdAt)==null?void 0:u.toDate())||new Date,updatedAt:((h=i.updatedAt)==null?void 0:h.toDate())||new Date}});return this.setCache(e,o),o}catch(a){return console.error("Error fetching user datasets:",a),[]}}getFromCache(t){const e=this.cache.get(t);return e?Date.now()>e.timestamp+e.ttl?(this.cache.delete(t),null):e.data:null}setCache(t,e,r=this.CACHE_TTL){this.cache.set(t,{data:e,timestamp:Date.now(),ttl:r})}clearCacheByPattern(t){for(const e of this.cache.keys())e.includes(t)&&this.cache.delete(e)}clearAllCache(){this.cache.clear()}static getInstance(){return m.instance||(m.instance=new m),m.instance}};w(m,"instance");let z=m;const E=z.getInstance();function _(){const[n,t]=d.useState(null),[e,r]=d.useState(!0),[a,c]=d.useState(null),o=d.useCallback(async()=>{try{r(!0),c(null);const s=await E.getCurrentUser();t(s)}catch(s){c(s instanceof Error?s.message:"Failed to fetch user")}finally{r(!1)}},[]);return d.useEffect(()=>{o()},[o]),{data:n,loading:e,error:a,refetch:o}}function Q(){const[n,t]=d.useState(!1),[e,r]=d.useState(null);return{mutate:d.useCallback(async({userId:c,updates:o})=>{try{t(!0),r(null),await E.updateUser(c,o)}catch(s){throw r(s instanceof Error?s.message:"Failed to update user"),s}finally{t(!1)}},[]),loading:n,error:e}}function V(){const[n,t]=d.useState([]),[e,r]=d.useState(!0),[a,c]=d.useState(null),o=d.useCallback(async()=>{try{r(!0),c(null);const s=await E.getProjectsForUser();t(s)}catch(s){c(s instanceof Error?s.message:"Failed to fetch projects")}finally{r(!1)}},[]);return d.useEffect(()=>{o()},[o]),{data:n,loading:e,error:a,refetch:o}}function W(){const[n,t]=d.useState(null),[e,r]=d.useState(!0),[a,c]=d.useState(null),o=d.useCallback(async()=>{try{r(!0),c(null);const s=await E.getOrganizationContext();t(s)}catch(s){c(s instanceof Error?s.message:"Failed to fetch organization context")}finally{r(!1)}},[]);return d.useEffect(()=>{o()},[o]),{data:n,loading:e,error:a,refetch:o}}function H(){var t,e,r;const{data:n}=_();return{canCreateProjects:((t=n==null?void 0:n.license)==null?void 0:t.canCreateProjects)||!1,canManageTeam:((e=n==null?void 0:n.license)==null?void 0:e.canManageTeam)||!1,isAccountOwner:(n==null?void 0:n.userType)==="ACCOUNT_OWNER",isTeamMember:(n==null?void 0:n.userType)==="TEAM_MEMBER",isAdmin:(n==null?void 0:n.userType)==="ADMIN",organizationTier:((r=n==null?void 0:n.organization)==null?void 0:r.tier)||"BASIC"}}function q(n,t){return d.useCallback((r,a)=>{const c=[...n];return t(r(n)),()=>{t(a?a(c):c)}},[n,t])}export{W as a,V as b,H as c,Q as d,q as e,_ as u};
