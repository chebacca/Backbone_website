<!DOCTYPE html>
<html>
<head>
    <title>Force Firebase Auth Refresh</title>
    <!-- Firebase v9 SDK (compat version for easier use) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
        #clearAuth { background: #ff4444; color: white; border: none; border-radius: 4px; }
        #testAuth { background: #4444ff; color: white; border: none; border-radius: 4px; }
        #output { background: #f5f5f5; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        #status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Firebase Auth Refresh Tool</h1>
    <div id="status">Loading...</div>
    <button id="clearAuth" onclick="clearAuth()">Clear Auth & Refresh</button>
    <button id="testAuth" onclick="testAuth()">Test Auth & Queries</button>
    <pre id="output"></pre>

    <script>
        // Firebase config (same as your app)
        const firebaseConfig = {
            apiKey: "AIzaSyDFnIzSYCdPsDDdvP1lympVxEeUn0AQhWs",
            authDomain: "backbone-logic.firebaseapp.com",
            projectId: "backbone-logic",
            storageBucket: "backbone-logic.firebasestorage.app",
            messagingSenderId: "749245129278",
            appId: "1:749245129278:web:dfa5647101ea160a3b276f",
            measurementId: "G-8SZRDQ4XVR"
        };

        // Initialize Firebase with error handling
        let auth, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            log('✅ Firebase initialized successfully');
        } catch (error) {
            log('❌ Firebase initialization failed: ' + error.message);
        }

        function log(message) {
            const output = document.getElementById('output');
            output.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }

        async function clearAuth() {
            try {
                log('🔄 Clearing all authentication data...');
                
                // Sign out from Firebase
                await auth.signOut();
                log('✅ Signed out from Firebase Auth');
                
                // Clear localStorage
                localStorage.clear();
                log('✅ Cleared localStorage');
                
                // Clear sessionStorage
                sessionStorage.clear();
                log('✅ Cleared sessionStorage');
                
                // Clear IndexedDB (Firebase cache)
                if ('indexedDB' in window) {
                    const databases = await indexedDB.databases();
                    for (const db of databases) {
                        if (db.name.includes('firebase') || db.name.includes('firestore')) {
                            indexedDB.deleteDatabase(db.name);
                            log(`✅ Cleared IndexedDB: ${db.name}`);
                        }
                    }
                }
                
                log('🎉 All auth data cleared! Please refresh the page and login again.');
                
            } catch (error) {
                log('❌ Error clearing auth: ' + error.message);
            }
        }

        async function testAuth() {
            try {
                log('🧪 Testing Firebase Auth and Firestore access...');
                
                // Check current user
                const user = auth.currentUser;
                if (!user) {
                    log('❌ No authenticated user');
                    return;
                }
                
                log(`✅ Authenticated user: ${user.email}`);
                log(`   UID: ${user.uid}`);
                
                // Get ID token and check claims
                const idTokenResult = await user.getIdTokenResult(true); // Force refresh
                log('✅ Got fresh ID token');
                log(`   Claims: ${JSON.stringify(idTokenResult.claims, null, 2)}`);
                
                // Test Firestore query
                log('🔍 Testing Firestore query...');
                const orgId = idTokenResult.claims.organizationId;
                if (!orgId) {
                    log('❌ No organizationId in claims');
                    return;
                }
                
                const licensesQuery = db.collection('licenses')
                    .where('organizationId', '==', orgId)
                    .limit(5);
                
                const snapshot = await licensesQuery.get();
                log(`✅ Firestore query successful: ${snapshot.size} licenses found`);
                
            } catch (error) {
                log('❌ Error testing auth: ' + error.message);
                log('   Error code: ' + error.code);
            }
        }

        // Auto-login for testing
        async function autoLogin() {
            try {
                log('🔑 Attempting auto-login...');
                await auth.signInWithEmailAndPassword('enterprise.user@example.com', 'Enterprise2024!');
                log('✅ Auto-login successful');
                await testAuth();
            } catch (error) {
                log('❌ Auto-login failed: ' + error.message);
            }
        }

        // Initialize
        auth.onAuthStateChanged((user) => {
            const status = document.getElementById('status');
            if (user) {
                status.textContent = `Authenticated: ${user.email}`;
                log(`🔑 Auth state changed: ${user.email}`);
            } else {
                status.textContent = 'Not authenticated';
                log('🔑 Auth state changed: Not authenticated');
            }
        });

        // Auto-login after 1 second
        setTimeout(autoLogin, 1000);
    </script>
</body>
</html>
